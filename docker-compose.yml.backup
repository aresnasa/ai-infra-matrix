# AI Infrastructure Matrix - 统一 Docker Compose 配置
# 版本: v3.0.0 - 自定义Nginx镜像版本 (嵌入式静态文件)
# 作者: AI Infrastructure Team

services:
  postgres:
    image: postgres:15-alpine
      TZ: Asia/Shanghai
    expose:
      - "8080"
    ports:
      - "9095:8080"  # Kafka UI 管理界面
    networks:
      - ai-infra-network
    restart: unless-stopped

  # OpenLDAP 目录服务
  openldap:
    image: osixia/openldap:stable
    container_name: ai-infra-openldap
    env_file:
    - .env
    environment:
      LDAP_ORGANISATION: "AI Infrastructure"
      LDAP_DOMAIN: "ai-infra.com"
      LDAP_ADMIN_PASSWORD: "${LDAP_ADMIN_PASSWORD}"
      LDAP_CONFIG_PASSWORD: "${LDAP_CONFIG_PASSWORD}"
      LDAP_BASE_DN: "dc=ai-infra,dc=com"
      *** End Patch
    volumes:
      - openscow_ssh_data:/home
      - openscow_ssh_keys:/etc/ssh/keys
    networks:
      - ai-infra-network
    restart: unless-stopped

  # OpenSCOW 主应用服务
  openscow:
    image: ai-infra-openscow:${IMAGE_TAG:-v0.3.6-dev}
    build:
      context: ./src/openscow
      dockerfile: docker/Dockerfile.scow
      args:
        VERSION: ${IMAGE_TAG:-v0.3.6-dev}
    container_name: ai-infra-openscow
    env_file:
    - .env
    environment:
      # 数据库配置
      DB_HOST: openscow-db
      DB_PORT: 3306
      DB_NAME: scow
      DB_USER: scow
      DB_PASSWORD: ${OPENSCOW_MYSQL_PASSWORD:-openscowpass}
      # Redis 配置
      REDIS_HOST: openscow-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${OPENSCOW_REDIS_PASSWORD:-openscowredis}
      # SSH 配置
      SSH_HOST: openscow-ssh
      SSH_PORT: 22
      # 应用配置
      SCOW_LAUNCH_APP: portal-web
      NODE_ENV: production
      TZ: Asia/Shanghai
      # 外部访问配置
      BASE_PATH: /openscow
      PUBLIC_URL: ${DOMAIN:-localhost}/openscow
    expose:
      - "3000"  # 主应用端口
      - "80"    # Nginx 端口
      - "5000"  # API 端口
    volumes:
      - openscow_data:/app/data
      - openscow_logs:/app/logs
    depends_on:
      openscow-db:
        condition: service_healthy
      openscow-redis:
        condition: service_healthy
      openscow-ssh:
        condition: service_started
    networks:
      - ai-infra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Gitea 代码托管服务（可选，供门户内嵌）
  gitea:
    image: ai-infra-gitea:${IMAGE_TAG:-v0.3.6-dev}
    build:
      context: ./src/gitea
      dockerfile: Dockerfile
    container_name: ai-infra-gitea
    env_file:
    - .env
    environment:
      USER_UID: "1000"
      USER_GID: "1000"
      ROOT_URL: "${ROOT_URL}"
      SUBURL: "/gitea"
      STATIC_URL_PREFIX: "/gitea"
      GITEA__server__ROOT_URL: "${ROOT_URL}"
      GITEA__server__SUBURL: "/gitea"
      DOMAIN: "${DOMAIN}"
      PROTOCOL: "http"
      HTTP_PORT: "3000"
      GITEA_DB_TYPE: "postgres"
      GITEA_DB_HOST: "${GITEA_DB_HOST:-postgres:5432}"
      GITEA_DB_NAME: "${GITEA_DB_NAME:-gitea}"
      # 注意：以下两行必须使用6个空格缩进，保持与其他 environment 项对齐，否则会导致 YAML 解析错误。
      GITEA_DB_USER: "${GITEA_DB_USER:-gitea}"
      GITEA_DB_PASSWD: "${GITEA_DB_PASSWD:-gitea-password}"
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres}"
      DISABLE_REGISTRATION: "false"
      REVERSE_PROXY_TRUSTED_PROXIES: "0.0.0.0/0,::/0"
      GITEA__auth__REVERSE_PROXY_AUTHENTICATION_USER: "X-WEBAUTH-USER"
      GITEA__auth__REVERSE_PROXY_AUTHENTICATION_EMAIL: "X-WEBAUTH-EMAIL"
      GITEA__auth__REVERSE_PROXY_AUTHENTICATION_FULL_NAME: "X-WEBAUTH-FULLNAME"
      GITEA__auth__PROXY_ENABLED: "true"
      GITEA__auth__PROXY_HEADER_NAME: "X-WEBAUTH-USER"
      GITEA__auth__PROXY_EMAIL_HEADER: "X-WEBAUTH-EMAIL"
      GITEA__auth__PROXY_FULL_NAME_HEADER: "X-WEBAUTH-FULLNAME"
      GITEA__security__REVERSE_PROXY_LIMIT: "1"
      GITEA__security__REVERSE_PROXY_TRUSTED_PROXIES: "0.0.0.0/0,::/0"
      # Set initial admin identity to 'admin' user
      INITIAL_ADMIN_USERNAME: "${GITEA_ALIAS_ADMIN_TO:-admin}"
      # Admin bootstrap via reverse-proxy SSO only; admin user will be default admin
      GITEA__storage__STORAGE_TYPE: "${GITEA_STORAGE:-local}"
      DATA_PATH: "/data/gitea"
      MINIO_ENDPOINT: "${MINIO_HOST:-minio}:${MINIO_PORT:-9000}"
      MINIO_BUCKET: "gitea"
      MINIO_USE_SSL: "false"
      MINIO_LOCATION: "us-east-1"
      MINIO_ACCESS_KEY: "${MINIO_ACCESS_KEY:-minioadmin}"
      MINIO_SECRET_KEY: "${MINIO_SECRET_KEY:-minioadmin}"
      TZ: "Asia/Shanghai"
    expose:
      - "3000"
      - "22"
    ports:
      # Debug: expose internal 3000 on host 3010 for direct backend access (bypass Nginx)
      - "3010:3000"
    volumes:
      - gitea_data:/data
    depends_on:
      postgres:
        condition: service_healthy
      backend:
        condition: service_healthy
    networks:
      - ai-infra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # MinIO (S3-compatible)
  minio:
    image: minio/minio:latest
    container_name: ai-infra-minio
    command: server /data --console-address ":9001"
    env_file:
    - .env
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
      - TZ=Asia/Shanghai
    expose:
      - "9000"
      - "9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - ai-infra-network
    restart: unless-stopped

volumes:
  postgres_data:
    name: ai-infra-postgres-data
  redis_data:
    name: ai-infra-redis-data
  kafka_data:
    name: ai-infra-kafka-data
  kafka_logs:
    name: ai-infra-kafka-logs
  ldap_data:
    name: ai-infra-ldap-data
  ldap_config:
    name: ai-infra-ldap-config
  jupyterhub_data:
    name: ai-infra-jupyterhub-data
  jupyterhub_notebooks:
    name: ai-infra-jupyterhub-notebooks
  nginx_logs:
    name: ai-infra-nginx-logs
  salt_data:
    name: ai-infra-salt-data
  salt_logs:
    name: ai-infra-salt-logs
  salt_keys:
    name: ai-infra-salt-keys
  slurm_operator_data:
    name: ai-infra-slurm-operator-data
  slurm_operator_webhook_data:
    name: ai-infra-slurm-operator-webhook-data
  slurm_operator_certs:
    name: ai-infra-slurm-operator-certs
  gitea_data:
    name: ai-infra-gitea-data
  minio_data:
    name: ai-infra-minio-data

networks:
  ai-infra-network:
    name: ai-infra-network
    driver: bridge
