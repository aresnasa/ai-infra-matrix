apiVersion: v1
kind: Secret
metadata:
  name: {{ include "redis-cluster.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
type: Opaque
stringData:
  redis-password: {{ .Values.redis.password | default (randAlphaNum 16) | quote }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "redis-cluster.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "redis-cluster.labels" . | nindent 4 }}
data:
  redis.conf: |
    # Redis Cluster Configuration
    port 6379
    bind 0.0.0.0
    protected-mode yes
    
    # Cluster settings
    cluster-enabled yes
    cluster-config-file /data/nodes.conf
    cluster-node-timeout {{ .Values.redis.config.cluster-node-timeout | default "15000" }}
    cluster-require-full-coverage {{ .Values.redis.config.cluster-require-full-coverage | default "no" }}
    cluster-migration-barrier {{ .Values.redis.config.cluster-migration-barrier | default "1" }}
    cluster-replica-validity-factor {{ .Values.redis.config.cluster-replica-validity-factor | default "10" }}
    
    # Memory settings
    maxmemory {{ .Values.redis.config.maxmemory | default "256mb" }}
    maxmemory-policy {{ .Values.redis.config.maxmemory-policy | default "allkeys-lru" }}
    
    # Persistence
    appendonly {{ .Values.redis.config.appendonly | default "yes" }}
    appendfsync {{ .Values.redis.config.appendfsync | default "everysec" }}
    dir /data
    
    # Security
    requirepass ${REDIS_PASSWORD}
    masterauth ${REDIS_PASSWORD}
    
    # Network
    tcp-keepalive {{ .Values.redis.config.tcp-keepalive | default "300" }}
    timeout {{ .Values.redis.config.timeout | default "0" }}
    
  start-node.sh: |
    #!/bin/sh
    set -e
    
    # Replace password placeholder
    sed "s/\${REDIS_PASSWORD}/$REDIS_PASSWORD/g" /etc/redis/redis.conf > /data/redis.conf
    
    # Set announce IP for cluster
    ANNOUNCE_IP=$(hostname -i)
    echo "cluster-announce-ip $ANNOUNCE_IP" >> /data/redis.conf
    echo "cluster-announce-port 6379" >> /data/redis.conf
    echo "cluster-announce-bus-port 16379" >> /data/redis.conf
    
    exec redis-server /data/redis.conf
