apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ai-infra-matrix.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ai-infra-matrix.labels" . | nindent 4 }}
data:
  # Database Configuration - Supports Patroni HA or standalone PostgreSQL
  {{- if .Values.patroni.enabled }}
  # Patroni PostgreSQL HA Mode
  POSTGRES_HOST: {{ printf "%s-patroni" (include "ai-infra-matrix.fullname" .) | quote }}
  POSTGRES_PORT: "5432"
  POSTGRES_DB: {{ .Values.patroni.postgresql.database | quote }}
  POSTGRES_USER: {{ .Values.patroni.postgresql.username | quote }}
  POSTGRES_HA_ENABLED: "true"
  POSTGRES_REPLICA_HOST: {{ printf "%s-patroni-replica" (include "ai-infra-matrix.fullname" .) | quote }}
  {{- else if .Values.postgresql.enabled }}
  # Standalone PostgreSQL Mode
  POSTGRES_HOST: {{ printf "%s-postgresql" (include "ai-infra-matrix.fullname" .) | quote }}
  POSTGRES_PORT: "5432"
  POSTGRES_DB: {{ .Values.postgresql.auth.database | quote }}
  POSTGRES_USER: {{ .Values.postgresql.auth.username | quote }}
  POSTGRES_HA_ENABLED: "false"
  {{- else }}
  # External PostgreSQL
  POSTGRES_HOST: "postgres-service"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "ai_infra_db"
  POSTGRES_USER: "postgres"
  POSTGRES_HA_ENABLED: "false"
  {{- end }}
  
  # Redis Configuration - Supports Redis Cluster or standalone Redis
  {{- if .Values.redisCluster.enabled }}
  # Redis Cluster Mode
  REDIS_MODE: "cluster"
  REDIS_HOST: {{ printf "%s-redis-cluster" (include "ai-infra-matrix.fullname" .) | quote }}
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  # Redis Cluster nodes for client connection
  REDIS_CLUSTER_NODES: {{ printf "%s-redis-cluster-0.%s-redis-cluster-headless:%d,%s-redis-cluster-1.%s-redis-cluster-headless:%d,%s-redis-cluster-2.%s-redis-cluster-headless:%d" (include "ai-infra-matrix.fullname" .) (include "ai-infra-matrix.fullname" .) (.Values.redisCluster.port | int) (include "ai-infra-matrix.fullname" .) (include "ai-infra-matrix.fullname" .) (.Values.redisCluster.port | int) (include "ai-infra-matrix.fullname" .) (include "ai-infra-matrix.fullname" .) (.Values.redisCluster.port | int) | quote }}
  {{- else }}
  # Standalone Redis Mode
  REDIS_MODE: "standalone"
  REDIS_HOST: {{ printf "%s-redis-master" (include "ai-infra-matrix.fullname" .) | quote }}
  REDIS_PORT: "6379"
  REDIS_DB: "1"
  {{- end }}
  
  # Kafka Configuration
  {{- if .Values.kafka.enabled }}
  KAFKA_ENABLED: "true"
  KAFKA_BOOTSTRAP_SERVERS: {{ printf "%s-kafka-headless:9092" (include "ai-infra-matrix.fullname" .) | quote }}
  KAFKA_KRAFT_MODE: "true"
  {{- else }}
  KAFKA_ENABLED: "false"
  KAFKA_BOOTSTRAP_SERVERS: ""
  KAFKA_KRAFT_MODE: "false"
  {{- end }}
  
  # Backend Configuration
  BACKEND_HOST: {{ printf "%s-backend" (include "ai-infra-matrix.fullname" .) | quote }}
  BACKEND_PORT: {{ .Values.backend.service.port | quote }}
  
  # Frontend Configuration
  FRONTEND_HOST: {{ printf "%s-frontend" (include "ai-infra-matrix.fullname" .) | quote }}
  FRONTEND_PORT: {{ .Values.frontend.service.port | quote }}
  
  # JupyterHub Configuration
  JUPYTERHUB_HOST: {{ printf "%s-jupyterhub" (include "ai-infra-matrix.fullname" .) | quote }}
  JUPYTERHUB_PORT: {{ .Values.jupyterhub.service.port | quote }}
  
  # JupyterHub Spawner Configuration  
  JUPYTERHUB_SPAWNER: {{ .Values.jupyterhub.env.JUPYTERHUB_SPAWNER | quote }}
  JUPYTERHUB_STORAGE_CLASS: {{ .Values.jupyterhub.env.JUPYTERHUB_STORAGE_CLASS | quote }}
  SHARED_STORAGE_CLASS: {{ .Values.jupyterhub.env.SHARED_STORAGE_CLASS | quote }}
  SHARED_STORAGE_ENABLED: {{ .Values.jupyterhub.env.SHARED_STORAGE_ENABLED | quote }}
  
  # Kubernetes Configuration (for KubeSpawner)
  KUBERNETES_NAMESPACE: {{ .Values.jupyterhub.env.KUBERNETES_NAMESPACE | quote }}
  KUBERNETES_SERVICE_ACCOUNT: {{ .Values.jupyterhub.env.KUBERNETES_SERVICE_ACCOUNT | quote }}
  
  # Gitea Configuration
  GITEA_HOST: {{ printf "%s-gitea" (include "ai-infra-matrix.fullname" .) | quote }}
  GITEA_PORT: {{ .Values.gitea.service.port | quote }}
  
  # OpenLDAP Configuration
  LDAP_HOST: {{ printf "%s-openldap" (include "ai-infra-matrix.fullname" .) | quote }}
  LDAP_PORT: {{ .Values.openldap.service.port | quote }}
  
  # SeaweedFS Configuration
  SEAWEEDFS_MASTER_URL: {{ printf "http://%s-seaweedfs-master:%d" (include "ai-infra-matrix.fullname" .) (.Values.seaweedfs.service.masterPort | int) | quote }}
  SEAWEEDFS_FILER_URL: {{ printf "http://%s-seaweedfs-filer:%d" (include "ai-infra-matrix.fullname" .) (.Values.seaweedfs.service.filerPort | int) | quote }}
  SEAWEEDFS_S3_PORT: {{ .Values.seaweedfs.service.s3Port | quote }}
  
  # Nginx Configuration
  NGINX_PORT: {{ .Values.nginx.service.port | quote }}
  NGINX_RESOLVER: "kube-dns.kube-system.svc.cluster.local"
  
  # SSL/TLS Configuration
  ENABLE_TLS: {{ .Values.env.ENABLE_TLS | default "false" | quote }}
  EXTERNAL_SCHEME: {{ .Values.env.EXTERNAL_SCHEME | default "http" | quote }}
  EXTERNAL_HOST: {{ .Values.env.EXTERNAL_HOST | default "localhost" | quote }}
  EXTERNAL_PORT: {{ .Values.env.EXTERNAL_PORT | default "8080" | quote }}
  HTTPS_PORT: {{ .Values.env.HTTPS_PORT | default "8443" | quote }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ai-infra-matrix.fullname" . }}-nginx-conf
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ai-infra-matrix.labels" . | nindent 4 }}
data:
  nginx.conf: |
    events { worker_connections 1024; }
    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      resolver kube-dns.kube-system.svc.cluster.local valid=10s ipv6=off;
      
      # Variables for better handling
      map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
      }
      
      # Cookie variables
      map $http_cookie $has_ai_cookie {
        ~*ai_infra_token=([^;]+) 1;
        default 0;
      }
      
      map $http_cookie $cookie_ai_infra_token {
        ~*ai_infra_token=([^;]+) $1;
        default "";
      }
      
      map $http_authorization $has_authz {
        ~*Bearer\s+([^\s]+) 1;
        default 0;
      }
      
      map $http_authorization $authz_final {
        ~*Bearer\s+([^\s]+) $http_authorization;
        default "Bearer $cookie_ai_infra_token";
      }
      
      # External variables
      map $scheme $external_scheme {
        http http;
        https https;
        default http;
      }
      
      map $host $external_host {
        default $host;
      }
      
      # Log format
      log_format authdebug '$remote_addr - $remote_user [$time_local] "$request" '
                           '$status $body_bytes_sent "$http_referer" '
                           '"$http_user_agent" '
                           'ai_cookie=$has_ai_cookie authz=$has_authz';
      
      server {
        listen 80 default_server;
        server_name _;
        
        absolute_redirect off;
        client_max_body_size 100M;
        
        # Security headers
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;
        
        # Health check endpoint
        location /health {
          access_log off;
          return 200 "OK\n";
          add_header Content-Type text/plain;
        }
        
        # Internal auth endpoint
        location = /__auth/verify {
          internal;
          access_log /var/log/nginx/auth_request.log;
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-backend:{{ .Values.backend.service.port }}/api/auth/verify;
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $external_scheme;
          proxy_set_header X-Forwarded-Host $external_host;
          proxy_set_header Authorization $authz_final;
          proxy_set_header Cookie $http_cookie;
          proxy_pass_request_body off;
          proxy_set_header Content-Length "";
        }
        
        # SSO bridge pages
        location /sso/ {
          root /usr/share/nginx/html;
          index jwt_sso_bridge.html;
          try_files $uri $uri/ /sso/jwt_sso_bridge.html;
          add_header Cache-Control "no-cache, no-store, must-revalidate" always;
          add_header Pragma "no-cache" always;
          add_header Expires "0" always;
        }
        
        # JWT auto login
        location /jwt-login {
          root /usr/share/nginx/html;
          try_files /jwt_login.html =404;
        }
        
        # Backend API
        location /api/ {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-backend:{{ .Values.backend.service.port }}/api/;
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $external_scheme;
          proxy_set_header X-Forwarded-Host $external_host;
          proxy_set_header Authorization $authz_final;
        }
        
        # JupyterHub
        location ^~ /jupyter/ {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-jupyterhub:{{ .Values.jupyterhub.service.port }};
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          proxy_buffering off;
        }
        
        # Gitea service integration
        {{- if .Values.gitea.enabled }}
        # Gitea root path - direct proxy to Gitea homepage
        location = /gitea/ {
          access_log /var/log/nginx/gitea_root_access.log authdebug;
          
          # Direct proxy to Gitea main page with SSO headers
          rewrite ^/gitea/$ / break;
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-gitea:{{ .Values.gitea.service.port }};
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $external_scheme;
          proxy_set_header X-Forwarded-Host $external_host;
          proxy_set_header X-External-Host $external_host;
          proxy_set_header Authorization "";
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          
          # SSO user headers (hardcoded mapping)
          proxy_set_header X-WEBAUTH-USER "test";
          proxy_set_header X-WEBAUTH-EMAIL "admin@example.com";
          proxy_set_header X-Forwarded-User "test";
          proxy_set_header Remote-User "test";
          proxy_set_header X-User "test";
          
          # Frame headers for iframe support
          proxy_hide_header Content-Security-Policy;
          proxy_hide_header Content-Security-Policy-Report-Only;
          proxy_hide_header X-Content-Security-Policy;
          proxy_hide_header X-Frame-Options;
          add_header X-Frame-Options SAMEORIGIN always;
          add_header Content-Security-Policy "frame-ancestors 'self'" always;
          proxy_redirect off;
          
          proxy_buffering off;
          proxy_request_buffering off;
          add_header Cache-Control "no-store, no-cache, must-revalidate" always;
          expires -1;
          
          # Debug headers
          add_header X-Debug-SSO-User "test" always;
          add_header X-Debug-SSO-Email "admin@example.com" always;
          add_header X-Debug-SSO-Method "hardcoded_mapping_root" always;
          add_header X-Debug-SSO-Action "gitea_root_direct_proxy" always;
        }
        
        # Gitea user login handling
        location = /gitea/user/login {
          access_log /var/log/nginx/gitea_login_access.log authdebug;
          
          rewrite ^/gitea/user/login$ /user/login break;
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-gitea:{{ .Values.gitea.service.port }};
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $external_scheme;
          proxy_set_header X-Forwarded-Host $external_host;
          proxy_set_header X-External-Host $external_host;
          
          # SSO user headers
          proxy_set_header X-WEBAUTH-USER "test";
          proxy_set_header X-WEBAUTH-EMAIL "admin@example.com";
          proxy_set_header X-Forwarded-User "test";
          proxy_set_header Remote-User "test";
          proxy_set_header X-User "test";
          
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          
          # Debug headers
          add_header X-Debug-SSO-User "test" always;
          add_header X-Debug-SSO-Email "admin@example.com" always;
          add_header X-Debug-SSO-Action "login_with_auth_headers" always;
        }
        
        # Gitea logout handling
        location = /gitea/user/logout {
          return 302 /gitea/;
        }
        
        # Other Gitea paths
        location ^~ /gitea/ {
          access_log /var/log/nginx/gitea_access.log authdebug;
          rewrite ^/gitea(/.*)$ $1 break;
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-gitea:{{ .Values.gitea.service.port }};
          proxy_set_header Host $http_host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $external_scheme;
          proxy_set_header X-Forwarded-Host $external_host;
          proxy_set_header X-External-Host $external_host;
          proxy_set_header Authorization "";
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection $connection_upgrade;
          
          # SSO user headers
          proxy_set_header X-WEBAUTH-USER "test";
          proxy_set_header X-WEBAUTH-EMAIL "admin@example.com";
          proxy_set_header X-Forwarded-User "test";
          proxy_set_header Remote-User "test";
          proxy_set_header X-User "test";
          
          # Frame headers
          proxy_hide_header Content-Security-Policy;
          proxy_hide_header Content-Security-Policy-Report-Only;
          proxy_hide_header X-Content-Security-Policy;
          proxy_hide_header X-Frame-Options;
          add_header X-Frame-Options SAMEORIGIN always;
          add_header Content-Security-Policy "frame-ancestors 'self'" always;
          proxy_redirect off;
          
          proxy_buffering off;
          proxy_request_buffering off;
          add_header Cache-Control "no-store, no-cache, must-revalidate" always;
          expires -1;
          
          # Debug headers
          add_header X-Debug-SSO-User "test" always;
          add_header X-Debug-SSO-Email "admin@example.com" always;
          add_header X-Debug-SSO-Method "hardcoded_mapping" always;
        }
        
        # Frontend exact path for /gitea (React page)
        location = /gitea {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-frontend:{{ .Values.frontend.service.port }};
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        {{- end }}
        
        # Frontend (catch-all)
        location / {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-frontend:{{ .Values.frontend.service.port }};
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
      }
    }
  
  gitea-iframe.html: |
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Gitea - AI Infrastructure Matrix</title>
        <style>
            body { margin: 0; padding: 0; overflow: hidden; }
            iframe { width: 100%; height: 100vh; border: none; }
        </style>
    </head>
    <body>
        <iframe src="/gitea/" title="Gitea"></iframe>
    </body>
    </html>
