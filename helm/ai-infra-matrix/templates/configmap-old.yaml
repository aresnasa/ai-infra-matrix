apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ai-infra-matrix.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ai-infra-matrix.labels" . | nindent 4 }}
data:
  # Database Configuration
  {{- if .Values.postgresql.enabled }}
  POSTGRES_HOST: {{ printf "%s-postgresql" (include "ai-infra-matrix.fullname" .) | quote }}
  POSTGRES_PORT: "5432"
  POSTGRES_DB: {{ .Values.postgresql.auth.database | quote }}
  POSTGRES_USER: {{ .Values.postgresql.auth.username | quote }}
  {{- else }}
  POSTGRES_HOST: "postgres-service"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "ai_infra_db"
  POSTGRES_USER: "postgres"
  {{- end }}
  
  # Redis Configuration
  REDIS_HOST: {{ include "ai-infra-matrix.redisHost" . | quote }}
  REDIS_PORT: "6379"
  REDIS_DB: "1"
  
  # Backend Configuration
  BACKEND_URL: {{ include "ai-infra-matrix.backendUrl" . | quote }}
  BACKEND_PORT: {{ .Values.backend.service.port | quote }}
  BACKEND_HOST: {{ printf "%s-backend" (include "ai-infra-matrix.fullname" .) | quote }}
  
  # Frontend Configuration
  FRONTEND_HOST: {{ printf "%s-frontend" (include "ai-infra-matrix.fullname" .) | quote }}
  FRONTEND_PORT: {{ .Values.frontend.service.port | quote }}
  REACT_APP_BACKEND_URL: "/api"
  
  # JupyterHub Configuration
  JUPYTERHUB_PORT: {{ .Values.jupyterhub.service.port | quote }}
  JUPYTERHUB_HOST: {{ printf "%s-jupyterhub" (include "ai-infra-matrix.fullname" .) | quote }}
  JUPYTERHUB_USE_PROXY: {{ .Values.jupyterhub.config.useProxy | quote }}
  JUPYTERHUB_PUBLIC_HOST: {{ .Values.jupyterhub.config.publicHost | quote }}
  JUPYTERHUB_HUB_CONNECT_HOST: {{ printf "%s-jupyterhub" (include "ai-infra-matrix.fullname" .) | quote }}
  JUPYTERHUB_IMAGE: {{ printf "%s:%s" .Values.jupyterhub.singleuser.image.repository .Values.jupyterhub.singleuser.image.tag | quote }}
  JUPYTERHUB_MEM_LIMIT: {{ .Values.jupyterhub.singleuser.resources.limit.memory | quote }}
  JUPYTERHUB_CPU_LIMIT: {{ .Values.jupyterhub.singleuser.resources.limit.cpu | quote }}
  JUPYTERHUB_START_TIMEOUT: {{ .Values.jupyterhub.config.startTimeout | quote }}
  JUPYTERHUB_HTTP_TIMEOUT: {{ .Values.jupyterhub.config.httpTimeout | quote }}
  JUPYTERHUB_AUTO_LOGIN: {{ .Values.jupyterhub.config.autoLogin | quote }}
  
  # Session Configuration
  SESSION_TIMEOUT: {{ .Values.jupyterhub.config.sessionTimeout | quote }}
  
  # Kubernetes Configuration
  JUPYTERHUB_SPAWNER: "kubernetes"
  K8S_NAMESPACE: {{ include "ai-infra-matrix.userNamespace" . | quote }}
  K8S_SERVICE_ACCOUNT: "default"
  
  # Nginx Configuration
  NGINX_PORT: {{ .Values.nginx.service.port | quote }}
  NGINX_SSL_PORT: {{ .Values.nginx.service.httpsPort | quote }}

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "ai-infra-matrix.fullname" . }}-nginx-conf
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ai-infra-matrix.labels" . | nindent 4 }}
data:
  nginx.conf: |
    events { worker_connections 1024; }
    http {
      include       /etc/nginx/mime.types;
      default_type  application/octet-stream;
      resolver kube-dns.kube-system.svc.cluster.local valid=10s ipv6=off;
      map $http_upgrade $connection_upgrade { default upgrade; '' close; }
      server { listen 80; server_name _;
        client_max_body_size 100M;
        # JupyterHub under /jupyter (preserve prefix)
        location ^~ /jupyter/ {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-jupyterhub:{{ .Values.jupyterhub.service.port }};
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_http_version 1.1;
          proxy_set_header Upgrade $http_upgrade;
          proxy_set_header Connection "upgrade";
          proxy_buffering off;
        }
        # Backend API
        location /api/ {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-backend:{{ .Values.backend.service.port }}/api/;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        # Static passthrough to frontend first for asset caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-frontend:{{ .Values.frontend.service.port }};
          expires 1y; add_header Cache-Control "public, immutable";
        }
        # Frontend app
        location / {
          proxy_pass http://{{ include "ai-infra-matrix.fullname" . }}-frontend:{{ .Values.frontend.service.port }}/;
          proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
        }
        location = /health { return 200 'healthy\n'; add_header Content-Type text/plain; }
      }
    }
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "ai-infra-matrix.fullname" . }}-secrets
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "ai-infra-matrix.labels" . | nindent 4 }}
type: Opaque
data:
  # Database password
  {{- if .Values.postgresql.enabled }}
  POSTGRES_PASSWORD: {{ .Values.postgresql.auth.password | b64enc | quote }}
  {{- else }}
  POSTGRES_PASSWORD: {{ "postgres" | b64enc | quote }}
  {{- end }}
  
  # Redis password
  {{- if .Values.redis.enabled }}
  REDIS_PASSWORD: {{ .Values.redis.auth.password | b64enc | quote }}
  {{- else }}
  REDIS_PASSWORD: {{ "ansible-redis-password" | b64enc | quote }}
  {{- end }}
  
  # JWT and other secrets
  JWT_SECRET: {{ .Values.backend.env.JWT_SECRET | b64enc | quote }}
  CONFIGPROXY_AUTH_TOKEN: {{ .Values.jupyterhub.env.CONFIGPROXY_AUTH_TOKEN | b64enc | quote }}
  JUPYTERHUB_CRYPT_KEY: {{ .Values.jupyterhub.env.JUPYTERHUB_CRYPT_KEY | b64enc | quote }}
