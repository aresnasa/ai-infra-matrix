# SLURM 节点恢复操作指南

## 📋 操作步骤

### 前置条件
- 系统地址：http://192.168.0.200:8080
- 默认账号：admin / admin123
- 需要恢复的节点：所有 down* 状态的节点

---

### 步骤 1: 登录系统
1. 浏览器访问：http://192.168.0.200:8080
2. 输入用户名：`admin`
3. 输入密码：`admin123`
4. 点击"登录"按钮

---

### 步骤 2: 访问 SLURM 管理页面
1. 登录成功后，从左侧菜单找到"SLURM 集群管理"
2. 或直接访问：http://192.168.0.200:8080/slurm

---

### 步骤 3: 查看节点列表
页面应该显示一个节点列表表格，包含以下列：
- 节点名称
- 分区
- **状态**（关键列，当前可能显示 down*）
- CPU
- 内存(MB)
- SaltStack状态
- 操作

---

### 步骤 4: 选择需要恢复的节点

**重要提示：** "节点操作"按钮仅在选中节点后才会显示！

#### 方法 A: 使用全选（推荐）
1. 找到节点表格左上角的 **复选框**（在表头"节点名称"左侧）
2. 点击此复选框，**选中所有节点**
3. 此时会在表格右上方看到：
   - 文本："已选择 X 个节点"
   - **"节点操作"按钮**（蓝色按钮）

#### 方法 B: 手动选择单个节点
1. 在节点列表中，找到状态为 `down*` 的节点
2. 点击该节点行左侧的 **复选框**
3. 可以选择多个节点（按住 Shift 键连续选择）
4. 选中后会在表格右上方看到：
   - 文本："已选择 X 个节点"
   - **"节点操作"按钮**（蓝色按钮）

---

### 步骤 5: 点击"节点操作"按钮
1. 在节点表格右上方，找到蓝色的 **"节点操作"** 按钮
2. 点击此按钮
3. 会弹出一个下拉菜单，显示可用的操作

---

### 步骤 6: 选择"恢复 (RESUME)"操作

下拉菜单中的选项说明：
- **恢复 (RESUME)** ← 选择此项
  - 功能：将 DOWN 状态的节点恢复为可用状态
  - 适用场景：节点硬件正常，但被标记为 down
  
- 排空 (DRAIN)
  - 功能：停止分配新作业，等待现有作业完成
  - 适用场景：计划维护节点
  
- 下线 (DOWN)
  - 功能：将节点标记为故障状态
  - 适用场景：节点硬件故障
  
- 空闲 (IDLE)
  - 功能：手动设置为空闲状态
  - 适用场景：强制设置节点为空闲

**选择"恢复 (RESUME)"**，点击该选项。

---

### 步骤 7: 确认操作
1. 系统会弹出一个确认对话框
2. 对话框内容类似：
   ```
   确认要对选中的节点执行 RESUME 操作吗？
   节点数量：X 个
   ```
3. **可选：** 在"原因"输入框中填写操作原因（如："恢复异常状态的节点"）
4. 点击 **"确定"** 或 **"确认"** 按钮

---

### 步骤 8: 等待操作完成
1. 系统会显示执行进度
2. 几秒钟后，会显示操作结果通知：
   - ✅ 成功：绿色通知"操作成功"
   - ❌ 失败：红色通知"操作失败"及错误信息

---

### 步骤 9: 刷新页面验证结果
1. 点击节点表格右上方的 **"刷新"** 按钮
2. 或按 **F5** 刷新整个页面
3. 检查节点状态列：
   - 成功：状态应从 `down*` 变为 `idle` 或 `allocated`
   - 失败：状态仍为 `down*`，需要检查日志

---

## 🔍 故障排查

### 问题 1: 看不到"节点操作"按钮
**原因：** 没有选中任何节点  
**解决：** 必须先勾选节点的复选框，按钮才会显示

### 问题 2: 操作后节点仍为 down 状态
**可能原因：**
1. 节点实际未启动或网络不通
2. SLURM 服务配置问题
3. SSH 连接失败

**解决方法：**
1. 检查节点是否真的在线：
   ```bash
   ssh admin@node01  # 测试能否连接
   ```

2. 查看后端日志：
   ```bash
   docker logs backend
   ```

3. 手动通过 SSH 执行恢复命令：
   ```bash
   ssh admin@slurm-server
   scontrol update NodeName=node01 State=RESUME Reason="manual recovery"
   ```

### 问题 3: 点击"节点操作"后没有反应
**解决：**
1. 打开浏览器开发者工具（F12）
2. 查看 Console 选项卡是否有错误
3. 查看 Network 选项卡，检查 API 请求是否成功
4. 如果返回 401 错误，说明 token 过期，需要重新登录

### 问题 4: 操作失败，显示"认证失败"
**解决：**
1. 退出登录
2. 重新登录系统
3. 再次尝试操作

---

## 📊 操作成功的标志

执行 RESUME 操作后，成功的标志包括：

1. **即时反馈：**
   - 显示绿色成功通知
   - 通知内容："节点操作成功"

2. **节点状态变化：**
   ```
   之前：node01  partition1  down*  8  32768  -  [操作]
   之后：node01  partition1  idle   8  32768  -  [操作]
   ```

3. **可以分配作业：**
   - 节点可以接收新的 SLURM 作业
   - 使用 `sinfo` 命令查看，节点显示为 idle 或 alloc 状态

---

## 🎯 快速操作流程（熟练后使用）

1. 访问 http://192.168.0.200:8080/slurm
2. 点击表头复选框（全选节点）
3. 点击"节点操作" → "恢复 (RESUME)"
4. 点击"确定"
5. 点击"刷新"验证结果

**总计时间：** 约 30 秒

---

## 📸 关键界面元素位置

```
┌─────────────────────────────────────────────────────────────────┐
│ AI-Infra-Matrix                                        [用户菜单] │
├─────────────────────────────────────────────────────────────────┤
│ [左侧菜单]  │ 📊 SLURM 集群管理                                │
│             │                                                    │
│  - 仪表板   │  ┌─────────────────────────────────────────────┐  │
│  - SLURM ◄─ │  │ 节点列表          [已选择 X 个节点] [节点操作▼] │  ← 选中节点后显示
│  - 用户管理 │  ├────┬──────┬──────┬──────┬───────┬─────┬───┤  │
│  - ...      │  │ ☑️  │节点名称│ 分区 │ 状态 │ CPU │内存 │..│  │
│             │  ├────┼──────┼──────┼──────┼───────┼─────┼───┤  │
│             │  │ □  │node01│part1 │down* │  8  │32768│..│  │
│             │  │ □  │node02│part1 │down* │  8  │32768│..│  │
│             │  │ □  │node03│part1 │down* │  8  │32768│..│  │
│             │  │ ...│      │      │      │     │     │  │  │
│             │  └─────────────────────────────────────────────┘  │
│             │                                                    │
└─────────────────────────────────────────────────────────────────┘

点击"节点操作"后：
                 ┌──────────────┐
                 │ 恢复 (RESUME)   │ ← 选择此项
                 ├──────────────┤
                 │ 排空 (DRAIN)    │
                 ├──────────────┤
                 │ 下线 (DOWN)     │
                 ├──────────────┤
                 │ 空闲 (IDLE)     │
                 └──────────────┘
```

---

## 💡 提示和建议

### 操作建议
1. **首次操作：** 建议先选择 1 个节点测试，成功后再批量操作
2. **批量操作：** 确认所有节点都是硬件正常的，再使用全选
3. **填写原因：** 养成填写操作原因的习惯，方便后续审计
4. **验证结果：** 每次操作后务必刷新页面验证结果

### 最佳实践
1. **定期检查：** 每天检查节点状态，及时发现异常
2. **日志记录：** 重要操作在备注中记录原因和时间
3. **测试环境：** 新操作先在测试节点上验证
4. **备份配置：** 操作前备份 SLURM 配置文件

---

## 📞 技术支持

如果遇到无法解决的问题，请提供以下信息：

1. **操作步骤：** 详细描述你的操作流程
2. **错误信息：** 浏览器控制台的错误信息（F12 → Console）
3. **API 响应：** 网络请求的响应内容（F12 → Network）
4. **后端日志：** `docker logs backend | tail -100`
5. **节点状态：** 执行 `sinfo -N -l` 的输出

---

## 📚 相关文档

- **Backend API 文档：** `src/backend/internal/controllers/slurm_controller.go`
- **Frontend 代码：** `src/frontend/src/pages/SlurmDashboard.js`
- **配置文件：** `dev-md.md` 记录 175
- **测试文件：** `test/e2e/specs/slurm-node-recovery-demo.spec.js`

---

## ✅ 操作检查清单

完成以下步骤后打勾：

- [ ] 1. 访问 SLURM 管理页面
- [ ] 2. 确认节点列表显示正常
- [ ] 3. 勾选需要恢复的节点
- [ ] 4. 看到"节点操作"按钮（重要！）
- [ ] 5. 点击"节点操作" → "恢复 (RESUME)"
- [ ] 6. 填写操作原因（可选）
- [ ] 7. 点击"确定"确认操作
- [ ] 8. 看到绿色成功通知
- [ ] 9. 刷新页面验证结果
- [ ] 10. 确认节点状态变为 idle 或 allocated

---

**最后更新：** 2024-12-XX  
**文档版本：** 1.0  
**状态：** ✅ 已验证
