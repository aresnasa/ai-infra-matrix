# æ„å»ºè¾“å‡ºå¢å¼º - æ˜¾ç¤ºå®Œæ•´æ„å»ºè¿‡ç¨‹

## é—®é¢˜æè¿°

åœ¨æ‰§è¡Œ `./build.sh build <service>` æ—¶ï¼Œæ„å»ºè¿‡ç¨‹æ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œç”¨æˆ·ä¸çŸ¥é“å½“å‰æ­£åœ¨æ‰§è¡Œä»€ä¹ˆæ“ä½œï¼š

```bash
[INFO]   â†’ æ­£åœ¨æ„å»ºé•œåƒ...
# è¿™é‡Œæ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œä¸çŸ¥é“æ„å»ºè¿›åº¦
```

**ç”¨æˆ·åé¦ˆ**ï¼š
> "éœ€è¦å¢åŠ ä¸€ä¸‹build.shçš„æ„å»ºè¿‡ç¨‹çš„æ‰“å°æ—¥å¿—ï¼Œå¦åˆ™ä¸çŸ¥é“åœ¨å¹²å•¥"

## é—®é¢˜åˆ†æ

### åŸå› 1ï¼šé‡å¤çš„æ—¥å¿—ä¿¡æ¯

åœ¨ `build_service` å‡½æ•°ä¸­ï¼Œå­˜åœ¨ä¸¤å¤„è¾“å‡º"æ­£åœ¨æ„å»ºé•œåƒ"çš„æ—¥å¿—ï¼š

```bash
# ç¬¬ä¸€å¤„ï¼ˆæ—§ä½ç½®ï¼‰- ç¬¬3652è¡Œ
print_info "  â†’ æ­£åœ¨æ„å»ºé•œåƒ..."

# ç¬¬äºŒå¤„ï¼ˆæ–°ä½ç½®ï¼‰- ç¬¬3733è¡Œ  
print_info "  ğŸ”¨ å¼€å§‹æ„å»ºé•œåƒ..."
```

ç¬¬ä¸€å¤„æ—¥å¿—è¾“å‡ºåï¼Œåç»­çš„è¯¦ç»†æ„å»ºé…ç½®ä¿¡æ¯è¢«è·³è¿‡ã€‚

### åŸå› 2ï¼šDocker build è¾“å‡ºè¢«æŠ‘åˆ¶

ä¹‹å‰çš„å®ç°å°è¯•è¿‡æ»¤ Docker è¾“å‡ºï¼Œä½†å› ä¸ºç®¡é“å¤„ç†å¯¼è‡´é€€å‡ºç ä¸¢å¤±ï¼Œæœ€ç»ˆç®€åŒ–ä¸ºç›´æ¥è°ƒç”¨ï¼Œä½†ç¼ºå°‘äº†è¿›åº¦æ˜¾ç¤ºã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. åˆ é™¤é‡å¤çš„æ—¥å¿—

åˆ é™¤æ—§çš„æ—¥å¿—è¾“å‡ºï¼Œåªä¿ç•™æ–°çš„è¯¦ç»†æ„å»ºä¿¡æ¯ï¼š

```bash
# åˆ é™¤è¿™ä¸€è¡Œï¼ˆç¬¬3652è¡Œï¼‰
print_info "  â†’ æ­£åœ¨æ„å»ºé•œåƒ..."
```

### 2. æ·»åŠ è¯¦ç»†çš„æ„å»ºé…ç½®ä¿¡æ¯æ¡†

åœ¨å®é™…æ‰§è¡Œ docker build ä¹‹å‰ï¼Œæ˜¾ç¤ºå®Œæ•´çš„é…ç½®ä¿¡æ¯ï¼š

```bash
print_info "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
print_info "  ğŸ“¦ Docker æ„å»ºé…ç½®:"
print_info "     Dockerfile: $dockerfile_path"
print_info "     æ„å»ºä¸Šä¸‹æ–‡: $build_context"
if [[ -n "$target_arg" ]]; then
    print_info "     æ„å»ºç›®æ ‡: ${target_arg#--target }"
fi
if [[ "$FORCE_REBUILD" == "true" ]]; then
    print_info "     ç¼“å­˜ç­–ç•¥: --no-cache (å¼ºåˆ¶é‡å»º)"
else
    print_info "     ç¼“å­˜ç­–ç•¥: ä½¿ç”¨ Docker å±‚ç¼“å­˜"
fi
print_info "     ç›®æ ‡é•œåƒ: $target_image"
print_info "  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo
print_info "  ğŸ”¨ å¼€å§‹æ„å»ºé•œåƒ..."
echo
```

### 3. ç›´æ¥æ˜¾ç¤º Docker build è¾“å‡º

ä¸å¯¹ Docker è¾“å‡ºåšä»»ä½•è¿‡æ»¤æˆ–å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºåŸç”Ÿè¾“å‡ºï¼š

```bash
# ç›´æ¥æ˜¾ç¤º docker build çš„å®Œæ•´è¾“å‡ºï¼Œä¸åšè¿‡æ»¤
if docker build -f "$dockerfile_path" $target_arg $cache_arg $label_args -t "$target_image" "$build_context"; then
    echo
    print_success "âœ“ æ„å»ºæˆåŠŸ: $target_image"
    # ... åç»­å¤„ç†
else
    print_error "âœ— æ„å»ºå¤±è´¥: $target_image"
    # ... é”™è¯¯å¤„ç†
    return 1
fi
```

## ä¿®æ”¹è¯¦æƒ…

### æ–‡ä»¶ä½ç½®
`build.sh` - `build_service()` å‡½æ•°

### ä¿®æ”¹1ï¼šåˆ é™¤æ—§æ—¥å¿—ï¼ˆç¬¬3645-3652è¡Œï¼‰

**ä¿®æ”¹å‰**ï¼š
```bash
print_info "  â†’ é¢„æ‹‰å– Dockerfile ä¾èµ–é•œåƒ..."
prefetch_base_images "$dockerfile_path" "$service"

# æ„å»ºé•œåƒ
print_info "  â†’ æ­£åœ¨æ„å»ºé•œåƒ..."

# ========================================
# SingleUser æ™ºèƒ½æ„å»ºå¤„ç†
```

**ä¿®æ”¹å**ï¼š
```bash
print_info "  â†’ é¢„æ‹‰å– Dockerfile ä¾èµ–é•œåƒ..."
prefetch_base_images "$dockerfile_path" "$service"

# ========================================
# SingleUser æ™ºèƒ½æ„å»ºå¤„ç†
```

### ä¿®æ”¹2ï¼šç®€åŒ– Docker build è°ƒç”¨ï¼ˆç¬¬3718-3740è¡Œï¼‰

**ä¿®æ”¹å‰ï¼ˆå¤æ‚çš„è¿‡æ»¤é€»è¾‘ï¼‰**ï¼š
```bash
docker build --progress=plain -f "$dockerfile_path" $target_arg $cache_arg $label_args -t "$target_image" "$build_context" 2>&1 | while IFS= read -r line; do
    # è¿‡æ»¤å¹¶æ ¼å¼åŒ–Dockeræ„å»ºè¾“å‡º
    if [[ "$line" =~ ^#[0-9]+ ]]; then
        echo "     $line"
    elif [[ "$line" =~ (CACHED|DONE|exporting|writing|naming) ]]; then
        echo "     âœ“ $line"
    # ... æ›´å¤šè¿‡æ»¤è§„åˆ™
    fi
done

# è·å–é€€å‡ºç ï¼ˆæœ‰é—®é¢˜ï¼‰
local build_exit_code=${PIPESTATUS[0]}
```

**ä¿®æ”¹åï¼ˆç›´æ¥æ˜¾ç¤ºï¼‰**ï¼š
```bash
# ç›´æ¥æ˜¾ç¤º docker build çš„å®Œæ•´è¾“å‡ºï¼Œä¸åšè¿‡æ»¤
if docker build -f "$dockerfile_path" $target_arg $cache_arg $label_args -t "$target_image" "$build_context"; then
    echo
    print_success "âœ“ æ„å»ºæˆåŠŸ: $target_image"
    # ... æˆåŠŸå¤„ç†
else
    print_error "âœ— æ„å»ºå¤±è´¥: $target_image"
    # ... å¤±è´¥å¤„ç†
    return 1
fi
```

## ä¿®æ”¹æ•ˆæœ

### ä¿®æ”¹å‰ï¼ˆæ— è¾“å‡ºï¼‰

```bash
$ ./build.sh build frontend --force

[INFO]   â†’ é¢„æ‹‰å– Dockerfile ä¾èµ–é•œåƒ...
[INFO]   â€¢ å·²å­˜åœ¨: 2
[INFO]   â†’ æ­£åœ¨æ„å»ºé•œåƒ...
# è¿™é‡Œä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œä¸çŸ¥é“åœ¨å¹²ä»€ä¹ˆ
# ç”¨æˆ·åªèƒ½ç­‰å¾…ï¼Œæ— æ³•åˆ¤æ–­æ˜¯å¦å¡ä½
```

### ä¿®æ”¹åï¼ˆå®Œæ•´è¾“å‡ºï¼‰

```bash
$ ./build.sh build nginx --force

[INFO]   â†’ é¢„æ‹‰å– Dockerfile ä¾èµ–é•œåƒ...
[INFO]   â€¢ å·²å­˜åœ¨: 1
[INFO]   â†’ nginxæ„å»ºå‰æ¸²æŸ“é…ç½®æ¨¡æ¿...
[SUCCESS] âœ“ Nginx æ¨¡æ¿æ¸²æŸ“å®Œæˆ

[INFO]   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO]   ğŸ“¦ Docker æ„å»ºé…ç½®:
[INFO]      Dockerfile: /path/to/src/nginx/Dockerfile
[INFO]      æ„å»ºä¸Šä¸‹æ–‡: /path/to/project
[INFO]      ç¼“å­˜ç­–ç•¥: --no-cache (å¼ºåˆ¶é‡å»º)
[INFO]      ç›®æ ‡é•œåƒ: ai-infra-nginx:v0.3.6-dev
[INFO]   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[INFO]   ğŸ”¨ å¼€å§‹æ„å»ºé•œåƒ...

#0 building with "desktop-linux" instance using docker driver

#1 [internal] load build definition from Dockerfile
#1 transferring dockerfile: 6.09kB done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/nginx:stable-alpine-perl
#2 DONE 5.6s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [ 1/20] FROM docker.io/library/nginx:stable-alpine-perl@sha256:...
#4 resolve docker.io/library/nginx:stable-alpine-perl@sha256:... done
#4 CACHED

#5 [internal] load build context
#5 transferring context: 245.45kB 0.1s done
#5 DONE 0.1s

#6 [ 2/20] RUN set -eux;     cp /etc/apk/repositories /etc/apk/repositories.bak;
#6 0.387 + cp /etc/apk/repositories /etc/apk/repositories.bak
#6 0.389 + cat /etc/alpine-release
#6 0.389 + cut -d. -f1,2
#6 0.390 + ALPINE_VERSION=3.21
... (å®Œæ•´çš„æ„å»ºæ­¥éª¤)

[SUCCESS] âœ“ æ„å»ºæˆåŠŸ: ai-infra-nginx:v0.3.6-dev
```

## ä¼˜åŠ¿

### 1. ç”¨æˆ·ä½“éªŒæå‡
- âœ… æ¸…æ™°å±•ç¤ºæ„å»ºé…ç½®ä¿¡æ¯
- âœ… å®æ—¶æ˜¾ç¤ºæ„å»ºè¿›åº¦
- âœ… å¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥çš„æ‰§è¡ŒçŠ¶æ€
- âœ… å‡ºé”™æ—¶èƒ½çœ‹åˆ°è¯¦ç»†é”™è¯¯ä¿¡æ¯

### 2. è°ƒè¯•å‹å¥½
- âœ… æ„å»ºå¡ä½æ—¶å¯ä»¥åˆ¤æ–­å¡åœ¨å“ªä¸€æ­¥
- âœ… ç½‘ç»œé—®é¢˜æ—¶å¯ä»¥çœ‹åˆ°ä¸‹è½½è¿›åº¦
- âœ… é”™è¯¯ä¿¡æ¯å®Œæ•´æ˜¾ç¤º

### 3. é€æ˜åº¦
- âœ… ç”¨æˆ·æ¸…æ¥šçŸ¥é“ Docker åœ¨åšä»€ä¹ˆ
- âœ… ç¼“å­˜å‘½ä¸­æƒ…å†µä¸€ç›®äº†ç„¶
- âœ… æ„å»ºæ—¶é—´å¯ä»¥ä¼°ç®—

## è¾“å‡ºä¿¡æ¯è¯´æ˜

### æ„å»ºé…ç½®æ¡†

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“¦ Docker æ„å»ºé…ç½®:
   Dockerfile: <Dockerfileè·¯å¾„>
   æ„å»ºä¸Šä¸‹æ–‡: <æ„å»ºä¸Šä¸‹æ–‡ç›®å½•>
   æ„å»ºç›®æ ‡: <targetåç§°>           # ä»…å¤šé˜¶æ®µæ„å»º
   ç¼“å­˜ç­–ç•¥: <--no-cache | ä½¿ç”¨ Docker å±‚ç¼“å­˜>
   ç›®æ ‡é•œåƒ: <é•œåƒå:æ ‡ç­¾>
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

### Docker æ„å»ºæ­¥éª¤

```
#<æ­¥éª¤å·> [<é˜¶æ®µ>] <æ“ä½œæè¿°>
#<æ­¥éª¤å·> <è¯¦ç»†è¾“å‡º>
#<æ­¥éª¤å·> DONE <è€—æ—¶>
```

**å¸¸è§çŠ¶æ€**ï¼š
- `CACHED` - ä½¿ç”¨ç¼“å­˜
- `DONE` - æ­¥éª¤å®Œæˆ
- `transferring` - ä¼ è¾“æ•°æ®
- `exporting` - å¯¼å‡ºé•œåƒ
- `writing` - å†™å…¥ç£ç›˜

### æ„å»ºç»“æœ

```
[SUCCESS] âœ“ æ„å»ºæˆåŠŸ: <é•œåƒå>
[ERROR] âœ— æ„å»ºå¤±è´¥: <é•œåƒå>
```

## å…¼å®¹æ€§

- âœ… macOS (Docker Desktop)
- âœ… Linux (Docker Engine)
- âœ… Docker 20.10+
- âœ… Docker 24.0+
- âœ… ä¸æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿå®Œå…¨å…¼å®¹

## ç›¸å…³é…ç½®

### Docker è¾“å‡ºæ¨¡å¼

é»˜è®¤ä½¿ç”¨ Docker çš„è‡ªåŠ¨æ¨¡å¼ï¼š
- TTYç¯å¢ƒï¼šå½©è‰²è¿›åº¦æ¡
- éTTYç¯å¢ƒï¼šçº¯æ–‡æœ¬è¾“å‡º

å¦‚éœ€å¼ºåˆ¶ä½¿ç”¨plainæ¨¡å¼ï¼Œå¯ä»¥ä¿®æ”¹ï¼š
```bash
docker build --progress=plain -f ...
```

## æµ‹è¯•å»ºè®®

### 1. æ­£å¸¸æ„å»ºæµ‹è¯•
```bash
./build.sh build nginx
# åº”è¯¥çœ‹åˆ°å®Œæ•´çš„æ„å»ºæ­¥éª¤
```

### 2. å¼ºåˆ¶é‡å»ºæµ‹è¯•
```bash
./build.sh build nginx --force
# åº”è¯¥çœ‹åˆ° "ç¼“å­˜ç­–ç•¥: --no-cache (å¼ºåˆ¶é‡å»º)"
# æ‰€æœ‰æ­¥éª¤éƒ½åº”è¯¥é‡æ–°æ‰§è¡Œ
```

### 3. ç¼“å­˜æ„å»ºæµ‹è¯•
```bash
./build.sh build nginx
# ç¬¬äºŒæ¬¡æ„å»º
./build.sh build nginx
# åº”è¯¥è·³è¿‡æ„å»ºï¼ˆæ™ºèƒ½ç¼“å­˜ï¼‰æˆ–çœ‹åˆ°å¤§é‡ CACHED
```

### 4. æ„å»ºå¤±è´¥æµ‹è¯•
```bash
# ä¸´æ—¶ç ´å Dockerfile
echo "INVALID COMMAND" >> src/nginx/Dockerfile
./build.sh build nginx
# åº”è¯¥çœ‹åˆ°é”™è¯¯ä¿¡æ¯å’Œ "[ERROR] âœ— æ„å»ºå¤±è´¥"
# æ¢å¤ Dockerfile
git checkout src/nginx/Dockerfile
```

## æ€§èƒ½å½±å“

- **è¾“å‡ºæ€§èƒ½**: æ— æ˜æ˜¾å½±å“ï¼ˆä¸å†è¿‡æ»¤ï¼Œç›´æ¥ä¼ é€’ï¼‰
- **æ„å»ºé€Ÿåº¦**: æ— å½±å“
- **æ—¥å¿—å¤§å°**: å®Œæ•´è¾“å‡ºå¯èƒ½å¢åŠ æ—¥å¿—å¤§å°ï¼Œå»ºè®®CI/CDç¯å¢ƒé…ç½®æ—¥å¿—è½®è½¬

## åç»­ä¼˜åŒ–

### å¯é€‰å¢å¼ºï¼ˆæœªå®æ–½ï¼‰

1. **å½©è‰²è¾“å‡º**
   ```bash
   # ä¸ºä¸åŒç±»å‹çš„æ¶ˆæ¯æ·»åŠ é¢œè‰²
   CACHED -> ç»¿è‰²
   DONE -> è“è‰²
   ERROR -> çº¢è‰²
   ```

2. **è¿›åº¦ç™¾åˆ†æ¯”**
   ```bash
   # è§£ææ­¥éª¤æ•°æ˜¾ç¤ºç™¾åˆ†æ¯”
   [15/20] 75% - RUN apk add ...
   ```

3. **æ„å»ºæ—¶é—´ç»Ÿè®¡**
   ```bash
   # è®°å½•æ¯ä¸ªé˜¶æ®µçš„è€—æ—¶
   âœ“ æ„å»ºæˆåŠŸ: ai-infra-nginx:v0.3.6-dev (è€—æ—¶: 2åˆ†30ç§’)
   ```

4. **æ—¥å¿—çº§åˆ«æ§åˆ¶**
   ```bash
   # æ·»åŠ  --quiet é€‰é¡¹åªæ˜¾ç¤ºå…³é”®ä¿¡æ¯
   ./build.sh build nginx --quiet
   ```

## ä¿®æ”¹æ—¶é—´

2025å¹´10æœˆ10æ—¥

## ç›¸å…³æ–‡æ¡£

- [æ™ºèƒ½æ„å»ºç¼“å­˜ç³»ç»Ÿ](./BUILD_SMART_CACHE_GUIDE.md)
- [æ„å»ºè„šæœ¬ä½¿ç”¨æŒ‡å—](./BUILD_USAGE_GUIDE.md)
- [è·¨å¹³å°å…¼å®¹æ€§](./CROSS_PLATFORM_COMPATIBILITY.md)

## æ€»ç»“

é€šè¿‡åˆ é™¤é‡å¤æ—¥å¿—å’Œç®€åŒ–è¾“å‡ºé€»è¾‘ï¼Œç°åœ¨æ„å»ºè¿‡ç¨‹å®Œå…¨é€æ˜ï¼Œç”¨æˆ·å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼š

1. âœ… æ„å»ºé…ç½®ä¿¡æ¯ï¼ˆDockerfileã€ä¸Šä¸‹æ–‡ã€ç¼“å­˜ç­–ç•¥ç­‰ï¼‰
2. âœ… å®Œæ•´çš„ Docker æ„å»ºæ­¥éª¤
3. âœ… æ¯ä¸€æ­¥çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆCACHEDã€DONEç­‰ï¼‰
4. âœ… æ„å»ºç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰

è¿™å¤§å¤§æå‡äº†ç”¨æˆ·ä½“éªŒå’Œè°ƒè¯•æ•ˆç‡ï¼
