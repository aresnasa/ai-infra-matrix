# 模板渲染多行替换修复报告

## 问题描述

在 JupyterHub 配置模板渲染过程中，遇到 `sed` 命令无法处理多行内容的错误：

```bash
sed: 1: "s/${AUTH_CONFIG}/# Back ...": unescaped newline inside substitute pattern
sed: 1: "s/{{AUTH_CONFIG}}/# Bac ...": unescaped newline inside substitute pattern
sed: 1: "s/${SPAWNER_CONFIG}/# D ...": unescaped newline inside substitute pattern
sed: 1: "s/{{SPAWNER_CONFIG}}/#  ...": unescaped newline inside substitute pattern
```

### 根本原因

1. **macOS BSD `sed` 限制**：
   - macOS 的 BSD 版本 `sed` 不支持在替换模式中使用 `\n` 表示换行符
   - 使用 `echo "$result" | sed` 处理多行文本时，`sed` 无法正确处理包含换行符的替换内容

2. **变量内容特殊性**：
   - `AUTH_CONFIG` 和 `SPAWNER_CONFIG` 包含完整的 Python 代码块（多行）
   - 原有的 `sed` 命令无法处理包含换行符的替换值

3. **可选变量处理**：
   - `ADDITIONAL_CONFIG` 等可选变量在为空时应该被替换为空字符串（移除占位符）
   - 原逻辑会跳过空变量，导致占位符保留在生成文件中

## 解决方案

### 1. 使用 Perl 替代 `sed`

Perl 的 `s///` 操作符可以正确处理包含换行符的多行替换：

```bash
# 使用 Perl 进行替换（支持多行内容）
if command -v perl >/dev/null 2>&1; then
    # 转义特殊字符用于 Perl 正则表达式
    local escaped_var_name
    escaped_var_name=$(printf '%s' "$var_name" | perl -pe 's/([\$\{\}\[\]\(\)\.\*\+\?\^\|\\])/\\$1/g')
    
    # -0777 让 Perl 读取整个文件为一个字符串（支持多行匹配）
    result=$(printf '%s' "$result" | perl -0777 -pe "
        my \$val = q($var_value);
        s/\\\$\{$escaped_var_name\}/\$val/g;
        s/\{\{$escaped_var_name\}\}/\$val/g;
    ")
fi
```

**关键参数**：
- `-0777`: 让 Perl 读取整个输入为单个字符串，而不是逐行处理
- `q(...)`: Perl 的引用操作符，避免转义问题
- 支持同时替换 `${VAR}` 和 `{{VAR}}` 两种格式

### 2. awk 降级方案

对于没有安装 Perl 的环境，使用 `awk` 作为降级方案：

```bash
# 降级到 awk（更通用，但速度较慢）
local tmp_val_file
tmp_val_file=$(mktemp)
printf '%s' "$var_value" > "$tmp_val_file"

result=$(awk -v var_name="$var_name" -v val_file="$tmp_val_file" '
    BEGIN {
        # 读取替换值
        while ((getline line < val_file) > 0) {
            if (val != "") val = val "\n"
            val = val line
        }
        close(val_file)
    }
    {
        # 替换 ${VAR} 格式
        gsub("\\$\\{" var_name "\\}", val)
        # 替换 {{VAR}} 格式
        gsub("\\{\\{" var_name "\\}\\}", val)
        print
    }
' <<< "$result")

rm -f "$tmp_val_file"
```

### 3. 可选变量处理

区分必需变量和可选变量，允许可选变量被替换为空字符串：

```bash
# 定义可选变量（允许为空，会被替换为空字符串）
local optional_vars=(
    "ADDITIONAL_CONFIG"
    "SHARED_STORAGE_CONFIG"
    "GENERATION_TIME"
)

# 检查是否为可选变量
local is_optional=false
for opt_var in "${optional_vars[@]}"; do
    if [[ "$var_name" == "$opt_var" ]]; then
        is_optional=true
        break
    fi
done

# 如果变量为空且不是可选变量，跳过替换（保留模板中的占位符）
if [[ -z "$var_value" ]] && [[ "$is_optional" == "false" ]]; then
    continue
fi
```

### 4. 添加 GENERATION_TIME 变量

在 `render_jupyterhub_templates` 函数中添加时间戳生成：

```bash
# 设置模板变量环境变量
export GENERATION_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
export AUTH_CONFIG="$auth_config"
export SPAWNER_CONFIG="$spawner_config"
export SHARED_STORAGE_CONFIG="$shared_storage_config"
export ADDITIONAL_CONFIG="$additional_config"
```

## 修复效果

### 修复前

```bash
sed: 1: "s/${AUTH_CONFIG}/# Back ...": unescaped newline inside substitute pattern
sed: 1: "s/{{AUTH_CONFIG}}/# Bac ...": unescaped newline inside substitute pattern
```

生成的配置文件：
```python
# Generated by build.sh at {{GENERATION_TIME}}  # ✗ 未替换
...
# Additional environment-specific configuration
{{ADDITIONAL_CONFIG}}  # ✗ 未替换
```

### 修复后

```bash
[SUCCESS] ✓ 模板渲染完成: jupyterhub_config_generated.py
[SUCCESS] ✓ 模板渲染完成: jupyterhub_config_development_generated.py
[SUCCESS] ✓ 模板渲染完成: jupyterhub_config_production_generated.py
[SUCCESS] ✓ JupyterHub 模板渲染完成
```

生成的配置文件：
```python
# Generated by build.sh at 2025-10-12 09:53:54 CST  # ✓ 正确替换
...
# Additional environment-specific configuration
# ✓ 空配置被正确移除
```

## 技术细节

### Perl 多行替换原理

1. **`-0777` 参数**：
   - 将输入记录分隔符设置为 `undef`
   - 导致 Perl 一次性读取整个输入，而不是逐行读取
   - 允许正则表达式跨越多行

2. **`q(...)` 引用操作符**：
   - 单引号引用，不进行变量插值
   - 避免特殊字符转义问题
   - 保留原始内容（包括换行符）

3. **全局替换 `/g`**：
   - 替换所有匹配项
   - 同时支持 `${VAR}` 和 `{{VAR}}` 两种格式

### awk 降级方案原理

1. **临时文件**：
   - 将替换值写入临时文件
   - 避免 shell 转义和引用问题
   - 支持包含任意字符的内容

2. **BEGIN 块**：
   - 在处理输入前执行
   - 一次性读取临时文件内容
   - 构建完整的替换值（包括换行符）

3. **gsub 函数**：
   - 全局替换函数
   - 支持正则表达式
   - 处理所有匹配项

## 兼容性

### 操作系统支持

| 操作系统 | Perl 方案 | awk 方案 | sed 方案 |
|---------|----------|---------|---------|
| macOS   | ✅ 支持  | ✅ 支持  | ❌ 不支持多行 |
| Linux   | ✅ 支持  | ✅ 支持  | ⚠️ 部分支持 |
| FreeBSD | ✅ 支持  | ✅ 支持  | ❌ 不支持多行 |

### 工具依赖

- **首选**: Perl（大多数 Unix 系统预装）
- **降级**: awk（POSIX 标准工具）
- **弃用**: sed（不支持多行替换）

## 测试验证

### 测试命令

```bash
# 测试 JupyterHub 模板渲染
./build.sh render-templates jupyterhub

# 检查生成的配置文件
head -5 src/jupyterhub/jupyterhub_config_generated.py
tail -5 src/jupyterhub/jupyterhub_config_generated.py

# 验证多行内容
grep -A 10 "class BackendAuth" src/jupyterhub/jupyterhub_config_generated.py
```

### 预期结果

1. ✅ 无 `sed` 错误消息
2. ✅ `GENERATION_TIME` 被替换为时间戳
3. ✅ `AUTH_CONFIG` 包含完整的 Python 代码
4. ✅ `SPAWNER_CONFIG` 包含完整的 Docker/K8s 配置
5. ✅ `ADDITIONAL_CONFIG` 占位符被移除

## 相关文件

- `build.sh`: 主构建脚本（`render_template` 函数）
- `src/jupyterhub/templates/*.tpl`: JupyterHub 配置模板
- `src/jupyterhub/*_generated.py`: 生成的配置文件

## 版本历史

### v1.1.0 (2025-10-12)
- ✅ 修复: 使用 Perl 替代 `sed` 处理多行替换
- ✅ 新增: awk 降级方案
- ✅ 新增: 可选变量处理逻辑
- ✅ 新增: `GENERATION_TIME` 变量支持

### v1.0.0 (2025-10-11)
- ❌ 问题: 使用 `sed` 处理多行替换失败
- ⚠️ 限制: 仅支持单行变量替换

## 相关文档

- [构建脚本使用指南](BUILD_USAGE_GUIDE.md)
- [Harbor 镜像 Tag 支持](IMAGE_TAG_HARBOR_SUPPORT.md)
- [构建系统优化总结](BUILD_OPTIMIZATION_SUMMARY.md)
