# 更新说明 - 2025年10月27日

## 修复内容

### 1. SLURM 集群扩容 - 支持逗号分隔主机名

**问题**: 用户输入逗号分隔的主机名（如 `test-ssh01,test-ssh02,test-ssh03`）时，系统无法正确解析。

**修复**:
- 修改 `src/frontend/src/pages/SlurmScalingPage.js`
- 使用正则表达式 `/[\n,]+/` 同时支持换行符和逗号分隔
- 更新用户界面提示说明支持逗号分隔

**支持的输入格式**:
```
# 换行分隔
test-ssh01
test-ssh02
test-ssh03

# 逗号分隔
test-ssh01,test-ssh02,test-ssh03

# 混合格式
test-ssh01,test-ssh02
test-ssh03
```

### 2. SaltStack 安装超时优化

**问题**: SaltStack Minion 部署时出现 `context deadline exceeded` 超时错误（10分钟）。

**修复**:
- 增加超时时间从 10 分钟到 20 分钟
- 优化安装脚本重试逻辑
- 添加连接超时和下载超时限制
- 简化安装步骤，减少不必要的重试

**文件**: `src/backend/internal/services/ssh_service.go`

**改进**:
- APT 安装逻辑优化
- YUM/DNF 安装逻辑优化
- 添加 `--connect-timeout 10 --max-time 60` 到 curl 命令
- 更清晰的错误处理和日志输出

### 3. AppHub 组件化构建系统

**已实现功能**:

`build.sh` 已经支持 AppHub 组件化构建，无需额外脚本。

**使用方法**:

```bash
# 只构建 SLURM
./build.sh build apphub --slurm-only

# 只构建 SaltStack
./build.sh build apphub --saltstack-only

# 只构建 Categraf
./build.sh build apphub --categraf-only

# 跳过某些组件
./build.sh build apphub --no-categraf
./build.sh build apphub --no-slurm

# 指定版本
./build.sh build apphub --slurm-version=25.05.5

# 组合使用
./build.sh build apphub --slurm-version=25.05.5 --no-categraf --force
```

**支持的参数**:
- `--slurm-only` - 只构建 SLURM
- `--saltstack-only` / `--salt-only` - 只构建 SaltStack
- `--categraf-only` - 只构建 Categraf
- `--no-slurm` - 跳过 SLURM
- `--no-saltstack` / `--no-salt` - 跳过 SaltStack
- `--no-categraf` - 跳过 Categraf
- `--slurm-version=<ver>` - 指定 SLURM 版本
- `--salt-version=<ver>` - 指定 SaltStack 版本
- `--categraf-version=<ver>` - 指定 Categraf 版本
- `--force` - 强制重建

**实现位置**:
- 参数解析: `build.sh` 第 11138-11181 行
- 构建应用: `build.sh` 第 5123-5135 行（build_service 函数）
- 帮助文档: `build.sh` 第 8904-8918 行

### 4. 新增文件

#### AppHub 构建配置
- `src/apphub/build-config.yaml` - 统一的组件构建配置
- `src/apphub/scripts/install-slurm.sh.tmpl` - SLURM 安装脚本模板
- `src/apphub/scripts/generate-install-script.sh` - 脚本生成器

#### Dockerfile 更新
- `src/apphub/Dockerfile` - 添加脚本生成步骤（第 647-656 行）

## 测试建议

### 1. 测试逗号分隔主机名

```bash
# 前端测试
1. 访问 SLURM 扩容页面
2. 输入: test-ssh01,test-ssh02,test-ssh03
3. 提交扩容任务
4. 验证创建了 3 个独立的节点任务
```

### 2. 测试 SaltStack 安装

```bash
# 检查 Backend 日志
docker logs ai-infra-backend -f

# 手动触发扩容
# 观察是否在 20 分钟内完成
```

### 3. 测试 AppHub 组件构建

```bash
# 只构建 SLURM
cd src/apphub
wget https://download.schedmd.com/slurm/slurm-25.05.4.tar.bz2
cd ../..
./build.sh build apphub --slurm-only

# 验证构建结果
docker run --rm ai-infra-apphub:latest sh -c "ls -lh /usr/share/nginx/html/pkgs/slurm-binaries/"
```

## 相关文档

- SLURM 逗号分隔支持: `docs/SLURM_SCALE_UP_COMMA_SUPPORT.md` (已撤销，功能已集成)
- AppHub 组件构建: 参考 `build.sh --help` 中的 "AppHub 组件化构建选项"

## 注意事项

1. **SLURM tarball**: 构建 AppHub 前需要先下载 SLURM 源码包到 `src/apphub/` 目录
2. **网络环境**: SaltStack 安装需要外网访问，内网环境建议提前准备离线包
3. **超时设置**: 如果网络特别慢，可能需要进一步调整超时时间

## 后续优化建议

1. 在 AppHub 中预置 SaltStack 离线安装包，避免从外网下载
2. 添加 SLURM 安装进度反馈，让用户知道安装状态
3. 考虑将 SaltStack 安装改为异步任务，避免阻塞其他操作
