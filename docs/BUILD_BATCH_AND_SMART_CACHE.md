# Build.sh æ‰¹é‡æ„å»ºä¸æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† `build.sh` çš„æ‰¹é‡æ„å»ºå’Œæ™ºèƒ½ç¼“å­˜ç³»ç»Ÿçš„å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- é€—å·åˆ†éš”çš„æœåŠ¡åˆ—è¡¨æ‰¹é‡æ„å»º
- æ™ºèƒ½æ„å»º ID ç®¡ç†
- åŸºäºæ–‡ä»¶å“ˆå¸Œçš„ç¼“å­˜åŒ¹é…
- æ„å»ºå†å²è®°å½•å’ŒæŸ¥è¯¢

## åŠŸèƒ½ç‰¹æ€§

### 1. é€—å·åˆ†éš”çš„æ‰¹é‡æ„å»º

**è¯­æ³•ï¼š**
```bash
./build.sh build <service1>,<service2>,<service3> [tag] [registry] [--force]
```

**ç¤ºä¾‹ï¼š**
```bash
# æ‰¹é‡æ„å»ºå¤šä¸ªæœåŠ¡
./build.sh build backend,backend-init,frontend

# å¸¦ç‰ˆæœ¬æ ‡ç­¾
./build.sh build backend,frontend,nginx v1.0.0

# å¼ºåˆ¶é‡å»ºæ¨¡å¼
./build.sh build backend,backend-init --force

# æ¨é€åˆ°ç§æœ‰ä»“åº“
./build.sh build backend,frontend v1.0.0 harbor.company.com/ai-infra
```

**ç‰¹æ€§ï¼š**
- âœ… è‡ªåŠ¨åˆ†å‰²é€—å·åˆ†éš”çš„æœåŠ¡å
- âœ… å»é™¤æœåŠ¡åå‰åç©ºæ ¼
- âœ… æ˜¾ç¤ºæ„å»ºè®¡åˆ’å’Œæ€»æ•°
- âœ… å®æ—¶æ˜¾ç¤ºè¿›åº¦ `[1/3]`, `[2/3]`, `[3/3]`
- âœ… é”™è¯¯å¤„ç†ï¼šè®°å½•å¤±è´¥çš„æœåŠ¡
- âœ… æœ€ç»ˆæ±‡æ€»ï¼šæˆåŠŸ/å¤±è´¥ç»Ÿè®¡
- âœ… æ”¯æŒ `--force` æ ‡å¿—ï¼ˆå¯æ”¾åœ¨ä»»æ„å‚æ•°ä½ç½®ï¼‰

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
[INFO] ğŸ“¦ æ‰¹é‡æ„å»ºæ¨¡å¼ï¼šæ£€æµ‹åˆ°å¤šä¸ªæœåŠ¡
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] æ„å»ºè®¡åˆ’ï¼š
  â€¢ backend
  â€¢ backend-init
  â€¢ frontend
[INFO] æ€»è®¡: 3 ä¸ªæœåŠ¡
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] [1/3] æ„å»ºæœåŠ¡: backend
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
...
[SUCCESS] âœ“ [1/3] backend æ„å»ºæˆåŠŸ

[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] ğŸ“Š æ‰¹é‡æ„å»ºç»“æœæ±‡æ€»
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] æ€»æœåŠ¡æ•°: 3
[INFO] æˆåŠŸ: 3
[INFO] å¤±è´¥: 0
[SUCCESS] ğŸ‰ æ‰€æœ‰æœåŠ¡æ„å»ºæˆåŠŸï¼
```

### 2. æ™ºèƒ½æ„å»º ID ç³»ç»Ÿ

**BUILD_ID æ ¼å¼ï¼š**
```
<é€’å¢æ•°å­—>_<æ—¶é—´æˆ³>
```

**ç¤ºä¾‹ï¼š**
```
514_20251020_172306
â”œâ”€â”€ 514: é€’å¢çš„æ„å»ºåºå·
â””â”€â”€ 20251020_172306: æ—¶é—´æˆ³ (YYYYMMDD_HHMMSS)
```

**å­˜å‚¨ä½ç½®ï¼š**
```
.build-cache/
â”œâ”€â”€ build-id.txt              # å½“å‰ BUILD_ID åºå·
â”œâ”€â”€ build-history.log         # æ„å»ºå†å²è®°å½•
â””â”€â”€ <service>/
    â””â”€â”€ last-build.json       # æœåŠ¡çš„æœ€åæ„å»ºä¿¡æ¯
```

**BUILD_ID ç”Ÿæˆé€»è¾‘ï¼š**
```bash
generate_build_id() {
    local last_id=$(cat "$BUILD_ID_FILE" 2>/dev/null || echo "0")
    local new_id=$((last_id + 1))
    local timestamp=$(date +%Y%m%d_%H%M%S)
    echo "${new_id}_${timestamp}"
}
```

### 3. æ™ºèƒ½ç¼“å­˜åŒ¹é…ç³»ç»Ÿ

**å·¥ä½œåŸç†ï¼š**

1. **è®¡ç®—æ–‡ä»¶å“ˆå¸Œ**
   ```bash
   calculate_service_hash() {
       # è®¡ç®—ä»¥ä¸‹æ–‡ä»¶çš„ç»¼åˆå“ˆå¸Œï¼š
       # - Dockerfile
       # - æºä»£ç ç›®å½•ï¼ˆæ’é™¤ node_modulesã€buildã€dist ç­‰ï¼‰
       # - é…ç½®æ–‡ä»¶ï¼ˆnginxã€jupyterhubã€backend ç­‰ï¼‰
   }
   ```

2. **åµŒå…¥é•œåƒæ ‡ç­¾**
   ```bash
   # æ„å»ºæ—¶æ·»åŠ çš„ Docker æ ‡ç­¾
   --label build.id=<BUILD_ID>
   --label build.service=<SERVICE>
   --label build.tag=<TAG>
   --label build.hash=<FILE_HASH>
   --label build.timestamp=<TIMESTAMP>
   --label build.reason=<REBUILD_REASON>
   ```

3. **æ„å»ºå†³ç­–æµç¨‹**
   ```bash
   need_rebuild() {
       # 1. å¼ºåˆ¶é‡å»ºæ¨¡å¼ï¼Ÿ
       if [[ "$FORCE_REBUILD" == "true" ]]; then
           return 0  # éœ€è¦é‡å»º
       fi
       
       # 2. é•œåƒæ˜¯å¦å­˜åœ¨ï¼Ÿ
       if ! docker image inspect "$image" >/dev/null 2>&1; then
           return 0  # éœ€è¦æ„å»º
       fi
       
       # 3. é•œåƒæ˜¯å¦æœ‰å“ˆå¸Œæ ‡ç­¾ï¼Ÿ
       local image_hash=$(docker image inspect "$image" --format '{{index .Config.Labels "build.hash"}}')
       if [[ -z "$image_hash" ]]; then
           return 0  # æ—§ç‰ˆæœ¬é•œåƒï¼Œéœ€è¦é‡å»º
       fi
       
       # 4. å¯¹æ¯”æ–‡ä»¶å“ˆå¸Œ
       local current_hash=$(calculate_service_hash "$service")
       if [[ "$current_hash" != "$image_hash" ]]; then
           return 0  # æ–‡ä»¶å·²å˜åŒ–ï¼Œéœ€è¦é‡å»º
       fi
       
       return 1  # æ— éœ€é‡å»ºï¼Œå¤ç”¨ç¼“å­˜
   }
   ```

**é‡å»ºåŸå› ï¼ˆREBUILD_REASONï¼‰ï¼š**
- `FORCE_REBUILD`: å¼ºåˆ¶é‡å»ºæ¨¡å¼ï¼ˆ`--force` æ ‡å¿—ï¼‰
- `SKIP_CACHE_CHECK`: è·³è¿‡ç¼“å­˜æ£€æŸ¥
- `IMAGE_NOT_EXIST`: é•œåƒä¸å­˜åœ¨
- `NO_HASH_LABEL`: é•œåƒç¼ºå°‘å“ˆå¸Œæ ‡ç­¾ï¼ˆæ—§ç‰ˆæœ¬ï¼‰
- `HASH_CHANGED|old:xxx|new:yyy`: æ–‡ä»¶å“ˆå¸Œå·²å˜åŒ–

**æ„å»ºè¾“å‡ºç¤ºä¾‹ï¼š**

**æ— éœ€é‡å»ºï¼ˆè·³è¿‡ï¼‰ï¼š**
```
[INFO] æ„å»ºæœåŠ¡: backend
[SUCCESS]   âœ“ é•œåƒæ— å˜åŒ–ï¼Œå¤ç”¨ç¼“å­˜: ai-infra-backend:v0.3.6-dev
[INFO]   ğŸ“‹ BUILD_ID: 515_20251020_180000 (SKIPPED)
```

**éœ€è¦é‡å»ºï¼š**
```
[INFO] æ„å»ºæœåŠ¡: backend
[INFO]   ğŸ”„ æ–‡ä»¶å·²å˜åŒ–ï¼Œéœ€è¦é‡å»º
[INFO]      æ—§å“ˆå¸Œ: 3a5f8b2c
[INFO]      æ–°å“ˆå¸Œ: 7e9d1a4f
[INFO]   ğŸ“‹ BUILD_ID: 516_20251020_180030
[INFO]   ğŸ”¨ å¼€å§‹æ„å»ºé•œåƒ...
```

### 4. æ„å»ºå†å²è®°å½•ç³»ç»Ÿ

**å†å²è®°å½•æ ¼å¼ï¼š**
```
[<æ—¶é—´æˆ³>] BUILD_ID=<ID> SERVICE=<æœåŠ¡> TAG=<æ ‡ç­¾> STATUS=<çŠ¶æ€> REASON=<åŸå› >
```

**ç¤ºä¾‹ï¼š**
```
[2025-10-20 17:25:31] BUILD_ID=514_20251020_172306 SERVICE=backend TAG=v0.3.6-dev STATUS=SUCCESS REASON=FORCE_REBUILD
[2025-10-20 17:26:15] BUILD_ID=515_20251020_172608 SERVICE=frontend TAG=v0.3.6-dev STATUS=SUCCESS REASON=IMAGE_NOT_EXIST
[2025-10-20 17:27:42] BUILD_ID=516_20251020_172740 SERVICE=backend TAG=v0.3.6-dev STATUS=SKIPPED REASON=NO_CHANGE
```

**çŠ¶æ€å€¼ï¼š**
- `SUCCESS`: æ„å»ºæˆåŠŸ âœ“ï¼ˆç»¿è‰²ï¼‰
- `FAILED`: æ„å»ºå¤±è´¥ âœ—ï¼ˆçº¢è‰²ï¼‰
- `SKIPPED`: è·³è¿‡æ„å»º âŠ˜ï¼ˆé»„è‰²ï¼‰

### 5. æ„å»ºå†å²æŸ¥è¯¢å‘½ä»¤

**è¯­æ³•ï¼š**
```bash
./build.sh build-history [service] [count]
```

**ç¤ºä¾‹ï¼š**
```bash
# æ˜¾ç¤ºæœ€è¿‘ 20 æ¡è®°å½•ï¼ˆé»˜è®¤ï¼‰
./build.sh build-history

# æ˜¾ç¤º backend çš„æ„å»ºå†å²
./build.sh build-history backend

# æ˜¾ç¤º backend æœ€è¿‘ 50 æ¡è®°å½•
./build.sh build-history backend 50

# æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡æœ€è¿‘ 100 æ¡è®°å½•
./build.sh build-history "" 100
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] ğŸ“‹ æ„å»ºå†å²è®°å½•
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] ğŸ” è¿‡æ»¤æœåŠ¡: backend
[INFO] ğŸ“Š æ˜¾ç¤ºè®°å½•æ•°: 20

æ—¶é—´               BUILD_ID        æœåŠ¡               æ ‡ç­¾     çŠ¶æ€     åŸå›               
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
2025-10-20 12:00:40  502_20251020_115807 backend              v0.3.6-dev âœ“ SUCCESS  FORCE_REBUILD       
2025-10-20 17:25:31  514_20251020_172306 backend              v0.3.6-dev âœ“ SUCCESS  FORCE_REBUILD       

[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] ğŸ“Š ç»Ÿè®¡: æ€»è®¡=2 | æˆåŠŸ=2 | å¤±è´¥=0 | è·³è¿‡=0
```

### 6. é•œåƒæ„å»ºä¿¡æ¯æŸ¥è¯¢

**è¯­æ³•ï¼š**
```bash
./build.sh build-info <service> [tag]
```

**ç¤ºä¾‹ï¼š**
```bash
# æŸ¥çœ‹ backend é•œåƒçš„æ„å»ºä¿¡æ¯
./build.sh build-info backend

# æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬çš„æ„å»ºä¿¡æ¯
./build.sh build-info frontend v1.0.0
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] ğŸ” é•œåƒæ„å»ºä¿¡æ¯
[INFO] â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[INFO] æœåŠ¡: backend
[INFO] é•œåƒ: ai-infra-backend:v0.3.6-dev

[SUCCESS] âœ“ é•œåƒå­˜åœ¨

[INFO] ğŸ·ï¸  æ„å»ºæ ‡ç­¾:
  ğŸ“‹ BUILD_ID: 514_20251020_172306
  ğŸ”§ æœåŠ¡: backend
  ğŸ·ï¸  æ ‡ç­¾: v0.3.6-dev
  #ï¸âƒ£  å“ˆå¸Œ: 3a5f8b2c9d1e4f7a...
  ğŸ• æ—¶é—´: 2025-10-20T09:23:06Z
  ğŸ“ åŸå› : FORCE_REBUILD

[INFO] ğŸ“¦ é•œåƒè¯¦æƒ…:
  åˆ›å»ºæ—¶é—´: 2025-10-20T09:23:15.123456789Z
  å¤§å°: 1234567890 bytes
  æ¶æ„: arm64
  OS: linux

[INFO] ğŸ’¾ ç¼“å­˜ä¿¡æ¯:
  BUILD_ID: 514_20251020_172306
  å“ˆå¸Œ: 3a5f8b2c9d1e4f7a...
  æ—¶é—´æˆ³: 2025-10-20T09:23:06Z
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æ–‡ä»¶å“ˆå¸Œè®¡ç®—

**ç›®å½•å“ˆå¸Œï¼š**
```bash
find "$path" -type f \
    \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.tsx" \
       -o -name "*.go" -o -name "*.conf" -o -name "*.yaml" \
       -o -name "*.yml" -o -name "*.json" -o -name "Dockerfile" \) \
    ! -path "*/node_modules/*" \
    ! -path "*/build/*" \
    ! -path "*/dist/*" \
    ! -path "*/.next/*" \
    ! -path "*/vendor/*" \
    ! -path "*/__pycache__/*" \
    ! -path "*/.git/*" \
    -exec shasum -a 256 {} \; 2>/dev/null | sort | shasum -a 256
```

**æœåŠ¡ç»¼åˆå“ˆå¸Œï¼š**
```bash
calculate_service_hash() {
    local hash_data=""
    
    # 1. Dockerfile å“ˆå¸Œ
    hash_data+="$(calculate_hash "$dockerfile")\n"
    
    # 2. æºä»£ç ç›®å½•å“ˆå¸Œ
    hash_data+="$(calculate_hash "$src_dir")\n"
    
    # 3. é…ç½®æ–‡ä»¶å“ˆå¸Œï¼ˆç‰¹å®šæœåŠ¡ï¼‰
    case "$service" in
        "nginx")
            hash_data+="$(calculate_hash "$SCRIPT_DIR/config/nginx")\n"
            ;;
        "backend"|"backend-init")
            hash_data+="$(calculate_hash "$SCRIPT_DIR/src/backend")\n"
            ;;
    esac
    
    # è®¡ç®—ç»¼åˆå“ˆå¸Œ
    echo -e "$hash_data" | shasum -a 256 | awk '{print $1}'
}
```

### æ„å»ºæµç¨‹å¢å¼º

**æ„å»ºå‰ï¼š**
1. ç”Ÿæˆ BUILD_ID
2. è®¡ç®—å½“å‰æ–‡ä»¶å“ˆå¸Œ
3. è·å–é•œåƒä¸­çš„å“ˆå¸Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
4. å¯¹æ¯”å“ˆå¸Œï¼Œå†³å®šæ˜¯å¦é‡å»º
5. æ˜¾ç¤ºæ„å»ºåŸå› 

**æ„å»ºä¸­ï¼š**
1. é¢„æ‹‰å–ä¾èµ–é•œåƒ
2. æ·»åŠ æ„å»ºæ ‡ç­¾ï¼ˆ`--label`ï¼‰
3. æ‰§è¡Œ Docker æ„å»º

**æ„å»ºåï¼š**
1. è®°å½•æ„å»ºå†å²ï¼ˆSUCCESS/FAILEDï¼‰
2. ä¿å­˜ BUILD_ID
3. ä¿å­˜æœåŠ¡æ„å»ºä¿¡æ¯åˆ°ç¼“å­˜

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šæ—¥å¸¸å¼€å‘ - å¢é‡æ„å»º

```bash
# ç¬¬ä¸€æ¬¡æ„å»ºï¼ˆå®Œæ•´æ„å»ºï¼‰
./build.sh build backend
# [INFO] ğŸ†• é•œåƒä¸å­˜åœ¨ï¼Œéœ€è¦æ„å»º
# [INFO] ğŸ“‹ BUILD_ID: 1_20251020_100000
# ... æ„å»ºè¿‡ç¨‹ ...
# [SUCCESS] âœ“ æ„å»ºæˆåŠŸ

# æ— ä»£ç å˜æ›´ï¼Œå†æ¬¡æ„å»ºï¼ˆè‡ªåŠ¨è·³è¿‡ï¼‰
./build.sh build backend
# [SUCCESS] âœ“ é•œåƒæ— å˜åŒ–ï¼Œå¤ç”¨ç¼“å­˜
# [INFO] ğŸ“‹ BUILD_ID: 2_20251020_100030 (SKIPPED)

# ä¿®æ”¹ä»£ç åæ„å»ºï¼ˆè‡ªåŠ¨é‡å»ºï¼‰
# ... ç¼–è¾‘ src/backend/main.go ...
./build.sh build backend
# [INFO] ğŸ”„ æ–‡ä»¶å·²å˜åŒ–ï¼Œéœ€è¦é‡å»º
# [INFO]    æ—§å“ˆå¸Œ: 3a5f8b2c
# [INFO]    æ–°å“ˆå¸Œ: 7e9d1a4f
# ... æ„å»ºè¿‡ç¨‹ ...
```

### åœºæ™¯ 2ï¼šæ‰¹é‡æ„å»ºå¤šä¸ªæœåŠ¡

```bash
# æ„å»ºå‰åç«¯æœåŠ¡
./build.sh build backend,frontend,nginx

# å¼ºåˆ¶é‡å»ºæ‰€æœ‰æœåŠ¡
./build.sh build backend,backend-init,frontend,nginx --force
```

### åœºæ™¯ 3ï¼šCI/CD æµæ°´çº¿

```bash
# å¼ºåˆ¶æ„å»ºå¹¶æ¨é€åˆ°ä»“åº“
./build.sh build backend,frontend v1.0.0 harbor.company.com/ai-infra --force

# æŸ¥çœ‹æ„å»ºå†å²ï¼Œç¡®è®¤æ„å»ºæˆåŠŸ
./build.sh build-history "" 10

# éªŒè¯é•œåƒæ„å»ºä¿¡æ¯
./build.sh build-info backend v1.0.0
```

### åœºæ™¯ 4ï¼šæ•…éšœæ’æŸ¥

```bash
# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„æ„å»ºå†å²
./build.sh build-history backend 50

# æŸ¥çœ‹é•œåƒè¯¦ç»†ä¿¡æ¯
./build.sh build-info backend

# æ£€æŸ¥æœ€è¿‘çš„æ„å»ºæ˜¯å¦æœ‰å¤±è´¥
./build.sh build-history | grep FAILED
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å“ˆå¸Œè®¡ç®—ä¼˜åŒ–

- âœ… åªè®¡ç®—ç›¸å…³æ–‡ä»¶ç±»å‹ï¼ˆ`.py`, `.js`, `.go` ç­‰ï¼‰
- âœ… æ’é™¤ä¾èµ–ç›®å½•ï¼ˆ`node_modules`, `vendor` ç­‰ï¼‰
- âœ… æ’é™¤æ„å»ºäº§ç‰©ï¼ˆ`build`, `dist`, `.next` ç­‰ï¼‰

### 2. æ„å»ºè·³è¿‡ä¼˜åŒ–

- âœ… æ™ºèƒ½ç¼“å­˜æ£€æŸ¥ï¼šæ— å˜åŒ–æ—¶è‡ªåŠ¨è·³è¿‡
- âœ… æ‰¹é‡æ„å»ºï¼šå¤±è´¥ä¸å½±å“å…¶ä»–æœåŠ¡
- âœ… æ„å»ºæ ‡ç­¾ï¼šé¿å…é‡å¤è®¡ç®—å“ˆå¸Œ

### 3. æ—¥å¿—ç®¡ç†

- âœ… å¢é‡æ—¥å¿—ï¼šè¿½åŠ è€Œéè¦†ç›–
- âœ… ç»“æ„åŒ–è¾“å‡ºï¼šä¾¿äºè§£æå’Œè¿‡æ»¤
- âœ… å½©è‰²è¾“å‡ºï¼šæå‡å¯è¯»æ€§

## æœ€ä½³å®è·µ

### 1. æ—¥å¸¸å¼€å‘

```bash
# æ¨èï¼šä½¿ç”¨æ™ºèƒ½æ„å»ºï¼ˆè‡ªåŠ¨è·³è¿‡æ— å˜åŒ–çš„æœåŠ¡ï¼‰
./build.sh build backend

# é¿å…ï¼šæ¯æ¬¡éƒ½å¼ºåˆ¶é‡å»ºï¼ˆæµªè´¹æ—¶é—´ï¼‰
./build.sh build backend --force  # âŒ
```

### 2. æ‰¹é‡æ„å»º

```bash
# æ¨èï¼šæŒ‰ä¾èµ–é¡ºåºæ„å»º
./build.sh build backend,backend-init,frontend,nginx

# æ¨èï¼šä½¿ç”¨é€—å·åˆ†éš”ï¼Œæ— ç©ºæ ¼
./build.sh build backend,frontend,nginx

# é¿å…ï¼šæ¯ä¸ªæœåŠ¡å•ç‹¬æ„å»ºï¼ˆæ•ˆç‡ä½ï¼‰
./build.sh build backend
./build.sh build frontend
./build.sh build nginx
```

### 3. ç‰ˆæœ¬å‘å¸ƒ

```bash
# æ¨èï¼šæŒ‡å®šç‰ˆæœ¬æ ‡ç­¾ + å¼ºåˆ¶é‡å»º
./build.sh build backend,frontend v1.0.0 --force

# æ¨èï¼šéªŒè¯æ„å»ºä¿¡æ¯
./build.sh build-info backend v1.0.0
./build.sh build-history backend 10
```

### 4. æ•…éšœæ’æŸ¥

```bash
# æŸ¥çœ‹æœ€è¿‘çš„å¤±è´¥æ„å»º
./build.sh build-history | grep FAILED

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡çš„è¯¦ç»†å†å²
./build.sh build-history backend 100

# æ£€æŸ¥é•œåƒæ„å»ºä¿¡æ¯
./build.sh build-info backend
```

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ¸…ç†æ„å»ºç¼“å­˜ï¼Ÿ

```bash
# åˆ é™¤ç¼“å­˜ç›®å½•
rm -rf .build-cache/

# ä¸‹æ¬¡æ„å»ºä¼šè‡ªåŠ¨é‡æ–°åˆå§‹åŒ–
./build.sh build backend
```

### Q2: å¦‚ä½•æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çš„æ„å»ºå†å²ï¼Ÿ

```bash
# æ˜¾ç¤ºæ‰€æœ‰æœåŠ¡æœ€è¿‘ 100 æ¡è®°å½•
./build.sh build-history "" 100
```

### Q3: å¦‚ä½•å¼ºåˆ¶é‡å»ºç‰¹å®šæœåŠ¡ï¼Ÿ

```bash
# å•ä¸ªæœåŠ¡
./build.sh build backend --force

# å¤šä¸ªæœåŠ¡
./build.sh build backend,frontend,nginx --force
```

### Q4: é•œåƒæ— å˜åŒ–ä½†æƒ³é‡æ–°æ„å»ºæ€ä¹ˆåŠï¼Ÿ

```bash
# ä½¿ç”¨ --force æ ‡å¿—
./build.sh build backend --force
```

### Q5: å¦‚ä½•æŸ¥çœ‹é•œåƒæ˜¯å¦æœ‰æ„å»ºæ ‡ç­¾ï¼Ÿ

```bash
# æŸ¥çœ‹é•œåƒæ„å»ºä¿¡æ¯
./build.sh build-info backend

# æ‰‹åŠ¨æ£€æŸ¥ Docker æ ‡ç­¾
docker image inspect ai-infra-backend:v0.3.6-dev \
    --format '{{range $k, $v := .Config.Labels}}{{if eq (slice $k 0 6) "build."}}{{$k}}={{$v}}{{"\n"}}{{end}}{{end}}'
```

## æ€»ç»“

æ™ºèƒ½æ„å»ºç³»ç»Ÿæä¾›äº†ä»¥ä¸‹æ ¸å¿ƒä»·å€¼ï¼š

1. **æå‡æ•ˆç‡**ï¼šæ— å˜åŒ–æ—¶è‡ªåŠ¨è·³è¿‡æ„å»ºï¼ŒèŠ‚çœæ—¶é—´
2. **å¯è¿½æº¯æ€§**ï¼šå®Œæ•´çš„æ„å»ºå†å²å’Œå…ƒæ•°æ®è®°å½•
3. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒé€—å·åˆ†éš”çš„æœåŠ¡åˆ—è¡¨ï¼Œä¸€æ¬¡æ„å»ºå¤šä¸ªæœåŠ¡
4. **æ™ºèƒ½å†³ç­–**ï¼šåŸºäºæ–‡ä»¶å“ˆå¸Œçš„ç²¾ç¡®å˜æ›´æ£€æµ‹
5. **æ˜“äºç»´æŠ¤**ï¼šæ¸…æ™°çš„æ„å»ºä¿¡æ¯æŸ¥è¯¢å’Œå†å²è®°å½•

## ç›¸å…³æ–‡æ¡£

- [BUILD_AND_TEST_GUIDE.md](./BUILD_AND_TEST_GUIDE.md) - å®Œæ•´çš„æ„å»ºå’Œæµ‹è¯•æŒ‡å—
- [BUILD_USAGE_GUIDE.md](./BUILD_USAGE_GUIDE.md) - æ„å»ºè„šæœ¬ä½¿ç”¨æŒ‡å—
- [BUILD_SMART_CACHE_GUIDE.md](./BUILD_SMART_CACHE_GUIDE.md) - æ™ºèƒ½ç¼“å­˜è¯¦ç»†è¯´æ˜
