# æ™ºèƒ½æ„å»ºç¼“å­˜ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

AI Infrastructure Matrix ç°å·²é›†æˆ**æ™ºèƒ½æ„å»ºç¼“å­˜ç³»ç»Ÿ**ï¼Œé€šè¿‡é€’å¢æ„å»ºIDã€æ–‡ä»¶å“ˆå¸Œæ£€æµ‹å’Œé•œåƒæ ‡ç­¾è¿½è¸ªï¼Œè‡ªåŠ¨è¯†åˆ«æ–‡ä»¶å˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤æ„å»ºï¼ŒèŠ‚çœå¤§é‡æ—¶é—´ã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. é€’å¢æ„å»ºID
æ¯æ¬¡æ„å»ºè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„æ„å»ºIDï¼š
```
BUILD_ID æ ¼å¼: <åºå·>_<æ—¶é—´æˆ³>
ç¤ºä¾‹: 1_20251010_173852
```

### 2. æ–‡ä»¶å˜åŒ–æ£€æµ‹
- ä½¿ç”¨ **SHA256** å“ˆå¸Œè¿½è¸ªæºç å’Œé…ç½®æ–‡ä»¶
- è‡ªåŠ¨å¯¹æ¯”å½“å‰æ–‡ä»¶ä¸ä¸Šæ¬¡æ„å»ºçš„å“ˆå¸Œå€¼
- æ”¯æŒç›®å½•çº§åˆ«çš„ç»¼åˆå“ˆå¸Œè®¡ç®—

### 3. æ™ºèƒ½ç¼“å­˜å†³ç­–
```
æ— å˜åŒ– â†’ å¤ç”¨é•œåƒ (è·³è¿‡æ„å»º)
æœ‰å˜åŒ– â†’ é‡æ–°æ„å»º
å¼ºåˆ¶æ¨¡å¼ â†’ æ€»æ˜¯æ„å»º (--force)
```

### 4. é•œåƒæ„å»ºæ ‡ç­¾
æ„å»ºæ—¶è‡ªåŠ¨åœ¨é•œåƒä¸­åµŒå…¥ä»¥ä¸‹æ ‡ç­¾ï¼š
- `build.id` - æ„å»ºID
- `build.service` - æœåŠ¡åç§°
- `build.tag` - é•œåƒæ ‡ç­¾
- `build.hash` - æ–‡ä»¶å“ˆå¸Œå€¼
- `build.timestamp` - æ„å»ºæ—¶é—´æˆ³
- `build.reason` - æ„å»ºåŸå› 

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬æ„å»ºå‘½ä»¤

#### 1. æ„å»ºå•ä¸ªæœåŠ¡
```bash
# è‡ªåŠ¨æ£€æµ‹å˜åŒ–ï¼Œæ— å˜åŒ–åˆ™è·³è¿‡
./build.sh build backend v0.3.7-dev

# å¼ºåˆ¶é‡å»ºï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
./build.sh build backend v0.3.7-dev --force

# è·³è¿‡ç¼“å­˜æ£€æŸ¥ï¼ˆæ€»æ˜¯æ„å»ºä½†ä¿ç•™å…¶ä»–ä¼˜åŒ–ï¼‰
./build.sh build backend v0.3.7-dev --skip-cache-check
```

#### 2. æ„å»ºæ‰€æœ‰æœåŠ¡
```bash
# æ™ºèƒ½æ„å»ºæ‰€æœ‰æœåŠ¡
./build.sh build-all v0.3.7-dev

# å¼ºåˆ¶é‡å»ºæ‰€æœ‰æœåŠ¡
./build.sh build-all v0.3.7-dev --force
```

### ç¼“å­˜ç®¡ç†å‘½ä»¤

#### 1. æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
```bash
./build.sh cache-stats
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
==========================================
æ„å»ºç¼“å­˜ç»Ÿè®¡
==========================================
æ€»æ„å»ºæ¬¡æ•°: 15

æœ€è¿‘10æ¬¡æ„å»º:
[2025-10-10 17:38:52] BUILD_ID=2_20251010_173852 SERVICE=backend TAG=v0.3.7-dev STATUS=SUCCESS REASON=IMAGE_NOT_EXIST
[2025-10-10 17:35:20] BUILD_ID=1_20251010_173520 SERVICE=frontend TAG=v0.3.7-dev STATUS=SKIPPED REASON=NO_CHANGE

å„æœåŠ¡ç¼“å­˜çŠ¶æ€:
  â€¢ backend: tag=v0.3.7-dev, time=2025-10-10T09:38:52Z
  â€¢ frontend: tag=v0.3.7-dev, time=2025-10-10T09:35:20Z
```

#### 2. æŸ¥çœ‹é•œåƒæ„å»ºä¿¡æ¯
```bash
./build.sh build-info backend v0.3.7-dev
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
==========================================
é•œåƒæ„å»ºä¿¡æ¯: ai-infra-backend:v0.3.7-dev
==========================================
build.id=2_20251010_173852
build.service=backend
build.tag=v0.3.7-dev
build.hash=a1b2c3d4e5f6...
build.timestamp=2025-10-10T09:38:52Z
build.reason=IMAGE_NOT_EXIST
```

#### 3. æ¸…ç†ç¼“å­˜
```bash
# æ¸…ç†æ‰€æœ‰ç¼“å­˜
./build.sh clean-cache

# æ¸…ç†ç‰¹å®šæœåŠ¡çš„ç¼“å­˜
./build.sh clean-cache backend
```

## æ„å»ºæµç¨‹è¯¦è§£

### æ™ºèƒ½ç¼“å­˜æ£€æŸ¥æµç¨‹

```
æ„å»ºæœåŠ¡ (build backend)
    â†“
ç”Ÿæˆ BUILD_ID (ä¾‹å¦‚: 2_20251010_173852)
    â†“
æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å»º (need_rebuild)
    â†“
    â”œâ”€ é•œåƒä¸å­˜åœ¨ â†’ IMAGE_NOT_EXIST â†’ æ„å»º
    â”œâ”€ å¼ºåˆ¶æ¨¡å¼ â†’ FORCE_REBUILD â†’ æ„å»º
    â”œâ”€ è·³è¿‡ç¼“å­˜æ£€æŸ¥ â†’ SKIP_CACHE_CHECK â†’ æ„å»º
    â”œâ”€ é•œåƒæ— å“ˆå¸Œæ ‡ç­¾ â†’ NO_HASH_LABEL â†’ æ„å»º
    â”œâ”€ æ–‡ä»¶å“ˆå¸Œå·²å˜åŒ– â†’ HASH_CHANGED â†’ æ„å»º
    â””â”€ æ— å˜åŒ– â†’ NO_CHANGE â†’ è·³è¿‡æ„å»º âœ“
    â†“
è®°å½•æ„å»ºå†å²
    â†“
å®Œæˆ
```

### æ„å»ºè¾“å‡ºç¤ºä¾‹

#### åœºæ™¯1ï¼šæ— å˜åŒ–ï¼Œè·³è¿‡æ„å»º
```bash
$ ./build.sh build backend v0.3.7-dev

[INFO] æ„å»ºæœåŠ¡: backend
[INFO]   Dockerfile: src/backend/Dockerfile
[INFO]   ç›®æ ‡é•œåƒ: ai-infra-backend:v0.3.7-dev
[INFO]   âœ“ é•œåƒæ— å˜åŒ–ï¼Œå¤ç”¨ç¼“å­˜: ai-infra-backend:v0.3.7-dev
[INFO]   ğŸ“‹ BUILD_ID: 3_20251010_174500 (SKIPPED)
```

#### åœºæ™¯2ï¼šæ–‡ä»¶å˜åŒ–ï¼Œéœ€è¦é‡å»º
```bash
$ ./build.sh build backend v0.3.7-dev

[INFO] æ„å»ºæœåŠ¡: backend
[INFO]   Dockerfile: src/backend/Dockerfile
[INFO]   ç›®æ ‡é•œåƒ: ai-infra-backend:v0.3.7-dev
[INFO]   ğŸ”„ æ–‡ä»¶å·²å˜åŒ–ï¼Œéœ€è¦é‡å»º
[INFO]      æ—§å“ˆå¸Œ: a1b2c3d4
[INFO]      æ–°å“ˆå¸Œ: e5f6g7h8
[INFO]   ğŸ“‹ BUILD_ID: 4_20251010_175000
[INFO]   â†’ é¢„æ‹‰å– Dockerfile ä¾èµ–é•œåƒ...
[INFO]   â†’ æ­£åœ¨æ„å»ºé•œåƒ...
... (æ„å»ºè¿‡ç¨‹) ...
[INFO] âœ“ æ„å»ºæˆåŠŸ: ai-infra-backend:v0.3.7-dev
```

#### åœºæ™¯3ï¼šå¼ºåˆ¶é‡å»º
```bash
$ ./build.sh build backend v0.3.7-dev --force

[INFO] å¯ç”¨å¼ºåˆ¶é‡æ–°æ„å»ºæ¨¡å¼
[INFO] æ„å»ºæœåŠ¡: backend
[INFO]   Dockerfile: src/backend/Dockerfile
[INFO]   ç›®æ ‡é•œåƒ: ai-infra-backend:v0.3.7-dev
[INFO]   ğŸ”¨ å¼ºåˆ¶é‡å»ºæ¨¡å¼
[INFO]   ğŸ“‹ BUILD_ID: 5_20251010_175500
[INFO]   â†’ é¢„æ‹‰å– Dockerfile ä¾èµ–é•œåƒ...
[INFO]   â†’ æ­£åœ¨æ„å»ºé•œåƒ...
... (æ„å»ºè¿‡ç¨‹ï¼Œä½¿ç”¨ --no-cache) ...
[INFO] âœ“ æ„å»ºæˆåŠŸ: ai-infra-backend:v0.3.7-dev
```

## å“ˆå¸Œè®¡ç®—è§„åˆ™

### å„æœåŠ¡çš„å“ˆå¸Œè®¡ç®—èŒƒå›´

| æœåŠ¡ | åŒ…å«æ–‡ä»¶/ç›®å½• |
|------|--------------|
| **backend** | `src/backend/Dockerfile` + `src/backend/**/*.go` + `src/backend/**/*.yaml` |
| **frontend** | `src/frontend/Dockerfile` + `src/frontend/**/*.ts` + `src/frontend/**/*.tsx` + `src/frontend/**/*.json` |
| **nginx** | `src/nginx/Dockerfile` + `config/nginx/**/*.conf` |
| **jupyterhub** | `src/jupyterhub/Dockerfile` + `config/jupyterhub_config.py` |
| **å…¶ä»–æœåŠ¡** | `src/<service>/Dockerfile` + `src/<service>/**/*` |

### æ”¯æŒçš„æ–‡ä»¶ç±»å‹
- `.py` - Python
- `.js`, `.ts`, `.tsx` - JavaScript/TypeScript
- `.go` - Golang
- `.conf`, `.yaml`, `.yml`, `.json` - é…ç½®æ–‡ä»¶
- `Dockerfile` - Dockeré…ç½®

## ç¼“å­˜ç›®å½•ç»“æ„

```
.build-cache/
â”œâ”€â”€ build-id.txt                    # å½“å‰æ„å»ºåºå·
â”œâ”€â”€ build-history.log               # æ„å»ºå†å²è®°å½•
â””â”€â”€ <service>/                      # å„æœåŠ¡çš„ç¼“å­˜æ•°æ®
    â””â”€â”€ last-build.json             # æœ€åä¸€æ¬¡æ„å»ºä¿¡æ¯
```

### build-history.log æ ¼å¼
```
[2025-10-10 17:38:52] BUILD_ID=2_20251010_173852 SERVICE=backend TAG=v0.3.7-dev STATUS=SUCCESS REASON=IMAGE_NOT_EXIST
[2025-10-10 17:40:15] BUILD_ID=3_20251010_174015 SERVICE=backend TAG=v0.3.7-dev STATUS=SKIPPED REASON=NO_CHANGE
[2025-10-10 17:42:30] BUILD_ID=4_20251010_174230 SERVICE=backend TAG=v0.3.7-dev STATUS=SUCCESS REASON=HASH_CHANGED
```

### last-build.json æ ¼å¼
```json
{
  "service": "backend",
  "tag": "v0.3.7-dev",
  "build_id": "2_20251010_173852",
  "hash": "a1b2c3d4e5f6789...",
  "timestamp": "2025-10-10T09:38:52Z",
  "image": "ai-infra-backend:v0.3.7-dev"
}
```

## å…¨å±€é€‰é¡¹è¯´æ˜

| é€‰é¡¹ | è¯´æ˜ | å½±å“ |
|------|------|------|
| `--force` | å¼ºåˆ¶é‡å»º | å¿½ç•¥ç¼“å­˜ï¼Œä½¿ç”¨ `--no-cache` é‡å»ºæ‰€æœ‰é•œåƒ |
| `--skip-cache-check` | è·³è¿‡ç¼“å­˜æ£€æŸ¥ | æ€»æ˜¯æ„å»ºï¼Œä½†ä¸ä½¿ç”¨ `--no-cache` |
| `--skip-pull` | è·³è¿‡é•œåƒæ‹‰å– | ä¸é¢„æ‹‰å–åŸºç¡€é•œåƒ |

### é€‰é¡¹å¯¹æ¯”

| åœºæ™¯ | ä½¿ç”¨é€‰é¡¹ | è¡Œä¸º |
|------|---------|------|
| æ­£å¸¸å¼€å‘ | æ—  | æ™ºèƒ½æ£€æµ‹å˜åŒ–ï¼Œæ— å˜åŒ–åˆ™è·³è¿‡ âœ“ |
| é…ç½®å˜æ›´ | æ—  | è‡ªåŠ¨æ£€æµ‹åˆ°å˜åŒ–ï¼Œé‡æ–°æ„å»º |
| å¼ºåˆ¶å…¨é‡é‡å»º | `--force` | å¿½ç•¥æ‰€æœ‰ç¼“å­˜ï¼Œå®Œå…¨é‡å»º |
| è°ƒè¯•æ„å»º | `--skip-cache-check` | æ€»æ˜¯æ„å»ºï¼Œä½†ä½¿ç”¨ Docker ç¼“å­˜ |
| ç¦»çº¿ç¯å¢ƒ | `--skip-pull` | ä¸æ‹‰å–åŸºç¡€é•œåƒï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜ |

## æœ€ä½³å®è·µ

### 1. æ—¥å¸¸å¼€å‘
```bash
# ç›´æ¥æ„å»ºï¼Œè®©ç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­
./build.sh build backend

# å¦‚æœä¿®æ”¹äº†ä»£ç ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹åˆ°å˜åŒ–å¹¶é‡å»º
# å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œä¼šç›´æ¥è·³è¿‡ï¼ŒèŠ‚çœæ—¶é—´
```

### 2. è°ƒè¯•æ„å»ºé—®é¢˜
```bash
# ä½¿ç”¨ --skip-cache-check ç¡®ä¿æ„å»ºè¿è¡Œï¼Œä½†ä¿ç•™ Docker å±‚ç¼“å­˜
./build.sh build backend --skip-cache-check
```

### 3. å®Œå…¨é‡å»º
```bash
# ä½¿ç”¨ --force å¼ºåˆ¶é‡å»ºï¼ˆå¯èƒ½éœ€è¦æ¸…ç†ç¼“å­˜ï¼‰
./build.sh clean-cache backend
./build.sh build backend --force
```

### 4. CI/CD ç¯å¢ƒ
```bash
# CI/CD é€šå¸¸ä½¿ç”¨å¼ºåˆ¶æ¨¡å¼ç¡®ä¿ä¸€è‡´æ€§
./build.sh build-all v1.0.0 --force

# æˆ–è€…æ¸…ç†ç¼“å­˜åæ„å»º
./build.sh clean-cache
./build.sh build-all v1.0.0
```

### 5. æŸ¥çœ‹æ„å»ºå†å²
```bash
# å®šæœŸæŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡ï¼Œäº†è§£æ„å»ºæ•ˆç‡
./build.sh cache-stats

# æŸ¥çœ‹ç‰¹å®šé•œåƒçš„æ„å»ºä¿¡æ¯
./build.sh build-info backend v0.3.7-dev
```

## æ€§èƒ½ä¼˜åŒ–

### æ—¶é—´èŠ‚çœä¼°ç®—

å‡è®¾å•ä¸ªæœåŠ¡æ„å»ºæ—¶é—´ï¼š
- **backend**: ~5åˆ†é’Ÿ
- **frontend**: ~8åˆ†é’Ÿ
- **å…¶ä»–æœåŠ¡**: ~2-3åˆ†é’Ÿ

ä½¿ç”¨æ™ºèƒ½ç¼“å­˜åï¼š
- **æ— å˜åŒ–æœåŠ¡**: < 1ç§’ï¼ˆè·³è¿‡ï¼‰
- **æœ‰å˜åŒ–æœåŠ¡**: æ­£å¸¸æ„å»ºæ—¶é—´
- **é¢„æœŸèŠ‚çœ**: 50-80% çš„æ€»æ„å»ºæ—¶é—´

### ç¤ºä¾‹åœºæ™¯

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | æ™ºèƒ½ç¼“å­˜ | èŠ‚çœæ—¶é—´ |
|------|---------|---------|---------|
| ä¿®æ”¹ backend ä»£ç  | æ„å»ºæ‰€æœ‰æœåŠ¡ (25åˆ†é’Ÿ) | ä»…æ„å»º backend (5åˆ†é’Ÿ) | **80%** â¬‡ï¸ |
| ä¿®æ”¹ frontend ä»£ç  | æ„å»ºæ‰€æœ‰æœåŠ¡ (25åˆ†é’Ÿ) | ä»…æ„å»º frontend (8åˆ†é’Ÿ) | **68%** â¬‡ï¸ |
| é…ç½®æ–‡ä»¶å˜æ›´ | æ„å»ºæ‰€æœ‰æœåŠ¡ (25åˆ†é’Ÿ) | æ„å»ºç›¸å…³æœåŠ¡ (7-10åˆ†é’Ÿ) | **60%** â¬‡ï¸ |
| æ— ä»»ä½•å˜åŒ– | æ„å»ºæ‰€æœ‰æœåŠ¡ (25åˆ†é’Ÿ) | å…¨éƒ¨è·³è¿‡ (< 10ç§’) | **99%** â¬‡ï¸ |

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šç¼“å­˜å¤±æ•ˆï¼Œæ€»æ˜¯é‡å»º

**åŸå› **ï¼šæ–‡ä»¶å“ˆå¸Œæ€»æ˜¯å˜åŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æŸ¥çœ‹é•œåƒçš„æ„å»ºä¿¡æ¯
./build.sh build-info backend

# æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆå¦‚æ—¶é—´æˆ³ï¼‰
# æ’é™¤è¿™äº›æ–‡ä»¶æˆ–ä½¿ç”¨ .dockerignore
```

### é—®é¢˜2ï¼šåº”è¯¥é‡å»ºä½†è¢«è·³è¿‡

**åŸå› **ï¼šä¿®æ”¹çš„æ–‡ä»¶ä¸åœ¨å“ˆå¸Œè®¡ç®—èŒƒå›´å†…

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ¸…ç†ç¼“å­˜å¼ºåˆ¶é‡å»º
./build.sh clean-cache backend
./build.sh build backend

# æˆ–ä½¿ç”¨ --skip-cache-check
./build.sh build backend --skip-cache-check
```

### é—®é¢˜3ï¼šBUILD_ID ä¸é€’å¢

**åŸå› **ï¼š`.build-cache/build-id.txt` æŸå

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# åˆ é™¤å¹¶é‡æ–°åˆå§‹åŒ–
rm -rf .build-cache
./build.sh build backend
```

### é—®é¢˜4ï¼šç¼“å­˜ç›®å½•è¿‡å¤§

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å®šæœŸæ¸…ç†ç¼“å­˜
./build.sh clean-cache

# æˆ–æ‰‹åŠ¨åˆ é™¤
rm -rf .build-cache
```

## æ³¨æ„äº‹é¡¹

1. **ä¸è¦æ‰‹åŠ¨ä¿®æ”¹** `.build-cache` ç›®å½•
2. **ä¸è¦æäº¤** `.build-cache` åˆ° Gitï¼ˆå·²åœ¨ `.gitignore` ä¸­ï¼‰
3. **CI/CD ç¯å¢ƒ**å»ºè®®æ¯æ¬¡æ„å»ºå‰æ¸…ç†ç¼“å­˜
4. **ç¦»çº¿ç¯å¢ƒ**å¯ä»¥ä¿ç•™ç¼“å­˜åŠ é€Ÿæ„å»º
5. **å¤šäººåä½œ**æ—¶ï¼Œæ¯äººçš„ç¼“å­˜æ˜¯ç‹¬ç«‹çš„

## ç›¸å…³æ–‡æ¡£

- [æ„å»ºè„šæœ¬ä½¿ç”¨æŒ‡å—](./BUILD_USAGE_GUIDE.md)
- [æ™ºèƒ½æ„å»ºçŠ¶æ€æ£€æŸ¥](./BUILD_SMART_STATUS_CHECK.md)
- [é•œåƒé¢„æ‹‰å–åŠŸèƒ½](./BUILD_IMAGE_PREFETCH.md)
- [è·¨å¹³å°å…¼å®¹æ€§](./CROSS_PLATFORM_COMPATIBILITY.md)

## æ›´æ–°æ—¥å¿—

- **v0.3.7** (2025-10-10)
  - âœ… æ–°å¢æ™ºèƒ½æ„å»ºç¼“å­˜ç³»ç»Ÿ
  - âœ… æ”¯æŒé€’å¢æ„å»ºID
  - âœ… æ”¯æŒæ–‡ä»¶å“ˆå¸Œæ£€æµ‹
  - âœ… æ”¯æŒé•œåƒæ„å»ºæ ‡ç­¾
  - âœ… æ–°å¢ç¼“å­˜ç®¡ç†å‘½ä»¤
  - âœ… ä¿®å¤ macOS å…¼å®¹æ€§é—®é¢˜
