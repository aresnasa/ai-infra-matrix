FROM python:3.11-alpine

# 配置Alpine镜像（多镜像自动回退）
RUN set -eux; \
    for MIR in mirrors.tuna.tsinghua.edu.cn mirrors.aliyun.com mirrors.ustc.edu.cn dl-cdn.alpinelinux.org; do \
        sed -i "s#://[^/]\+/alpine#://$MIR/alpine#g" /etc/apk/repositories || true; \
        apk update && break || true; \
    done

# Install system dependencies
RUN apk add --no-cache \
    bash \
    curl \
    jq \
    git

# Install Python packages
RUN pip install --no-cache-dir \
    pytest \
    pytest-html \
    requests \
    pyyaml \
    docker \
    saltstack

# Install Salt CLI tools
RUN pip install --no-cache-dir salt

# Create test directory
WORKDIR /tests

# Copy test scripts
COPY tests/ /tests/
COPY scripts/run-tests.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/run-tests.sh

ENTRYPOINT ["/usr/local/bin/run-tests.sh"]
