<!DOCTYPE html>
<html>
<head>
    <title>ä¿®å¤SSOè®¤è¯é—®é¢˜</title>
    <style>
        body { margin: 40px; font-family: Arial, sans-serif; }
        .container { max-width: 800px; margin: 0 auto; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
        code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¿®å¤JupyterHub SSOè®¤è¯é—®é¢˜</h1>
        
        <div class="step warning">
            <h3>é—®é¢˜è¯Šæ–­</h3>
            <p>å‘ç°localStorageä¸­å­˜åœ¨æ— æ•ˆçš„mock token: <code>mock.jwt.token.for.testing.purposes.only</code></p>
            <p>è¿™ä¸ªmock tokenå¯¼è‡´SSOè®¤è¯å¤±è´¥ï¼Œè¿”å›401é”™è¯¯ã€‚</p>
            <div id="currentStatus"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤1: æ¸…ç†æ— æ•ˆToken</h3>
            <button onclick="clearInvalidTokens()" class="danger">æ¸…é™¤æ‰€æœ‰Token</button>
            <button onclick="checkCurrentToken()">æ£€æŸ¥å½“å‰Token</button>
            <div id="clearStatus"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤2: è®¾ç½®æœ‰æ•ˆToken</h3>
            <button onclick="getValidToken()">è·å–æ–°çš„æœ‰æ•ˆToken</button>
            <div id="tokenStatus"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤3: æµ‹è¯•SSOæµç¨‹</h3>
            <button onclick="testSSO()">æµ‹è¯•SSOè®¤è¯</button>
            <button onclick="testJupyterHubAccess()">æµ‹è¯•JupyterHubè®¿é—®</button>
            <div id="testStatus"></div>
        </div>
        
        <div class="step">
            <h3>æ­¥éª¤4: æ‰“å¼€JupyterHub</h3>
            <button onclick="openJupyterHub()">æ‰“å¼€JupyterHub</button>
            <div id="accessStatus"></div>
        </div>
        
        <div class="step">
            <h3>è°ƒè¯•ä¿¡æ¯</h3>
            <pre id="debugInfo"></pre>
        </div>
    </div>

    <script>
        let validToken = null;
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = type;
            element.innerHTML = message;
        }
        
        function log(message) {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }
        
        function checkCurrentToken() {
            const token = localStorage.getItem('token');
            const expires = localStorage.getItem('token_expires');
            
            log(`æ£€æŸ¥å½“å‰token: ${token ? token.substring(0, 30) + '...' : 'æ— '}`);
            
            if (token === 'mock.jwt.token.for.testing.purposes.only') {
                updateStatus('currentStatus', 
                    'âŒ å‘ç°é—®é¢˜token: mock.jwt.token.for.testing.purposes.only<br>' +
                    'è¿™ä¸ªtokenä¼šå¯¼è‡´è®¤è¯å¤±è´¥ï¼Œéœ€è¦æ¸…é™¤ã€‚', 'error');
            } else if (token) {
                updateStatus('currentStatus', 
                    `âœ… Tokenå­˜åœ¨: ${token.substring(0, 30)}...<br>` +
                    `è¿‡æœŸæ—¶é—´: ${expires || 'æœªè®¾ç½®'}`, 'success');
            } else {
                updateStatus('currentStatus', 'âš ï¸ æœªæ‰¾åˆ°token', 'warning');
            }
        }
        
        function clearInvalidTokens() {
            localStorage.removeItem('token');
            localStorage.removeItem('token_expires');
            localStorage.removeItem('username');
            localStorage.removeItem('email');
            
            log('å·²æ¸…é™¤æ‰€æœ‰localStorageä¸­çš„è®¤è¯ä¿¡æ¯');
            updateStatus('clearStatus', 'âœ… å·²æ¸…é™¤æ‰€æœ‰è®¤è¯ä¿¡æ¯', 'success');
            checkCurrentToken();
        }
        
        async function getValidToken() {
            try {
                log('æ­£åœ¨è·å–æ–°çš„æœ‰æ•ˆtoken...');
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    validToken = data.token;
                    
                    // è®¾ç½®åˆ°localStorage
                    localStorage.setItem('token', validToken);
                    localStorage.setItem('token_expires', new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString());
                    localStorage.setItem('username', 'admin');
                    localStorage.setItem('email', 'admin@example.com');
                    
                    log('æˆåŠŸè·å–å¹¶è®¾ç½®æœ‰æ•ˆtoken');
                    updateStatus('tokenStatus', 'âœ… æˆåŠŸè·å–å¹¶è®¾ç½®æœ‰æ•ˆtoken', 'success');
                    checkCurrentToken();
                } else {
                    log(`è·å–tokenå¤±è´¥: ${response.status} ${response.statusText}`);
                    updateStatus('tokenStatus', `âŒ è·å–tokenå¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`è·å–tokené”™è¯¯: ${error.message}`);
                updateStatus('tokenStatus', `âŒ è·å–tokené”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        async function testSSO() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                updateStatus('testStatus', 'âŒ æ²¡æœ‰tokenï¼Œè¯·å…ˆè·å–æœ‰æ•ˆtoken', 'error');
                return;
            }
            
            try {
                log('æµ‹è¯•SSOè®¤è¯...');
                
                const response = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`SSOè®¤è¯æˆåŠŸ: ${JSON.stringify(data)}`);
                    updateStatus('testStatus', 
                        `âœ… SSOè®¤è¯æˆåŠŸ<br>` +
                        `ç”¨æˆ·: ${data.username}<br>` +
                        `é‚®ç®±: ${data.email}<br>` +
                        `æœ‰æ•ˆ: ${data.valid}`, 'success');
                } else {
                    log(`SSOè®¤è¯å¤±è´¥: ${response.status} ${response.statusText}`);
                    updateStatus('testStatus', `âŒ SSOè®¤è¯å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`SSOæµ‹è¯•é”™è¯¯: ${error.message}`);
                updateStatus('testStatus', `âŒ SSOæµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        async function testJupyterHubAccess() {
            try {
                log('æµ‹è¯•JupyterHubè®¿é—®...');
                
                const response = await fetch('/api/jupyter/status', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`JupyterHubçŠ¶æ€: ${JSON.stringify(data)}`);
                    updateStatus('testStatus', 
                        `âœ… JupyterHubè®¿é—®æˆåŠŸ<br>` +
                        `çŠ¶æ€: ${data.status}<br>` +
                        `URL: ${data.url}`, 'success');
                } else {
                    log(`JupyterHubè®¿é—®å¤±è´¥: ${response.status} ${response.statusText}`);
                    updateStatus('testStatus', `âŒ JupyterHubè®¿é—®å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`JupyterHubæµ‹è¯•é”™è¯¯: ${error.message}`);
                updateStatus('testStatus', `âŒ JupyterHubæµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
            }
        }
        
        function openJupyterHub() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                updateStatus('accessStatus', 'âŒ æ²¡æœ‰æœ‰æ•ˆtokenï¼Œæ— æ³•è®¿é—®JupyterHub', 'error');
                return;
            }
            
            log('æ­£åœ¨æ‰“å¼€JupyterHub...');
            updateStatus('accessStatus', 'ğŸš€ æ­£åœ¨æ‰“å¼€JupyterHub...', 'warning');
            
            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€JupyterHub
            window.open('/jupyterhub', '_blank');
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è¯Šæ–­...');
            checkCurrentToken();
        });
    </script>
</body>
</html>
