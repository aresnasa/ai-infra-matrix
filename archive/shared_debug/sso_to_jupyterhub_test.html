<!DOCTYPE html>
<html>
<head>
    <title>SSOåˆ°JupyterHubå®Œæ•´æµç¨‹æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeeba; }
        button { margin: 5px; padding: 10px 15px; }
        .code { background: #f8f9fa; padding: 5px; font-family: monospace; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ğŸ”„ SSOåˆ°JupyterHubå®Œæ•´æµç¨‹æµ‹è¯•</h1>
    
    <div class="step info">
        <strong>æµ‹è¯•æµç¨‹:</strong>
        <ol>
            <li>æ£€æŸ¥å½“å‰localStorageçŠ¶æ€</li>
            <li>æ¨¡æ‹ŸSSOç™»å½•è¿‡ç¨‹</li>
            <li>éªŒè¯tokenæ˜¯å¦æ­£ç¡®è®¾ç½®</li>
            <li>æµ‹è¯•è®¤è¯æ¡¥æ¥é¡µé¢é€»è¾‘</li>
            <li>æ‰§è¡Œå®Œæ•´çš„è·³è½¬æµç¨‹</li>
        </ol>
    </div>
    
    <button onclick="startFullTest()">ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•</button>
    <button onclick="testSSOOnly()">ğŸ” ä»…æµ‹è¯•SSOæµç¨‹</button>
    <button onclick="testAuthBridgeOnly()">ğŸŒ‰ ä»…æµ‹è¯•è®¤è¯æ¡¥æ¥</button>
    <button onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
    
    <div id="results"></div>

    <script>
        let stepCounter = 0;

        function log(message, type = 'info') {
            stepCounter++;
            const resultsDiv = document.getElementById('results');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${type}`;
            stepDiv.innerHTML = `<strong>æ­¥éª¤ ${stepCounter}:</strong> ${message}`;
            resultsDiv.appendChild(stepDiv);
            console.log(`[æ­¥éª¤${stepCounter}] ${message}`);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
            stepDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearAll() {
            localStorage.clear();
            sessionStorage.clear();
            document.getElementById('results').innerHTML = '';
            stepCounter = 0;
            log('å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®', 'info');
        }

        function checkCurrentState() {
            log('æ£€æŸ¥å½“å‰localStorageçŠ¶æ€...', 'info');
            
            const token = localStorage.getItem('token');
            const expires = localStorage.getItem('token_expires');
            
            if (token) {
                log(`å‘ç°Token: <span class="code">${token.substring(0, 30)}...</span>`, 'success');
                if (expires) {
                    const expiryDate = new Date(expires);
                    const now = new Date();
                    const isExpired = now >= expiryDate;
                    log(`Tokenè¿‡æœŸæ—¶é—´: <span class="code">${expiryDate.toLocaleString()}</span> ${isExpired ? '(å·²è¿‡æœŸ)' : '(æœ‰æ•ˆ)'}`, isExpired ? 'warning' : 'success');
                }
            } else {
                log('æœªå‘ç°Token', 'warning');
            }
            
            // æ£€æŸ¥sessionStorageä¸­çš„é‡å®šå‘è®°å½•
            const redirectCount = sessionStorage.getItem('redirect_count');
            const lastRedirectTime = sessionStorage.getItem('last_redirect_time');
            if (redirectCount) {
                log(`é‡å®šå‘è®¡æ•°: ${redirectCount}, æœ€åé‡å®šå‘æ—¶é—´: ${new Date(parseInt(lastRedirectTime)).toLocaleTimeString()}`, 'info');
            }
        }

        function simulateSSO() {
            log('æ¨¡æ‹ŸSSOç™»å½•æµç¨‹...', 'info');
            
            // æ¨¡æ‹ŸSSOè®¾ç½®çš„token
            const mockToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZXhwIjoxNzIzMzEwNDAwfQ.test_signature';
            const expires = new Date(Date.now() + 3600000).toISOString();
            
            localStorage.setItem('token', mockToken);
            localStorage.setItem('token_expires', expires);
            
            log('âœ… SSO Tokenè®¾ç½®å®Œæˆ', 'success');
            log(`Token: <span class="code">${mockToken.substring(0, 30)}...</span>`, 'success');
            log(`è¿‡æœŸæ—¶é—´: <span class="code">${expires}</span>`, 'success');
        }

        function testAuthBridgeLogic() {
            log('æµ‹è¯•è®¤è¯æ¡¥æ¥é¡µé¢é€»è¾‘...', 'info');
            
            // æ¨¡æ‹Ÿè®¤è¯æ¡¥æ¥é¡µé¢çš„tokenæ£€æŸ¥é€»è¾‘
            const urlParams = new URLSearchParams('?target_url=/jupyter/hub/');
            let token = urlParams.get('token') || urlParams.get('auth_token');
            
            if (!token) {
                token = localStorage.getItem('token');
            }
            
            if (token) {
                log(`âœ… è®¤è¯æ¡¥æ¥é¡µé¢èƒ½å¤Ÿè·å–åˆ°Token: <span class="code">${token.substring(0, 30)}...</span>`, 'success');
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æµ‹è¯•token
                if (token.includes('test_signature')) {
                    log('âœ… æ£€æµ‹åˆ°æµ‹è¯•Tokenï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®', 'success');
                    
                    const userData = {
                        username: 'testuser',
                        user: { username: 'testuser' }
                    };
                    
                    // æ¨¡æ‹Ÿé‡å®šå‘URLæ„å»º
                    const targetUrl = urlParams.get('target_url') || '/jupyter/hub/';
                    const username = userData.username;
                    
                    let redirectUrl;
                    if (targetUrl === '/jupyter/hub/') {
                        redirectUrl = `/jupyter/hub/home?auth_token=${encodeURIComponent(token)}&username=${encodeURIComponent(username)}`;
                    } else {
                        redirectUrl = `${targetUrl}?auth_token=${encodeURIComponent(token)}&username=${encodeURIComponent(username)}`;
                    }
                    
                    log(`âœ… æ„å»ºçš„é‡å®šå‘URL: <span class="code">${redirectUrl}</span>`, 'success');
                    return redirectUrl;
                } else {
                    log('âš ï¸ éæµ‹è¯•Tokenï¼Œéœ€è¦è°ƒç”¨APIéªŒè¯', 'warning');
                }
            } else {
                log('âŒ è®¤è¯æ¡¥æ¥é¡µé¢æ— æ³•è·å–Token', 'error');
                return null;
            }
        }

        async function testSSOOnly() {
            clearAll();
            checkCurrentState();
            simulateSSO();
            checkCurrentState();
        }

        async function testAuthBridgeOnly() {
            checkCurrentState();
            const redirectUrl = testAuthBridgeLogic();
            if (redirectUrl) {
                log('ğŸ¯ å‡†å¤‡è·³è½¬åˆ°JupyterHub...', 'info');
                setTimeout(() => {
                    log(`ğŸš€ æ‰§è¡Œè·³è½¬: ${redirectUrl}`, 'info');
                    window.location.href = redirectUrl;
                }, 2000);
            }
        }

        async function startFullTest() {
            clearAll();
            
            log('ğŸš€ å¼€å§‹å®Œæ•´çš„SSOåˆ°JupyterHubæµç¨‹æµ‹è¯•', 'info');
            
            // æ­¥éª¤1: æ£€æŸ¥åˆå§‹çŠ¶æ€
            checkCurrentState();
            
            // æ­¥éª¤2: æ¨¡æ‹ŸSSOç™»å½•
            simulateSSO();
            
            // æ­¥éª¤3: éªŒè¯tokenè®¾ç½®
            checkCurrentState();
            
            // æ­¥éª¤4: æµ‹è¯•è®¤è¯æ¡¥æ¥é€»è¾‘
            const redirectUrl = testAuthBridgeLogic();
            
            if (redirectUrl) {
                log('âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼Œå‡†å¤‡æ‰§è¡Œè·³è½¬', 'success');
                log('3ç§’åå°†è·³è½¬åˆ°JupyterHub...', 'info');
                
                let countdown = 3;
                const countdownInterval = setInterval(() => {
                    log(`å€’è®¡æ—¶: ${countdown} ç§’`, 'info');
                    countdown--;
                    if (countdown < 0) {
                        clearInterval(countdownInterval);
                        log(`ğŸš€ æ‰§è¡Œè·³è½¬åˆ°: ${redirectUrl}`, 'success');
                        window.location.href = redirectUrl;
                    }
                }, 1000);
            } else {
                log('âŒ æµ‹è¯•å¤±è´¥ï¼Œæ— æ³•ç”Ÿæˆæœ‰æ•ˆçš„é‡å®šå‘URL', 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å½“å‰çŠ¶æ€
        window.addEventListener('load', () => {
            checkCurrentState();
        });
    </script>
</body>
</html>
