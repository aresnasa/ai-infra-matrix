<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JupyterHub - AIåŸºç¡€è®¾æ–½çŸ©é˜µ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        .header {
            background: rgba(0,0,0,0.1);
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }
        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }
        .status-indicator {
            font-size: 12px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            margin-left: 10px;
        }
        .content-frame {
            margin-top: 60px;
            height: calc(100vh - 60px);
            width: 100%;
            border: none;
            background: white;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .loading-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.3);
            padding: 40px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #2c3e50;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
        }
        .error-container h3 {
            margin-bottom: 20px;
            color: #e74c3c;
        }
        .error-container .error-detail {
            margin: 15px 0;
            font-size: 14px;
            color: #7f8c8d;
        }
        .error-container button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        .error-container button:hover {
            transform: translateY(-2px);
        }
        .hidden {
            display: none !important;
        }
        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš€ AIåŸºç¡€è®¾æ–½çŸ©é˜µ - JupyterHub</h1>
        <div class="nav-links">
            <a href="/" target="_top">ğŸ  ä¸»é¡µ</a>
            <a href="#" onclick="refreshJupyter()">ğŸ”„ åˆ·æ–°</a>
            <a href="/jupyter/hub/" target="_blank">ğŸ”— æ–°çª—å£</a>
            <span class="status-indicator" id="status">å‡†å¤‡ä¸­...</span>
        </div>
    </div>
    
    <div id="loading" class="loading-container">
        <div class="spinner"></div>
        <h3>æ­£åœ¨åŠ è½½JupyterHub...</h3>
        <p id="loading-status">æ­£åœ¨è·å–è®¤è¯ä»¤ç‰Œ...</p>
    </div>
    
    <div id="error" class="error-container hidden">
        <h3>âš ï¸ è¿æ¥å¤±è´¥</h3>
        <p id="error-message">æ— æ³•è¿æ¥åˆ°JupyterHubæœåŠ¡</p>
        <div class="error-detail" id="error-detail"></div>
        <button onclick="location.reload()">ğŸ”„ é‡æ–°åŠ è½½</button>
        <button onclick="openJupyterInNewTab()">ğŸ”— æ–°çª—å£æ‰“å¼€</button>
    </div>
    
    <iframe 
        id="jupyterhub-frame"
        class="content-frame hidden"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation allow-downloads allow-modals">
    </iframe>
    
    <div class="debug-info hidden" id="debug-info">
        <div><strong>è°ƒè¯•ä¿¡æ¯:</strong></div>
        <div id="debug-content"></div>
    </div>
    
    <script>
        // å…¨å±€çŠ¶æ€
        let authToken = null;
        let loadAttempts = 0;
        const maxAttempts = 3;
        let debugMode = window.location.search.includes('debug=1');
        
        // è°ƒè¯•å‡½æ•°
        function debug(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            console.log(logMessage, data || '');
            
            if (debugMode) {
                const debugInfo = document.getElementById('debug-info');
                const debugContent = document.getElementById('debug-content');
                debugInfo.classList.remove('hidden');
                debugContent.innerHTML += `<div>${logMessage}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(status, color = null) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            if (color) {
                statusEl.style.background = color;
            }
        }
        
        // æ›´æ–°åŠ è½½çŠ¶æ€
        function updateLoadingStatus(message) {
            document.getElementById('loading-status').textContent = message;
        }
        
        // è·å–JWTè®¤è¯ä»¤ç‰Œ
        async function getAuthToken() {
            debug('å¼€å§‹è·å–JWTè®¤è¯ä»¤ç‰Œ');
            updateLoadingStatus('æ­£åœ¨è·å–è®¤è¯ä»¤ç‰Œ...');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                debug(`è®¤è¯APIå“åº”çŠ¶æ€: ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`è®¤è¯APIå¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                debug('è®¤è¯APIå“åº”', data);
                
                if (data.token) {
                    authToken = data.token;
                    debug(`JWTä»¤ç‰Œè·å–æˆåŠŸï¼Œé•¿åº¦: ${authToken.length}`);
                    updateStatus('å·²è®¤è¯', 'rgba(46, 204, 113, 0.3)');
                    return authToken;
                } else {
                    throw new Error('è®¤è¯å“åº”ä¸­ç¼ºå°‘ä»¤ç‰Œ');
                }
                
            } catch (error) {
                debug('è·å–JWTä»¤ç‰Œå¤±è´¥', error);
                updateStatus('è®¤è¯å¤±è´¥', 'rgba(231, 76, 60, 0.3)');
                throw error;
            }
        }
        
        // åŠ è½½JupyterHub
        async function loadJupyterHub() {
            debug(`å¼€å§‹åŠ è½½JupyterHubï¼Œç¬¬ ${loadAttempts + 1} æ¬¡å°è¯•`);
            loadAttempts++;
            
            try {
                updateLoadingStatus('æ­£åœ¨è·å–è®¤è¯...');
                await getAuthToken();
                
                updateLoadingStatus('æ­£åœ¨è¿æ¥JupyterHub...');
                
                // æ„å»ºå¸¦è®¤è¯ä»¤ç‰Œçš„URL
                const jupyterUrl = `/jupyter/hub/?token=${encodeURIComponent(authToken)}`;
                debug(`JupyterHub URL: ${jupyterUrl.substring(0, 50)}...`);
                
                // è®¾ç½®iframe
                const iframe = document.getElementById('jupyterhub-frame');
                iframe.onload = handleIframeLoad;
                iframe.onerror = handleIframeError;
                
                // è®¾ç½®åŠ è½½è¶…æ—¶
                const loadTimeout = setTimeout(() => {
                    debug('iframeåŠ è½½è¶…æ—¶');
                    handleIframeError(new Error('åŠ è½½è¶…æ—¶'));
                }, 15000);
                
                // ä¿å­˜è¶…æ—¶IDä»¥ä¾¿æ¸…é™¤
                iframe.loadTimeout = loadTimeout;
                
                // å¼€å§‹åŠ è½½
                iframe.src = jupyterUrl;
                
                updateStatus('è¿æ¥ä¸­...', 'rgba(52, 152, 219, 0.3)');
                
            } catch (error) {
                debug('åŠ è½½JupyterHubå¤±è´¥', error);
                showError(`è®¤è¯å¤±è´¥: ${error.message}`, 'è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ');
            }
        }
        
        // iframeåŠ è½½æˆåŠŸ
        function handleIframeLoad() {
            const iframe = document.getElementById('jupyterhub-frame');
            
            // æ¸…é™¤è¶…æ—¶
            if (iframe.loadTimeout) {
                clearTimeout(iframe.loadTimeout);
            }
            
            debug('iframeåŠ è½½æˆåŠŸ');
            
            // æ˜¾ç¤ºiframeï¼Œéšè—åŠ è½½ç•Œé¢
            showIframe();
            
            updateStatus('å·²è¿æ¥', 'rgba(46, 204, 113, 0.3)');
            
            // é‡ç½®é‡è¯•è®¡æ•°
            loadAttempts = 0;
        }
        
        // iframeåŠ è½½å¤±è´¥
        function handleIframeError(error = null) {
            const iframe = document.getElementById('jupyterhub-frame');
            
            // æ¸…é™¤è¶…æ—¶
            if (iframe.loadTimeout) {
                clearTimeout(iframe.loadTimeout);
            }
            
            debug('iframeåŠ è½½å¤±è´¥', error);
            
            if (loadAttempts < maxAttempts) {
                debug(`å‡†å¤‡é‡è¯•ï¼Œå‰©ä½™å°è¯•æ¬¡æ•°: ${maxAttempts - loadAttempts}`);
                setTimeout(() => {
                    loadJupyterHub();
                }, 3000);
            } else {
                debug('è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ˜¾ç¤ºé”™è¯¯');
                showError(
                    'æ— æ³•åŠ è½½JupyterHubæœåŠ¡',
                    `å·²å°è¯• ${maxAttempts} æ¬¡ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€æˆ–ç¨åé‡è¯•`
                );
                updateStatus('è¿æ¥å¤±è´¥', 'rgba(231, 76, 60, 0.3)');
            }
        }
        
        // æ˜¾ç¤ºiframe
        function showIframe() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('jupyterhub-frame').classList.remove('hidden');
        }
        
        // æ˜¾ç¤ºé”™è¯¯
        function showError(message, detail = '') {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('jupyterhub-frame').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
            
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-detail').textContent = detail;
        }
        
        // åˆ·æ–°JupyterHub
        function refreshJupyter() {
            debug('æ‰‹åŠ¨åˆ·æ–°JupyterHub');
            loadAttempts = 0;
            authToken = null;
            
            // é‡ç½®ç•Œé¢
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('jupyterhub-frame').classList.add('hidden');
            
            // æ¸…ç©ºiframe
            document.getElementById('jupyterhub-frame').src = 'about:blank';
            
            // é‡æ–°åŠ è½½
            setTimeout(loadJupyterHub, 500);
        }
        
        // åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€JupyterHub
        function openJupyterInNewTab() {
            debug('åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€JupyterHub');
            window.open('/jupyter/hub/', '_blank');
        }
        
        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                debug('é¡µé¢é‡æ–°å¯è§');
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡è¿é€»è¾‘
            }
        });
        
        // é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            debug('JavaScripté”™è¯¯', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno
            });
        });
        
        // é¡µé¢åˆå§‹åŒ–
        function initializePage() {
            debug('åˆå§‹åŒ–é¡µé¢');
            updateStatus('åˆå§‹åŒ–ä¸­...');
            
            // æ£€æŸ¥è°ƒè¯•æ¨¡å¼
            if (debugMode) {
                debug('è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
            }
            
            // å¼€å§‹åŠ è½½JupyterHub
            setTimeout(loadJupyterHub, 1000);
        }
        
        // ç­‰å¾…DOMåŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }
        
        debug('JupyterHub Wrapperè„šæœ¬å·²åŠ è½½');
    </script>
</body>
</html>
