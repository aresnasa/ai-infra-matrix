<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŸºç¡€è®¾æ–½çŸ©é˜µ - æ™ºèƒ½ç™»å½•</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        .status.loading {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        .status.success {
            background-color: #e8f5e8;
            color: #2e7d2e;
            border: 1px solid #c8e6c9;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        .manual-login {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px 5px;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: #6c757d;
        }
        .debug-info {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: left;
            font-size: 12px;
            color: #666;
            display: none;
        }
        .debug-info h4 {
            margin-top: 0;
            color: #333;
        }
        .debug-info pre {
            background: #eee;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">AI</div>
        <h1>AIåŸºç¡€è®¾æ–½çŸ©é˜µ</h1>
        <p class="subtitle">æ™ºèƒ½å•ç‚¹ç™»å½•ç³»ç»Ÿ</p>

        <div id="status" class="status loading">
            ğŸ” æ­£åœ¨æ£€æµ‹ç™»å½•çŠ¶æ€...
        </div>

        <div class="progress-bar">
            <div id="progress" class="progress-bar-fill"></div>
        </div>

        <div id="manual-login" class="manual-login">
            <h3>æ‰‹åŠ¨ç™»å½•</h3>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å:</label>
                    <input type="text" id="username" name="username" value="admin" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç :</label>
                    <input type="password" id="password" name="password" value="admin123" required>
                </div>
                <button type="submit" class="btn">ç™»å½•</button>
            </form>
        </div>

        <button id="show-debug" class="btn btn-secondary" onclick="toggleDebug()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>

        <div id="debug-info" class="debug-info">
            <h4>è°ƒè¯•ä¿¡æ¯</h4>
            <pre id="debug-content"></pre>
        </div>
    </div>

    <script>
        let debugData = {};
        let progressValue = 0;

        function updateProgress(value) {
            progressValue = value;
            document.getElementById('progress').style.width = value + '%';
        }

        function updateStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;

            debugData.lastStatus = {
                message: message,
                type: type,
                timestamp: new Date().toISOString()
            };
            updateDebugInfo();
        }

        function updateDebugInfo() {
            document.getElementById('debug-content').textContent = JSON.stringify(debugData, null, 2);
        }

        function toggleDebug() {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
        }

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function setCookie(name, value, hours) {
            const expires = new Date(Date.now() + hours * 60 * 60 * 1000).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        async function attemptJWTLogin(token, username) {
            try {
                updateStatus('ğŸ”‘ éªŒè¯JWT token...', 'loading');
                updateProgress(30);

                // éªŒè¯tokenæ ¼å¼
                const tokenParts = token.split('.');
                if (tokenParts.length !== 3) {
                    throw new Error('JWT tokenæ ¼å¼æ— æ•ˆ');
                }

                // è§£ç payload (ä¸éªŒè¯ç­¾åï¼Œä»…ç”¨äºæ˜¾ç¤ºä¿¡æ¯)
                const payload = JSON.parse(atob(tokenParts[1]));
                debugData.jwtPayload = payload;
                updateDebugInfo();

                updateStatus('ğŸª è®¾ç½®è®¤è¯cookie...', 'loading');
                updateProgress(50);

                // è®¾ç½®JWT cookie
                setCookie('jupyterhub-jwt-token', token, 24);
                setCookie('ai-matrix-user', username || payload.username, 24);

                updateStatus('ğŸš€ é‡å®šå‘åˆ°JupyterHub...', 'loading');
                updateProgress(80);

                // æ„å»ºJupyterHubç™»å½•URL
                const jupyterUrl = new URL('/jupyter/hub/login', window.location.origin);
                jupyterUrl.searchParams.set('token', token);
                if (username) {
                    jupyterUrl.searchParams.set('username', username);
                }

                debugData.redirectUrl = jupyterUrl.toString();
                updateDebugInfo();

                updateProgress(100);
                updateStatus('âœ… æ­£åœ¨è·³è½¬åˆ°JupyterHub...', 'success');

                // å»¶è¿Ÿè·³è½¬ä»¥æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                setTimeout(() => {
                    window.location.href = jupyterUrl.toString();
                }, 1500);

                return true;

            } catch (error) {
                debugData.jwtError = error.message;
                updateDebugInfo();
                updateStatus(`âŒ JWTç™»å½•å¤±è´¥: ${error.message}`, 'error');
                updateProgress(0);
                return false;
            }
        }

        async function attemptBackendLogin(username, password) {
            try {
                updateStatus('ğŸ” è¿æ¥åç«¯è®¤è¯...', 'loading');
                updateProgress(20);

                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                debugData.backendResponse = {
                    status: response.status,
                    headers: Object.fromEntries(response.headers.entries())
                };

                if (response.ok) {
                    const data = await response.json();
                    debugData.backendData = data;
                    updateDebugInfo();

                    if (data.token) {
                        updateStatus('âœ… åç«¯è®¤è¯æˆåŠŸï¼Œä½¿ç”¨JWTç™»å½•...', 'success');
                        updateProgress(60);
                        return await attemptJWTLogin(data.token, username);
                    } else {
                        throw new Error('åç«¯æœªè¿”å›JWT token');
                    }
                } else {
                    const errorData = await response.text();
                    debugData.backendError = errorData;
                    throw new Error(`åç«¯è®¤è¯å¤±è´¥: ${response.status}`);
                }

            } catch (error) {
                debugData.backendLoginError = error.message;
                updateDebugInfo();
                updateStatus(`âŒ åç«¯ç™»å½•å¤±è´¥: ${error.message}`, 'error');
                updateProgress(0);
                return false;
            }
        }

        async function initializeLogin() {
            updateProgress(10);

            // 1. æ£€æŸ¥URLå‚æ•°ä¸­çš„token
            const urlToken = getUrlParameter('token');
            const urlUsername = getUrlParameter('username');

            if (urlToken) {
                debugData.urlToken = urlToken.substring(0, 50) + '...';
                debugData.urlUsername = urlUsername;
                updateDebugInfo();

                const success = await attemptJWTLogin(urlToken, urlUsername);
                if (success) return;
            }

            // 2. æ£€æŸ¥å·²å­˜å‚¨çš„token
            const storedToken = getCookie('jupyterhub-jwt-token');
            const storedUser = getCookie('ai-matrix-user');

            if (storedToken) {
                debugData.storedToken = storedToken.substring(0, 50) + '...';
                debugData.storedUser = storedUser;
                updateDebugInfo();

                updateStatus('ğŸ” å‘ç°å·²å­˜å‚¨çš„tokenï¼Œå°è¯•è‡ªåŠ¨ç™»å½•...', 'loading');
                const success = await attemptJWTLogin(storedToken, storedUser);
                if (success) return;
            }

            // 3. æ˜¾ç¤ºæ‰‹åŠ¨ç™»å½•é€‰é¡¹
            updateStatus('âš ï¸ éœ€è¦æ‰‹åŠ¨ç™»å½•', 'error');
            updateProgress(0);
            document.getElementById('manual-login').style.display = 'block';
        }

        // è¡¨å•æäº¤å¤„ç†
        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const success = await attemptBackendLogin(username, password);
            if (!success) {
                // å¦‚æœåç«¯ç™»å½•å¤±è´¥ï¼Œå°è¯•ç›´æ¥JupyterHubç™»å½•
                updateStatus('ğŸ”„ å°è¯•ç›´æ¥JupyterHubç™»å½•...', 'loading');

                try {
                    const formData = new FormData();
                    formData.append('username', username);
                    formData.append('password', password);

                    const response = await fetch('/jupyter/hub/login', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok || response.redirected) {
                        updateStatus('âœ… JupyterHubç›´æ¥ç™»å½•æˆåŠŸ', 'success');
                        window.location.href = '/jupyter/hub/home';
                    } else {
                        throw new Error('JupyterHubç™»å½•å¤±è´¥');
                    }

                } catch (error) {
                    updateStatus('âŒ æ‰€æœ‰ç™»å½•æ–¹å¼éƒ½å¤±è´¥äº†', 'error');
                    debugData.finalError = error.message;
                    updateDebugInfo();
                }
            }
        });

        // é¡µé¢åŠ è½½æ—¶å¼€å§‹ç™»å½•æµç¨‹
        window.addEventListener('load', initializeLogin);

        // åˆå§‹åŒ–è°ƒè¯•ä¿¡æ¯
        debugData.pageLoaded = new Date().toISOString();
        debugData.userAgent = navigator.userAgent;
        debugData.location = window.location.toString();
        updateDebugInfo();
    </script>
</body>
</html>