#!/bin/bash

# API测试脚本 - Ansible Playbook Generator
# 测试新实现的预览、验证、兼容性检查和包生成功能

set -e

# API基础URL
BASE_URL="http://localhost:8082/api"
AUTH_TOKEN=""
PROJECT_ID=""

# 测试凭证文件
CREDENTIALS_FILE="tests/user-pass.csv"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_message() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}================================${NC}"
    echo -e "${BLUE} $1${NC}"
    echo -e "${BLUE}================================${NC}"
}

# 检查必要工具
check_requirements() {
    if ! command -v curl &> /dev/null; then
        print_error "curl未安装，请先安装curl"
        exit 1
    fi
    
    if ! command -v jq &> /dev/null; then
        print_warning "建议安装jq用于JSON格式化输出"
    fi
    
    # 检查凭证文件是否存在
    if [ ! -f "$CREDENTIALS_FILE" ]; then
        print_error "凭证文件 $CREDENTIALS_FILE 不存在"
        exit 1
    fi
}

# 读取测试凭证
read_credentials() {
    if [ ! -f "$CREDENTIALS_FILE" ]; then
        print_error "凭证文件不存在: $CREDENTIALS_FILE"
        return 1
    fi
    
    # 读取第一行（跳过注释行）
    local line=$(grep -v '^//' "$CREDENTIALS_FILE" | head -n1)
    if [ -z "$line" ]; then
        print_error "凭证文件中没有有效的凭证"
        return 1
    fi
    
    # 解析用户名和密码
    USERNAME=$(echo "$line" | cut -d',' -f1)
    PASSWORD=$(echo "$line" | cut -d',' -f2)
    
    if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
        print_error "无法解析凭证文件中的用户名或密码"
        return 1
    fi
    
    print_message "已读取测试凭证: $USERNAME"
    return 0
}

# 格式化JSON输出
format_json() {
    if command -v jq &> /dev/null; then
        jq .
    else
        cat
    fi
}

# 解析HTTP响应 (兼容macOS)
parse_response() {
    local response="$1"
    local http_code=$(echo "$response" | tail -1)
    local body=$(echo "$response" | sed '$d')
    echo "$body"
    echo "$http_code"
}

# 用户注册（跳过，使用现有凭证）
register_user() {
    print_header "跳过用户注册 - 使用现有凭证"
    
    if ! read_credentials; then
        print_error "无法读取测试凭证"
        return 1
    fi
    
    print_message "将使用现有用户: $USERNAME"
    return 0
}

# 用户登录
login_user() {
    print_header "用户登录测试"
    
    if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
        if ! read_credentials; then
            print_error "无法读取测试凭证"
            return 1
        fi
    fi
    
    print_message "登录用户: $USERNAME"
    
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -d "{
            \"username\": \"$USERNAME\",
            \"password\": \"$PASSWORD\"
        }" \
        "${BASE_URL}/auth/login")
    
    local parsed_response=$(parse_response "$response")
    local body=$(echo "$parsed_response" | sed '$d')
    local http_code=$(echo "$parsed_response" | tail -1)
    
    if [ "$http_code" -eq 200 ]; then
        print_message "✓ 用户登录成功"
        # 尝试不同的方式提取Token
        AUTH_TOKEN=$(echo "$body" | jq -r '.token' 2>/dev/null || echo "$body" | grep -oE '"token":"[^"]*"' | cut -d'"' -f4 || echo "$body" | sed -n 's/.*"token":"\([^"]*\)".*/\1/p')
        echo "$body" | format_json
        echo ""
        
        if [ -n "$AUTH_TOKEN" ] && [ "$AUTH_TOKEN" != "null" ] && [ "$AUTH_TOKEN" != "" ]; then
            print_message "已获取认证Token: ${AUTH_TOKEN:0:20}..."
            return 0
        else
            print_error "无法获取认证Token，响应体:"
            echo "$body"
            return 1
        fi
    else
        print_error "✗ 用户登录失败 (HTTP $http_code)"
        echo "$body" | format_json
        echo ""
        return 1
    fi
}

# 创建测试项目
create_test_project() {
    print_header "创建测试项目"
    
    if [ -z "$AUTH_TOKEN" ]; then
        print_error "未获取认证Token，请先登录"
        return 1
    fi
    
    local project_name="Test Ansible Project $(date +%s)"
    
    print_message "创建项目: $project_name"
    
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"name\": \"$project_name\",
            \"description\": \"Test project for Ansible Playbook Generator\",
            \"ansible_version\": \"2.14.0\"
        }" \
        "${BASE_URL}/projects")
    
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | head -n -1)
    
    if [ "$http_code" -eq 201 ]; then
        print_message "✓ 项目创建成功"
        PROJECT_ID=$(echo "$body" | jq -r '.id' 2>/dev/null || echo "$body" | grep -o '"id":[0-9]*' | cut -d: -f2)
        echo "$body" | format_json
        echo ""
        
        if [ -n "$PROJECT_ID" ] && [ "$PROJECT_ID" != "null" ]; then
            print_message "项目ID: $PROJECT_ID"
            return 0
        else
            print_error "无法获取项目ID"
            return 1
        fi
    else
        print_error "✗ 项目创建失败 (HTTP $http_code)"
        echo "$body" | format_json
        echo ""
        return 1
    fi
}

# 添加测试主机
add_test_hosts() {
    print_header "添加测试主机"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    # 添加Web服务器主机
    print_message "添加Web服务器主机"
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID,
            \"name\": \"web-server-01\",
            \"hostname\": \"192.168.1.10\",
            \"ip_address\": \"192.168.1.10\",
            \"ssh_user\": \"ubuntu\",
            \"ssh_port\": 22,
            \"groups\": [\"webservers\", \"production\"]
        }" \
        "${BASE_URL}/hosts")
    
    local http_code=$(echo "$response" | tail -n1)
    if [ "$http_code" -eq 201 ]; then
        print_message "✓ Web服务器主机添加成功"
    else
        print_warning "✗ Web服务器主机添加失败 (HTTP $http_code)"
    fi
    
    # 添加数据库服务器主机
    print_message "添加数据库服务器主机"
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID,
            \"name\": \"db-server-01\",
            \"hostname\": \"192.168.1.20\",
            \"ip_address\": \"192.168.1.20\",
            \"ssh_user\": \"ubuntu\",
            \"ssh_port\": 22,
            \"groups\": [\"databases\", \"production\"]
        }" \
        "${BASE_URL}/hosts")
    
    local http_code=$(echo "$response" | tail -n1)
    if [ "$http_code" -eq 201 ]; then
        print_message "✓ 数据库服务器主机添加成功"
    else
        print_warning "✗ 数据库服务器主机添加失败 (HTTP $http_code)"
    fi
    
    echo ""
}

# 添加测试变量
add_test_variables() {
    print_header "添加测试变量"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    # 添加全局变量
    print_message "添加全局变量"
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID,
            \"name\": \"app_version\",
            \"value\": \"1.0.0\",
            \"description\": \"Application version\",
            \"is_encrypted\": false
        }" \
        "${BASE_URL}/variables")
    
    local http_code=$(echo "$response" | tail -n1)
    if [ "$http_code" -eq 201 ]; then
        print_message "✓ 全局变量添加成功"
    else
        print_warning "✗ 全局变量添加失败 (HTTP $http_code)"
    fi
    
    echo ""
}

# 添加测试任务
add_test_tasks() {
    print_header "添加测试任务"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    # 添加安装软件包任务
    print_message "添加软件包安装任务"
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID,
            \"name\": \"Install Nginx\",
            \"module\": \"apt\",
            \"args\": {
                \"name\": \"nginx\",
                \"state\": \"present\",
                \"update_cache\": true
            },
            \"description\": \"Install Nginx web server\",
            \"order_index\": 1
        }" \
        "${BASE_URL}/tasks")
    
    local http_code=$(echo "$response" | tail -n1)
    if [ "$http_code" -eq 201 ]; then
        print_message "✓ 软件包安装任务添加成功"
    else
        print_warning "✗ 软件包安装任务添加失败 (HTTP $http_code)"
    fi
    
    # 添加服务启动任务
    print_message "添加服务启动任务"
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID,
            \"name\": \"Start Nginx Service\",
            \"module\": \"systemd\",
            \"args\": {
                \"name\": \"nginx\",
                \"state\": \"started\",
                \"enabled\": true
            },
            \"description\": \"Start and enable Nginx service\",
            \"order_index\": 2
        }" \
        "${BASE_URL}/tasks")
    
    local http_code=$(echo "$response" | tail -n1)
    if [ "$http_code" -eq 201 ]; then
        print_message "✓ 服务启动任务添加成功"
    else
        print_warning "✗ 服务启动任务添加失败 (HTTP $http_code)"
    fi
    
    echo ""
}

# 测试Playbook预览功能
test_playbook_preview() {
    print_header "测试Playbook预览功能"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    print_message "生成Playbook预览..."
    
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID
        }" \
        "${BASE_URL}/playbook/preview")
    
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | head -n -1)
    
    if [ "$http_code" -eq 200 ]; then
        print_message "✓ Playbook预览生成成功"
        echo "$body" | format_json | head -50
        echo "..."
        echo ""
        return 0
    else
        print_error "✗ Playbook预览生成失败 (HTTP $http_code)"
        echo "$body" | format_json
        echo ""
        return 1
    fi
}

# 测试Playbook验证功能
test_playbook_validation() {
    print_header "测试Playbook验证功能"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    print_message "验证Playbook语法和结构..."
    
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID
        }" \
        "${BASE_URL}/playbook/validate")
    
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | head -n -1)
    
    if [ "$http_code" -eq 200 ]; then
        print_message "✓ Playbook验证完成"
        echo "$body" | format_json
        echo ""
        return 0
    else
        print_error "✗ Playbook验证失败 (HTTP $http_code)"
        echo "$body" | format_json
        echo ""
        return 1
    fi
}

# 测试Ansible版本兼容性检查
test_compatibility_check() {
    print_header "测试Ansible版本兼容性检查"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    print_message "检查与多个Ansible版本的兼容性..."
    
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID,
            \"target_versions\": [\"2.9.0\", \"2.12.0\", \"2.14.0\", \"7.0.0\", \"8.0.0\"]
        }" \
        "${BASE_URL}/playbook/compatibility")
    
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | head -n -1)
    
    if [ "$http_code" -eq 200 ]; then
        print_message "✓ 兼容性检查完成"
        echo "$body" | format_json
        echo ""
        return 0
    else
        print_error "✗ 兼容性检查失败 (HTTP $http_code)"
        echo "$body" | format_json
        echo ""
        return 1
    fi
}

# 测试包生成功能
test_package_generation() {
    print_header "测试包生成功能"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    print_message "生成下载包..."
    
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID
        }" \
        "${BASE_URL}/playbook/package")
    
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | head -n -1)
    
    if [ "$http_code" -eq 200 ]; then
        print_message "✓ 下载包生成成功"
        echo "$body" | format_json
        
        # 提取下载路径并测试下载
        local download_path=$(echo "$body" | jq -r '.download_path' 2>/dev/null || echo "$body" | grep -o '"download_path":"[^"]*"' | cut -d'"' -f4)
        if [ -n "$download_path" ] && [ "$download_path" != "null" ]; then
            print_message "测试ZIP包下载..."
            local download_response=$(curl -s -w "\n%{http_code}" -X GET \
                -H "Authorization: Bearer $AUTH_TOKEN" \
                "${BASE_URL}/playbook/download-zip/${download_path}")
            
            local download_http_code=$(echo "$download_response" | tail -n1)
            if [ "$download_http_code" -eq 200 ]; then
                print_message "✓ ZIP包下载成功"
            else
                print_warning "✗ ZIP包下载失败 (HTTP $download_http_code)"
            fi
        fi
        echo ""
        return 0
    else
        print_error "✗ 下载包生成失败 (HTTP $http_code)"
        echo "$body" | format_json
        echo ""
        return 1
    fi
}

# 测试传统生成功能
test_traditional_generation() {
    print_header "测试传统Playbook生成功能"
    
    if [ -z "$AUTH_TOKEN" ] || [ -z "$PROJECT_ID" ]; then
        print_error "缺少认证Token或项目ID"
        return 1
    fi
    
    print_message "生成Playbook..."
    
    local response=$(curl -s -w "\n%{http_code}" -X POST \
        -H "Content-Type: application/json" \
        -H "Authorization: Bearer $AUTH_TOKEN" \
        -d "{
            \"project_id\": $PROJECT_ID
        }" \
        "${BASE_URL}/playbook/generate")
    
    local http_code=$(echo "$response" | tail -n1)
    local body=$(echo "$response" | head -n -1)
    
    if [ "$http_code" -eq 200 ]; then
        print_message "✓ Playbook生成成功"
        echo "$body" | format_json
        echo ""
        return 0
    else
        print_error "✗ Playbook生成失败 (HTTP $http_code)"
        echo "$body" | format_json
        echo ""
        return 1
    fi
}

# 清理测试数据
cleanup_test_data() {
    print_header "清理测试数据"
    
    if [ -f test_credentials.txt ]; then
        rm test_credentials.txt
        print_message "已清理测试凭证文件"
    fi
    
    print_message "测试完成"
}

# 运行完整测试套件
run_full_test_suite() {
    print_header "开始完整API测试套件"
    
    local test_results=()
    
    # 执行测试序列
    register_user && test_results+=("注册:✓") || test_results+=("注册:✗")
    login_user && test_results+=("登录:✓") || test_results+=("登录:✗")
    create_test_project && test_results+=("项目创建:✓") || test_results+=("项目创建:✗")
    add_test_hosts && test_results+=("主机添加:✓") || test_results+=("主机添加:✗")
    add_test_variables && test_results+=("变量添加:✓") || test_results+=("变量添加:✗")
    add_test_tasks && test_results+=("任务添加:✓") || test_results+=("任务添加:✗")
    test_playbook_preview && test_results+=("Playbook预览:✓") || test_results+=("Playbook预览:✗")
    test_playbook_validation && test_results+=("Playbook验证:✓") || test_results+=("Playbook验证:✗")
    test_compatibility_check && test_results+=("兼容性检查:✓") || test_results+=("兼容性检查:✗")
    test_package_generation && test_results+=("包生成:✓") || test_results+=("包生成:✗")
    test_traditional_generation && test_results+=("传统生成:✓") || test_results+=("传统生成:✗")
    
    # 显示测试结果摘要
    print_header "测试结果摘要"
    for result in "${test_results[@]}"; do
        if [[ $result == *"✓"* ]]; then
            print_message "$result"
        else
            print_error "$result"
        fi
    done
    
    cleanup_test_data
}

# 显示帮助信息
show_help() {
    cat << EOF
Ansible Playbook Generator API测试脚本

用法: $0 [命令]

命令:
    full            运行完整测试套件
    register        用户注册测试
    login           用户登录测试
    project         创建测试项目
    hosts           添加测试主机
    variables       添加测试变量
    tasks           添加测试任务
    preview         测试Playbook预览功能
    validate        测试Playbook验证功能
    compatibility   测试兼容性检查功能
    package         测试包生成功能
    generate        测试传统生成功能
    cleanup         清理测试数据
    help            显示此帮助信息

示例:
    $0 full                 # 运行完整测试套件
    $0 preview              # 仅测试预览功能
    $0 compatibility        # 仅测试兼容性检查

注意:
    - 确保Docker服务已启动且API可访问
    - 建议安装jq工具用于JSON格式化输出
    - 测试会自动创建和清理测试数据

EOF
}

# 主函数
main() {
    check_requirements
    
    case ${1:-help} in
        "full")
            run_full_test_suite
            ;;
        "register")
            register_user
            ;;
        "login")
            register_user && login_user
            ;;
        "project")
            register_user && login_user && create_test_project
            ;;
        "hosts")
            register_user && login_user && create_test_project && add_test_hosts
            ;;
        "variables")
            register_user && login_user && create_test_project && add_test_variables
            ;;
        "tasks")
            register_user && login_user && create_test_project && add_test_tasks
            ;;
        "preview")
            register_user && login_user && create_test_project && add_test_hosts && add_test_variables && add_test_tasks && test_playbook_preview
            ;;
        "validate")
            register_user && login_user && create_test_project && add_test_hosts && add_test_variables && add_test_tasks && test_playbook_validation
            ;;
        "compatibility")
            register_user && login_user && create_test_project && add_test_hosts && add_test_variables && add_test_tasks && test_compatibility_check
            ;;
        "package")
            register_user && login_user && create_test_project && add_test_hosts && add_test_variables && add_test_tasks && test_package_generation
            ;;
        "generate")
            register_user && login_user && create_test_project && add_test_hosts && add_test_variables && add_test_tasks && test_traditional_generation
            ;;
        "cleanup")
            cleanup_test_data
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        *)
            print_error "未知命令: $1"
            show_help
            exit 1
            ;;
    esac
}

# 执行主函数
main "$@"
