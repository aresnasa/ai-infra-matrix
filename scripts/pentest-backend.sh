#!/bin/bash
# =============================================================================
# AI-Infra-Matrix åç«¯æ¸—é€æµ‹è¯•è„šæœ¬
# ç”¨äºå®‰å…¨å®¡è®¡å’Œæ¼æ´æ£€æµ‹
# =============================================================================
# ä¸ä½¿ç”¨ set -eï¼Œå› ä¸ºæµ‹è¯•è„šæœ¬ä¸­å¾ˆå¤šå‘½ä»¤é¢„æœŸä¼šå¤±è´¥

# é…ç½®
TARGET_URL="${TARGET_URL:-https://ai-infra-matrix.top}"
ADMIN_PATH="/admin"
API_PATH="/api"
OUTPUT_DIR="${OUTPUT_DIR:-./pentest-results}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REPORT_FILE="${OUTPUT_DIR}/pentest_report_${TIMESTAMP}.md"

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# è®¡æ•°å™¨
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0
WARNINGS=0

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[PASS]${NC} $1"; ((PASSED_TESTS++)); ((TOTAL_TESTS++)); }
log_fail() { echo -e "${RED}[FAIL]${NC} $1"; ((FAILED_TESTS++)); ((TOTAL_TESTS++)); }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; ((WARNINGS++)); ((TOTAL_TESTS++)); }
log_test() { echo -e "${CYAN}[TEST]${NC} $1"; }

# åˆå§‹åŒ–æŠ¥å‘Š
init_report() {
    mkdir -p "${OUTPUT_DIR}"
    cat > "${REPORT_FILE}" << EOF
# æ¸—é€æµ‹è¯•æŠ¥å‘Š

**ç›®æ ‡**: ${TARGET_URL}
**æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
**æµ‹è¯•è€…**: Automated Security Scanner

---

## æµ‹è¯•ç»“æœæ‘˜è¦

EOF
}

# æ·»åŠ åˆ°æŠ¥å‘Š
add_to_report() {
    local severity="$1"
    local title="$2"
    local description="$3"
    local response="$4"
    
    cat >> "${REPORT_FILE}" << EOF

### ${severity}: ${title}

**æè¿°**: ${description}

**å“åº”**:
\`\`\`
${response:0:500}
\`\`\`

---
EOF
}

# =============================================================================
# 1. ä¿¡æ¯æ”¶é›†æµ‹è¯•
# =============================================================================
test_information_disclosure() {
    echo ""
    log_info "========== 1. ä¿¡æ¯æ³„éœ²æµ‹è¯• =========="
    
    # æµ‹è¯•æœåŠ¡å™¨å¤´ä¿¡æ¯
    log_test "æ£€æŸ¥ HTTP å“åº”å¤´..."
    local headers=$(curl -sI "${TARGET_URL}" 2>/dev/null)
    
    # æ£€æŸ¥ Server å¤´
    if echo "$headers" | grep -qi "Server:.*nginx"; then
        local server_version=$(echo "$headers" | grep -i "Server:" | head -1)
        if echo "$server_version" | grep -qE "nginx/[0-9]"; then
            log_warn "æœåŠ¡å™¨ç‰ˆæœ¬æ³„éœ²: $server_version"
            add_to_report "âš ï¸ ä¸­å±" "æœåŠ¡å™¨ç‰ˆæœ¬æ³„éœ²" "å“åº”å¤´æš´éœ²äº† Nginx ç‰ˆæœ¬ä¿¡æ¯" "$server_version"
        else
            log_success "æœåŠ¡å™¨å¤´æœªæš´éœ²ç‰ˆæœ¬å·"
        fi
    else
        log_success "æœªå‘ç°æœåŠ¡å™¨ä¿¡æ¯æ³„éœ²"
    fi
    
    # æ£€æŸ¥ X-Powered-By
    if echo "$headers" | grep -qi "X-Powered-By"; then
        local powered=$(echo "$headers" | grep -i "X-Powered-By")
        log_warn "X-Powered-By å¤´æ³„éœ²: $powered"
        add_to_report "âš ï¸ ä½å±" "æŠ€æœ¯æ ˆæ³„éœ²" "X-Powered-By å¤´æš´éœ²äº†åç«¯æŠ€æœ¯" "$powered"
    else
        log_success "æœªå‘ç° X-Powered-By å¤´"
    fi
    
    # æ£€æŸ¥å®‰å…¨å¤´
    log_test "æ£€æŸ¥å®‰å…¨å“åº”å¤´..."
    
    if ! echo "$headers" | grep -qi "X-Content-Type-Options"; then
        log_warn "ç¼ºå°‘ X-Content-Type-Options å¤´"
    else
        log_success "å­˜åœ¨ X-Content-Type-Options å¤´"
    fi
    
    if ! echo "$headers" | grep -qi "X-Frame-Options"; then
        log_warn "ç¼ºå°‘ X-Frame-Options å¤´"
    else
        log_success "å­˜åœ¨ X-Frame-Options å¤´"
    fi
    
    if ! echo "$headers" | grep -qi "Strict-Transport-Security"; then
        log_warn "ç¼ºå°‘ HSTS å¤´"
    else
        log_success "å­˜åœ¨ HSTS å¤´"
    fi
}

# =============================================================================
# 2. è®¤è¯å®‰å…¨æµ‹è¯•
# =============================================================================
test_authentication() {
    echo ""
    log_info "========== 2. è®¤è¯å®‰å…¨æµ‹è¯• =========="
    
    # æµ‹è¯•ç™»å½•æ¥å£
    log_test "æµ‹è¯•ç™»å½•æ¥å£å“åº”..."
    local login_resp=$(curl -s -X POST "${TARGET_URL}/api/auth/login" \
        -H "Content-Type: application/json" \
        -d '{"username":"admin","password":"wrongpassword"}' 2>/dev/null)
    
    # æ£€æŸ¥æ˜¯å¦æ³„éœ²ç”¨æˆ·å­˜åœ¨ä¿¡æ¯
    if echo "$login_resp" | grep -qi "ç”¨æˆ·ä¸å­˜åœ¨\|user not found"; then
        log_fail "ç™»å½•é”™è¯¯ä¿¡æ¯æ³„éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨"
        add_to_report "ğŸ”´ é«˜å±" "ç”¨æˆ·æšä¸¾æ¼æ´" "ç™»å½•å¤±è´¥ä¿¡æ¯å¯åŒºåˆ†ç”¨æˆ·æ˜¯å¦å­˜åœ¨" "$login_resp"
    else
        log_success "ç™»å½•é”™è¯¯ä¿¡æ¯æœªæ³„éœ²ç”¨æˆ·å­˜åœ¨çŠ¶æ€"
    fi
    
    # æµ‹è¯•æ³¨å†Œæ¥å£ï¼ˆæ— é‚€è¯·ç ï¼‰
    log_test "æµ‹è¯•æ³¨å†Œç»•è¿‡ï¼ˆæ— é‚€è¯·ç ï¼‰..."
    local register_resp=$(curl -s -X POST "${TARGET_URL}/api/auth/register" \
        -H "Content-Type: application/json" \
        -d '{"username":"pentest_user","password":"Test123!","email":"pentest@test.com"}' 2>/dev/null)
    
    if echo "$register_resp" | grep -qi "success\|æ³¨å†ŒæˆåŠŸ\|created"; then
        log_fail "å¯ç»•è¿‡é‚€è¯·ç æ³¨å†Œç”¨æˆ·ï¼"
        add_to_report "ğŸ”´ é«˜å±" "æ³¨å†Œç»•è¿‡æ¼æ´" "å¯åœ¨æ— é‚€è¯·ç æƒ…å†µä¸‹æ³¨å†Œç”¨æˆ·" "$register_resp"
    else
        log_success "æ³¨å†Œéœ€è¦é‚€è¯·ç éªŒè¯"
    fi
    
    # æµ‹è¯•å¼±å¯†ç 
    log_test "æµ‹è¯•å¼±å¯†ç ç­–ç•¥..."
    local weak_pwd_resp=$(curl -s -X POST "${TARGET_URL}/api/auth/register" \
        -H "Content-Type: application/json" \
        -d '{"username":"weakuser","password":"123456","email":"weak@test.com","invitationCode":"test"}' 2>/dev/null)
    
    if echo "$weak_pwd_resp" | grep -qi "success\|æ³¨å†ŒæˆåŠŸ"; then
        log_fail "å…è®¸ä½¿ç”¨å¼±å¯†ç æ³¨å†Œ"
        add_to_report "ğŸ”´ ä¸­å±" "å¼±å¯†ç ç­–ç•¥" "ç³»ç»Ÿå…è®¸ä½¿ç”¨ç®€å•å¯†ç " "$weak_pwd_resp"
    else
        log_success "å¼±å¯†ç è¢«æ‹’ç»"
    fi
}

# =============================================================================
# 3. SQL æ³¨å…¥æµ‹è¯•
# =============================================================================
test_sql_injection() {
    echo ""
    log_info "========== 3. SQL æ³¨å…¥æµ‹è¯• =========="
    
    local sqli_payloads=(
        "' OR '1'='1"
        "'; DROP TABLE users;--"
        "1' UNION SELECT NULL,NULL,NULL--"
        "admin'--"
        "1; SELECT * FROM users"
        "' OR 1=1#"
        "') OR ('1'='1"
    )
    
    local endpoints=(
        "/api/auth/login"
        "/api/users"
        "/api/slurm/clusters"
    )
    
    for endpoint in "${endpoints[@]}"; do
        log_test "æµ‹è¯• ${endpoint} SQL æ³¨å…¥..."
        
        for payload in "${sqli_payloads[@]}"; do
            local resp=$(curl -s -X POST "${TARGET_URL}${endpoint}" \
                -H "Content-Type: application/json" \
                -d "{\"username\":\"${payload}\",\"password\":\"test\"}" 2>/dev/null)
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®åº“é”™è¯¯æ³„éœ²
            if echo "$resp" | grep -qiE "sql|syntax|mysql|postgres|oracle|sqlite|database error|query"; then
                log_fail "SQL æ³¨å…¥å¯èƒ½å­˜åœ¨äº ${endpoint}"
                add_to_report "ğŸ”´ é«˜å±" "SQL æ³¨å…¥" "ç«¯ç‚¹ ${endpoint} å¯èƒ½å­˜åœ¨ SQL æ³¨å…¥æ¼æ´" "Payload: ${payload}\nResponse: ${resp:0:200}"
                break
            fi
        done
    done
    
    log_success "æœªå‘ç°æ˜æ˜¾çš„ SQL æ³¨å…¥æ¼æ´"
}

# =============================================================================
# 4. XSS æµ‹è¯•
# =============================================================================
test_xss() {
    echo ""
    log_info "========== 4. XSS è·¨ç«™è„šæœ¬æµ‹è¯• =========="
    
    local xss_payloads=(
        "<script>alert('XSS')</script>"
        "<img src=x onerror=alert('XSS')>"
        "javascript:alert('XSS')"
        "<svg onload=alert('XSS')>"
        "'\"><script>alert('XSS')</script>"
    )
    
    log_test "æµ‹è¯•åå°„å‹ XSS..."
    
    for payload in "${xss_payloads[@]}"; do
        local encoded_payload=$(python3 -c "import urllib.parse; print(urllib.parse.quote('${payload}'))" 2>/dev/null || echo "$payload")
        local resp=$(curl -s "${TARGET_URL}/api/search?q=${encoded_payload}" 2>/dev/null)
        
        # æ£€æŸ¥ payload æ˜¯å¦è¢«åŸæ ·è¿”å›ï¼ˆæœªè½¬ä¹‰ï¼‰
        if echo "$resp" | grep -qF "<script>"; then
            log_fail "å‘ç°æ½œåœ¨çš„ XSS æ¼æ´"
            add_to_report "ğŸ”´ é«˜å±" "XSS æ¼æ´" "å‘ç°æœªè½¬ä¹‰çš„è„šæœ¬æ ‡ç­¾" "Payload: ${payload}"
            break
        fi
    done
    
    log_success "æœªå‘ç°æ˜æ˜¾çš„ XSS æ¼æ´"
}

# =============================================================================
# 5. CORS é…ç½®æµ‹è¯•
# =============================================================================
test_cors() {
    echo ""
    log_info "========== 5. CORS é…ç½®æµ‹è¯• =========="
    
    # æµ‹è¯•æ¶æ„æ¥æº
    log_test "æµ‹è¯• CORS å¯¹æ¶æ„æ¥æºçš„å“åº”..."
    local cors_resp=$(curl -sI -X OPTIONS "${TARGET_URL}/api/auth/login" \
        -H "Origin: https://evil.com" \
        -H "Access-Control-Request-Method: POST" 2>/dev/null)
    
    local acao=$(echo "$cors_resp" | grep -i "Access-Control-Allow-Origin" | head -1)
    
    if echo "$acao" | grep -qi "evil.com"; then
        log_fail "CORS å…è®¸ä»»æ„æ¥æº (evil.com)"
        add_to_report "ğŸ”´ é«˜å±" "CORS é…ç½®é”™è¯¯" "æœåŠ¡å™¨å…è®¸æ¥è‡ªæ¶æ„åŸŸçš„è·¨åŸŸè¯·æ±‚" "$acao"
    elif echo "$acao" | grep -qF "*"; then
        log_warn "CORS ä½¿ç”¨é€šé…ç¬¦ (*)"
        add_to_report "âš ï¸ ä¸­å±" "CORS é€šé…ç¬¦" "æœåŠ¡å™¨å¯¹æ‰€æœ‰æ¥æºå¼€æ”¾ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©" "$acao"
    else
        log_success "CORS é…ç½®æ­£ç¡®ï¼Œæ‹’ç»æ¶æ„æ¥æº"
    fi
    
    # æµ‹è¯•å‡­è¯ä¸é€šé…ç¬¦ç»„åˆ
    log_test "æµ‹è¯• CORS å‡­è¯é…ç½®..."
    local creds=$(echo "$cors_resp" | grep -i "Access-Control-Allow-Credentials")
    
    if echo "$acao" | grep -qF "*" && echo "$creds" | grep -qi "true"; then
        log_fail "CORS é…ç½®å±é™©: é€šé…ç¬¦ + å‡­è¯"
        add_to_report "ğŸ”´ é«˜å±" "CORS å‡­è¯æ³„éœ²" "é€šé…ç¬¦ä¸å‡­è¯åŒæ—¶å¯ç”¨ä¼šå¯¼è‡´å®‰å…¨é—®é¢˜" "$cors_resp"
    else
        log_success "CORS å‡­è¯é…ç½®å®‰å…¨"
    fi
}

# =============================================================================
# 6. é€Ÿç‡é™åˆ¶æµ‹è¯•
# =============================================================================
test_rate_limiting() {
    echo ""
    log_info "========== 6. é€Ÿç‡é™åˆ¶æµ‹è¯• =========="
    
    log_test "æµ‹è¯•ç™»å½•æ¥å£é€Ÿç‡é™åˆ¶..."
    local blocked=false
    
    for i in {1..20}; do
        local resp=$(curl -s -w "%{http_code}" -o /dev/null -X POST "${TARGET_URL}/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"username":"ratelimit_test","password":"wrong"}' 2>/dev/null)
        
        if [[ "$resp" == "429" ]]; then
            log_success "é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆ (è¯·æ±‚ #${i} è¢«é˜»æ­¢)"
            blocked=true
            break
        fi
        
        # çŸ­æš‚å»¶è¿Ÿé¿å…è¢«é˜²ç«å¢™å°ç¦
        sleep 0.1
    done
    
    if [[ "$blocked" == "false" ]]; then
        log_warn "20 æ¬¡è¯·æ±‚æœªè§¦å‘é€Ÿç‡é™åˆ¶"
        add_to_report "âš ï¸ ä¸­å±" "é€Ÿç‡é™åˆ¶ä¸è¶³" "ç™»å½•æ¥å£å¯èƒ½ç¼ºä¹è¶³å¤Ÿçš„é€Ÿç‡é™åˆ¶" "20æ¬¡è¿ç»­è¯·æ±‚æœªè¢«é˜»æ­¢"
    fi
}

# =============================================================================
# 7. API æƒé™æµ‹è¯•
# =============================================================================
test_api_authorization() {
    echo ""
    log_info "========== 7. API æƒé™æµ‹è¯• =========="
    
    # æœªè®¤è¯è®¿é—®æµ‹è¯•
    local protected_endpoints=(
        "/api/users"
        "/api/admin/users"
        "/api/slurm/clusters"
        "/api/saltstack/keys"
        "/api/security/config"
        "/api/security/ip-blacklist"
    )
    
    for endpoint in "${protected_endpoints[@]}"; do
        log_test "æµ‹è¯•æœªè®¤è¯è®¿é—® ${endpoint}..."
        local resp=$(curl -s -w "\n%{http_code}" "${TARGET_URL}${endpoint}" 2>/dev/null)
        local status=$(echo "$resp" | tail -1)
        local body=$(echo "$resp" | head -n -1)
        
        if [[ "$status" == "200" ]]; then
            # æ£€æŸ¥æ˜¯å¦çœŸçš„è¿”å›äº†æ•æ„Ÿæ•°æ®
            if echo "$body" | grep -qiE "password|secret|token|key|user"; then
                log_fail "æœªè®¤è¯å¯è®¿é—®æ•æ„Ÿ API: ${endpoint}"
                add_to_report "ğŸ”´ é«˜å±" "æœªæˆæƒè®¿é—®" "æ•æ„Ÿ API ${endpoint} æ— éœ€è®¤è¯å³å¯è®¿é—®" "${body:0:200}"
            else
                log_warn "API ${endpoint} è¿”å› 200ï¼Œéœ€äººå·¥éªŒè¯"
            fi
        elif [[ "$status" == "401" || "$status" == "403" ]]; then
            log_success "API ${endpoint} éœ€è¦è®¤è¯"
        else
            log_info "API ${endpoint} è¿”å› ${status}"
        fi
    done
}

# =============================================================================
# 8. æ•æ„Ÿè·¯å¾„æ¢æµ‹
# =============================================================================
test_sensitive_paths() {
    echo ""
    log_info "========== 8. æ•æ„Ÿè·¯å¾„æ¢æµ‹ =========="
    
    local sensitive_paths=(
        "/.env"
        "/.git/config"
        "/config.yaml"
        "/api/debug"
        "/api/metrics"
        "/api/health"
        "/swagger"
        "/api-docs"
        "/graphql"
        "/admin/config"
        "/.well-known/security.txt"
        "/robots.txt"
        "/sitemap.xml"
        "/backup"
        "/dump.sql"
    )
    
    for path in "${sensitive_paths[@]}"; do
        local resp=$(curl -s -w "%{http_code}" -o /tmp/pentest_resp.txt "${TARGET_URL}${path}" 2>/dev/null)
        local content=$(cat /tmp/pentest_resp.txt 2>/dev/null | head -c 200)
        
        # æ£€æŸ¥æ˜¯å¦è¿”å›äº† SPA çš„ index.htmlï¼ˆå‡é˜³æ€§ï¼‰
        local is_spa_fallback=false
        if echo "$content" | grep -qi "<!doctype html>\|<html.*lang="; then
            is_spa_fallback=true
        fi
        
        if [[ "$resp" == "200" ]]; then
            case "$path" in
                "/.env"|"/.git/config"|"/config.yaml"|"/dump.sql"|"/backup")
                    if [[ "$is_spa_fallback" == "true" ]]; then
                        log_warn "æ•æ„Ÿè·¯å¾„ ${path} è¿”å› 200 (SPA fallbackï¼Œå»ºè®®è¿”å› 404)"
                        add_to_report "âš ï¸ ä¸­å±" "æ•æ„Ÿè·¯å¾„æœªé˜»æ­¢" "è·¯å¾„ ${path} è¿”å› 200ï¼Œè™½ä¸º SPA fallback ä½†åº”è¿”å› 404" "Content-Type: HTML"
                    else
                        log_fail "æ•æ„Ÿæ–‡ä»¶å¯è®¿é—®: ${path}"
                        add_to_report "ğŸ”´ é«˜å±" "æ•æ„Ÿæ–‡ä»¶æ³„éœ²" "æ–‡ä»¶ ${path} å¯è¢«ç›´æ¥è®¿é—®" "${content}"
                    fi
                    ;;
                "/api/debug"|"/api/metrics")
                    log_warn "è°ƒè¯•/ç›‘æ§ç«¯ç‚¹å¯è®¿é—®: ${path}"
                    add_to_report "âš ï¸ ä¸­å±" "è°ƒè¯•ç«¯ç‚¹æš´éœ²" "ç«¯ç‚¹ ${path} å¯è¢«è®¿é—®" "${content}"
                    ;;
                *)
                    log_info "è·¯å¾„ ${path} è¿”å› 200"
                    ;;
            esac
        elif [[ "$resp" == "403" || "$resp" == "404" ]]; then
            log_success "æ•æ„Ÿè·¯å¾„ ${path} å·²é˜»æ­¢ (${resp})"
        else
            log_info "è·¯å¾„ ${path} è¿”å› ${resp}"
        fi
    done
    
    rm -f /tmp/pentest_resp.txt
    log_success "æ•æ„Ÿè·¯å¾„æ¢æµ‹å®Œæˆ"
}

# =============================================================================
# 9. CSRF æµ‹è¯•
# =============================================================================
test_csrf() {
    echo ""
    log_info "========== 9. CSRF ä¿æŠ¤æµ‹è¯• =========="
    
    log_test "æ£€æŸ¥ CSRF Token..."
    
    # æ£€æŸ¥ç™»å½•å“åº”æ˜¯å¦è®¾ç½® CSRF cookie
    local resp=$(curl -sI "${TARGET_URL}/api/auth/login" 2>/dev/null)
    
    if echo "$resp" | grep -qi "csrf\|xsrf"; then
        log_success "å‘ç° CSRF ä¿æŠ¤æœºåˆ¶"
    else
        log_warn "æœªå‘ç°æ˜æ˜¾çš„ CSRF Token"
        add_to_report "âš ï¸ ä¸­å±" "CSRF ä¿æŠ¤" "æœªæ£€æµ‹åˆ° CSRF Token æœºåˆ¶ï¼Œéœ€äººå·¥éªŒè¯" "$resp"
    fi
    
    # æ£€æŸ¥ SameSite cookie å±æ€§
    if echo "$resp" | grep -qi "SameSite"; then
        log_success "Cookie è®¾ç½®äº† SameSite å±æ€§"
    else
        log_warn "Cookie å¯èƒ½ç¼ºå°‘ SameSite å±æ€§"
    fi
}

# =============================================================================
# 10. SSRF æµ‹è¯•
# =============================================================================
test_ssrf() {
    echo ""
    log_info "========== 10. SSRF æœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ æµ‹è¯• =========="
    
    local ssrf_payloads=(
        "http://127.0.0.1"
        "http://localhost"
        "http://169.254.169.254/latest/meta-data/"  # AWS metadata
        "http://[::1]"
        "file:///etc/passwd"
    )
    
    # æµ‹è¯•å¯èƒ½å­˜åœ¨ SSRF çš„ç«¯ç‚¹
    local ssrf_endpoints=(
        "/api/proxy?url="
        "/api/fetch?url="
        "/api/webhook?callback="
    )
    
    for endpoint in "${ssrf_endpoints[@]}"; do
        for payload in "${ssrf_payloads[@]}"; do
            log_test "æµ‹è¯• SSRF: ${endpoint}${payload}"
            local resp=$(curl -s "${TARGET_URL}${endpoint}${payload}" 2>/dev/null)
            
            if echo "$resp" | grep -qiE "root:|ec2|metadata|localhost"; then
                log_fail "å¯èƒ½å­˜åœ¨ SSRF æ¼æ´"
                add_to_report "ğŸ”´ é«˜å±" "SSRF æ¼æ´" "ç«¯ç‚¹ ${endpoint} å¯èƒ½å­˜åœ¨ SSRF" "Payload: ${payload}"
                break 2
            fi
        done
    done
    
    log_success "æœªå‘ç°æ˜æ˜¾çš„ SSRF æ¼æ´"
}

# =============================================================================
# ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
# =============================================================================
generate_final_report() {
    echo ""
    log_info "========== ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š =========="
    
    cat >> "${REPORT_FILE}" << EOF

## æµ‹è¯•ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°é‡ |
|------|------|
| æ€»æµ‹è¯•æ•° | ${TOTAL_TESTS} |
| é€šè¿‡ | ${PASSED_TESTS} |
| å¤±è´¥ | ${FAILED_TESTS} |
| è­¦å‘Š | ${WARNINGS} |

## é£é™©ç­‰çº§è¯´æ˜

- ğŸ”´ **é«˜å±**: éœ€è¦ç«‹å³ä¿®å¤
- âš ï¸ **ä¸­å±**: å»ºè®®å°½å¿«ä¿®å¤
- ğŸŸ¡ **ä½å±**: å¯åœ¨åç»­ç‰ˆæœ¬ä¿®å¤

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')*
EOF

    echo ""
    echo "=========================================="
    echo -e "${BLUE}æ¸—é€æµ‹è¯•å®Œæˆ${NC}"
    echo "=========================================="
    echo -e "æ€»æµ‹è¯•: ${TOTAL_TESTS}"
    echo -e "é€šè¿‡: ${GREEN}${PASSED_TESTS}${NC}"
    echo -e "å¤±è´¥: ${RED}${FAILED_TESTS}${NC}"
    echo -e "è­¦å‘Š: ${YELLOW}${WARNINGS}${NC}"
    echo ""
    echo -e "è¯¦ç»†æŠ¥å‘Š: ${CYAN}${REPORT_FILE}${NC}"
    echo "=========================================="
}

# =============================================================================
# ä¸»å‡½æ•°
# =============================================================================
main() {
    echo ""
    echo "=========================================="
    echo -e "${CYAN}AI-Infra-Matrix æ¸—é€æµ‹è¯•å·¥å…·${NC}"
    echo "=========================================="
    echo -e "ç›®æ ‡: ${TARGET_URL}"
    echo -e "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
    echo "=========================================="
    
    # æ£€æŸ¥ç›®æ ‡å¯è¾¾æ€§
    if ! curl -s --connect-timeout 5 "${TARGET_URL}" > /dev/null 2>&1; then
        log_error "æ— æ³•è¿æ¥åˆ°ç›®æ ‡ ${TARGET_URL}"
        exit 1
    fi
    
    init_report
    
    # è¿è¡Œæ‰€æœ‰æµ‹è¯•
    test_information_disclosure
    test_authentication
    test_sql_injection
    test_xss
    test_cors
    test_rate_limiting
    test_api_authorization
    test_sensitive_paths
    test_csrf
    test_ssrf
    
    generate_final_report
}

# è§£æå‚æ•°
while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--url)
            TARGET_URL="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        -h|--help)
            echo "ç”¨æ³•: $0 [-u URL] [-o OUTPUT_DIR]"
            echo "  -u, --url      ç›®æ ‡ URL (é»˜è®¤: https://ai-infra-matrix.top)"
            echo "  -o, --output   è¾“å‡ºç›®å½• (é»˜è®¤: ./pentest-results)"
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

main
