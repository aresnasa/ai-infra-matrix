#!/bin/bash
# =============================================================================
# Categraf Installation Script Template
# Auto-generated by AI-Infra-Matrix
# 
# Template Variables (passed via environment):
#   HOSTNAME      - Target hostname
#   HOST_IP       - Target host IP
#   N9E_HOST      - Nightingale server host
#   N9E_PORT      - Nightingale server port
#   APPHUB_URL    - AppHub URL for downloading packages (optional)
#   GITHUB_MIRROR - GitHub mirror URL (optional)
#   CATEGRAF_VERSION - Categraf version (from env or config)
# =============================================================================

set -e

# Validate required variables
: "${HOSTNAME:?HOSTNAME is required}"
: "${HOST_IP:?HOST_IP is required}"
: "${N9E_HOST:?N9E_HOST is required}"
: "${N9E_PORT:?N9E_PORT is required}"

# Use environment variable for version, fallback to config
CATEGRAF_VERSION="${CATEGRAF_VERSION:-{{.CategrafVersion}}}"

echo "=========================================="
echo "Installing Categraf Monitoring Agent"
echo "=========================================="
echo "Hostname: ${HOSTNAME}"
echo "Host IP: ${HOST_IP}"
echo "Nightingale: ${N9E_HOST}:${N9E_PORT}"
echo "Version: ${CATEGRAF_VERSION}"
echo ""

# Detect architecture
detect_arch() {
    local arch=$(uname -m)
    case $arch in
        x86_64|amd64) echo "amd64" ;;
        aarch64|arm64) echo "arm64" ;;
        *) echo "Unsupported architecture: $arch" >&2; exit 1 ;;
    esac
}

ARCH=$(detect_arch)
echo "Detected architecture: ${ARCH}"

# Determine download URL
PACKAGE_NAME="categraf-${CATEGRAF_VERSION}-linux-${ARCH}.tar.gz"

if [ -n "${APPHUB_URL}" ]; then
    DOWNLOAD_URL="${APPHUB_URL}/pkgs/categraf/${PACKAGE_NAME}"
    echo "Using AppHub: ${DOWNLOAD_URL}"
elif [ -n "${GITHUB_MIRROR}" ]; then
    DOWNLOAD_URL="${GITHUB_MIRROR}/https://github.com/flashcatcloud/categraf/releases/download/${CATEGRAF_VERSION}/${PACKAGE_NAME}"
    echo "Using GitHub Mirror: ${DOWNLOAD_URL}"
else
    DOWNLOAD_URL="https://github.com/flashcatcloud/categraf/releases/download/${CATEGRAF_VERSION}/${PACKAGE_NAME}"
    echo "Using GitHub: ${DOWNLOAD_URL}"
fi

# Download and extract
echo ""
echo "Downloading Categraf..."
cd /tmp
if ! curl -fsSL -o "${PACKAGE_NAME}" "${DOWNLOAD_URL}"; then
    echo "ERROR: Failed to download Categraf from ${DOWNLOAD_URL}"
    exit 1
fi

echo "Extracting..."
tar xzf "${PACKAGE_NAME}"

# Find extracted directory
EXTRACT_DIR=$(ls -d categraf-* 2>/dev/null | head -1)
if [ -z "${EXTRACT_DIR}" ]; then
    EXTRACT_DIR="categraf"
fi
cd "${EXTRACT_DIR}" 2>/dev/null || { echo "ERROR: Cannot find extracted directory"; exit 1; }

# Install binaries
INSTALL_DIR="/usr/local/categraf"
echo "Installing to ${INSTALL_DIR}..."

mkdir -p ${INSTALL_DIR}/{bin,conf,logs}

if [ -f bin/categraf ]; then
    cp bin/categraf ${INSTALL_DIR}/bin/
elif [ -f categraf ]; then
    cp categraf ${INSTALL_DIR}/bin/
else
    echo "ERROR: Cannot find categraf binary"
    exit 1
fi
chmod +x ${INSTALL_DIR}/bin/categraf

# Copy default configs if exist
[ -d conf ] && cp -r conf/* ${INSTALL_DIR}/conf/ 2>/dev/null || true

# Create main configuration
echo "Creating configuration..."
cat > ${INSTALL_DIR}/conf/config.toml << CATEOF
# Categraf Configuration
# Auto-generated by AI-Infra-Matrix

[global]
hostname = "${HOSTNAME}"
interval = 15
omit_hostname = false

[global.labels]
ip = "${HOST_IP}"

[heartbeat]
enable = true
interval = 10

[log]
file_name = "${INSTALL_DIR}/logs/categraf.log"
level = "info"
max_size = 50
max_backups = 5
max_age = 7
compress = true

[[writers]]
url = "http://${N9E_HOST}:${N9E_PORT}/prometheus/v1/write"
timeout = 10
dial_timeout = 3
max_idle_conns_per_host = 100
CATEOF

# Create systemd service
echo "Creating systemd service..."
cat > /etc/systemd/system/categraf.service << EOF
[Unit]
Description=Categraf Monitoring Agent
Documentation=https://github.com/flashcatcloud/categraf
Wants=network-online.target
After=network-online.target

[Service]
Type=simple
ExecStart=${INSTALL_DIR}/bin/categraf --config ${INSTALL_DIR}/conf/config.toml
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=5
WorkingDirectory=${INSTALL_DIR}
StandardOutput=journal
StandardError=journal
SyslogIdentifier=categraf

[Install]
WantedBy=multi-user.target
EOF

# Enable and start service
echo "Starting service..."
systemctl daemon-reload
systemctl enable categraf
systemctl start categraf

# Verify
sleep 2
if systemctl is-active categraf > /dev/null 2>&1; then
    echo ""
    echo "âœ“ Categraf installed and running successfully!"
else
    echo ""
    echo "WARNING: Categraf service may not be running. Check: journalctl -u categraf"
fi

# Cleanup
cd /tmp
rm -rf categraf-* *.tar.gz 2>/dev/null || true

echo ""
echo "=========================================="
echo "Installation Complete"
echo "=========================================="
echo "Configuration: ${INSTALL_DIR}/conf/config.toml"
echo "Logs: ${INSTALL_DIR}/logs/"
echo "Service: systemctl status categraf"
echo ""
