<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLURM API 测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .task { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 5px; 
            background-color: #f9f9f9;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #4CAF50;
            transition: width 0.3s ease;
        }
        .error { color: red; }
        .success { color: green; }
        button { padding: 10px 15px; margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>SLURM 任务栏测试</h1>
        
        <div>
            <button onclick="login()">登录</button>
            <button onclick="loadTasks()">加载任务</button>
            <button onclick="loadSummary()">加载摘要</button>
        </div>
        
        <div id="status"></div>
        
        <h2>当前任务</h2>
        <div id="tasks"></div>
        
        <h2>集群摘要</h2>
        <div id="summary"></div>
    </div>

    <script>
        let authToken = '';
        
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.innerHTML = `<p class="${isError ? 'error' : 'success'}">${message}</p>`;
        }
        
        async function login() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                if (data.token) {
                    authToken = data.token;
                    updateStatus('登录成功！');
                } else {
                    updateStatus('登录失败: ' + JSON.stringify(data), true);
                }
            } catch (error) {
                updateStatus('登录错误: ' + error.message, true);
            }
        }
        
        async function loadTasks() {
            if (!authToken) {
                updateStatus('请先登录', true);
                return;
            }
            
            try {
                const response = await fetch('/api/slurm/tasks', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                displayTasks(data.data.tasks || []);
                updateStatus(`加载了 ${data.data.tasks?.length || 0} 个任务`);
            } catch (error) {
                updateStatus('加载任务失败: ' + error.message, true);
            }
        }
        
        async function loadSummary() {
            if (!authToken) {
                updateStatus('请先登录', true);
                return;
            }
            
            try {
                const response = await fetch('/api/slurm/summary', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                displaySummary(data.data || {});
                updateStatus('摘要加载成功');
            } catch (error) {
                updateStatus('加载摘要失败: ' + error.message, true);
            }
        }
        
        function displayTasks(tasks) {
            const container = document.getElementById('tasks');
            if (tasks.length === 0) {
                container.innerHTML = '<p>暂无任务</p>';
                return;
            }
            
            const html = tasks.map(task => {
                const progress = Math.round((task.progress || 0) * 100);
                const startedAt = task.started_at ? new Date(task.started_at * 1000).toLocaleString() : '未知';
                
                return `
                    <div class="task">
                        <h3>${task.name} (${task.id})</h3>
                        <p><strong>状态:</strong> ${task.status}</p>
                        <p><strong>进度:</strong> ${progress}%</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <p><strong>当前步骤:</strong> ${task.current_step || '无'}</p>
                        <p><strong>开始时间:</strong> ${startedAt}</p>
                        <p><strong>最新消息:</strong> ${task.last_message || '无'}</p>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function displaySummary(summary) {
            const container = document.getElementById('summary');
            container.innerHTML = `
                <p><strong>总节点数:</strong> ${summary.nodes_total || 0}</p>
                <p><strong>空闲节点:</strong> ${summary.nodes_idle || 0}</p>
                <p><strong>分配节点:</strong> ${summary.nodes_alloc || 0}</p>
                <p><strong>运行作业:</strong> ${summary.jobs_running || 0}</p>
                <p><strong>等待作业:</strong> ${summary.jobs_pending || 0}</p>
                <p><strong>分区数:</strong> ${summary.partitions || 0}</p>
                <p><strong>演示模式:</strong> ${summary.demo ? '是' : '否'}</p>
            `;
        }
        
        // 自动登录
        window.onload = () => {
            login().then(() => {
                setTimeout(() => {
                    loadTasks();
                    loadSummary();
                }, 500);
            });
        };
        
        // 自动刷新任务
        setInterval(() => {
            if (authToken) {
                loadTasks();
            }
        }, 10000); // 每10秒刷新
    </script>
</body>
</html>