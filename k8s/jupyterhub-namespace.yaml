apiVersion: v1
kind: Namespace
metadata:
  name: jupyterhub-jobs
  labels:
    purpose: jupyterhub-gpu-jobs
    created-by: ai-infra-matrix

---
# NFS存储类
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: WaitForFirstConsumer

---
# NFS PersistentVolume
apiVersion: v1
kind: PersistentVolume
metadata:
  name: jupyterhub-nfs-pv
  labels:
    type: nfs
spec:
  capacity:
    storage: 100Gi
  accessModes:
    - ReadWriteMany
  nfs:
    server: nfs-server.default.svc.cluster.local
    path: "/shared"
  persistentVolumeReclaimPolicy: Retain

---
# NFS PersistentVolumeClaim
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jupyterhub-nfs-pvc
  namespace: jupyterhub-jobs
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 100Gi
  selector:
    matchLabels:
      type: nfs

---
# GPU节点标签配置
apiVersion: v1
kind: ConfigMap
metadata:
  name: gpu-node-config
  namespace: jupyterhub-jobs
data:
  nvidia-gpu-nodes.yaml: |
    nodes:
      - name: gpu-node-1
        gpu_type: "RTX 4090"
        gpu_count: 2
        labels:
          accelerator: nvidia
          gpu-type: rtx4090
      - name: gpu-node-2
        gpu_type: "Tesla V100"
        gpu_count: 4
        labels:
          accelerator: nvidia
          gpu-type: v100
  
  node-taints.yaml: |
    taints:
      - key: "nvidia.com/gpu"
        value: "present"
        effect: "NoSchedule"
      - key: "dedicated"
        value: "gpu-workload"
        effect: "NoSchedule"

---
# RBAC权限配置
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jupyterhub-job-manager
  namespace: jupyterhub-jobs

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: jupyterhub-job-manager
rules:
  # Job管理权限
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  
  # Pod管理权限
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch", "delete"]
  
  # Pod日志查看权限
  - apiGroups: [""]
    resources: ["pods/log"]
    verbs: ["get", "list"]
  
  # 节点查看权限
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  
  # 资源配额查看权限
  - apiGroups: [""]
    resources: ["resourcequotas"]
    verbs: ["get", "list", "watch"]
  
  # 事件查看权限
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: jupyterhub-job-manager
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: jupyterhub-job-manager
subjects:
  - kind: ServiceAccount
    name: jupyterhub-job-manager
    namespace: jupyterhub-jobs

---
# 资源配额限制
apiVersion: v1
kind: ResourceQuota
metadata:
  name: jupyterhub-jobs-quota
  namespace: jupyterhub-jobs
spec:
  hard:
    # Pod数量限制
    pods: "50"
    # Job数量限制
    count/jobs.batch: "20"
    # GPU资源限制
    nvidia.com/gpu: "16"
    # CPU限制
    requests.cpu: "100"
    limits.cpu: "200"
    # 内存限制
    requests.memory: "200Gi"
    limits.memory: "400Gi"
    # 存储限制
    requests.storage: "1Ti"

---
# 网络策略
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: jupyterhub-jobs-netpol
  namespace: jupyterhub-jobs
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
  
  # 入站规则
  ingress:
    # 允许同命名空间内的通信
    - from:
        - namespaceSelector:
            matchLabels:
              name: jupyterhub-jobs
    
    # 允许来自主应用的访问
    - from:
        - namespaceSelector:
            matchLabels:
              name: default
        - podSelector:
            matchLabels:
              app: ai-infra-matrix
  
  # 出站规则
  egress:
    # 允许DNS解析
    - to: []
      ports:
        - protocol: UDP
          port: 53
    
    # 允许访问NFS服务器
    - to:
        - namespaceSelector:
            matchLabels:
              name: default
        - podSelector:
            matchLabels:
              app: nfs-server
    
    # 允许访问外部网络(pip安装等)
    - to: []
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443

---
# Pod安全策略
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: jupyterhub-jobs-psp
spec:
  privileged: false
  allowPrivilegeEscalation: false
  
  # 用户和组设置
  runAsUser:
    rule: 'MustRunAsNonRoot'
  
  # 文件系统设置
  fsGroup:
    rule: 'RunAsAny'
  
  # 卷类型限制
  volumes:
    - 'configMap'
    - 'emptyDir'
    - 'projected'
    - 'secret'
    - 'downwardAPI'
    - 'persistentVolumeClaim'
    - 'nfs'
  
  # 网络设置
  hostNetwork: false
  hostIPC: false
  hostPID: false
  
  # SELinux设置
  seLinux:
    rule: 'RunAsAny'
