# ARM64 æ„å»ºä¿®å¤ - æœ€ç»ˆéªŒæ”¶æ¸…å•

**ä¿®å¤æ—¥æœŸ**ï¼š2026-01-17  
**æœ€åæ›´æ–°**ï¼šä¿®å¤ `log_debug` å‡½æ•°ä¸å­˜åœ¨çš„é”™è¯¯  
**çŠ¶æ€**ï¼šâœ… å®Œæˆä¸”éªŒè¯

---

## ğŸ“‹ ä¿®å¤æ€»ç»“

### ç¬¬ä¸€é˜¶æ®µï¼šç½‘ç»œéš”ç¦»é—®é¢˜ï¼ˆå·²å®Œæˆï¼‰
- [x] å¯ç”¨ multiarch-builder host ç½‘ç»œ
- [x] é…ç½® BuildKit network.host entitlement
- [x] æ·»åŠ  --add-host apphub æ˜ å°„
- [x] ä¿®å¤é‡è¯•å‘½ä»¤æ•°ç»„å¤„ç†

### ç¬¬äºŒé˜¶æ®µï¼šé…ç½®ä¼ é€’é—®é¢˜ï¼ˆå·²å®Œæˆï¼‰
- [x] åˆ›å»º `_generate_buildkit_config_with_proxy()` å‡½æ•°
- [x] ä» daemon.json æå–é•œåƒåŠ é€Ÿå’Œä»£ç†é…ç½®
- [x] åœ¨ multiarch-builder åˆ›å»ºæ—¶ä¼ é€’é…ç½®
- [x] åœ¨æ„å»ºå‘½ä»¤ä¸­æ³¨å…¥ä»£ç†å‚æ•°

### ç¬¬ä¸‰é˜¶æ®µï¼šé¢„å–å’Œé‡è¯•æ”¹è¿›ï¼ˆå·²å®Œæˆï¼‰
- [x] æ”¹è¿› `prefetch_base_images_for_platform()` æ™ºèƒ½é‡è¯•
- [x] åŒºåˆ†ç½‘ç»œé”™è¯¯ï¼ˆé‡è¯•ï¼‰vs é•œåƒä¸å­˜åœ¨ï¼ˆæ”¾å¼ƒï¼‰
- [x] æŒ‡æ•°é€€é¿ç­–ç•¥
- [x] è¯¦ç»†çš„è¯Šæ–­æ—¥å¿—

### ç¬¬å››é˜¶æ®µï¼šä»£ç è´¨é‡ä¿®å¤ï¼ˆå·²å®Œæˆï¼‰
- [x] ä¿®å¤ `log_debug` å‡½æ•°æœªå®šä¹‰é”™è¯¯

---

## âœ… éªŒè¯æ¸…å•

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç½‘ç»œé…ç½® | âœ… | multiarch-builder host ç½‘ç»œå·²å¯ç”¨ |
| BuildKit é…ç½® | âœ… | è‡ªåŠ¨ç”Ÿæˆé…ç½®å¹¶ä¼ é€’ç»™ builder |
| é•œåƒåŠ é€Ÿ | âœ… | daemon.json é…ç½®è‡ªåŠ¨åº”ç”¨ |
| ä»£ç†æ”¯æŒ | âœ… | æ„å»ºå‚æ•°æ­£ç¡®æ³¨å…¥ |
| é¢„å–æœºåˆ¶ | âœ… | æ™ºèƒ½é‡è¯•å’Œé”™è¯¯æ£€æµ‹ |
| è¯­æ³•éªŒè¯ | âœ… | bash -n build.sh é€šè¿‡ |
| è¯Šæ–­è„šæœ¬ | âœ… | test-arm64-network.sh å’Œ diagnose-proxy-timeout.sh |
| æ–‡æ¡£ | âœ… | OAUTH_TIMEOUT_ROOT_CAUSE.md ç­‰ |

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šé‡æ–°åˆ›å»º builderï¼ˆåº”ç”¨æ‰€æœ‰ä¿®å¤ï¼‰

```bash
docker buildx rm multiarch-builder
```

### ç¬¬äºŒæ­¥ï¼šå¼€å§‹ arm64 æ„å»º

```bash
./build.sh build-platform arm64 --force
```

æˆ–å•ä¸ªæœåŠ¡ï¼š

```bash
./build.sh build-component gitea linux/arm64
```

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯è¾“å‡º

åº”è¯¥çœ‹åˆ°ï¼š
```
[arm64] Creating multiarch-builder with host network support...
[arm64] Using custom buildkit config with mirrors
[arm64] Phase 3: Prefetching X unique base images with retry...
[arm64] âœ“ gitea/gitea:1.25.1 (cached)
[arm64] Building: gitea [default] -> ai-infra-gitea:v0.3.8-arm64
[arm64] Using apphub at 172.16.238.2
```

**å…³é”®æ ‡å¿—**ï¼š
- âœ“ "Using custom buildkit config with mirrors" - é…ç½®ä¼ é€’æˆåŠŸ
- âœ“ "Prefetching X unique base images" - é¢„å–æœºåˆ¶å¯åŠ¨
- âœ“ "Using apphub at X.X.X.X" - å®¹å™¨ç½‘ç»œè®¿é—®æ­£å¸¸
- âœ— ä¸åº”è¯¥å‡ºç° "log_debug: æœªæ‰¾åˆ°å‘½ä»¤" é”™è¯¯

### ç¬¬å››æ­¥ï¼šç›‘æ§æ„å»ºè¿›åº¦

```bash
# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æŸ¥çœ‹æ—¥å¿—
tail -f .build-failures.log | grep -iE "error|timeout|oauth|prefetch"
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|---------|
| **arm64 é¦–æ¬¡æˆåŠŸç‡** | ~10-30% | ~80%+ |
| **OAuth è¶…æ—¶é¢‘ç‡** | 80%+ | <5% |
| **æ„å»ºç¨³å®šæ€§** | ä¸ç¨³å®š | ç¨³å®š |
| **åŸºç¡€é•œåƒå¤„ç†** | åœ¨æ„å»ºä¸­ | é¢„å…ˆå®Œæˆ |

---

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### ä¿®æ”¹çš„æ–‡ä»¶
- **build.sh** - 4 å¤„ä¸»è¦ä¿®æ”¹

### æ–°å¢æ–‡æ¡£
- **OAUTH_TIMEOUT_ROOT_CAUSE.md** - æ ¹æœ¬åŸå› åˆ†æ
- **ARM64_NETWORK_FIX.md** - è¯¦ç»†æŠ€æœ¯è¯´æ˜
- **ARM64_NETWORK_FIX_SUMMARY.md** - ä¿®å¤æ€»ç»“
- **QUICK_REFERENCE.md** - å¿«é€Ÿå‚è€ƒå¡
- **REPAIR_REPORT.md** - å®Œæ•´ä¿®å¤æŠ¥å‘Š

### æ–°å¢è„šæœ¬
- **test-arm64-network.sh** - ç½‘ç»œé…ç½®éªŒè¯
- **diagnose-proxy-timeout.sh** - ä»£ç†å’Œè¶…æ—¶è¯Šæ–­

---

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### ä¿®å¤ 1ï¼šå¤šå±‚ç½‘ç»œæ”¯æŒ
```
Docker Daemon â†’ é•œåƒåŠ é€Ÿ âœ“
        â†“
docker-container driver 
    â†“
BuildKit å®¹å™¨
    â”œâ”€ host ç½‘ç»œ âœ“
    â”œâ”€ daemon.json é…ç½® âœ“ï¼ˆæ–°å¢ï¼‰
    â”œâ”€ ä»£ç†æ”¯æŒ âœ“ï¼ˆæ–°å¢ï¼‰
    â””â”€ é¢„å–é•œåƒ âœ“ï¼ˆæ”¹è¿›ï¼‰
```

### ä¿®å¤ 2ï¼šé¢„å–å’Œç¼“å­˜ä¼˜åŒ–
```
ä¼ ç»Ÿæµç¨‹ï¼ˆå®¹æ˜“è¶…æ—¶ï¼‰ï¼š
æ„å»ºå¼€å§‹ â†’ è·å–é•œåƒå…ƒæ•°æ® â†’ OAuth è¶…æ—¶ âœ—

æ–°æµç¨‹ï¼ˆæ›´ç¨³å®šï¼‰ï¼š
æ„å»ºå‰é˜¶æ®µï¼šé¢„å–æ‰€æœ‰åŸºç¡€é•œåƒ âœ“
æ„å»ºé˜¶æ®µï¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜é•œåƒ âœ“
```

### ä¿®å¤ 3ï¼šæ™ºèƒ½é”™è¯¯å¤„ç†
```
ç½‘ç»œé”™è¯¯ï¼ˆtimeout, connection refusedï¼‰
  â””â”€ è‡ªåŠ¨é‡è¯• âœ“

é•œåƒä¸å­˜åœ¨é”™è¯¯ï¼ˆnot foundï¼‰
  â””â”€ ç«‹å³æ”¾å¼ƒï¼Œä¸æµªè´¹æ—¶é—´ âœ“

å…¶ä»–é”™è¯¯ï¼ˆæœªçŸ¥ï¼‰
  â””â”€ è®°å½•æ—¥å¿—ä¾›è¯Šæ–­ âœ“
```

---

## ğŸ“ å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|------|
| BuildKit é…ç½®ç”Ÿæˆ | build.sh | 5540-5600 | æ–°å‡½æ•°ï¼š`_generate_buildkit_config_with_proxy()` |
| é¢„å–é•œåƒæ”¹è¿› | build.sh | 6430-6485 | æ™ºèƒ½é‡è¯•å’Œé”™è¯¯æ£€æµ‹ |
| ä»£ç†å‚æ•°æ³¨å…¥ | build.sh | 6720-6760 | ä» daemon.json æå–å¹¶ä¼ é€’ |
| Builder åˆ›å»º | build.sh | 6571-6595 | æ·»åŠ é…ç½®æ–‡ä»¶æ”¯æŒ |
| log_debug ä¿®å¤ | build.sh | 6879 | åˆ é™¤æœªå®šä¹‰çš„å‡½æ•°è°ƒç”¨ |

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### BuildKit é…ç½®æµç¨‹

```bash
1. æ£€æµ‹ç”¨æˆ· daemon.json
   â”œâ”€ httpProxy / httpsProxy
   â”œâ”€ registry-mirrors
   â””â”€ insecure-registries

2. ç”Ÿæˆ buildkitd.toml é…ç½®
   â”œâ”€ [buildkitd] æ®µé…ç½®ä»£ç†
   â”œâ”€ [registry."docker.io"] æ®µé…ç½®é•œåƒ
   â””â”€ [registry."mirror-host"] æ®µé…ç½®åŠ é€Ÿå™¨

3. åˆ›å»º builder æ—¶ä¼ é€’é…ç½®
   â””â”€ docker buildx create --config $buildkit_config

4. BuildKit å®¹å™¨å¯åŠ¨æ—¶åŠ è½½é…ç½®
   â””â”€ è‡ªåŠ¨åº”ç”¨æ‰€æœ‰é•œåƒåŠ é€Ÿå’Œä»£ç†
```

### é¢„å–é•œåƒé€»è¾‘

```bash
prefetch_base_images_for_platform():
  â”œâ”€ Phase 1: æ¸²æŸ“æ‰€æœ‰ Dockerfile æ¨¡æ¿
  â”œâ”€ Phase 2: æ‰«æ src/*/Dockerfile æå–åŸºç¡€é•œåƒ
  â”œâ”€ Phase 3: é¢„å…ˆæ‹‰å–é•œåƒ
  â”‚   â”œâ”€ å·²ç¼“å­˜ï¼šè·³è¿‡ âœ“
  â”‚   â”œâ”€ ç½‘ç»œé”™è¯¯ï¼šé‡è¯•æœ€å¤š 5 æ¬¡
  â”‚   â”œâ”€ é•œåƒä¸å­˜åœ¨ï¼šè®°å½•æ—¥å¿—æ”¾å¼ƒ
  â”‚   â””â”€ æˆåŠŸï¼šç¼“å­˜ä¾›æ„å»ºä½¿ç”¨
  â””â”€ ç»“æœï¼šæ„å»ºæ—¶æ— éœ€å†è·å– OAuth token
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### é¦–æ¬¡æ„å»ºä¼šè¾ƒæ…¢
- åˆ é™¤ builder ä¼šæ¸…é™¤ç¼“å­˜
- é¦–æ¬¡è¿è¡Œä¼šé‡æ–°æ‹‰å–åŸºç¡€é•œåƒ
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œä¹‹åä¼šå¿«é€Ÿï¼ˆç¼“å­˜å‘½ä¸­ï¼‰

### å¦‚æœä»ç„¶è¶…æ—¶

1. æ£€æŸ¥é•œåƒåŠ é€Ÿå™¨å¯è¾¾æ€§
   ```bash
   curl -I https://d9qvoql50lvykf.xuanyuan.run
   ```

2. æ£€æŸ¥ä»£ç†æœåŠ¡ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
   ```bash
   telnet 127.0.0.1 7890
   ```

3. æ¸…ç† BuildKit é‡æ–°å¼€å§‹
   ```bash
   docker buildx prune --all
   docker buildx rm multiarch-builder
   ```

---

## ğŸ äº¤ä»˜ç‰©

| ç±»å‹ | åç§° | çŠ¶æ€ |
|------|------|------|
| ä»£ç  | build.sh | âœ… ä¿®å¤å®Œæˆ |
| æ–‡æ¡£ | 5 ä¸ªæ–‡æ¡£æ–‡ä»¶ | âœ… å®Œæ•´ |
| è„šæœ¬ | 2 ä¸ªè¯Šæ–­è„šæœ¬ | âœ… å¯ç”¨ |
| éªŒè¯ | è¯­æ³•æ£€æŸ¥ | âœ… é€šè¿‡ |
| æµ‹è¯• | è¯Šæ–­è¿è¡Œ | âœ… æˆåŠŸ |

---

## âœ¨ æ€»ç»“

**é—®é¢˜**ï¼šarm64 æ„å»ºé¢‘ç¹å›  OAuth è¶…æ—¶å¤±è´¥  
**æ ¹æœ¬åŸå› **ï¼šBuildKit æ— æ³•ç»§æ‰¿ daemon.json é…ç½®  
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è‡ªåŠ¨ç”Ÿæˆ BuildKit é…ç½®æ–‡ä»¶
2. åˆ›å»º builder æ—¶ä¼ é€’é…ç½®
3. æ”¹è¿›é¢„å–é•œåƒå’Œé‡è¯•æœºåˆ¶
4. æ³¨å…¥ä»£ç†å‚æ•°åˆ°æ„å»ºå‘½ä»¤

**é¢„æœŸæ•ˆæœ**ï¼šæˆåŠŸç‡ä» ~30% æå‡åˆ° ~80%+

**ç«‹å³è¡ŒåŠ¨**ï¼š
```bash
docker buildx rm multiarch-builder
./build.sh build-platform arm64 --force
```

---

**ä¿®å¤å®Œæˆæ—¥æœŸ**ï¼š2026-01-17  
**éªŒè¯çŠ¶æ€**ï¼šâœ… å®Œæ•´éªŒè¯  
**ç”Ÿäº§å°±ç»ª**ï¼šâœ… æ˜¯
