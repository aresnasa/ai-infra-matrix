events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    # Docker 内置DNS解析器，支持运行时解析容器域名
    resolver 127.0.0.11 ipv6=off;
    
    # 字符集设置
    charset utf-8;
    source_charset utf-8;

    # WebSocket 连接升级映射
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Backend upstream - 支持分布式部署
    upstream backend {
        # 支持环境变量配置后端节点
        # 默认: ai-infra-backend:8082 (Docker Compose)
        # 分布式: BACKEND_HOST:BACKEND_PORT
        server ai-infra-backend:8082;
        keepalive 32;
    }

    # JupyterHub 动态上游地址（使用变量避免启动时解析失败）
    # 默认使用 jupyterhub:8000；可通过代理层环境变量替换生成模板
    map $host $jhub_upstream {
        default "jupyterhub:8000";
    }

    # Frontend upstream - 支持分布式部署
    upstream frontend {
        # 支持环境变量配置前端节点
        # 默认: ai-infra-frontend:80 (Docker Compose)
        # 分布式: FRONTEND_HOST:FRONTEND_PORT
        server ai-infra-frontend:80;
        keepalive 32;
    }

    # 分布式部署支持：动态主机变量
    map $http_host $external_host {
        default $http_host;
        # 如果是内部容器访问，使用外部主机
        "~^ai-infra-nginx" $http_x_forwarded_host;
    }

    map $http_x_forwarded_proto $external_scheme {
        default $scheme;
        https https;
        http http;
    }

    server {
        listen 80;
        server_name localhost _;  # 支持任意主机名的分布式访问
        
        # 分布式部署优化：相对重定向避免主机/端口问题
        absolute_redirect off;
        
        # 分布式安全头设置
        add_header X-Frame-Options SAMEORIGIN always;
        add_header X-Content-Type-Options nosniff always;
        add_header X-XSS-Protection "1; mode=block" always;

        # 设置最大请求体大小
        client_max_body_size 100M;

        # SSO单点登录桥接页面
        location /sso/ {
            alias /usr/share/nginx/html/sso/;
            index jwt_sso_bridge.html;
            try_files $uri $uri/ jwt_sso_bridge.html;
        }
        
        location = /sso {
            return 301 /sso/;
        }

        # 调试工具页面
        location /debug/ {
            alias /usr/share/nginx/html/debug/;
            index index.html;
            try_files $uri $uri/ =404;
            
            # 调试页面头部设置
            add_header Content-Type "text/html; charset=utf-8";
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # JupyterHub 入口 - 直接重定向到SSO登录
        location = /jupyterhub {
            # 直接重定向到SSO登录，带回调参数
            return 302 /sso/?redirect_uri=/jupyterhub-authenticated;
        }
        
        # JupyterHub 认证后的入口 - 跳转到认证桥接，便于附加token
        location = /jupyterhub-authenticated {
            return 302 /jupyterhub-auth-bridge?target_url=/jupyter/hub/;
        }
        
        # JupyterHub 认证桥接页面（备用）
        location = /jupyterhub-auth-bridge {
            alias /usr/share/nginx/html/jupyterhub/jupyterhub_auth_bridge.html;
            add_header Content-Type "text/html; charset=utf-8";
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
            
            # 安全头
            add_header X-Frame-Options SAMEORIGIN;
            add_header X-Content-Type-Options nosniff;
        }
        
        # JupyterHub 认证成功后的直接访问 - 带token参数
        location /jupyterhub-direct {
            # 去掉路径前缀，直接代理到JupyterHub
            rewrite ^/jupyterhub-direct(.*) /jupyter/hub$1 break;
            proxy_pass http://$jhub_upstream;
            
            # 代理头设置
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Cookie $http_cookie;
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # 长连接支持
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
        }
        
        # JupyterHub 根路径重定向
        location = /jupyterhub/ {
            return 301 /jupyterhub;
        }

        # JupyterHub 核心服务代理 - 统一入口点
        location = /jupyter {
            return 301 /jupyterhub;
        }

    # JupyterHub hub页面 - 由通用 /jupyter/ 代理处理，避免重定向循环
    # 注意：不要为 /jupyter/hub/ 设置重定向，否则会与 auto-login 流程形成循环

        # JupyterHub 登录页面 - 重定向到SSO
        location = /jupyter/hub/login {
            # 如果访问登录页面，重定向到SSO进行认证
            return 302 /sso/?redirect_uri=/jupyterhub-authenticated;
        }

        # JupyterHub 完整代理配置 - 直接代理，无路径重写
    location /jupyter/ {
            # 检查是否有认证token参数，如果有则设置认证header
            set $auth_header "";
            if ($arg_auth_token) {
                set $auth_header "Bearer $arg_auth_token";
            }
            
            # 直接代理到JupyterHub，保持路径不变
            proxy_pass http://$jhub_upstream/jupyter/;
            
            # 基础代理头
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # 认证头部转发 - 优先使用token参数
            proxy_set_header Authorization $auth_header;
            proxy_set_header Cookie $http_cookie;
            
            # 如果有token参数，添加到Cookie中实现自动登录
            if ($arg_auth_token) {
                add_header Set-Cookie "token=$arg_auth_token; Path=/; HttpOnly" always;
            }
            
            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            
            # 长连接和流式支持
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            
            # 修改CSP头以允许iframe嵌入
            proxy_hide_header Content-Security-Policy;
            add_header Content-Security-Policy "frame-ancestors 'self' http://localhost:8080 https://localhost:8443;" always;
            
            # 重定向处理 - 确保重定向URL正确
            proxy_redirect ~^http://[^/]+/jupyter/(.*)$ /jupyter/$1;
        }

        # 处理根路径的favicon
        location = /favicon.ico {
            proxy_pass http://$jhub_upstream/favicon.ico;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # JWT 自动登录页面
        location /jwt-login {
            alias /usr/share/nginx/html/jwt_login.html;
            try_files $uri $uri/ =404;
        }

        # 后端API代理 - 分布式部署支持
        location /api/ {
            proxy_pass http://backend/api/;
            
            # 分布式部署代理头
            proxy_set_header Host $http_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $external_scheme;
            proxy_set_header X-Forwarded-Host $external_host;
            proxy_set_header X-External-Host $external_host;
            
            # SSO认证支持
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Cookie $http_cookie;

            # 分布式CORS支持 - 动态Origin
            set $cors_origin "*";
            if ($http_origin ~ ^https?://(.*\.)?(localhost|[\d\.]+)(:\d+)?$) {
                set $cors_origin $http_origin;
            }
            
            add_header Access-Control-Allow-Origin $cors_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-External-Host" always;
            add_header Access-Control-Allow-Credentials "true" always;

            # 处理OPTIONS请求
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin $cors_origin always;
                add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-External-Host" always;
                add_header Access-Control-Allow-Credentials "true" always;
                return 204;
            }
        }



        # 测试页面 - 必须在前端路由之前
        location = /test_auth.html {
            root /usr/share/nginx/html;
            add_header Content-Type "text/html; charset=utf-8";
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # 调试页面
        location = /debug_auth.html {
            root /usr/share/nginx/html;
            add_header Content-Type "text/html; charset=utf-8";
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # Token设置页面
        location = /token_setup.html {
            root /usr/share/nginx/html;
            add_header Content-Type text/html;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # 前端应用代理
        location / {
            proxy_pass http://frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 静态资源缓存
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                proxy_pass http://frontend;
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # 健康检查端点
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}