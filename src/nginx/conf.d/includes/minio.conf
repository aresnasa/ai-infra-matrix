# MinIO Object Storage Configuration
# This file handles MinIO API and Console routing

# MinIO S3 API 路由 (用于API访问)
location ^~ /minio/ {
    # S3 API 直通代理，不做前缀重写，避免破坏客户端行为
    # 隐藏与浏览器相关的安全头（非必须，防御性处理）
    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;
    
    proxy_pass http://minio_api/;
    proxy_set_header Host ;
    proxy_set_header X-Forwarded-For ;
    proxy_set_header X-Forwarded-Proto ;
    proxy_set_header X-Forwarded-Host ;
    # 关闭上游压缩，便于子过滤器改写HTML/资产路径
    proxy_set_header Accept-Encoding "";
    
    # MinIO S3 API 特定配置
    proxy_set_header X-Forwarded-Server ;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    proxy_buffering off;
    client_max_body_size 0;
    
    # CORS 支持
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, HEAD, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Origin, X-Requested-With, Content-Type, Accept, X-Amz-Date, X-Amz-Content-Sha256, X-Amz-User-Agent" always;
    add_header Access-Control-Expose-Headers "ETag, x-amz-request-id" always;
    
    if ( = OPTIONS) {
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Origin, X-Requested-With, Content-Type, Accept, X-Amz-Date, X-Amz-Content-Sha256, X-Amz-User-Agent" always;
        add_header Access-Control-Max-Age 3600 always;
        return 204;
    }
}

# MinIO Console Web界面路由 (用于iframe集成)
location ^~ /minio-console/ {
    # 允许在iframe中嵌入MinIO控制台：隐藏上游限制性头
    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header X-Content-Security-Policy;

    # 将上游返回的根路径重写为带前缀，避免跳到 /
    # 例如: Location: /login  ->  /minio-console/login
    proxy_redirect ~^/(.*)$ /minio-console/$1;
    # 处理绝对URL跳转
    proxy_redirect http://minio:9001/ /minio-console/;
    proxy_redirect https://minio:9001/ /minio-console/;

    # 如用户访问无尾随斜杠，补全
    rewrite ^/minio-console$ /minio-console/ permanent;

    # 传递前缀信息（部分应用可识别该头）
    proxy_set_header X-Forwarded-Prefix /minio-console;

    # 明确允许同源页面内嵌
    add_header X-Frame-Options "SAMEORIGIN" always;
    # 放宽frame-ancestors以允许本系统页面嵌入
    add_header Content-Security-Policy "frame-ancestors 'self' ://" always;

    # 使用带结尾斜杠的proxy_pass自动去除/minio-console/前缀
    proxy_pass http://minio_console/;
    proxy_set_header Host ;
    proxy_set_header X-Real-IP ;
    proxy_set_header X-Forwarded-For ;
    proxy_set_header X-Forwarded-Proto ;
    proxy_set_header X-Forwarded-Host ;
    
    # WebSocket 升级支持 (MinIO Console可能使用WebSocket)
    proxy_http_version 1.1;
    proxy_set_header Upgrade ;
    proxy_set_header Connection ;
    
    # 缓冲与超时配置
    proxy_buffering off;
    proxy_request_buffering off;
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    
    # 大文件上传支持
    client_max_body_size 0;
    
    # 安全头配置 (适配iframe嵌入)
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    # 注意：不设置全局 X-Frame-Options（避免覆盖子location行为）
    
    # CORS 配置
    add_header Access-Control-Allow-Origin "://" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
    add_header Access-Control-Allow-Credentials "true" always;
    
    if ( = OPTIONS) {
        add_header Access-Control-Allow-Origin "://" always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
        add_header Access-Control-Allow-Credentials "true" always;
        return 204;
    }
    # 允许iframe嵌入MinIO控制台（前端页面以iframe展示）
    # 已在上方通过隐藏上游头与设置合适的 CSP 完成

    # 关键改写：让MinIO Console在子路径正常加载静态资源
    # 将 <base href="/"> 改为 <base href="/minio-console/">
    sub_filter_once off;
    sub_filter_types text/html;
    sub_filter '<base href="/"' '<base href="/minio-console/"';
    # 同时兜底改写绝对路径资源到子路径下
    sub_filter 'href="/' 'href="/minio-console/';
    sub_filter 'src="/' 'src="/minio-console/';
}

# MinIO 健康检查
location = /minio/health {
    access_log off;
    proxy_pass http://minio_api/minio/health/live;
    proxy_set_header Host ;
}
