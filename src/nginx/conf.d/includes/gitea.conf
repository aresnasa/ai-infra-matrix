    # Gitea iframe 包装页（稳定URL）
    location = /gitea-iframe.html {
        root /usr/share/nginx/html;
        try_files /gitea-iframe.html =404;
        add_header Content-Type "text/html; charset=utf-8";
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header X-Frame-Options SAMEORIGIN always;
        add_header Content-Security-Policy "frame-ancestors 'self'" always;
    }

    # 按官方建议：反向代理认证时，/user/login 需要传递SSO认证信息给Gitea
    # 这样Gitea才能建立正确的用户会话
    location = /gitea/user/login {
        access_log /var/log/nginx/gitea_login_access.log authdebug;
        
        # 首先尝试认证
        auth_request /__auth/verify;
        auth_request_set $auth_user $upstream_http_x_user;
        auth_request_set $auth_email $upstream_http_x_email;
        auth_request_set $auth_user_webauth $upstream_http_x_webauth_user;
        auth_request_set $auth_email_webauth $upstream_http_x_webauth_email;
        
        # 认证失败时的处理
        error_page 401 403 = @gitea_login_auth_failure;
        
        # 设置用户信息头
        set $user_header $auth_user_webauth;
        if ($user_header = "") { set $user_header $auth_user; }
        # Gitea reserves the username 'admin' by default, map to 'test'
        if ($user_header = "admin") { set $user_header "test"; }
        set $email_header $auth_email_webauth;
        if ($email_header = "") { set $email_header $auth_email; }
        
        # 代理到Gitea的登录页面，传递认证头信息
        rewrite ^/gitea/user/login$ /user/login break;
        proxy_pass http://gitea:3000;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $external_scheme;
        proxy_set_header X-Forwarded-Host $external_host;
        proxy_set_header X-External-Host $external_host;
        
        # 关键：传递SSO认证头给Gitea，让它建立用户会话
        proxy_set_header X-WEBAUTH-USER $user_header;
        proxy_set_header X-WEBAUTH-EMAIL $email_header;
        proxy_set_header X-Forwarded-User $user_header;
        proxy_set_header Remote-User $user_header;
        proxy_set_header X-WEBAUTH-DISPLAY-NAME $user_header;
        proxy_set_header X-WEBAUTH-UID $user_header;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # 添加调试信息
        add_header X-Debug-SSO-User "$user_header" always;
        add_header X-Debug-SSO-Email "$email_header" always;
        add_header X-Debug-SSO-Action "login_with_auth_headers" always;
    }
    # 兼容 /user/signin
    location = /gitea/user/signin { return 302 /gitea/; }
    # 登出：回到 /gitea/（Gitea 会基于头信息自动建立会话）
    location = /gitea/user/logout {
        return 302 /gitea/;
    }

    # 处理/gitea/根路径 - 如果认证通过则重定向到用户页面  
    location = /gitea/ {
        # 添加调试信息
        add_header X-Debug-Cookie-Value "$cookie_ai_infra_token" always;
        add_header X-Debug-Has-Token "$cookie_ai_infra_token" always;
        
        # 简化版本：先检查cookie是否存在，如果存在就假设认证成功
        if ($cookie_ai_infra_token != "") {
            # 对于已认证用户，重定向到admin页面（暂时硬编码）
            return 302 /gitea/admin;
        }
        
        # 没有token，重定向到SSO登录
        return 302 /sso/?redirect_to=/gitea/;
    }

    # /gitea/根路径认证失败处理
    location @gitea_root_auth_failure {
        add_header X-Debug-SSO-Action "root_auth_failed_redirect" always;
        return 302 /sso/?redirect_to=/gitea/;
    }

    # 顶层 /gitea 由前端应用渲染（包含全局抬头 + iframe），保持统一体验
    location = /gitea {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }


    # Gitea 反向代理 + SSO 注入
    # Gitea 反向代理 + SSO 注入（子路径全部走这里，顶层 /gitea 仍由前端渲染）
    location ^~ /gitea/ {
        access_log /var/log/nginx/gitea_access.log authdebug;
        rewrite ^/gitea(/.*)$ $1 break;
        proxy_pass http://gitea:3000;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $external_scheme;
        proxy_set_header X-Forwarded-Host $external_host;
        proxy_set_header X-External-Host $external_host;
        proxy_set_header Authorization "";
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        auth_request /__auth/verify;
        error_page 401 = @gitea_auth_failure;
        error_page 403 = @gitea_auth_failure;
        error_page 502 503 504 = @gitea_backend_error;
        auth_request_set $auth_user $upstream_http_x_user;
        auth_request_set $auth_email $upstream_http_x_email;
        auth_request_set $auth_user_webauth $upstream_http_x_webauth_user;
        auth_request_set $auth_email_webauth $upstream_http_x_webauth_email;
        auth_request_set $auth_status $upstream_status;

        set $user_header $auth_user_webauth;
        if ($user_header = "") { set $user_header $auth_user; }
    # Gitea reserves the username 'admin' by default, which blocks auto-creation.
    # Map SSO 'admin' to existing Gitea admin user 'test' to ensure admin access.
    if ($user_header = "admin") { set $user_header "test"; }
        set $email_header $auth_email_webauth;
        if ($email_header = "") { set $email_header $auth_email; }
        proxy_set_header X-WEBAUTH-USER $user_header;
        proxy_set_header X-WEBAUTH-EMAIL $email_header;
        proxy_set_header X-Forwarded-User $user_header;
        proxy_set_header Remote-User $user_header;
        proxy_set_header X-User $user_header;

        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Content-Security-Policy-Report-Only;
        proxy_hide_header X-Content-Security-Policy;
        proxy_hide_header X-Frame-Options;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header Content-Security-Policy "frame-ancestors 'self'" always;
        proxy_redirect off;

        proxy_buffering off;
        proxy_request_buffering off;
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        expires -1;
    }

    location @gitea_sso_redirect {
        add_header X-Debug-Auth-Status $auth_status always;
        add_header X-Debug-Has-AI $has_ai_cookie always;
        add_header X-Debug-Has-JWT $has_jwt_cookie always;
        add_header X-Debug-Has-AUTH $has_auth_cookie always;
        add_header X-Debug-Has-Authz $has_authz always;
        return 302 /sso/jwt_sso_bridge.html?service=gitea&redirect_path=$uri&redirect_args=$args;
    }

    # 增强的认证失败处理 - 重定向到后端登录
    location @gitea_auth_failure {
        add_header X-Debug-SSO-Action "auth_failed_redirect" always;
        return 302 /sso/?redirect_to=$request_uri;
    }

    # 专门处理/gitea/user/login认证失败的情况
    location @gitea_login_auth_failure {
        add_header X-Debug-SSO-Action "login_auth_failed_redirect_to_sso" always;
        # 保持原始的redirect_to参数
        return 302 /sso/?redirect_to=$request_uri;
    }

    # 后端不可用时的降级处理 - 直接访问Gitea
    location @gitea_backend_error {
        add_header X-Debug-SSO-Action "backend_error_fallback" always;
        rewrite ^/gitea(/.*)$ $1 break;
        proxy_pass http://gitea:3000;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Cookie $http_cookie;
    }
