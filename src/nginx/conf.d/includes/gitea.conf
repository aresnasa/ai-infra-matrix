    # Gitea iframe 包装页（稳定URL）
    location = /gitea-iframe.html {
        root /usr/share/nginx/html;
        try_files /gitea-iframe.html =404;
        add_header Content-Type "text/html; charset=utf-8";
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header X-Frame-Options SAMEORIGIN always;
        add_header Content-Security-Policy "frame-ancestors 'self'" always;
    }

    # 按官方建议：反向代理认证时，/user/login 与 /user/logout 直接由代理处理
    # 登录：统一交给代理处理，直接回到 /gitea/
    location = /gitea/user/login { return 302 /gitea/; }
    # 兼容 /user/signin
    location = /gitea/user/signin { return 302 /gitea/; }
    # 登出：回到 /gitea/（Gitea 会基于头信息自动建立会话）
    location = /gitea/user/logout {
        return 302 /gitea/;
    }

    # 顶层 /gitea 由前端应用渲染（包含全局抬头 + iframe），保持统一体验
    location = /gitea {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }


    # Gitea 反向代理 + SSO 注入
    # Gitea 反向代理 + SSO 注入（子路径全部走这里，顶层 /gitea 仍由前端渲染）
    location ^~ /gitea/ {
        access_log /var/log/nginx/gitea_access.log authdebug;
        proxy_pass http://gitea:3000/;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $external_scheme;
        proxy_set_header X-Forwarded-Host $external_host;
        proxy_set_header X-External-Host $external_host;
        proxy_set_header Authorization "";
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        auth_request /__auth/verify;
        error_page 401 = @gitea_sso_redirect;
        error_page 403 = @gitea_sso_redirect;
        auth_request_set $auth_user $upstream_http_x_user;
        auth_request_set $auth_email $upstream_http_x_email;
        auth_request_set $auth_user_webauth $upstream_http_x_webauth_user;
        auth_request_set $auth_email_webauth $upstream_http_x_webauth_email;
        auth_request_set $auth_status $upstream_status;

        set $user_header $auth_user_webauth;
        if ($user_header = "") { set $user_header $auth_user; }
    # Gitea reserves the username 'admin' by default, which blocks auto-creation.
    # Map SSO 'admin' to existing Gitea admin user 'test' to ensure admin access.
    if ($user_header = "admin") { set $user_header "test"; }
        set $email_header $auth_email_webauth;
        if ($email_header = "") { set $email_header $auth_email; }
        proxy_set_header X-WEBAUTH-USER $user_header;
        proxy_set_header X-WEBAUTH-EMAIL $email_header;
        proxy_set_header X-Forwarded-User $user_header;
        proxy_set_header Remote-User $user_header;
        proxy_set_header X-User $user_header;

        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Content-Security-Policy-Report-Only;
        proxy_hide_header X-Content-Security-Policy;
        proxy_hide_header X-Frame-Options;
        add_header X-Frame-Options SAMEORIGIN always;
        add_header Content-Security-Policy "frame-ancestors 'self'" always;
        proxy_redirect off;

        proxy_buffering off;
        proxy_request_buffering off;
        add_header Cache-Control "no-store, no-cache, must-revalidate" always;
        expires -1;
    }

    location @gitea_sso_redirect {
        add_header X-Debug-Auth-Status $auth_status always;
        add_header X-Debug-Has-AI $has_ai_cookie always;
        add_header X-Debug-Has-JWT $has_jwt_cookie always;
        add_header X-Debug-Has-AUTH $has_auth_cookie always;
        add_header X-Debug-Has-Authz $has_authz always;
        return 302 /sso/jwt_sso_bridge.html?service=gitea&redirect_path=$uri&redirect_args=$args;
    }
