# Nightingale Monitoring System Proxy Configuration
# Simple reverse proxy with sub_filter for path rewriting
# Template variables: NIGHTINGALE_HOST, NIGHTINGALE_PORT
# Note: /api/n9e/ is handled in server-main.conf to ensure proper priority

## IMPORTANT: Do NOT globally intercept top-level /js, /image, /font
## Doing so breaks the frontend SPA and can cause redirect loops.
## Nightingale assets will be served via the /nightingale/ location below.

# Main Nightingale location - must come before regex locations
# Use ^~ to stop regex matching (prevents static file location from intercepting)
location ^~ /nightingale/ {
    # Proxy to Nightingale backend (with trailing slash to strip /nightingale prefix)
    proxy_pass http://nightingale:17000/;
    
    # Ensure redirects and cookies stay under /nightingale/
    proxy_redirect ~^/(.*)$ /nightingale/$1;
    proxy_redirect http://nightingale:17000/ /nightingale/;
    proxy_redirect https://nightingale:17000/ /nightingale/;
    proxy_cookie_path / /nightingale/;
    proxy_cookie_domain nightingale $http_host;
    
    # SSO Integration: Extract username from JWT token via auth_request
    # The backend's /auth/verify endpoint returns X-User header with username
    # This enables ProxyAuth SSO - users are automatically logged into Nightingale
    auth_request /__auth/verify;
    auth_request_set $auth_username $upstream_http_x_user;
    
    # Pass the authenticated username to Nightingale for ProxyAuth
    proxy_set_header X-User-Name $auth_username;
    
    # Standard proxy headers
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $http_host;
    proxy_set_header X-Forwarded-Prefix /nightingale;
    
    # Disable compression for sub_filter to work
    proxy_set_header Accept-Encoding "";
    
    # Rewrite all absolute paths to include /nightingale prefix
    # This is needed because Nightingale uses absolute paths like /assets/
    sub_filter_types text/html application/javascript text/css application/json;
    sub_filter_once off;
    sub_filter '="/' '="/nightingale/';
    sub_filter "='/" "='/nightingale/";
    
    # Hide iframe blocking headers
    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;
    
    # WebSocket support
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    
    # Enable buffering for sub_filter
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    
    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
