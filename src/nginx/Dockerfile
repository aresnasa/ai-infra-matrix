# AIåŸºç¡€è®¾æ–½çŸ©é˜µ - è‡ªå®šä¹‰Nginxé•œåƒ
# æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²å’ŒJupyterHub upstreamè®¿é—®
# æ”¯æŒå¼€å‘æ¨¡å¼å’Œç”Ÿäº§æ¨¡å¼

FROM nginx:alpine

# æ„å»ºå‚æ•° - æ§åˆ¶æ˜¯å¦å¯ç”¨è°ƒè¯•æ¨¡å¼
ARG DEBUG_MODE=false
ARG BUILD_ENV=production

# é…ç½®Alpineé•œåƒï¼ˆå¤šé•œåƒè‡ªåŠ¨å›é€€ï¼‰
RUN set -eux; \
	for MIR in mirrors.tuna.tsinghua.edu.cn mirrors.aliyun.com mirrors.ustc.edu.cn dl-cdn.alpinelinux.org; do \
		sed -i "s#://[^/]\+/alpine#://$MIR/alpine#g" /etc/apk/repositories || true; \
		apk update && break || true; \
	done

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apk add --no-cache \
    curl \
    bash \
    tzdata

# è®¾ç½®æ—¶åŒº
RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„
RUN mkdir -p /usr/share/nginx/html/sso \
    && mkdir -p /usr/share/nginx/html/jupyterhub \
    && mkdir -p /usr/share/nginx/html/debug \
    && mkdir -p /var/log/nginx \
    && mkdir -p /etc/nginx/conf.d

# å¤åˆ¶é¡¹ç›®é™æ€æ–‡ä»¶
COPY src/shared/sso/ /usr/share/nginx/html/sso/
COPY src/shared/jupyterhub/ /usr/share/nginx/html/jupyterhub/
COPY src/shared/jupyterhub/browser_debug.html /usr/share/nginx/html/debug.html

# è°ƒè¯•æ–‡ä»¶å¤„ç† - æ ¹æ®æ¨¡å¼å†³å®šæ˜¯å¦å¤åˆ¶å®Œæ•´è°ƒè¯•å·¥å…·
RUN if [ "$DEBUG_MODE" = "true" ]; then \
        echo "ğŸ”§ å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œå°†å¤åˆ¶å®Œæ•´è°ƒè¯•å·¥å…·..."; \
    else \
        echo "ğŸš€ ç”Ÿäº§æ¨¡å¼ï¼Œå°†åˆ›å»ºç®€å•è°ƒè¯•é¡µé¢"; \
        echo "<h1>Debug tools are disabled in production mode</h1>" > /usr/share/nginx/html/debug/index.html; \
    fi

# æ¡ä»¶å¤åˆ¶ï¼šä»…åœ¨è°ƒè¯•æ¨¡å¼ä¸‹å¤åˆ¶å®Œæ•´è°ƒè¯•æ–‡ä»¶å¤¹
COPY --chown=nginx:nginx src/shared/debug/ /tmp/debug/
RUN if [ "$DEBUG_MODE" = "true" ]; then \
        echo "ï¿½ å¤åˆ¶è°ƒè¯•æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•..."; \
        cp -r /tmp/debug/* /usr/share/nginx/html/debug/ || echo "âš ï¸  è°ƒè¯•æ–‡ä»¶å¤åˆ¶å¤±è´¥ï¼Œä½†ç»§ç»­æ„å»º"; \
        echo "âœ… è°ƒè¯•æ–‡ä»¶å·²å¤åˆ¶åˆ° /usr/share/nginx/html/debug/"; \
        ls -la /usr/share/nginx/html/debug/ | head -10; \
    fi && \
    rm -rf /tmp/debug

# å¤åˆ¶ç¯å¢ƒé…ç½®æ¨¡æ¿
COPY src/nginx/nginx.conf /tmp/nginx.conf.template

# åˆ›å»ºJupyterHub wrapperé¡µé¢çš„ç¬¦å·é“¾æ¥ï¼Œæ”¯æŒå¤šç§è®¿é—®æ–¹å¼
RUN ln -sf /usr/share/nginx/html/jupyterhub/jupyterhub_wrapper_upstream.html /usr/share/nginx/html/jupyterhub_wrapper.html

# è®¾ç½®æƒé™
RUN chown -R nginx:nginx /usr/share/nginx/html \
    && chmod -R 755 /usr/share/nginx/html \
    && chown -R nginx:nginx /var/log/nginx \
    && chmod -R 755 /var/log/nginx

# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY src/nginx/docker-entrypoint.sh /docker-entrypoint.sh

# è®¾ç½®å¯åŠ¨è„šæœ¬æƒé™
RUN chmod +x /docker-entrypoint.sh

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DEBUG_MODE=${DEBUG_MODE}
ENV BUILD_ENV=${BUILD_ENV}

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=20s --retries=3 \
    CMD curl -f http://localhost/health || exit 1

# æš´éœ²ç«¯å£
EXPOSE 80 443

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /usr/share/nginx/html

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["nginx", "-g", "daemon off;"]

# å…ƒæ•°æ®æ ‡ç­¾
LABEL maintainer="AI Infrastructure Team" \
      version="1.0.0" \
      description="AIåŸºç¡€è®¾æ–½çŸ©é˜µ - åˆ†å¸ƒå¼Nginxä»£ç†æœåŠ¡" \
      features="SSO,JupyterHub,Distributed,Upstream"
