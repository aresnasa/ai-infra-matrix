#!/bin/bash
#
# Node Metrics Deploy Script Template
# 部署节点指标采集脚本到目标节点
#
# 模板变量:
#   {{.CallbackURL}}     - 指标回调 URL
#   {{.CollectInterval}} - 采集间隔（分钟）
#   {{.APIToken}}        - API 认证令牌
#   {{.MinionID}}        - Minion 标识符
#   {{.CollectScript}}   - 采集脚本内容（base64 或原文）
#

set -e

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "Deploying node metrics collection..."

# 创建目录
mkdir -p /opt/ai-infra/scripts /var/log/ai-infra

# 写入配置文件
log "Writing configuration file..."
cat > /opt/ai-infra/scripts/node-metrics.conf << 'CONFEOF'
# Node Metrics Configuration
# Auto-generated by ai-infra-matrix

CALLBACK_URL="{{.CallbackURL}}"
COLLECT_INTERVAL="{{.CollectInterval}}"
API_TOKEN="{{.APIToken}}"
MINION_ID="{{.MinionID}}"
CONFEOF
chmod 600 /opt/ai-infra/scripts/node-metrics.conf

# 写入采集脚本
log "Writing collection script..."
cat > /opt/ai-infra/scripts/collect-node-metrics.sh << 'SCRIPTEOF'
{{.CollectScript}}
SCRIPTEOF
chmod 755 /opt/ai-infra/scripts/collect-node-metrics.sh

# 设置定时任务
log "Setting up cron job (every {{.CollectInterval}} minutes)..."
(crontab -l 2>/dev/null | grep -v 'collect-node-metrics.sh'; echo "*/{{.CollectInterval}} * * * * /opt/ai-infra/scripts/collect-node-metrics.sh >> /var/log/ai-infra/node-metrics.log 2>&1") | crontab -

# 立即执行一次采集
log "Running initial collection..."
/opt/ai-infra/scripts/collect-node-metrics.sh >> /var/log/ai-infra/node-metrics.log 2>&1 &

log "Node metrics collection deployed successfully"
echo "Configuration: /opt/ai-infra/scripts/node-metrics.conf"
echo "Script: /opt/ai-infra/scripts/collect-node-metrics.sh"
echo "Log: /var/log/ai-infra/node-metrics.log"
