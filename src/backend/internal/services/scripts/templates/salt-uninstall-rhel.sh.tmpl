#!/bin/bash
# =============================================================================
# Salt Minion Uninstallation Script for RHEL/CentOS/Rocky/AlmaLinux/Fedora
# =============================================================================
# Template variables (Go text/template syntax):
#   {{.SudoPrefix}}  - Sudo command prefix (empty or "sudo ")
# =============================================================================

set -e
echo "=== Uninstalling Salt Minion ==="
echo "=== Target: RHEL/CentOS/Rocky/AlmaLinux/Fedora System ==="
echo "=== Timestamp: $(date '+%Y-%m-%d %H:%M:%S') ==="

# Stop and disable service (with multiple retry)
echo "=== Stopping Salt Minion service ==="
for i in 1 2 3; do
    {{.SudoPrefix}}systemctl stop salt-minion 2>/dev/null && break || sleep 2
done
{{.SudoPrefix}}systemctl disable salt-minion 2>/dev/null || true

# Kill any remaining salt-minion processes
echo "=== Killing remaining salt-minion processes ==="
{{.SudoPrefix}}pkill -9 -f salt-minion 2>/dev/null || true
{{.SudoPrefix}}pkill -9 -f salt-call 2>/dev/null || true
sleep 1

# Remove packages (try both yum and dnf)
echo "=== Removing Salt packages ==="
if command -v dnf &> /dev/null; then
    {{.SudoPrefix}}dnf remove -y salt-minion salt-repo salt 2>/dev/null || true
    {{.SudoPrefix}}dnf clean all 2>/dev/null || true
elif command -v yum &> /dev/null; then
    {{.SudoPrefix}}yum remove -y salt-minion salt-repo salt 2>/dev/null || true
    {{.SudoPrefix}}yum clean all 2>/dev/null || true
fi

# Remove Salt repository
echo "=== Removing Salt repository ==="
{{.SudoPrefix}}rm -f /etc/yum.repos.d/salt*.repo 2>/dev/null || true
{{.SudoPrefix}}rm -f /etc/yum.repos.d/apphub*.repo 2>/dev/null || true

# Clean up Minion keys first (important for re-installation)
echo "=== Cleaning up Salt Minion keys ==="
{{.SudoPrefix}}rm -rf /etc/salt/pki/minion 2>/dev/null || true
{{.SudoPrefix}}rm -f /etc/salt/minion_id 2>/dev/null || true
echo "OK: Minion keys and ID removed"

# Clean up configuration and data
echo "=== Cleaning up Salt directories ==="
{{.SudoPrefix}}rm -rf /etc/salt
{{.SudoPrefix}}rm -rf /var/cache/salt
{{.SudoPrefix}}rm -rf /var/log/salt
{{.SudoPrefix}}rm -rf /var/run/salt
{{.SudoPrefix}}rm -rf /run/salt 2>/dev/null || true
{{.SudoPrefix}}rm -rf /srv/salt
{{.SudoPrefix}}rm -rf /srv/pillar
{{.SudoPrefix}}rm -rf /opt/saltstack

# Clean up systemd service files
echo "=== Cleaning up systemd service files ==="
{{.SudoPrefix}}rm -f /etc/systemd/system/salt-minion.service 2>/dev/null || true
{{.SudoPrefix}}rm -f /usr/lib/systemd/system/salt-minion.service 2>/dev/null || true
{{.SudoPrefix}}systemctl daemon-reload 2>/dev/null || true

# Remove salt user if exists
echo "=== Removing salt user ==="
{{.SudoPrefix}}userdel -r salt 2>/dev/null || true
{{.SudoPrefix}}groupdel salt 2>/dev/null || true

# Verify uninstallation
echo "=== Verifying uninstallation ==="
if command -v salt-minion &> /dev/null; then
    echo "WARNING: salt-minion command still exists"
    which salt-minion || true
else
    echo "OK: salt-minion command removed"
fi

if [ -d /etc/salt ]; then
    echo "WARNING: /etc/salt directory still exists"
else
    echo "OK: /etc/salt directory removed"
fi

echo "=== Salt Minion Uninstall Complete ==="
echo "=== Completed at: $(date '+%Y-%m-%d %H:%M:%S') ==="

