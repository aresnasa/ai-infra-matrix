#!/bin/bash
# ====================================================================
# Salt Minion 安装脚本
# ====================================================================
# 描述: 从AppHub或官方仓库安装salt-minion
# 参数:
#   APPHUB_URL - AppHub服务地址 (可选，如: http://apphub:80)
# ====================================================================

set -e

APPHUB_URL="${APPHUB_URL:-}"
installed=0

echo "=== 开始安装 Salt Minion ==="
echo "AppHub URL: ${APPHUB_URL:-未设置}"

# ==================== Debian/Ubuntu 系统 ====================
if command -v apt-get >/dev/null 2>&1; then
	export DEBIAN_FRONTEND=noninteractive
	
	# 优先尝试 AppHub APT 仓库
	if [ -n "$APPHUB_URL" ]; then
		echo "[Salt] 检查AppHub APT仓库: $APPHUB_URL/pkgs/saltstack-deb/"
		if timeout 8 wget -q --spider "$APPHUB_URL/pkgs/saltstack-deb/Packages"; then
			echo "[Salt] 使用AppHub APT仓库安装salt-minion"
			echo "deb [trusted=yes] $APPHUB_URL/pkgs/saltstack-deb ./" > /etc/apt/sources.list.d/ai-infra-salt.list
			apt-get update -y || true
			if apt-get install -y salt-minion; then
				installed=1
				echo "[Salt] ✓ 从AppHub APT仓库安装成功"
			else
				echo "[Salt] ✗ 从AppHub APT安装失败，尝试其他方式..."
			fi
		else
			echo "[Salt] AppHub APT索引不存在，跳过"
		fi
	fi
	
	# 尝试系统仓库
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 尝试从系统仓库安装..."
		apt-get update -y || true
		if apt-get install -y salt-minion; then
			installed=1
			echo "[Salt] ✓ 从系统仓库安装成功"
		fi
	fi
	
	# 尝试 Broadcom 官方仓库
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 系统仓库无salt-minion，尝试添加Broadcom Salt仓库..."
		apt-get install -y curl gnupg2 ca-certificates lsb-release wget || true
		mkdir -p /usr/share/keyrings
		if curl -fsSL --connect-timeout 10 --max-time 30 \
			https://packages.broadcom.com/artifactory/api/security/keypair/SaltProjectKey/public \
			-o /usr/share/keyrings/salt-archive-keyring.gpg; then
			echo "deb [signed-by=/usr/share/keyrings/salt-archive-keyring.gpg] https://packages.broadcom.com/artifactory/saltproject-deb/ stable main" \
				> /etc/apt/sources.list.d/saltproject.list
			apt-get update -y || true
			if apt-get install -y salt-minion; then
				installed=1
				echo "[Salt] ✓ 从Broadcom仓库安装成功"
			fi
		fi
	fi
	
	# 最后尝试 bootstrap 脚本
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 所有仓库失败，使用官方bootstrap脚本..."
		if curl -fsSL --connect-timeout 10 --max-time 60 https://bootstrap.saltproject.io -o /tmp/install_salt.sh; then
			# 验证下载的文件是否为有效的shell脚本
			if head -1 /tmp/install_salt.sh | grep -q '^#!/'; then
				if sh /tmp/install_salt.sh -X 2>/dev/null || sh /tmp/install_salt.sh 2>/dev/null; then
					installed=1
					echo "[Salt] ✓ 使用bootstrap脚本安装成功"
				else
					echo "[Salt] ✗ bootstrap脚本执行失败"
				fi
			else
				echo "[Salt] ✗ 下载的文件不是有效的shell脚本"
			fi
		else
			echo "[Salt] ✗ bootstrap脚本下载失败（可能无网络访问）"
		fi
	fi

# ==================== RHEL/CentOS (YUM) 系统 ====================
elif command -v yum >/dev/null 2>&1; then
	# 优先尝试 AppHub YUM 仓库
	if [ -n "$APPHUB_URL" ]; then
		echo "[Salt] 检查AppHub YUM仓库: $APPHUB_URL/pkgs/saltstack-rpm/"
		if timeout 8 wget -q --spider "$APPHUB_URL/pkgs/saltstack-rpm/repodata/repomd.xml"; then
			echo "[Salt] 使用AppHub YUM仓库安装salt-minion"
			cat > /etc/yum.repos.d/ai-infra-salt.repo <<EOF
[ai-infra-salt]
name=AI Infra Salt RPMs
baseurl=$APPHUB_URL/pkgs/saltstack-rpm
enabled=1
gpgcheck=0
EOF
			yum clean all || true
			yum makecache -y || true
			if yum install -y salt-minion; then
				installed=1
				echo "[Salt] ✓ 从AppHub YUM仓库安装成功"
			else
				echo "[Salt] ✗ 从AppHub YUM安装失败，尝试其他方式..."
			fi
		else
			echo "[Salt] AppHub YUM元数据不存在，跳过"
		fi
	fi
	
	# 尝试系统仓库
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 尝试从系统仓库安装..."
		if yum install -y salt-minion; then
			installed=1
			echo "[Salt] ✓ 从系统仓库安装成功"
		fi
	fi
	
	# 尝试 Salt 官方仓库
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 系统仓库无salt-minion，尝试添加Salt官方仓库..."
		if yum install -y https://repo.saltproject.io/py3/redhat/salt-py3-repo-latest.el8.noarch.rpm; then
			yum clean all || true
			yum makecache -y || true
			if yum install -y salt-minion; then
				installed=1
				echo "[Salt] ✓ 从Salt官方仓库安装成功"
			fi
		fi
	fi
	
	# 最后尝试 bootstrap 脚本
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 所有仓库失败，使用bootstrap脚本"
		if curl -fsSL --connect-timeout 10 --max-time 60 https://bootstrap.saltproject.io -o /tmp/install_salt.sh; then
			sh /tmp/install_salt.sh -X || sh /tmp/install_salt.sh || true
			installed=1
			echo "[Salt] ✓ 使用bootstrap脚本安装"
		else
			echo "[Salt] ✗ bootstrap脚本下载失败"
			exit 1
		fi
	fi

# ==================== Fedora/Rocky (DNF) 系统 ====================
elif command -v dnf >/dev/null 2>&1; then
	# 优先尝试 AppHub DNF 仓库
	if [ -n "$APPHUB_URL" ]; then
		echo "[Salt] 检查AppHub DNF仓库: $APPHUB_URL/pkgs/saltstack-rpm/"
		if timeout 8 wget -q --spider "$APPHUB_URL/pkgs/saltstack-rpm/repodata/repomd.xml"; then
			echo "[Salt] 使用AppHub DNF仓库安装salt-minion"
			cat > /etc/yum.repos.d/ai-infra-salt.repo <<EOF
[ai-infra-salt]
name=AI Infra Salt RPMs
baseurl=$APPHUB_URL/pkgs/saltstack-rpm
enabled=1
gpgcheck=0
EOF
			dnf makecache -y || true
			if dnf install -y salt-minion; then
				installed=1
				echo "[Salt] ✓ 从AppHub DNF仓库安装成功"
			else
				echo "[Salt] ✗ 从AppHub DNF安装失败，尝试其他方式..."
			fi
		else
			echo "[Salt] AppHub DNF元数据不存在，跳过"
		fi
	fi
	
	# 尝试系统仓库
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 尝试从系统仓库安装..."
		if dnf install -y salt-minion; then
			installed=1
			echo "[Salt] ✓ 从系统仓库安装成功"
		fi
	fi
	
	# 尝试 Salt 官方仓库
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 系统仓库无salt-minion，尝试添加Salt官方仓库..."
		if dnf install -y https://repo.saltproject.io/py3/redhat/salt-py3-repo-latest.fc36.noarch.rpm; then
			dnf makecache -y || true
			if dnf install -y salt-minion; then
				installed=1
				echo "[Salt] ✓ 从Salt官方仓库安装成功"
			fi
		fi
	fi
	
	# 最后尝试 bootstrap 脚本
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] 所有仓库失败，使用bootstrap脚本"
		if curl -fsSL --connect-timeout 10 --max-time 60 https://bootstrap.saltproject.io -o /tmp/install_salt.sh; then
			sh /tmp/install_salt.sh -X || sh /tmp/install_salt.sh || true
			installed=1
			echo "[Salt] ✓ 使用bootstrap脚本安装"
		else
			echo "[Salt] ✗ bootstrap脚本下载失败"
			exit 1
		fi
	fi

# ==================== SUSE (zypper) 系统 ====================
elif command -v zypper >/dev/null 2>&1; then
	zypper refresh || true
	if zypper install -y salt-minion; then
		installed=1
		echo "[Salt] ✓ 从系统仓库安装成功"
	fi
	
	if [ "$installed" -eq 0 ]; then
		echo "[Salt] zypper安装失败，尝试bootstrap脚本"
		if curl -fsSL --connect-timeout 10 --max-time 60 https://bootstrap.saltproject.io -o /tmp/install_salt.sh; then
			sh /tmp/install_salt.sh -X || sh /tmp/install_salt.sh || true
			installed=1
			echo "[Salt] ✓ 使用bootstrap脚本安装"
		else
			echo "[Salt] ✗ bootstrap脚本下载失败"
			exit 1
		fi
	fi

else
	echo "[Salt] ✗ 不支持的包管理器"
	exit 1
fi

# 验证安装
if command -v salt-minion >/dev/null 2>&1; then
	echo "=== Salt Minion 安装成功 ==="
	salt-minion --version
	exit 0
else
	echo "=== Salt Minion 安装失败 ==="
	exit 1
fi
