<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <title>{{page_title}}</title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    {% block stylesheet %}
    <link rel="stylesheet" href="{{ static_url("css/style.min.css") }}" type="text/css"/>
    {% endblock %}
    
    {% block favicon %}
    <link rel="icon" href="{{ static_url("favicon.ico") }}" type="image/x-icon">
    {% endblock %}
    
    <style>
        .auto-login-progress {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div id="main" class="container">
        <!-- 自动登录检查区域 -->
        <div id="auto-login-check" class="auto-login-progress" style="display: none;">
            <div class="spinner"></div>
            <p>正在检查认证状态...</p>
        </div>
        
        <!-- 原始登录表单 -->
        <div id="login-main" class="container">
            {% block login %}
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="login-form">
                        {% block login_header %}
                        <div class="auth-form-header">
                            <h1>{{ login_title | default("Sign in to JupyterHub") }}</h1>
                        </div>
                        {% endblock login_header %}
                        
                        {% if login_error %}
                        <div class="alert alert-danger" role="alert">
                            {{ login_error }}
                        </div>
                        {% endif %}
                        
                        {% block login_form %}
                        <form action="{{ authenticator_login_url }}" method="post" role="form">
                            <input type="hidden" name="_xsrf" value="{{ xsrf_token }}">
                            
                            <div class="auth-form-body">
                                {% if next %}
                                <input type="hidden" name="next" value="{{ next }}">
                                {% endif %}
                                
                                <div class="form-group">
                                    <label for="username_input">用户名:</label>
                                    <input id="username_input" 
                                           type="text" 
                                           autocapitalize="off" 
                                           autocorrect="off" 
                                           class="form-control" 
                                           name="username" 
                                           value="{{ username }}" 
                                           required 
                                           autofocus>
                                </div>
                                
                                <div class="form-group">
                                    <label for="password_input">密码:</label>
                                    <input type="password" 
                                           class="form-control" 
                                           name="password" 
                                           id="password_input" 
                                           required>
                                </div>
                                
                                <div class="form-group">
                                    <input type="submit" 
                                           id="login_submit" 
                                           class="btn btn-primary form-control" 
                                           value="登录">
                                </div>
                            </div>
                        </form>
                        {% endblock login_form %}
                        
                        {% if custom_html %}
                        <div class="custom-html">
                            {{ custom_html | safe }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endblock login %}
        </div>
    </div>

    {% block script %}
    <script type="text/javascript">
        // AI Infra Matrix 自动登录检查
        (function() {
            'use strict';
            
            console.log('AI Infra Matrix 自动登录检查开始...');
            
            // 检查localStorage中的token
            function getStoredToken() {
                try {
                    const token = localStorage.getItem('token');
                    const expires = localStorage.getItem('token_expires');
                    
                    if (!token || !expires) {
                        console.log('未找到存储的token');
                        return null;
                    }
                    
                    // 检查token是否过期
                    const expiresAt = new Date(expires);
                    const now = new Date();
                    const timeUntilExpiry = expiresAt.getTime() - now.getTime();
                    
                    if (timeUntilExpiry <= 0) {
                        console.log('Token已过期');
                        localStorage.removeItem('token');
                        localStorage.removeItem('token_expires');
                        return null;
                    }
                    
                    console.log('找到有效token，剩余时间:', Math.floor(timeUntilExpiry / 1000), '秒');
                    return token;
                } catch (e) {
                    console.error('读取token失败:', e);
                    return null;
                }
            }
            
            // 检查是否已经尝试过自动登录
            function hasTriedAutoLogin() {
                const tried = sessionStorage.getItem('auto_login_attempted');
                return tried === 'true';
            }
            
            // 标记已尝试自动登录
            function markAutoLoginAttempted() {
                sessionStorage.setItem('auto_login_attempted', 'true');
            }
            
            // 使用JWT token自动登录
            function autoLoginWithToken(token) {
                console.log('尝试使用JWT token自动登录...');
                
                // 检查是否已经有token参数，避免重复处理
                const currentUrl = new URL(window.location.href);
                if (currentUrl.searchParams.has('token')) {
                    console.log('URL中已包含token参数，跳过自动登录');
                    showLoginForm();
                    return;
                }
                
                // 显示loading状态
                const autoLoginDiv = document.getElementById('auto-login-check');
                const loginForm = document.getElementById('login-main');
                
                if (autoLoginDiv && loginForm) {
                    autoLoginDiv.style.display = 'block';
                    loginForm.style.display = 'none';
                }
                
                // 设置cookie以便后端读取
                document.cookie = `ai_infra_token=${token}; path=/; max-age=3600; SameSite=Lax`;
                
                // 构建带token的URL
                const nextParam = currentUrl.searchParams.get('next') || '/jupyter/hub/';
                const tokenUrl = `/jupyter/hub/login?token=${encodeURIComponent(token)}&next=${encodeURIComponent(nextParam)}`;
                
                // 标记已尝试，然后重定向
                markAutoLoginAttempted();
                
                setTimeout(() => {
                    console.log('重定向到:', tokenUrl);
                    window.location.href = tokenUrl;
                }, 1000);
            }
            
            // 显示登录表单
            function showLoginForm() {
                const autoLoginDiv = document.getElementById('auto-login-check');
                const loginForm = document.getElementById('login-main');
                
                if (autoLoginDiv && loginForm) {
                    autoLoginDiv.style.display = 'none';
                    loginForm.style.display = 'block';
                }
            }
            
            // 页面加载时检查自动登录
            function checkAutoLogin() {
                // 如果已经尝试过自动登录，直接显示表单
                if (hasTriedAutoLogin()) {
                    console.log('本次会话已尝试过自动登录，显示登录表单');
                    showLoginForm();
                    return false;
                }
                
                // 检查URL中是否已有token参数，如果有则跳过自动登录
                const currentUrl = new URL(window.location.href);
                if (currentUrl.searchParams.has('token')) {
                    console.log('URL中包含token参数，跳过自动登录检查');
                    showLoginForm();
                    return false;
                }
                
                const token = getStoredToken();
                
                if (token) {
                    console.log('发现有效token，开始自动登录...');
                    autoLoginWithToken(token);
                    return true;
                } else {
                    console.log('未找到有效token，显示登录表单');
                    showLoginForm();
                    return false;
                }
            }
            
            // 页面加载完成后执行检查
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkAutoLogin);
            } else {
                checkAutoLogin();
            }
            
            // 监听localStorage变化（跨标签页同步）
            window.addEventListener('storage', function(e) {
                if (e.key === 'token' && e.newValue && !hasTriedAutoLogin()) {
                    console.log('检测到新的token，尝试自动登录...');
                    autoLoginWithToken(e.newValue);
                }
            });
            
            // 为手动登录表单添加增强功能
            document.addEventListener('DOMContentLoaded', function() {
                const loginForm = document.querySelector('form[action*="login"]');
                if (loginForm) {
                    loginForm.addEventListener('submit', function(e) {
                        console.log('手动登录提交');
                        // 可以在这里添加额外的处理逻辑
                    });
                }
            });
            
        })();
    </script>
    {% endblock script %}
</body>
</html>
