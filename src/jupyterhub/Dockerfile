# JupyterHub Backendé›†æˆ - ç²¾ç‚¼ç‰ˆï¼ˆä¿®å¤æž„å»ºé—®é¢˜ï¼‰
ARG PYTHON_ALPINE_VERSION=3.14-alpine
FROM python:${PYTHON_ALPINE_VERSION}

# Build arguments for versions
ARG PIP_VERSION=24.2
ARG PYPI_INDEX_URL=https://mirrors.aliyun.com/pypi/simple/
ARG NPM_REGISTRY=https://registry.npmmirror.com
ARG ALPINE_MIRROR

# Version metadata (overridable at build time)
ARG VERSION="dev"
ENV APP_VERSION=${VERSION}
ENV TZ=Asia/Shanghai

# åŸºç¡€çŽ¯å¢ƒå’Œæž„å»ºå·¥å…·ï¼ˆå¤šé•œåƒæºæ™ºèƒ½å›žé€€é…ç½®ï¼‰
RUN set -eux; \
    # å¤‡ä»½åŽŸå§‹repositoriesæ–‡ä»¶
    cp /etc/apk/repositories /etc/apk/repositories.bak; \
    # èŽ·å–Alpineç‰ˆæœ¬
    ALPINE_VERSION=$(cat /etc/alpine-release | cut -d'.' -f1,2); \
    echo "Detected Alpine version: ${ALPINE_VERSION}"; \
    # å°è¯•è‡ªå®šä¹‰é•œåƒæº
    if [ -n "${ALPINE_MIRROR}" ]; then \
        echo "å°è¯•è‡ªå®šä¹‰é•œåƒæº: ${ALPINE_MIRROR}..."; \
        echo "https://${ALPINE_MIRROR}/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories && \
        echo "https://${ALPINE_MIRROR}/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories && \
        apk update && \
        echo "æˆåŠŸä½¿ç”¨è‡ªå®šä¹‰é•œåƒæº"; \
    else \
        # å°è¯•é˜¿é‡Œäº‘é•œåƒæº
        { \
            echo "å°è¯•é˜¿é‡Œäº‘é•œåƒæº..."; \
            echo "https://mirrors.aliyun.com/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories && \
            echo "https://mirrors.aliyun.com/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories && \
            apk update && \
            echo "æˆåŠŸä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº"; \
        } || { \
            echo "é˜¿é‡Œäº‘é•œåƒæºå¤±è´¥ï¼Œå°è¯•æ¸…åŽæº..."; \
            echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories && \
            echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories && \
            apk update && \
            echo "æˆåŠŸä½¿ç”¨æ¸…åŽæº"; \
        } || { \
            echo "æ¸…åŽæºå¤±è´¥ï¼Œå°è¯•ä¸­ç§‘å¤§æº..."; \
            echo "https://mirrors.ustc.edu.cn/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories && \
            echo "https://mirrors.ustc.edu.cn/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories && \
            apk update && \
            echo "æˆåŠŸä½¿ç”¨ä¸­ç§‘å¤§æº"; \
        } || { \
            echo "æ‰€æœ‰å›½å†…æºéƒ½å¤±è´¥ï¼Œä½¿ç”¨å®˜æ–¹æº..."; \
            cp /etc/apk/repositories.bak /etc/apk/repositories && \
            apk update && \
            echo "ä½¿ç”¨å®˜æ–¹æº"; \
        }; \
    fi; \
    # å®‰è£…å¿…éœ€çš„è¿è¡Œæ—¶ä¾èµ–
    apk add --no-cache \
        ca-certificates \
        curl \
        openssl \
        tzdata \
        bash \
        shadow \
        netcat-openbsd \
        redis \
        git \
        lsof \
    && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

WORKDIR /srv/jupyterhub

# PythonçŽ¯å¢ƒ
ENV PYTHONUNBUFFERED=1 \
    PYTHONPATH="/srv/jupyterhub"

# ä½¿ç”¨é…ç½®çš„ PyPI é•œåƒï¼ˆå¸¦å®˜æ–¹ PyPI ä½œä¸ºå¤‡ç”¨æºï¼‰
ENV PIP_INDEX_URL="${PYPI_INDEX_URL}" \
    PIP_EXTRA_INDEX_URL="${PYPI_INDEX_URL}" \
    PIP_TRUSTED_HOST="mirrors.aliyun.com" \
    PIP_TIMEOUT=60

# å‡çº§pipå¹¶å®‰è£…æ ¸å¿ƒå·¥å…·
RUN pip install --no-cache-dir --upgrade pip==${PIP_VERSION} setuptools wheel

# ä¾èµ–å®‰è£…ï¼ˆåˆ†å±‚ä¼˜åŒ–ï¼Œä¼˜å…ˆäºŒè¿›åˆ¶ç‰ˆæœ¬ï¼‰
COPY requirements.txt .
# å¤åˆ¶ third_party ç›®å½•ä»¥æ”¯æŒç¦»çº¿æž„å»º
COPY third_party/ /third_party/

# Install Node.js and temporary build deps to compile psutil on Alpine, then remove them
RUN set -eux; \
    # æ­¥éª¤1: é…ç½® Alpine é•œåƒæºï¼ˆå¤šé‡é™çº§ï¼‰
    cp /etc/apk/repositories /etc/apk/repositories.bak; \
    ALPINE_VERSION=$(cat /etc/alpine-release | cut -d. -f1,2); \
    if [ -n "${ALPINE_MIRROR}" ]; then \
        echo "https://${ALPINE_MIRROR}/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories; \
        echo "https://${ALPINE_MIRROR}/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories; \
    else \
        # å°è¯•é˜¿é‡Œäº‘é•œåƒ
        echo "https://mirrors.aliyun.com/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories; \
        echo "https://mirrors.aliyun.com/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories; \
    fi; \
    if ! apk update 2>/dev/null; then \
        echo "âŒ é˜¿é‡Œäº‘é•œåƒå¤±è´¥ï¼Œå°è¯•æ¸…åŽé•œåƒ..."; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories; \
        if ! apk update 2>/dev/null; then \
            echo "âŒ æ¸…åŽé•œåƒå¤±è´¥ï¼Œå°è¯•ä¸­ç§‘å¤§é•œåƒ..."; \
            echo "https://mirrors.ustc.edu.cn/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories; \
            echo "https://mirrors.ustc.edu.cn/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories; \
            if ! apk update 2>/dev/null; then \
                echo "âŒ ä¸­ç§‘å¤§é•œåƒå¤±è´¥ï¼Œä½¿ç”¨å®˜æ–¹é•œåƒæº..."; \
                mv /etc/apk/repositories.bak /etc/apk/repositories; \
                apk update || (sleep 5 && apk update) || (sleep 10 && apk update); \
            fi; \
        fi; \
    fi; \
    \
    # æ­¥éª¤2: å®‰è£…ç³»ç»Ÿä¾èµ–
    apk add --no-cache nodejs npm && \
    apk add --no-cache --virtual .build-deps \
        build-base \
        musl-dev \
        linux-headers \
        python3-dev \
        curl-dev \
        openssl-dev \
        zlib-dev; \
    \
    # æ­¥éª¤3: é…ç½® npm é•œåƒæºï¼ˆå¤šé‡é™çº§ï¼‰
    npm config set registry ${NPM_REGISTRY} || \
    npm config set registry https://registry.npm.taobao.org || \
    npm config set registry https://registry.npmjs.org; \
    \
    # æ­¥éª¤4: é…ç½® pip é•œåƒæºï¼ˆå¤šé‡é™çº§ï¼‰
    pip config set global.index-url ${PYPI_INDEX_URL} || true; \
    pip config set global.trusted-host mirrors.aliyun.com || true; \
    \
    # æ­¥éª¤5: å®‰è£… Python ä¾èµ–ï¼ˆå¸¦é‡è¯•ï¼‰
    pip install --no-cache-dir --prefer-binary psutil>=5.9.0 || \
        (pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/ && \
         pip config set global.trusted-host mirrors.tuna.tsinghua.edu.cn && \
         pip install --no-cache-dir --prefer-binary psutil>=5.9.0) || \
        (pip config set global.index-url https://pypi.org/simple/ && \
         pip config unset global.trusted-host && \
         pip install --no-cache-dir --prefer-binary psutil>=5.9.0); \
    \
    pip install --no-cache-dir -r requirements.txt || \
        (pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/ && \
         pip install --no-cache-dir -r requirements.txt) || \
        (pip config set global.index-url https://pypi.org/simple/ && \
         pip install --no-cache-dir -r requirements.txt); \
    \
    # æ­¥éª¤6: å®‰è£… pycurlï¼ˆç¼–è¯‘å®‰è£…ï¼Œå¸¦å¤šé‡é™çº§ï¼‰
    echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘å®‰è£… pycurl..."; \
    if [ -f "/third_party/python/pycurl-7.45.3.tar.gz" ]; then \
        echo "ðŸ“¦ ä½¿ç”¨æœ¬åœ° PyCurl æºç ..."; \
        PYCURL_SSL_LIBRARY=openssl pip install --no-cache-dir --no-binary=:all: /third_party/python/pycurl-7.45.3.tar.gz; \
    else \
        PYCURL_SSL_LIBRARY=openssl pip install --no-cache-dir --no-binary=:all: pycurl || \
            (echo "âŒ é˜¿é‡Œäº‘æºå®‰è£…å¤±è´¥ï¼Œå°è¯•æ¸…åŽæº..."; \
             pip config set global.index-url https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple/ && \
             pip config set global.trusted-host mirrors.tuna.tsinghua.edu.cn && \
             PYCURL_SSL_LIBRARY=openssl pip install --no-cache-dir --no-binary=:all: pycurl) || \
            (echo "âŒ æ¸…åŽæºå®‰è£…å¤±è´¥ï¼Œå°è¯•å®˜æ–¹ PyPI..."; \
             pip config set global.index-url https://pypi.org/simple/ && \
             pip config unset global.trusted-host && \
             PYCURL_SSL_LIBRARY=openssl pip install --no-cache-dir --no-binary=:all: pycurl); \
    fi; \
    \
    # æ­¥éª¤7: å®‰è£… configurable-http-proxy
    npm install -g configurable-http-proxy; \
    \
    # æ­¥éª¤8: æ¸…ç†æž„å»ºä¾èµ–
    apk del .build-deps

# ç”¨æˆ·å’Œç›®å½•
RUN adduser -D -s /bin/bash admin && \
    adduser -D -s /bin/bash testuser && \
    mkdir -p /var/log/jupyterhub

# é…ç½®æ—¶é—´æˆ³ï¼ˆå¼ºåˆ¶é‡å»ºé…ç½®å±‚ï¼‰
RUN echo "Build: $(date '+%Y-%m-%d %H:%M:%S')" > /srv/jupyterhub/build_info.txt

# é…ç½®æ–‡ä»¶ï¼ˆæœ€åŽå¤åˆ¶ï¼Œä¼˜åŒ–ç¼“å­˜ï¼‰
COPY jupyterhub_config.py backend_integrated_config.py simple_config.py kubernetes_spawner_config.py ./

# åˆ›å»ºæ•°æ®åº“ç­‰å¾…è„šæœ¬ï¼ˆç®€åŒ–ç‰ˆï¼Œåªæ£€æŸ¥è¿žæŽ¥æ€§ï¼‰
RUN echo '#!/bin/bash' > /wait-for-db.sh && \
    echo 'set -e' >> /wait-for-db.sh && \
    echo 'host="$1"' >> /wait-for-db.sh && \
    echo 'shift' >> /wait-for-db.sh && \
    echo 'cmd="$@"' >> /wait-for-db.sh && \
    echo 'echo "Waiting for PostgreSQL at $host:5432..."' >> /wait-for-db.sh && \
    echo 'while ! nc -z "$host" 5432; do' >> /wait-for-db.sh && \
    echo '  echo "PostgreSQL is unavailable - sleeping"' >> /wait-for-db.sh && \
    echo '  sleep 2' >> /wait-for-db.sh && \
    echo 'done' >> /wait-for-db.sh && \
    echo 'echo "PostgreSQL is up - waiting for backend initialization..."' >> /wait-for-db.sh && \
    echo 'sleep 10' >> /wait-for-db.sh && \
    echo 'echo "Backend should be initialized - starting JupyterHub"' >> /wait-for-db.sh && \
    echo 'exec $cmd' >> /wait-for-db.sh && \
    chmod +x /wait-for-db.sh

EXPOSE 8000
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://127.0.0.1:8000/jupyter/hub/api || exit 1

CMD ["/wait-for-db.sh", "postgres", "jupyterhub", "-f", "/srv/jupyterhub/backend_integrated_config.py"]

LABEL maintainer="AI Infrastructure Team" \
    org.opencontainers.image.title="ai-infra-jupyterhub" \
    org.opencontainers.image.version="${APP_VERSION}" \
    org.opencontainers.image.description="AI Infra Matrix - JupyterHub with integrated backend auth"
