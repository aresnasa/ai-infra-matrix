# =============================================================================
# Stage 1: Build SLURM deb packages (Ubuntu 22.04)
# =============================================================================
FROM ubuntu:22.04 AS deb-builder

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# Build control flags - set to "true" to enable building specific components
# æž„å»ºæŽ§åˆ¶å¼€å…³ - è®¾ç½®ä¸º "true" æ¥å¯ç”¨ç‰¹å®šç»„ä»¶çš„æž„å»º
ARG BUILD_SLURM=true
ARG BUILD_SALTSTACK=true
ARG BUILD_CATEGRAF=true
ARG BUILD_SINGULARITY=false

# Package cache optimization - specify a previous image to copy packages from
# åŒ…ç¼“å­˜ä¼˜åŒ– - æŒ‡å®šä¸€ä¸ªå…ˆå‰çš„é•œåƒæ¥å¤åˆ¶åŒ…ï¼Œé¿å…é‡å¤ä¸‹è½½
ARG CACHE_IMAGE=""

# SLURM version configuration - update these when upgrading
# æ›´æ–° SLURM ç‰ˆæœ¬æ—¶åªéœ€ä¿®æ”¹è¿™ä¸¤ä¸ªå˜é‡
ARG SLURM_VERSION=25.05.4
ARG SLURM_TARBALL_NAME=slurm-${SLURM_VERSION}.tar.bz2

# SaltStack version configuration
ARG SALTSTACK_VERSION=v3007.8

# Categraf version configuration
ARG CATEGRAF_VERSION=v0.4.22

# Singularity version configuration
ARG SINGULARITY_VERSION=v4.3.4

# Accept optional tarball path relative to build context root
# é»˜è®¤åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾ tarball
ARG SLURM_TARBALL_PATH=${SLURM_TARBALL_NAME}

# é…ç½®APTé•œåƒæºå’Œå®‰è£…æž„å»ºä¾èµ–ï¼ˆåˆ†æ­¥éª¤é¿å…ç½‘ç»œé—®é¢˜ï¼‰
RUN set -eux; \
    # æ¸…é™¤å¯èƒ½å¹²æ‰°çš„ä»£ç†è®¾ç½®ï¼ˆæž„å»ºå®¹å™¨å†…éƒ¨æ— æ³•è®¿é—®å®¿ä¸»æœºä»£ç†ï¼‰
    unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY all_proxy no_proxy NO_PROXY || true; \
    rm -f /etc/apt/apt.conf.d/*proxy* 2>/dev/null || true; \
    echo 'Acquire::http::Proxy "false";' > /etc/apt/apt.conf.d/99no-proxy; \
    echo 'Acquire::https::Proxy "false";' >> /etc/apt/apt.conf.d/99no-proxy; \
    # å¤‡ä»½åŽŸå§‹sources.list
    cp /etc/apt/sources.list /etc/apt/sources.list.backup; \
    # æ£€æµ‹æž¶æž„
    ARCH=$(dpkg --print-architecture); \
    echo "Detected architecture: ${ARCH}"; \
    # æ ¹æ®æž¶æž„ç›´æŽ¥é…ç½®é˜¿é‡Œäº‘é•œåƒæº
    if [ "${ARCH}" = "arm64" ] || [ "${ARCH}" = "aarch64" ]; then \
        echo "é…ç½®ARM64æž¶æž„çš„é˜¿é‡Œäº‘HTTPé•œåƒæº..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    else \
        echo "é…ç½®AMD64æž¶æž„çš„é˜¿é‡Œäº‘HTTPé•œåƒæº..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    fi; \
    # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…åŸºç¡€å·¥å…·ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
    apt-get update || (sleep 5 && apt-get update) || (sleep 10 && apt-get update); \
    apt-get install -y ca-certificates curl tzdata; \
    ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo "Asia/Shanghai" > /etc/timezone

# Install build prerequisites (åˆ†ç»„å®‰è£…å‡å°‘å¤±è´¥é£Žé™©)
RUN apt-get install -y --no-install-recommends \
       wget git gpg \
       build-essential fakeroot devscripts equivs gdebi-core \
       pkg-config debhelper dh-autoreconf \
    && rm -rf /var/lib/apt/lists/*

# Install development libraries (å•ç‹¬å®‰è£…é¿å…ä¾èµ–å†²çª)
RUN apt-get update && apt-get install -y --no-install-recommends \
       libmunge-dev libmariadb-dev libpam0g-dev libcgroup-dev libhwloc-dev \
    && rm -rf /var/lib/apt/lists/*

# Add a non-root builder user to satisfy debuild
RUN useradd -m -u 1000 builder
USER builder
WORKDIR /home/builder/build

# Copy SLURM source tarball (use wildcard to make it optional-ish)
# Docker will fail if no matching file, but we handle it gracefully in build script
ARG SLURM_TARBALL_PATH
COPY --chown=builder:builder ${SLURM_TARBALL_PATH} /home/builder/build/

# Extract SLURM source
# è§£åŽ‹ tarball å¹¶è®°å½•æºç ç›®å½•åç§°
RUN set -eux; \
    if ls slurm-*.tar.bz2 >/dev/null 2>&1; then \
        tarball=$(ls slurm-*.tar.bz2 | head -1); \
        echo "âœ“ Found SLURM tarball: ${tarball}"; \
        tar -xaf "${tarball}"; \
        srcdir=$(basename "${tarball}" .tar.bz2); \
        echo "SRC=${srcdir}" > /home/builder/build/.srcdir; \
        echo "âœ“ SLURM source extracted: ${srcdir}"; \
        echo "  Version: $(echo ${srcdir} | grep -oP '\\d+\\.\\d+\\.\\d+' || echo 'unknown')"; \
    else \
        echo "SKIP_SLURM_BUILD=1" > /home/builder/build/.srcdir; \
        echo "âš ï¸  No SLURM tarball found - will skip SLURM package build"; \
    fi

# Install build-deps as root, then build .deb packages as unprivileged user (skip if no SLURM source)
USER root
RUN set -eux; \
    if grep -q "SKIP_SLURM_BUILD=1" /home/builder/build/.srcdir; then \
        echo "âš ï¸  Skipping SLURM build - no source tarball available"; \
        mkdir -p /out; \
        touch /out/.skip_slurm; \
    else \
        # æ¸…é™¤å¯èƒ½å¹²æ‰°çš„ä»£ç†è®¾ç½®
        unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY all_proxy no_proxy NO_PROXY || true; \
        # æ¸…é™¤ apt ä»£ç†é…ç½®
        rm -f /etc/apt/apt.conf.d/*proxy* 2>/dev/null || true; \
        echo 'Acquire::http::Proxy "false";' > /etc/apt/apt.conf.d/99no-proxy; \
        echo 'Acquire::https::Proxy "false";' >> /etc/apt/apt.conf.d/99no-proxy; \
        srcdir=$(cut -d= -f2 /home/builder/build/.srcdir); \
        cd "/home/builder/build/${srcdir}"; \
        echo "ðŸ“¦ Updating package list..."; \
        apt-get update || { \
            echo "âš ï¸  Update failed, retrying in 5 seconds..."; \
            sleep 5; \
            apt-get update; \
        }; \
        echo "ðŸ“¦ Installing build dependencies..."; \
        mk-build-deps -i debian/control -t 'apt-get -y --no-install-recommends' --remove || { \
            echo "âš ï¸  mk-build-deps failed, trying with --fix-missing..."; \
            apt-get update && apt-get install -y --fix-missing --no-install-recommends -f; \
            mk-build-deps -i debian/control -t 'apt-get -y --no-install-recommends --fix-missing' --remove; \
        }; \
    fi

USER builder
RUN set -eux; \
    if grep -q "SKIP_SLURM_BUILD=1" /home/builder/build/.srcdir; then \
        echo "âš ï¸  Skipping SLURM package build"; \
    else \
        srcdir=$(cut -d= -f2 /home/builder/build/.srcdir); \
        cd "/home/builder/build/${srcdir}"; \
        dpkg-buildpackage -b -uc; \
    fi

# Download SaltStack packages from GitHub releases
USER root
ARG BUILD_SALTSTACK
ARG SALTSTACK_VERSION
ARG GITHUB_PROXY

# Use BuildKit cache mount for package caching
# This allows packages to be reused across builds without re-downloading
RUN --mount=type=cache,target=/var/cache/saltstack-deb,sharing=locked \
    set -eux; \
    if [ "${BUILD_SALTSTACK}" = "true" ]; then \
        mkdir -p /saltstack-deb; \
        cd /var/cache/saltstack-deb; \
        # ========================================
        # åŒ…ç¼“å­˜ä¼˜åŒ–ï¼šæ£€æŸ¥å¹¶å¤ç”¨ç¼“å­˜ä¸­çš„åŒ…
        # ========================================
        cached_count=$(ls -1 *.deb 2>/dev/null | wc -l || echo 0); \
        if [ "$cached_count" -gt 0 ]; then \
            echo "ðŸ“¦ å‘çŽ°ç¼“å­˜çš„ SaltStack deb åŒ…: ${cached_count} ä¸ª"; \
            echo "âœ“ éªŒè¯ç¼“å­˜åŒ…å®Œæ•´æ€§..."; \
            # éªŒè¯å¹¶å¤åˆ¶æœ‰æ•ˆçš„åŒ…åˆ°ç›®æ ‡ç›®å½•
            valid_count=0; \
            for pkg in *.deb; do \
                if [ -f "$pkg" ] && [ -s "$pkg" ]; then \
                    cp "$pkg" /saltstack-deb/ 2>/dev/null || true; \
                    valid_count=$((valid_count + 1)); \
                fi; \
            done; \
            echo "âœ“ å¤åˆ¶äº† ${valid_count} ä¸ªæœ‰æ•ˆåŒ…åˆ°æž„å»ºç›®å½•"; \
        fi; \
        # ========================================
        # ç½‘ç»œä¸‹è½½ï¼ˆä»…ä¸‹è½½ç¼ºå¤±çš„åŒ…ï¼‰
        # ========================================
        echo "ðŸ“¦ æ£€æŸ¥ SaltStack ${SALTSTACK_VERSION} deb packages..."; \
        # é…ç½®ä»£ç†ï¼ˆå¦‚æžœæä¾›ï¼‰
        if [ -n "${GITHUB_PROXY:-}" ]; then \
            echo "ðŸŒ Using proxy: ${GITHUB_PROXY}"; \
            export ALL_PROXY="${GITHUB_PROXY}"; \
            export HTTP_PROXY="${GITHUB_PROXY}"; \
            export HTTPS_PROXY="${GITHUB_PROXY}"; \
            export http_proxy="${GITHUB_PROXY}"; \
            export https_proxy="${GITHUB_PROXY}"; \
        fi; \
        # GitHub releases åŸºç¡€ URL (ä¿®æ­£ç‰ˆæœ¬å·æ ¼å¼)
        VERSION_NUM="${SALTSTACK_VERSION#v}"; \
        BASE_URL="https://github.com/saltstack/salt/releases/download/${SALTSTACK_VERSION}"; \
        echo "Version: ${VERSION_NUM}"; \
        echo "Base URL: ${BASE_URL}"; \
        # ä¸‹è½½ä¸¤ç§æž¶æž„çš„ deb åŒ…
        total_downloaded=0; \
        total_cached=0; \
        for ARCH_SUFFIX in amd64 arm64; do \
            echo ""; \
            echo "ðŸ“¥ Processing ${ARCH_SUFFIX} packages..."; \
            arch_count=0; \
            # æ£€æŸ¥æ‰€æœ‰ä¸»è¦çš„ deb åŒ…
            for pkg in salt-common salt-master salt-minion salt-api salt-ssh salt-syndic salt-cloud; do \
                PKG_FILE="${pkg}_${VERSION_NUM}_${ARCH_SUFFIX}.deb"; \
                # æ£€æŸ¥åŒ…æ˜¯å¦å·²å­˜åœ¨ï¼ˆä»Žç¼“å­˜å¤åˆ¶æˆ–å·²ä¸‹è½½ï¼‰
                if [ -f "${PKG_FILE}" ] && [ -s "${PKG_FILE}" ]; then \
                    echo "âœ“ Cached: ${PKG_FILE}"; \
                    total_cached=$((total_cached + 1)); \
                    arch_count=$((arch_count + 1)); \
                    continue; \
                fi; \
                echo "Downloading: ${PKG_FILE}"; \
                for attempt in 1 2 3; do \
                    if wget --timeout=60 --tries=3 -nv "${BASE_URL}/${PKG_FILE}"; then \
                        echo "âœ“ Downloaded: ${PKG_FILE}"; \
                        # ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶ï¼ˆç”¨äºŽåŽç»­éªŒè¯ï¼‰
                        shasum -a 256 "${PKG_FILE}" > "${PKG_FILE}.sha256" 2>/dev/null || true; \
                        # å¤åˆ¶åˆ°æž„å»ºç›®å½•
                        cp "${PKG_FILE}" /saltstack-deb/ 2>/dev/null || true; \
                        total_downloaded=$((total_downloaded + 1)); \
                        arch_count=$((arch_count + 1)); \
                        break; \
                    else \
                        echo "âš ï¸  Attempt ${attempt}/3 failed"; \
                        if [ $attempt -lt 3 ]; then sleep 2; fi; \
                    fi; \
                done || echo "âœ— Failed to download ${PKG_FILE}"; \
            done; \
            echo "âœ“ ${ARCH_SUFFIX}: ${arch_count} packages available"; \
        done; \
        # æ£€æŸ¥ç»“æžœ
        echo ""; \
        echo "ðŸ“Š Package Summary:"; \
        echo "   Cached: ${total_cached}"; \
        echo "   Downloaded: ${total_downloaded}"; \
        total_packages=$((total_cached + total_downloaded)); \
        if [ "$total_packages" -gt 0 ]; then \
            echo "âœ“ Total available: ${total_packages} SaltStack deb packages"; \
            echo ""; \
            echo "AMD64 packages:"; \
            ls -lh /saltstack-deb/*_amd64.deb 2>/dev/null || echo "  (none)"; \
            echo ""; \
            echo "ARM64 packages:"; \
            ls -lh /saltstack-deb/*_arm64.deb 2>/dev/null || echo "  (none)"; \
        else \
            echo "âš ï¸  No SaltStack packages available"; \
        fi; \
    else \
        echo "â­ï¸  Skipping SaltStack download (BUILD_SALTSTACK=${BUILD_SALTSTACK})"; \
        mkdir -p /saltstack-deb; \
    fi

# Collect artifacts into /out (root stage)
RUN mkdir -p /out \
    && chown -R root:root /home/builder

# Move all debuild outputs to /out (skip verification if SLURM build was skipped)
RUN set -eux; \
    if [ ! -f /out/.skip_slurm ]; then \
        find /home/builder/build -maxdepth 1 -type f -name '*.deb' -exec mv {} /out/ \; || true; \
        find /home/builder/build -maxdepth 1 -type f -name '*.ddeb' -exec mv {} /out/ \; || true; \
        find /home/builder/build -maxdepth 1 -type f -name '*.build*' -exec mv {} /out/ \; || true; \
        find /home/builder/build -maxdepth 1 -type f -name '*.changes' -exec mv {} /out/ \; || true; \
        # Verify at least one .deb file was produced
        deb_count=$(find /out -name '*.deb' -type f | wc -l); \
        if [ "$deb_count" -eq 0 ]; then \
            echo "ERROR: No .deb packages were built!"; \
            echo "Build artifacts in /home/builder:"; \
            ls -la /home/builder/ || true; \
            echo "Build artifacts in /home/builder/build:"; \
            ls -la /home/builder/build/ || true; \
            exit 1; \
        fi; \
        echo "âœ“ Successfully built $deb_count SLURM .deb package(s)"; \
    else \
        echo "âš ï¸  SLURM build was skipped - no packages to collect"; \
    fi; \
    # Copy SaltStack packages
    if [ -d /saltstack-deb ] && [ "$(ls -A /saltstack-deb/*.deb 2>/dev/null)" ]; then \
        cp /saltstack-deb/*.deb /out/ || true; \
        salt_count=$(ls /saltstack-deb/*.deb 2>/dev/null | wc -l || echo 0); \
        echo "âœ“ Added ${salt_count} SaltStack deb packages"; \
        ls -lh /out/salt*.deb 2>/dev/null || true; \
    fi

# =============================================================================
# Stage 2: Build SLURM rpm packages (Rocky Linux 9)
# =============================================================================
FROM rockylinux:9 AS rpm-builder

ENV TZ=Asia/Shanghai

# Build control flags
ARG BUILD_SLURM=true
ARG BUILD_SALTSTACK=true

# SLURM version configuration (same as deb builder)
ARG SLURM_VERSION=25.05.4
ARG SLURM_TARBALL_NAME=slurm-${SLURM_VERSION}.tar.bz2
ARG SLURM_TARBALL_PATH=${SLURM_TARBALL_NAME}

# SaltStack version configuration (same as deb builder)
ARG SALTSTACK_VERSION=v3007.8

# é…ç½® Rocky Linux é•œåƒæºï¼ˆå¯é€‰ï¼Œå¦‚æžœç½‘ç»œä¸å¥½åˆ™è·³è¿‡ï¼‰
# æ³¨æ„ï¼šä¹Ÿå¯ä»¥é€šè¿‡ docker build --build-arg HTTP_PROXY=... ä½¿ç”¨ä»£ç†
RUN set -eux; \
    echo "å°è¯•é…ç½® Rocky Linux é˜¿é‡Œäº‘é•œåƒæºï¼ˆå¯é€‰ï¼‰..."; \
    # å¤‡ä»½åŽŸå§‹é…ç½®
    cp -r /etc/yum.repos.d /etc/yum.repos.d.backup 2>/dev/null || true; \
    # å°è¯•é…ç½®é˜¿é‡Œäº‘é•œåƒæº
    ( \
        sed -e 's|^mirrorlist=|#mirrorlist=|g' \
            -e 's|^#baseurl=http://dl.rockylinux.org/\$contentdir|baseurl=http://mirrors.aliyun.com/rockylinux|g' \
            -i.bak \
            /etc/yum.repos.d/rocky*.repo 2>/dev/null && \
        dnf clean all 2>/dev/null && \
        dnf makecache 2>/dev/null && \
        echo "âœ“ æˆåŠŸé…ç½®é˜¿é‡Œäº‘é•œåƒæº" \
    ) || { \
        echo "âš ï¸ é•œåƒæºé…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"; \
        cp -r /etc/yum.repos.d.backup/* /etc/yum.repos.d/ 2>/dev/null || true; \
        dnf clean all 2>/dev/null || true; \
    }

# Install build prerequisites and enable required repositories
RUN set -eux; \
    # Enable PowerTools/CRB repository for additional development packages
    dnf config-manager --set-enabled crb 2>/dev/null || \
    dnf config-manager --set-enabled powertools 2>/dev/null || \
    echo "PowerTools/CRB repository not available"; \
    dnf install -y epel-release || echo "EPEL repository not available"; \
    # åªæ›´æ–°å…ƒæ•°æ®ç¼“å­˜ï¼Œä¸æ›´æ–°æ‰€æœ‰åŒ…ï¼ˆé¿å…ç½‘ç»œé—®é¢˜ï¼‰
    dnf makecache --refresh || dnf makecache || true; \
    # Install basic build dependencies first
    echo "ðŸ“¦ Installing RPM build tools..."; \
    dnf install -y \
        rpm-build \
        rpmdevtools \
        redhat-rpm-config \
        gcc \
        make \
        wget \
        tar \
        bzip2 \
        pam-devel \
        readline-devel \
        perl-ExtUtils-MakeMaker \
        openssl-devel; \
    # Verify rpmdevtools installation
    echo "âœ“ Verifying rpmdevtools installation..."; \
    which rpmdev-setuptree || { \
        echo "âŒ rpmdev-setuptree not found, trying to reinstall..."; \
        dnf reinstall -y rpmdevtools || dnf install -y rpmdevtools; \
    }; \
    which rpmdev-setuptree && echo "âœ“ rpmdev-setuptree found: $(which rpmdev-setuptree)"; \
    dnf clean all; \
    # Try to install optional dependencies (may not be available)
    echo "å°è¯•å®‰è£…å¯é€‰ä¾èµ–åŒ…..."; \
    dnf install -y munge-devel 2>/dev/null || echo "âš ï¸  munge-devel not available"; \
    dnf install -y mariadb-devel 2>/dev/null || echo "âš ï¸  mariadb-devel not available"; \
    dnf install -y mysql-devel 2>/dev/null || echo "âš ï¸  mysql-devel not available"; \
    dnf install -y hwloc-devel 2>/dev/null || echo "âš ï¸  hwloc-devel not available"; \
    dnf install -y json-c-devel 2>/dev/null || echo "âš ï¸  json-c-devel not available"; \
    dnf install -y yaml-devel 2>/dev/null || echo "âš ï¸  yaml-devel not available (trying libyaml-devel)"; \
    dnf install -y libyaml-devel 2>/dev/null || echo "âš ï¸  libyaml-devel not available"; \
    echo "ä¾èµ–åŒ…å®‰è£…å®Œæˆ"

# Add non-root builder user
RUN useradd -m -u 1000 builder
USER builder
WORKDIR /home/builder/build

# Setup RPM build environment
RUN set -eux; \
    echo "ðŸ“ Setting up RPM build tree..."; \
    # Check if rpmdev-setuptree is available
    if command -v rpmdev-setuptree >/dev/null 2>&1; then \
        rpmdev-setuptree; \
        echo "âœ“ RPM build tree created successfully"; \
    else \
        # Manual setup if rpmdev-setuptree is not available
        echo "âš ï¸  rpmdev-setuptree not found, creating directories manually..."; \
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}; \
        echo "%_topdir %(echo \$HOME)/rpmbuild" > ~/.rpmmacros; \
        echo "âœ“ RPM build tree created manually"; \
    fi; \
    ls -la ~/rpmbuild/ || echo "Warning: rpmbuild directory check failed"

# Copy SLURM source tarball
ARG SLURM_TARBALL_PATH
COPY --chown=builder:builder ${SLURM_TARBALL_PATH} /home/builder/build/

# Build SLURM RPM packages
RUN set -eux; \
    if [ "${BUILD_SLURM}" = "true" ]; then \
        echo "ðŸ“¦ Building SLURM ${SLURM_VERSION} RPM packages..."; \
        cd /home/builder/build; \
        # Extract source tarball
        tarball=$(ls slurm-*.tar.bz2 | head -1); \
        echo "âœ“ Found SLURM tarball: ${tarball}"; \
        tar -xaf "${tarball}"; \
        srcdir=$(basename "${tarball}" .tar.bz2); \
        cd "${srcdir}"; \
        # Setup rpmbuild directories
        echo ">>> Setting up rpmbuild environment..."; \
        mkdir -p /home/builder/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}; \
        cp ../"${tarball}" /home/builder/rpmbuild/SOURCES/; \
        # Configure SLURM
        echo ">>> Configuring SLURM for RPM build..."; \
        ./configure \
            --prefix=/usr \
            --sysconfdir=/etc/slurm \
            --disable-debug \
            --with-munge \
            --enable-pam \
            --without-rpath 2>&1 | tee /tmp/configure-rpm.log || { \
            echo "âŒ Configure failed! Last 50 lines of output:"; \
            tail -50 /tmp/configure-rpm.log; \
            exit 1; \
        }; \
        # Build RPM packages using make rpm
        echo ">>> Building SLURM RPM packages (this may take 10-15 minutes)..."; \
        echo ">>> Current directory: $(pwd)"; \
        make contrib 2>&1 | tee /tmp/make-contrib.log || { \
            echo "âŒ Make contrib failed! Last 100 lines of output:"; \
            tail -100 /tmp/make-contrib.log; \
            exit 1; \
        }; \
        make rpm 2>&1 | tee /tmp/make-rpm.log || { \
            echo "âŒ Make RPM failed! Last 100 lines of output:"; \
            tail -100 /tmp/make-rpm.log; \
            exit 1; \
        }; \
        echo "âœ“ SLURM RPM build completed successfully"; \
        echo ">>> Listing RPM build output locations:"; \
        find /home/builder -name "*.rpm" -type f 2>/dev/null | head -20 || echo "No RPMs found yet"; \
    else \
        echo "ðŸš« Skipping SLURM RPM build (BUILD_SLURM=false)"; \
        mkdir -p /home/builder/rpms; \
        touch /home/builder/rpms/.skip_slurm; \
    fi

# Download SaltStack packages from GitHub releases
USER root
ARG BUILD_SALTSTACK
ARG SALTSTACK_VERSION
ARG GITHUB_PROXY

# Use BuildKit cache mount for package caching
# This allows packages to be reused across builds without re-downloading
RUN --mount=type=cache,target=/var/cache/saltstack-rpm,sharing=locked \
    set -eux; \
    if [ "${BUILD_SALTSTACK}" = "true" ]; then \
        mkdir -p /saltstack-rpm; \
        cd /var/cache/saltstack-rpm; \
        # ========================================
        # åŒ…ç¼“å­˜ä¼˜åŒ–ï¼šæ£€æŸ¥å¹¶å¤ç”¨ç¼“å­˜ä¸­çš„åŒ…
        # ========================================
        cached_count=$(ls -1 *.rpm 2>/dev/null | wc -l || echo 0); \
        if [ "$cached_count" -gt 0 ]; then \
            echo "ï¿½ å‘çŽ°ç¼“å­˜çš„ SaltStack rpm åŒ…: ${cached_count} ä¸ª"; \
            echo "âœ“ éªŒè¯ç¼“å­˜åŒ…å®Œæ•´æ€§..."; \
            # éªŒè¯å¹¶å¤åˆ¶æœ‰æ•ˆçš„åŒ…åˆ°ç›®æ ‡ç›®å½•
            valid_count=0; \
            for pkg in *.rpm; do \
                if [ -f "$pkg" ] && [ -s "$pkg" ]; then \
                    cp "$pkg" /saltstack-rpm/ 2>/dev/null || true; \
                    valid_count=$((valid_count + 1)); \
                fi; \
            done; \
            echo "âœ“ å¤åˆ¶äº† ${valid_count} ä¸ªæœ‰æ•ˆåŒ…åˆ°æž„å»ºç›®å½•"; \
        fi; \
        # ========================================
        # ç½‘ç»œä¸‹è½½ï¼ˆä»…ä¸‹è½½ç¼ºå¤±çš„åŒ…ï¼‰
        # ========================================
        echo "ðŸ“¦ æ£€æŸ¥ SaltStack ${SALTSTACK_VERSION} rpm packages..."; \
        # é…ç½®ä»£ç†ï¼ˆå¦‚æžœæä¾›ï¼‰
        if [ -n "${GITHUB_PROXY:-}" ]; then \
            echo "ðŸŒ Using proxy: ${GITHUB_PROXY}"; \
            export ALL_PROXY="${GITHUB_PROXY}"; \
            export HTTP_PROXY="${GITHUB_PROXY}"; \
            export HTTPS_PROXY="${GITHUB_PROXY}"; \
            export http_proxy="${GITHUB_PROXY}"; \
            export https_proxy="${GITHUB_PROXY}"; \
        fi; \
        # GitHub releases åŸºç¡€ URL (ä¿®æ­£ç‰ˆæœ¬å·æ ¼å¼)
        VERSION_NUM="${SALTSTACK_VERSION#v}"; \
        BASE_URL="https://github.com/saltstack/salt/releases/download/${SALTSTACK_VERSION}"; \
        echo "Version: ${VERSION_NUM}"; \
        echo "Base URL: ${BASE_URL}"; \
        # ä¸‹è½½ä¸¤ç§æž¶æž„çš„ rpm åŒ…
        total_downloaded=0; \
        total_cached=0; \
        for ARCH_SUFFIX in x86_64 aarch64; do \
            echo ""; \
            echo "ðŸ“¥ Processing ${ARCH_SUFFIX} packages..."; \
            arch_count=0; \
            # æ£€æŸ¥æ‰€æœ‰ä¸»è¦çš„ rpm åŒ…
            for pkg in salt salt-master salt-minion salt-api salt-ssh salt-syndic salt-cloud; do \
                PKG_FILE="${pkg}-${VERSION_NUM}-0.${ARCH_SUFFIX}.rpm"; \
                # æ£€æŸ¥åŒ…æ˜¯å¦å·²å­˜åœ¨ï¼ˆä»Žç¼“å­˜å¤åˆ¶æˆ–å·²ä¸‹è½½ï¼‰
                if [ -f "${PKG_FILE}" ] && [ -s "${PKG_FILE}" ]; then \
                    echo "âœ“ Cached: ${PKG_FILE}"; \
                    total_cached=$((total_cached + 1)); \
                    arch_count=$((arch_count + 1)); \
                    continue; \
                fi; \
                echo "Downloading: ${PKG_FILE}"; \
                for attempt in 1 2 3; do \
                    if wget --timeout=60 --tries=3 -nv "${BASE_URL}/${PKG_FILE}"; then \
                        echo "âœ“ Downloaded: ${PKG_FILE}"; \
                        # ç”Ÿæˆ SHA256 æ ¡éªŒæ–‡ä»¶ï¼ˆç”¨äºŽåŽç»­éªŒè¯ï¼‰
                        sha256sum "${PKG_FILE}" > "${PKG_FILE}.sha256" 2>/dev/null || \
                        shasum -a 256 "${PKG_FILE}" > "${PKG_FILE}.sha256" 2>/dev/null || true; \
                        # å¤åˆ¶åˆ°æž„å»ºç›®å½•
                        cp "${PKG_FILE}" /saltstack-rpm/ 2>/dev/null || true; \
                        total_downloaded=$((total_downloaded + 1)); \
                        arch_count=$((arch_count + 1)); \
                        break; \
                    else \
                        echo "âš ï¸  Attempt ${attempt}/3 failed"; \
                        if [ $attempt -lt 3 ]; then sleep 2; fi; \
                    fi; \
                done || echo "âœ— Failed to download ${PKG_FILE}"; \
            done; \
            echo "âœ“ ${ARCH_SUFFIX}: ${arch_count} packages available"; \
        done; \
        # æ£€æŸ¥ç»“æžœ
        echo ""; \
        echo "ðŸ“Š Package Summary:"; \
        echo "   Cached: ${total_cached}"; \
        echo "   Downloaded: ${total_downloaded}"; \
        total_packages=$((total_cached + total_downloaded)); \
        if [ "$total_packages" -gt 0 ]; then \
            echo "âœ“ Total available: ${total_packages} SaltStack rpm packages"; \
            echo ""; \
            echo "x86_64 packages:"; \
            ls -lh /saltstack-rpm/*.x86_64.rpm 2>/dev/null || echo "  (none)"; \
            echo ""; \
            echo "aarch64 packages:"; \
            ls -lh /saltstack-rpm/*.aarch64.rpm 2>/dev/null || echo "  (none)"; \
        else \
            echo "âš ï¸  No SaltStack packages available"; \
        fi; \
    else \
        echo "â­ï¸  Skipping SaltStack download (BUILD_SALTSTACK=${BUILD_SALTSTACK})"; \
        mkdir -p /saltstack-rpm; \
    fi

# Collect RPM artifacts
RUN set -eux; \
    mkdir -p /out; \
    echo "ðŸ“¦ Collecting RPM packages..."; \
    if [ ! -f /home/builder/rpms/.skip_slurm ] && [ "${BUILD_SLURM}" = "true" ]; then \
        # Find and copy built SLURM RPMs from all possible locations
        echo ">>> Looking for SLURM RPM packages..."; \
        echo ">>> Searching in common RPM build locations:"; \
        # List all possible locations
        find /home/builder -name "*.rpm" -type f 2>/dev/null | head -20 || echo "No RPMs found with find command"; \
        # Check rpmbuild directory structure (standard rpmbuild location)
        if [ -d /home/builder/rpmbuild/RPMS ]; then \
            echo "  Checking: /home/builder/rpmbuild/RPMS"; \
            find /home/builder/rpmbuild/RPMS -type f -name '*.rpm' -exec cp {} /out/ \; 2>/dev/null || true; \
        fi; \
        # Check source directory (make rpm sometimes puts RPMs here)
        if [ -d /home/builder/build ]; then \
            echo "  Checking: /home/builder/build"; \
            find /home/builder/build -type f -name '*.rpm' -exec cp {} /out/ \; 2>/dev/null || true; \
        fi; \
        # Check home directory root (backup location)
        echo "  Checking: /home/builder"; \
        find /home/builder -maxdepth 3 -type f -name '*.rpm' -exec cp {} /out/ \; 2>/dev/null || true; \
        # Remove duplicates and debug symbols if needed
        cd /out && rm -f *-debuginfo-*.rpm *-debugsource-*.rpm 2>/dev/null || true; \
        # Count collected RPMs
        rpm_count=$(ls /out/*.rpm 2>/dev/null | wc -l || echo 0); \
        if [ "$rpm_count" -gt 0 ]; then \
            echo "âœ“ Successfully collected ${rpm_count} SLURM RPM package(s)"; \
            echo ">>> SLURM RPM packages:"; \
            ls -lh /out/*.rpm; \
        else \
            echo "âš ï¸  No SLURM RPM packages were found"; \
            echo ">>> Listing /home/builder structure for debugging:"; \
            ls -laR /home/builder/ | head -100 || true; \
            touch /out/.skip_slurm; \
        fi; \
    else \
        echo "âš ï¸  SLURM RPM build was skipped"; \
        touch /out/.skip_slurm; \
    fi; \
    # Copy SaltStack packages (CRITICAL: ensure they exist before copying)
    echo "ðŸ“¦ Checking SaltStack packages..."; \
    if [ -d /saltstack-rpm ]; then \
        salt_rpm_count=$(ls /saltstack-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
        echo "Found ${salt_rpm_count} SaltStack rpm files in /saltstack-rpm"; \
        if [ "$salt_rpm_count" -gt 0 ]; then \
            ls -lh /saltstack-rpm/*.rpm; \
            cp /saltstack-rpm/*.rpm /out/ || { \
                echo "âŒ Failed to copy SaltStack RPMs"; \
                exit 1; \
            }; \
            echo "âœ“ Copied ${salt_rpm_count} SaltStack rpm packages to /out"; \
            ls -lh /out/salt*.rpm 2>/dev/null || echo "âš ï¸  No salt*.rpm in /out"; \
        else \
            echo "âš ï¸  No SaltStack RPM files found in /saltstack-rpm"; \
        fi; \
    else \
        echo "âŒ /saltstack-rpm directory does not exist"; \
    fi; \
    # Final verification
    echo "ðŸ“Š Final /out contents:"; \
    ls -lh /out/ || echo "âš ï¸  /out is empty"; \
    total_rpm_count=$(ls /out/*.rpm 2>/dev/null | wc -l || echo 0); \
    echo "âœ“ Total RPM packages in /out: ${total_rpm_count}"; \
    # Generate RPM repository metadata using createrepo_c (Rocky Linux has it)
    echo "ðŸ”§ Installing createrepo_c for metadata generation..."; \
    dnf install -y createrepo_c 2>/dev/null || { \
        echo "âš ï¸  createrepo_c not available, trying createrepo..."; \
        dnf install -y createrepo 2>/dev/null || echo "âš ï¸  No createrepo tools available"; \
    }; \
    # Separate SLURM and SaltStack RPMs into subdirectories
    mkdir -p /out/slurm-rpm /out/saltstack-rpm; \
    # Check if there are any RPM files to organize
    if ls /out/*.rpm >/dev/null 2>&1; then \
        echo "ðŸ“¦ Organizing RPM packages..."; \
        mv /out/slurm-*.rpm /out/slurm-rpm/ 2>/dev/null || true; \
        mv /out/salt-*.rpm /out/saltstack-rpm/ 2>/dev/null || true; \
        # Count packages in each directory
        slurm_count=$(ls /out/slurm-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
        salt_count=$(ls /out/saltstack-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
        echo "  - SLURM RPMs: ${slurm_count}"; \
        echo "  - SaltStack RPMs: ${salt_count}"; \
        # Generate metadata for SLURM repository
        if [ "$slurm_count" -gt 0 ] && command -v createrepo_c >/dev/null 2>&1; then \
            echo "ðŸ”§ Generating SLURM RPM repository metadata..."; \
            cd /out/slurm-rpm && createrepo_c . && \
            echo "âœ“ Generated SLURM repodata: $(ls -d repodata 2>/dev/null || echo 'failed')"; \
        elif [ "$slurm_count" -gt 0 ] && command -v createrepo >/dev/null 2>&1; then \
            echo "ðŸ”§ Generating SLURM RPM repository metadata (using createrepo)..."; \
            cd /out/slurm-rpm && createrepo . && \
            echo "âœ“ Generated SLURM repodata"; \
        fi; \
        # Generate metadata for SaltStack repository
        if [ "$salt_count" -gt 0 ] && command -v createrepo_c >/dev/null 2>&1; then \
            echo "ðŸ”§ Generating SaltStack RPM repository metadata..."; \
            cd /out/saltstack-rpm && createrepo_c . && \
            echo "âœ“ Generated SaltStack repodata: $(ls -d repodata 2>/dev/null || echo 'failed')"; \
        elif [ "$salt_count" -gt 0 ] && command -v createrepo >/dev/null 2>&1; then \
            echo "ðŸ”§ Generating SaltStack RPM repository metadata (using createrepo)..."; \
            cd /out/saltstack-rpm && createrepo . && \
            echo "âœ“ Generated SaltStack repodata"; \
        fi; \
    fi

# =============================================================================
# Stage 3: Build SLURM binaries (Ubuntu 22.04 with glibc)
# Alpine uses musl libc which doesn't support cpu_set_t, so we use Ubuntu
# =============================================================================
FROM ubuntu:22.04 AS binary-builder

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# Build control flags
ARG BUILD_SLURM=true

# SLURM version configuration
ARG SLURM_VERSION=25.05.4
ARG SLURM_TARBALL_NAME=slurm-${SLURM_VERSION}.tar.bz2
ARG SLURM_TARBALL_PATH=${SLURM_TARBALL_NAME}

# é…ç½® Ubuntu é•œåƒæºï¼ˆé˜¿é‡Œäº‘ï¼‰å¹¶å®‰è£…æ‰€æœ‰ä¾èµ–
RUN set -eux; \
    # æ¸…é™¤å¯èƒ½å¹²æ‰°çš„ä»£ç†è®¾ç½®ï¼ˆæž„å»ºå®¹å™¨å†…éƒ¨æ— æ³•è®¿é—®å®¿ä¸»æœºä»£ç†ï¼‰
    unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY all_proxy no_proxy NO_PROXY || true; \
    rm -f /etc/apt/apt.conf.d/*proxy* 2>/dev/null || true; \
    echo 'Acquire::http::Proxy "false";' > /etc/apt/apt.conf.d/99no-proxy; \
    echo 'Acquire::https::Proxy "false";' >> /etc/apt/apt.conf.d/99no-proxy; \
    # æ£€æµ‹æž¶æž„
    ARCH=$(dpkg --print-architecture); \
    echo "Detected architecture: ${ARCH}"; \
    # å¤‡ä»½åŽŸå§‹æº
    cp /etc/apt/sources.list /etc/apt/sources.list.backup || true; \
    # æ ¹æ®æž¶æž„é…ç½®é˜¿é‡Œäº‘é•œåƒæº
    if [ "${ARCH}" = "arm64" ] || [ "${ARCH}" = "aarch64" ]; then \
        echo "é…ç½®ARM64æž¶æž„çš„é˜¿é‡Œäº‘é•œåƒæº..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse" > /etc/apt/sources.list; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    else \
        echo "é…ç½®AMD64æž¶æž„çš„é˜¿é‡Œäº‘é•œåƒæº..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    fi; \
    echo "å½“å‰é…ç½®çš„é•œåƒæº:"; \
    cat /etc/apt/sources.list; \
    # æ¸…ç†æ—§ç¼“å­˜
    rm -rf /var/lib/apt/lists/*; \
    # å°è¯•æ›´æ–°åŒ…åˆ—è¡¨ï¼ˆå¸¦é‡è¯•å’Œå›žé€€åˆ°å®˜æ–¹æºï¼‰
    if ! apt-get update 2>&1; then \
        echo "âš ï¸  é˜¿é‡Œäº‘æºå¤±è´¥ï¼Œç­‰å¾…5ç§’åŽé‡è¯•..."; \
        sleep 5; \
        if ! apt-get update 2>&1; then \
            echo "âš ï¸  ä»ç„¶å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å®˜æ–¹æº..."; \
            if [ "${ARCH}" = "arm64" ] || [ "${ARCH}" = "aarch64" ]; then \
                echo "deb http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse" > /etc/apt/sources.list; \
                echo "deb http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse" >> /etc/apt/sources.list; \
                echo "deb http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list; \
            else \
                echo "deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse" > /etc/apt/sources.list; \
                echo "deb http://security.ubuntu.com/ubuntu jammy-security main restricted universe multiverse" >> /etc/apt/sources.list; \
                echo "deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list; \
            fi; \
            echo "ä½¿ç”¨å®˜æ–¹æº:"; \
            cat /etc/apt/sources.list; \
            rm -rf /var/lib/apt/lists/*; \
            apt-get update || ( echo "âŒ å®˜æ–¹æºä¹Ÿå¤±è´¥äº†ï¼" && exit 1 ); \
        fi; \
    fi; \
    echo "âœ“ apt-get update æˆåŠŸ"; \
    # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåˆ†ç»„å®‰è£…ï¼Œæé«˜æˆåŠŸçŽ‡ï¼‰
    echo "å®‰è£…åŸºç¡€å·¥å…·..."; \
    apt-get install -y --no-install-recommends \
        ca-certificates \
        tzdata \
        build-essential \
        wget \
        tar \
        bzip2 \
        python3 \
        python3-pip && \
    echo "å®‰è£…å¼€å‘åº“..."; \
    apt-get install -y --no-install-recommends \
        libmunge-dev \
        libmariadb-dev \
        libpam0g-dev \
        libhwloc-dev \
        libjson-c-dev \
        libyaml-dev \
        libssl-dev \
        libreadline-dev || \
    ( echo "âš ï¸  libreadline-dev å®‰è£…å¤±è´¥ï¼Œå°è¯•æ›¿ä»£åŒ…..." && \
      apt-get install -y --no-install-recommends libreadline8 || \
      echo "âš ï¸  ç»§ç»­æž„å»ºï¼Œè·³è¿‡ readline åº“" ); \
    ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo "Asia/Shanghai" > /etc/timezone; \
    rm -rf /var/lib/apt/lists/*

# åˆ›å»ºæž„å»ºç”¨æˆ·
RUN useradd -m -u 1000 builder
USER builder
WORKDIR /home/builder/build

# å¤åˆ¶ SLURM æºç åŒ…
COPY --chown=builder:builder ${SLURM_TARBALL_PATH} /home/builder/build/

# è§£åŽ‹å¹¶ç¼–è¯‘ SLURM
RUN set -eux; \
    if [ "$BUILD_SLURM" = "true" ]; then \
        tarball=$(ls slurm-*.tar.bz2 | head -1); \
        echo "âœ“ Found SLURM tarball: ${tarball}"; \
        tar -xaf "${tarball}"; \
        srcdir=$(basename "${tarball}" .tar.bz2); \
        cd "${srcdir}"; \
        echo ">>> Configuring SLURM..."; \
        ./configure \
            --prefix=/usr/local/slurm \
            --sysconfdir=/etc/slurm \
            --disable-debug \
            --without-rpath 2>&1 | tee /tmp/configure.log || { \
            echo "âŒ Configure failed! Last 50 lines of output:"; \
            tail -50 /tmp/configure.log; \
            exit 1; \
        }; \
        echo ">>> Building SLURM (this may take 5-10 minutes)..."; \
        make -j$(nproc) 2>&1 | tee /tmp/make.log || { \
            echo "âŒ Make failed! Last 100 lines of output:"; \
            tail -100 /tmp/make.log; \
            exit 1; \
        }; \
        echo "âœ“ SLURM build completed successfully"; \
    else \
        echo "ðŸš« Skipping SLURM build (BUILD_SLURM=false)"; \
        mkdir -p /tmp/empty-slurm; \
        cd /tmp/empty-slurm; \
        echo "# Empty directory for skipped SLURM build" > README.txt; \
    fi

# å®‰è£…åˆ°ä¸´æ—¶ç›®å½•å¹¶æ”¶é›†äºŒè¿›åˆ¶æ–‡ä»¶
USER root
RUN set -eux; \
    if [ "$BUILD_SLURM" = "true" ]; then \
        cd /home/builder/build/slurm-*; \
        ARCH=$(uname -m); \
        echo "Architecture: ${ARCH}"; \
        mkdir -p /out/packages/${ARCH}; \
        mkdir -p /out/packages/${ARCH}/bin; \
        mkdir -p /out/packages/${ARCH}/lib; \
        echo ">>> Collecting SLURM binaries..."; \
        for cmd in sinfo squeue scontrol scancel sbatch srun salloc sacct sacctmgr; do \
            if [ -f "src/${cmd}/${cmd}" ]; then \
                cp -f "src/${cmd}/${cmd}" /out/packages/${ARCH}/bin/; \
                chmod +x /out/packages/${ARCH}/bin/${cmd}; \
                echo "  âœ“ Collected: ${cmd}"; \
            elif [ -f "src/${cmd}/.libs/${cmd}" ]; then \
                cp -f "src/${cmd}/.libs/${cmd}" /out/packages/${ARCH}/bin/; \
                chmod +x /out/packages/${ARCH}/bin/${cmd}; \
                echo "  âœ“ Collected: ${cmd} (from .libs)"; \
            else \
                echo "  âœ— Not found: ${cmd}"; \
            fi; \
        done; \
        echo ">>> Collecting SLURM libraries..."; \
        if [ -d "src/api/.libs" ]; then \
            find src/api/.libs -name "libslurm*.so*" -type f -exec cp {} /out/packages/${ARCH}/lib/ \; || true; \
        fi; \
        if [ -d "src/common/.libs" ]; then \
            find src/common/.libs -name "libslurm*.so*" -type f -exec cp {} /out/packages/${ARCH}/lib/ \; || true; \
        fi; \
        echo "${SLURM_VERSION}" > /out/packages/${ARCH}/VERSION; \
        echo ""; \
        echo "ðŸ“¦ SLURM binaries for ${ARCH}:"; \
        ls -lh /out/packages/${ARCH}/bin/ || true; \
        echo ""; \
        echo "ðŸ“š SLURM libraries for ${ARCH}:"; \
        ls -lh /out/packages/${ARCH}/lib/ || true; \
    else \
        echo "ðŸš« Skipping SLURM binary collection (BUILD_SLURM=false)"; \
        mkdir -p /out/packages/empty; \
        echo "No SLURM binaries built" > /out/packages/empty/README.txt; \
    fi

# =============================================================================
# Stage 4: Build Categraf (Multi-Architecture Go Binary)
# æ³›åŒ–çš„åº”ç”¨æž„å»ºé˜¶æ®µ - åªéœ€å¤åˆ¶ scripts/categraf/ ç›®å½•å³å¯
# =============================================================================
FROM golang:1.25-alpine AS categraf-builder

# Build control flags
ARG BUILD_CATEGRAF=true

# Categraf version configuration
ARG CATEGRAF_VERSION=v0.4.22
ARG CATEGRAF_REPO=https://github.com/flashcatcloud/categraf.git

# é…ç½® Go ä»£ç†ï¼ˆä¸­å›½é•œåƒåŠ é€Ÿï¼‰
ENV GOPROXY=https://goproxy.cn,https://proxy.golang.org,direct
ENV GO111MODULE=on
ENV CGO_ENABLED=0

# é…ç½® Alpine é•œåƒæºå¹¶å®‰è£…ä¾èµ–ï¼ˆåˆå¹¶åˆ°ä¸€ä¸ªRUNå‡å°‘å±‚æ•°ï¼‰
RUN set -eux; \
    # å¤‡ä»½å¹¶é…ç½®é•œåƒæº
    cp /etc/apk/repositories /etc/apk/repositories.bak || true; \
    ARCH=$(uname -m); \
    echo "Detected architecture: ${ARCH}"; \
    # æ ¹æ®æž¶æž„é…ç½®é•œåƒæº
    if [ "${ARCH}" = "aarch64" ]; then \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/community" >> /etc/apk/repositories; \
    else \
        echo "https://mirrors.aliyun.com/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.aliyun.com/alpine/v3.20/community" >> /etc/apk/repositories; \
    fi; \
    # æ›´æ–°åŒ…ç´¢å¼•ï¼ˆå¸¦é‡è¯•å’Œå¤‡ç”¨æºï¼‰
    apk update || { \
        echo "ä¸»é•œåƒæºå¤±è´¥ï¼Œåˆ‡æ¢åˆ°å®˜æ–¹æº..."; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    } || { \
        echo "å°è¯•ä½¿ç”¨HTTPåè®®..."; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    }; \
    # å®‰è£…æž„å»ºä¾èµ–
    apk add --no-cache git make bash tar gzip sed coreutils

# å¤åˆ¶é€šç”¨æž„å»ºè„šæœ¬å’Œåº”ç”¨ç‰¹å®šè„šæœ¬
COPY scripts/build-app.sh /scripts/build-app.sh
COPY scripts/categraf/ /scripts/categraf/
RUN chmod +x /scripts/build-app.sh /scripts/categraf/*.sh

# åˆ›å»ºè¾“å‡ºç›®å½•
RUN mkdir -p /out

# æ‰§è¡Œæž„å»ºï¼ˆä½¿ç”¨é€šç”¨æž„å»ºè„šæœ¬ï¼‰
ARG BUILD_CATEGRAF
ARG GITHUB_PROXY
RUN set -eux; \
    if [ "${BUILD_CATEGRAF}" = "true" ]; then \
        # é…ç½®ä»£ç†ï¼ˆå¦‚æžœæä¾›ï¼‰
        if [ -n "${GITHUB_PROXY:-}" ]; then \
            echo "ðŸŒ Using proxy for Categraf build: ${GITHUB_PROXY}"; \
            export ALL_PROXY="${GITHUB_PROXY}"; \
            export HTTP_PROXY="${GITHUB_PROXY}"; \
            export HTTPS_PROXY="${GITHUB_PROXY}"; \
            export http_proxy="${GITHUB_PROXY}"; \
            export https_proxy="${GITHUB_PROXY}"; \
            # é…ç½® git ä½¿ç”¨ä»£ç†å’Œ SSL
            git config --global http.proxy "${GITHUB_PROXY}"; \
            git config --global https.proxy "${GITHUB_PROXY}"; \
            git config --global http.sslVerify false; \
            git config --global http.version HTTP/1.1; \
            echo "âœ“ Git proxy configured"; \
        else \
            echo "âš ï¸  No GITHUB_PROXY provided, using direct connection"; \
        fi; \
        echo "Starting Categraf build..."; \
        CATEGRAF_VERSION=${CATEGRAF_VERSION} \
        CATEGRAF_REPO=${CATEGRAF_REPO} \
        BUILD_DIR=/build \
        OUTPUT_DIR=/out \
        /scripts/build-app.sh categraf; \
    else \
        echo "â­ï¸  Skipping Categraf build (BUILD_CATEGRAF=${BUILD_CATEGRAF})"; \
    fi

#================================================
# Stage 5: æœ€ç»ˆé•œåƒ - ä½¿ç”¨ nginx æä¾›ä¸‹è½½æœåŠ¡
#================================================

# =============================================================================
# Stage 5: AppHub - HTTP Server with Package Management & Development Tools
# =============================================================================
FROM nginx:alpine

# é…ç½® Alpine é•œåƒæºå¹¶å®‰è£…åŸºç¡€å·¥å…·ï¼ˆä½¿ç”¨å›½å†…é•œåƒæºï¼‰
RUN set -eux; \
    # å¤‡ä»½åŽŸå§‹é…ç½®
    cp /etc/apk/repositories /etc/apk/repositories.bak || true; \
    # æ£€æµ‹æž¶æž„
    ARCH=$(uname -m); \
    echo "Detected architecture: ${ARCH}"; \
    # æ ¹æ®æž¶æž„é…ç½®é•œåƒæº
    if [ "${ARCH}" = "aarch64" ]; then \
        echo "é…ç½®ARM64æž¶æž„çš„æ¸…åŽAlpineé•œåƒæº..."; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/community" >> /etc/apk/repositories; \
    else \
        echo "é…ç½®AMD64æž¶æž„çš„é˜¿é‡Œäº‘Alpineé•œåƒæº..."; \
        echo "https://mirrors.aliyun.com/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.aliyun.com/alpine/v3.20/community" >> /etc/apk/repositories; \
    fi; \
    # æ›´æ–°åŒ…ç´¢å¼•ï¼ˆå¸¦é‡è¯•å’Œå¤‡ç”¨æºï¼‰
    apk update || { \
        echo "ä¸»é•œåƒæºå¤±è´¥ï¼Œåˆ‡æ¢åˆ°å®˜æ–¹é•œåƒæº..."; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    } || { \
        echo "å°è¯•ä½¿ç”¨HTTPåè®®..."; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    }

# Install tools for repo management and general development
# Note: Some packages may not be available in Alpine, install what we can
RUN set -eux; \
    # Install dpkg tools first (critical for deb package indexing)
    # Also install zstd for decompressing modern deb packages (Ubuntu 22.04+ uses zstd compression)
    apk add --no-cache dpkg dpkg-dev zstd || { \
        echo "âš ï¸  dpkg packages not available, will skip deb indexing"; \
    }; \
    # Install createrepo_c for RPM repository metadata generation
    apk add --no-cache createrepo_c || { \
        echo "âš ï¸  createrepo_c not available, will skip RPM indexing"; \
    }; \
    # Install core development and network tools
    apk add --no-cache \
        build-base \
        git \
        vim \
        wget \
        curl \
        bash \
        ca-certificates \
        gzip \
        perl \
        || echo "âš ï¸  Some packages failed to install"; \
    # Try to install optional network tools (may not be available)
    apk add --no-cache net-tools 2>/dev/null || echo "âš ï¸  net-tools not available"; \
    apk add --no-cache iputils 2>/dev/null || echo "âš ï¸  iputils not available"; \
    apk add --no-cache procps 2>/dev/null || echo "âš ï¸  procps not available"

# Copy nginx config
COPY nginx.conf /etc/nginx/nginx.conf

# Create directories for packages
RUN mkdir -p \
    /usr/share/nginx/html/deb \
    /usr/share/nginx/html/rpm \
    /usr/share/nginx/html/pkgs/slurm-deb \
    /usr/share/nginx/html/pkgs/slurm-rpm \
    /usr/share/nginx/html/pkgs/slurm-binaries \
    /usr/share/nginx/html/pkgs/saltstack-deb \
    /usr/share/nginx/html/pkgs/saltstack-rpm \
    /usr/share/nginx/html/pkgs/categraf

# Copy all deb packages from deb-builder stage (SLURM + SaltStack)
COPY --from=deb-builder /out/ /usr/share/nginx/html/pkgs/slurm-deb/

# Copy SLURM rpm packages with metadata from rpm-builder stage
COPY --from=rpm-builder /out/slurm-rpm/ /usr/share/nginx/html/pkgs/slurm-rpm/

# Copy SaltStack rpm packages with metadata from rpm-builder stage
COPY --from=rpm-builder /out/saltstack-rpm/ /usr/share/nginx/html/pkgs/saltstack-rpm/

# Copy SLURM binaries from binary-builder stage
COPY --from=binary-builder /out/packages/ /usr/share/nginx/html/pkgs/slurm-binaries/

# Copy scripts for installation
COPY scripts/install-slurm.sh.tmpl /app/scripts/install-slurm.sh.tmpl
COPY scripts/generate-install-script.sh /app/scripts/generate-install-script.sh
RUN chmod +x /app/scripts/generate-install-script.sh

# Generate SLURM installation script from template
ARG SLURM_VERSION=25.05.4
ENV SLURM_VERSION=${SLURM_VERSION}
ENV APPHUB_BASE_URL=http://localhost:8081
RUN /app/scripts/generate-install-script.sh \
    /app/scripts/install-slurm.sh.tmpl \
    /usr/share/nginx/html/packages/install-slurm.sh

# Copy Categraf packages from categraf-builder stage
COPY --from=categraf-builder /out/ /usr/share/nginx/html/pkgs/categraf/

# Organize packages and generate DEB indexes (RPM metadata already generated in rpm-builder stage)
RUN set -eux; \
    echo "ðŸ“¦ Organizing packages..."; \
    # Separate SLURM and SaltStack deb packages
    mkdir -p /usr/share/nginx/html/pkgs/saltstack-deb; \
    if [ -d /usr/share/nginx/html/pkgs/slurm-deb ]; then \
        cd /usr/share/nginx/html/pkgs/slurm-deb; \
        # Move SaltStack packages to separate directory
        find . -name "salt-*.deb" -exec mv {} /usr/share/nginx/html/pkgs/saltstack-deb/ \; 2>/dev/null || true; \
    fi; \
    # Count packages
    slurm_deb_count=$(ls -1 /usr/share/nginx/html/pkgs/slurm-deb/*.deb 2>/dev/null | wc -l || echo 0); \
    slurm_rpm_count=$(ls -1 /usr/share/nginx/html/pkgs/slurm-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
    slurm_bin_count=$(find /usr/share/nginx/html/pkgs/slurm-binaries -type f -name "s*" 2>/dev/null | wc -l || echo 0); \
    salt_deb_count=$(ls -1 /usr/share/nginx/html/pkgs/saltstack-deb/*.deb 2>/dev/null | wc -l || echo 0); \
    salt_rpm_count=$(ls -1 /usr/share/nginx/html/pkgs/saltstack-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
    categraf_count=$(ls -1 /usr/share/nginx/html/pkgs/categraf/*.tar.gz 2>/dev/null | wc -l || echo 0); \
    # Check if RPM metadata was copied from rpm-builder
    slurm_rpm_metadata=$([ -d /usr/share/nginx/html/pkgs/slurm-rpm/repodata ] && echo "yes" || echo "no"); \
    salt_rpm_metadata=$([ -d /usr/share/nginx/html/pkgs/saltstack-rpm/repodata ] && echo "yes" || echo "no"); \
    echo "ðŸ“Š Package Summary:"; \
    echo "  - SLURM deb packages: ${slurm_deb_count}"; \
    echo "  - SLURM rpm packages: ${slurm_rpm_count} (metadata: ${slurm_rpm_metadata})"; \
    echo "  - SLURM binaries: ${slurm_bin_count}"; \
    echo "  - SaltStack deb packages: ${salt_deb_count}"; \
    echo "  - SaltStack rpm packages: ${salt_rpm_count} (metadata: ${salt_rpm_metadata})"; \
    echo "  - Categraf packages: ${categraf_count}"; \
    # Generate Debian repository metadata (both Packages and Packages.gz)
    if [ "$slurm_deb_count" -gt 0 ] && command -v dpkg-scanpackages >/dev/null 2>&1; then \
        echo "ðŸ”§ Generating SLURM DEB repository metadata..."; \
        cd /usr/share/nginx/html/pkgs/slurm-deb && \
        dpkg-scanpackages -m . > Packages && \
        gzip -k -f Packages; \
        echo "âœ“ Generated SLURM DEB repository metadata (Packages, Packages.gz)"; \
    elif [ "$slurm_deb_count" -gt 0 ]; then \
        echo "âš ï¸  dpkg-scanpackages not available, SLURM DEB packages available for direct download only"; \
    fi; \
    if [ "$salt_deb_count" -gt 0 ] && command -v dpkg-scanpackages >/dev/null 2>&1; then \
        echo "ðŸ”§ Generating SaltStack DEB repository metadata..."; \
        cd /usr/share/nginx/html/pkgs/saltstack-deb && \
        dpkg-scanpackages -m . > Packages && \
        gzip -k -f Packages; \
        echo "âœ“ Generated SaltStack DEB repository metadata (Packages, Packages.gz)"; \
    elif [ "$salt_deb_count" -gt 0 ]; then \
        echo "âš ï¸  dpkg-scanpackages not available, SaltStack DEB packages available for direct download only"; \
    fi; \
    # General deb index (if any)
    if [ -d /usr/share/nginx/html/deb ] && [ "$(ls -A /usr/share/nginx/html/deb 2>/dev/null)" ]; then \
        if command -v dpkg-scanpackages >/dev/null 2>&1; then \
            cd /usr/share/nginx/html/deb && \
            dpkg-scanpackages -m . > Packages && \
            gzip -k -f Packages; \
            echo "âœ“ Generated general deb package index"; \
        fi; \
    fi; \
    # RPM metadata was already generated in rpm-builder stage (Rocky Linux has createrepo)
    # Verify it was copied correctly
    if [ "$slurm_rpm_count" -gt 0 ]; then \
        if [ -d /usr/share/nginx/html/pkgs/slurm-rpm/repodata ]; then \
            echo "âœ“ SLURM RPM repository metadata available (repodata/)"; \
        else \
            echo "âš ï¸  SLURM RPM metadata missing - packages available for direct download only"; \
        fi; \
    fi; \
    if [ "$salt_rpm_count" -gt 0 ]; then \
        if [ -d /usr/share/nginx/html/pkgs/saltstack-rpm/repodata ]; then \
            echo "âœ“ SaltStack RPM repository metadata available (repodata/)"; \
            ls -la /usr/share/nginx/html/pkgs/saltstack-rpm/repodata/ || true; \
        else \
            echo "âš ï¸  SaltStack RPM metadata missing - packages available for direct download only"; \
        fi; \
    fi; \
    # SLURM binaries (list architecture directories)
    if [ "$slurm_bin_count" -gt 0 ]; then \
        echo "âœ“ SLURM binaries available at /pkgs/slurm-binaries/"; \
        for arch_dir in /usr/share/nginx/html/pkgs/slurm-binaries/*; do \
            if [ -d "$arch_dir" ]; then \
                arch=$(basename "$arch_dir"); \
                bin_count=$(ls "$arch_dir/bin/"* 2>/dev/null | wc -l || echo 0); \
                echo "  âœ“ ${arch}: ${bin_count} binaries"; \
            fi; \
        done; \
    fi; \
    # Categraf packages (create latest symlinks)
    if [ "$categraf_count" -gt 0 ]; then \
        cd /usr/share/nginx/html/pkgs/categraf; \
        echo "âœ“ Categraf packages available at /pkgs/categraf/"; \
        # Create latest symlink for amd64
        latest_amd64=$(ls -t categraf-*-linux-amd64.tar.gz 2>/dev/null | head -1); \
        if [ -n "$latest_amd64" ]; then \
            ln -sf "$latest_amd64" categraf-latest-linux-amd64.tar.gz; \
            echo "  âœ“ Created symlink: categraf-latest-linux-amd64.tar.gz -> $latest_amd64"; \
        fi; \
        # Create latest symlink for arm64
        latest_arm64=$(ls -t categraf-*-linux-arm64.tar.gz 2>/dev/null | head -1); \
        if [ -n "$latest_arm64" ]; then \
            ln -sf "$latest_arm64" categraf-latest-linux-arm64.tar.gz; \
            echo "  âœ“ Created symlink: categraf-latest-linux-arm64.tar.gz -> $latest_arm64"; \
        fi; \
    fi; \
    # Create symlinks in top-level directories for easier access
    echo "ðŸ”— Creating top-level package directory symlinks..."; \
    # Link SLURM deb packages to /usr/share/nginx/html/deb/
    if [ "$slurm_deb_count" -gt 0 ]; then \
        ln -sf ../pkgs/slurm-deb/* /usr/share/nginx/html/deb/ 2>/dev/null || true; \
        echo "  âœ“ Linked SLURM deb packages to /deb/"; \
    fi; \
    # Link SLURM rpm packages to /usr/share/nginx/html/rpm/
    if [ "$slurm_rpm_count" -gt 0 ]; then \
        ln -sf ../pkgs/slurm-rpm/* /usr/share/nginx/html/rpm/ 2>/dev/null || true; \
        echo "  âœ“ Linked SLURM rpm packages to /rpm/"; \
    fi; \
    # Note about RPM metadata
    if [ "$slurm_rpm_count" -gt 0 ] || [ "$salt_rpm_count" -gt 0 ]; then \
        echo "âš ï¸  Note: YUM/DNF metadata not generated (createrepo not available in Alpine)"; \
        echo "âš ï¸  Packages can be downloaded directly via HTTP"; \
    fi

# Expose port
EXPOSE 80

# Entrypoint to regenerate indexes if needed
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]