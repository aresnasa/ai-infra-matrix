# =============================================================================
# ÂÖ®Â±Ä ARG Â£∞ÊòéÔºàÁî®‰∫éÂ§öÈò∂ÊÆµÊûÑÂª∫ÁöÑ FROM ËØ≠Âè•Ôºâ
# Global ARG declarations for multi-stage build FROM statements
# Ëøô‰∫õÂÄºÂ∞ÜÈÄöËøá build.sh ÁöÑ --build-arg ÂèÇÊï∞‰ªé .env Êñá‰ª∂‰º†ÂÖ•
# Êèê‰æõÈªòËÆ§ÂÄº‰ª•‰øùÊåÅÂêëÂêéÂÖºÂÆπÊÄß
# =============================================================================
ARG UBUNTU_VERSION=22.04
ARG ROCKYLINUX_VERSION=9
ARG GOLANG_ALPINE_VERSION=1.25-alpine
ARG NGINX_ALPINE_VERSION=1.27-alpine

# =============================================================================
# Stage 1: Build SLURM deb packages (Ubuntu 22.04)
# =============================================================================
FROM ubuntu:${UBUNTU_VERSION} AS deb-builder

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# Build control flags - set to "true" to enable building specific components
# ÊûÑÂª∫ÊéßÂà∂ÂºÄÂÖ≥ - ËÆæÁΩÆ‰∏∫ "true" Êù•ÂêØÁî®ÁâπÂÆöÁªÑ‰ª∂ÁöÑÊûÑÂª∫
ARG BUILD_SLURM=true
ARG BUILD_SALTSTACK=true
ARG BUILD_CATEGRAF=true
ARG BUILD_SINGULARITY=false

# Package cache optimization - specify a previous image to copy packages from
# ÂåÖÁºìÂ≠ò‰ºòÂåñ - ÊåáÂÆö‰∏Ä‰∏™ÂÖàÂâçÁöÑÈïúÂÉèÊù•Â§çÂà∂ÂåÖÔºåÈÅøÂÖçÈáçÂ§ç‰∏ãËΩΩ
ARG CACHE_IMAGE=""

# SLURM version configuration - update these when upgrading
# Êõ¥Êñ∞ SLURM ÁâàÊú¨Êó∂Âè™ÈúÄ‰øÆÊîπËøô‰∏§‰∏™ÂèòÈáè
ARG SLURM_VERSION=25.05.4
ARG SLURM_TARBALL_NAME=slurm-${SLURM_VERSION}.tar.bz2

# SaltStack version configuration
ARG SALTSTACK_VERSION=v3007.8

# Categraf version configuration
ARG CATEGRAF_VERSION=v0.4.22

# Singularity version configuration
ARG SINGULARITY_VERSION=v4.3.4

# Accept optional tarball path relative to build context root
# ÈªòËÆ§Âú®ÂΩìÂâçÁõÆÂΩïÊü•Êâæ tarball
ARG SLURM_TARBALL_PATH=${SLURM_TARBALL_NAME}

# ÈÖçÁΩÆAPTÈïúÂÉèÊ∫êÂíåÂÆâË£ÖÊûÑÂª∫‰æùËµñÔºàÂàÜÊ≠•È™§ÈÅøÂÖçÁΩëÁªúÈóÆÈ¢òÔºâ
RUN set -eux; \
    # Ê∏ÖÈô§ÂèØËÉΩÂπ≤Êâ∞ÁöÑ‰ª£ÁêÜËÆæÁΩÆÔºàÊûÑÂª∫ÂÆπÂô®ÂÜÖÈÉ®Êó†Ê≥ïËÆøÈóÆÂÆø‰∏ªÊú∫‰ª£ÁêÜÔºâ
    unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY all_proxy no_proxy NO_PROXY || true; \
    rm -f /etc/apt/apt.conf.d/*proxy* 2>/dev/null || true; \
    echo 'Acquire::http::Proxy "false";' > /etc/apt/apt.conf.d/99no-proxy; \
    echo 'Acquire::https::Proxy "false";' >> /etc/apt/apt.conf.d/99no-proxy; \
    # Â§á‰ªΩÂéüÂßãsources.list
    cp /etc/apt/sources.list /etc/apt/sources.list.backup; \
    # Ê£ÄÊµãÊû∂ÊûÑ
    ARCH=$(dpkg --print-architecture); \
    echo "Detected architecture: ${ARCH}"; \
    # Ê†πÊçÆÊû∂ÊûÑÈÖçÁΩÆÈïúÂÉèÊ∫êÔºà‰ºòÂÖàÂ∞ùËØïÈòøÈáå‰∫ëÔºåÂ§±Ë¥•ÂàôÂõûÈÄÄÂà∞ÂÆòÊñπÊ∫êÔºâ
    if [ "${ARCH}" = "arm64" ] || [ "${ARCH}" = "aarch64" ]; then \
        echo "ÈÖçÁΩÆARM64Êû∂ÊûÑÈïúÂÉèÊ∫ê..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    else \
        echo "ÈÖçÁΩÆAMD64Êû∂ÊûÑÈïúÂÉèÊ∫ê..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    fi; \
    # Êõ¥Êñ∞ÂåÖÂàóË°®Âπ∂ÂÆâË£ÖÂü∫Á°ÄÂ∑•ÂÖ∑ÔºàÂ∏¶ÈáçËØïÂíåÂõûÈÄÄÊú∫Âà∂Ôºâ
    if ! apt-get update; then \
        echo "ÈòøÈáå‰∫ëÈïúÂÉèÊ∫êÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÂÆòÊñπÊ∫ê..."; \
        mv /etc/apt/sources.list.backup /etc/apt/sources.list; \
        apt-get update; \
    fi; \
    apt-get install -y ca-certificates curl tzdata; \
    ln -snf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo "Asia/Shanghai" > /etc/timezone

# Install build prerequisites (ÂàÜÁªÑÂÆâË£ÖÂáèÂ∞ëÂ§±Ë¥•È£éÈô©)
RUN apt-get install -y --no-install-recommends \
       wget git gpg \
       build-essential fakeroot devscripts equivs gdebi-core \
       pkg-config debhelper dh-autoreconf \
    && rm -rf /var/lib/apt/lists/*

# Install development libraries (ÂçïÁã¨ÂÆâË£ÖÈÅøÂÖç‰æùËµñÂÜ≤Á™Å)
RUN set -eux; \
    # Â∞ùËØïÊõ¥Êñ∞ÂåÖÂàóË°®ÔºåÂ§±Ë¥•ÂàôÂõûÈÄÄÂà∞ÂÆòÊñπÊ∫ê
    if ! apt-get update; then \
        echo "ÈïúÂÉèÊ∫êÊõ¥Êñ∞Â§±Ë¥•ÔºåÂ∞ùËØïÂõûÈÄÄÂà∞ÂÆòÊñπÊ∫ê..."; \
        if [ -f /etc/apt/sources.list.backup ]; then \
            mv /etc/apt/sources.list.backup /etc/apt/sources.list; \
        fi; \
        apt-get update; \
    fi; \
    apt-get install -y --no-install-recommends \
       libmunge-dev libmariadb-dev libpam0g-dev libcgroup-dev libhwloc-dev \
    && rm -rf /var/lib/apt/lists/*

# Add a non-root builder user to satisfy debuild
RUN useradd -m -u 1000 builder
USER builder
WORKDIR /home/builder/build

# Copy SLURM source tarball (use wildcard to make it optional-ish)
# Docker will fail if no matching file, but we handle it gracefully in build script
ARG SLURM_TARBALL_PATH
COPY --chown=builder:builder ${SLURM_TARBALL_PATH} /home/builder/build/

# Extract SLURM source
# Ëß£Âéã tarball Âπ∂ËÆ∞ÂΩïÊ∫êÁ†ÅÁõÆÂΩïÂêçÁß∞
RUN set -eux; \
    if ls slurm-*.tar.bz2 >/dev/null 2>&1; then \
        tarball=$(ls slurm-*.tar.bz2 | head -1); \
        echo "‚úì Found SLURM tarball: ${tarball}"; \
        tar -xaf "${tarball}"; \
        srcdir=$(basename "${tarball}" .tar.bz2); \
        echo "SRC=${srcdir}" > /home/builder/build/.srcdir; \
        echo "‚úì SLURM source extracted: ${srcdir}"; \
        echo "  Version: $(echo ${srcdir} | grep -oP '\\d+\\.\\d+\\.\\d+' || echo 'unknown')"; \
    else \
        echo "SKIP_SLURM_BUILD=1" > /home/builder/build/.srcdir; \
        echo "‚ö†Ô∏è  No SLURM tarball found - will skip SLURM package build"; \
    fi

# Install build-deps as root, then build .deb packages as unprivileged user (skip if no SLURM source)
USER root
RUN set -eux; \
    if grep -q "SKIP_SLURM_BUILD=1" /home/builder/build/.srcdir; then \
        echo "‚ö†Ô∏è  Skipping SLURM build - no source tarball available"; \
        mkdir -p /out; \
        touch /out/.skip_slurm; \
    else \
        # Ê∏ÖÈô§ÂèØËÉΩÂπ≤Êâ∞ÁöÑ‰ª£ÁêÜËÆæÁΩÆ
        unset http_proxy https_proxy HTTP_PROXY HTTPS_PROXY ALL_PROXY all_proxy no_proxy NO_PROXY || true; \
        # Ê∏ÖÈô§ apt ‰ª£ÁêÜÈÖçÁΩÆ
        rm -f /etc/apt/apt.conf.d/*proxy* 2>/dev/null || true; \
        echo 'Acquire::http::Proxy "false";' > /etc/apt/apt.conf.d/99no-proxy; \
        echo 'Acquire::https::Proxy "false";' >> /etc/apt/apt.conf.d/99no-proxy; \
        srcdir=$(cut -d= -f2 /home/builder/build/.srcdir); \
        cd "/home/builder/build/${srcdir}"; \
        echo "üì¶ Updating package list..."; \
        apt-get update || { \
            echo "‚ö†Ô∏è  Update failed, retrying in 5 seconds..."; \
            sleep 5; \
            apt-get update; \
        }; \
        echo "üì¶ Installing build dependencies..."; \
        mk-build-deps -i debian/control -t 'apt-get -y --no-install-recommends' --remove || { \
            echo "‚ö†Ô∏è  mk-build-deps failed, trying with --fix-missing..."; \
            apt-get update && apt-get install -y --fix-missing --no-install-recommends -f; \
            mk-build-deps -i debian/control -t 'apt-get -y --no-install-recommends --fix-missing' --remove; \
        }; \
    fi

USER builder
RUN set -eux; \
    if grep -q "SKIP_SLURM_BUILD=1" /home/builder/build/.srcdir; then \
        echo "‚ö†Ô∏è  Skipping SLURM package build"; \
    else \
        srcdir=$(cut -d= -f2 /home/builder/build/.srcdir); \
        cd "/home/builder/build/${srcdir}"; \
        dpkg-buildpackage -b -uc; \
    fi

# Download SaltStack packages from GitHub releases
USER root
ARG BUILD_SALTSTACK
ARG SALTSTACK_VERSION
ARG GITHUB_PROXY

# Use BuildKit cache mount for package caching
# This allows packages to be reused across builds without re-downloading
RUN --mount=type=cache,target=/var/cache/saltstack-deb,sharing=locked \
    set -eux; \
    if [ "${BUILD_SALTSTACK}" = "true" ]; then \
        mkdir -p /saltstack-deb; \
        cd /var/cache/saltstack-deb; \
        # ========================================
        # ÂåÖÁºìÂ≠ò‰ºòÂåñÔºöÊ£ÄÊü•Âπ∂Â§çÁî®ÁºìÂ≠ò‰∏≠ÁöÑÂåÖ
        # ========================================
        cached_count=$(ls -1 *.deb 2>/dev/null | wc -l || echo 0); \
        if [ "$cached_count" -gt 0 ]; then \
            echo "üì¶ ÂèëÁé∞ÁºìÂ≠òÁöÑ SaltStack deb ÂåÖ: ${cached_count} ‰∏™"; \
            echo "‚úì È™åËØÅÁºìÂ≠òÂåÖÂÆåÊï¥ÊÄß..."; \
            # È™åËØÅÂπ∂Â§çÂà∂ÊúâÊïàÁöÑÂåÖÂà∞ÁõÆÊ†áÁõÆÂΩï
            valid_count=0; \
            for pkg in *.deb; do \
                if [ -f "$pkg" ] && [ -s "$pkg" ]; then \
                    cp "$pkg" /saltstack-deb/ 2>/dev/null || true; \
                    valid_count=$((valid_count + 1)); \
                fi; \
            done; \
            echo "‚úì Â§çÂà∂‰∫Ü ${valid_count} ‰∏™ÊúâÊïàÂåÖÂà∞ÊûÑÂª∫ÁõÆÂΩï"; \
        fi; \
        # ========================================
        # ÁΩëÁªú‰∏ãËΩΩÔºà‰ªÖ‰∏ãËΩΩÁº∫Â§±ÁöÑÂåÖÔºâ
        # ========================================
        echo "üì¶ Ê£ÄÊü• SaltStack ${SALTSTACK_VERSION} deb packages..."; \
        # ÈÖçÁΩÆ‰ª£ÁêÜÔºàÂ¶ÇÊûúÊèê‰æõÔºâ
        if [ -n "${GITHUB_PROXY:-}" ]; then \
            echo "üåê Using proxy: ${GITHUB_PROXY}"; \
            export ALL_PROXY="${GITHUB_PROXY}"; \
            export HTTP_PROXY="${GITHUB_PROXY}"; \
            export HTTPS_PROXY="${GITHUB_PROXY}"; \
            export http_proxy="${GITHUB_PROXY}"; \
            export https_proxy="${GITHUB_PROXY}"; \
        fi; \
        # GitHub releases Âü∫Á°Ä URL (‰øÆÊ≠£ÁâàÊú¨Âè∑Ê†ºÂºèÔºåÁ°Æ‰øùÊúâ v ÂâçÁºÄ)
        VERSION_NUM="${SALTSTACK_VERSION#v}"; \
        # Á°Æ‰øù release tag Êúâ v ÂâçÁºÄ
        RELEASE_TAG="${SALTSTACK_VERSION}"; \
        if [[ ! "$RELEASE_TAG" =~ ^v ]]; then \
            RELEASE_TAG="v${RELEASE_TAG}"; \
        fi; \
        BASE_URL="https://github.com/saltstack/salt/releases/download/${RELEASE_TAG}"; \
        echo "Version: ${VERSION_NUM}"; \
        echo "Release Tag: ${RELEASE_TAG}"; \
        echo "Base URL: ${BASE_URL}"; \
        # ‰∏ãËΩΩ‰∏§ÁßçÊû∂ÊûÑÁöÑ deb ÂåÖ
        total_downloaded=0; \
        total_cached=0; \
        for ARCH_SUFFIX in amd64 arm64; do \
            echo ""; \
            echo "üì• Processing ${ARCH_SUFFIX} packages..."; \
            arch_count=0; \
            # Ê£ÄÊü•ÊâÄÊúâ‰∏ªË¶ÅÁöÑ deb ÂåÖ
            for pkg in salt-common salt-master salt-minion salt-api salt-ssh salt-syndic salt-cloud; do \
                PKG_FILE="${pkg}_${VERSION_NUM}_${ARCH_SUFFIX}.deb"; \
                # Ê£ÄÊü•ÂåÖÊòØÂê¶Â∑≤Â≠òÂú®Ôºà‰ªéÁºìÂ≠òÂ§çÂà∂ÊàñÂ∑≤‰∏ãËΩΩÔºâ
                if [ -f "${PKG_FILE}" ] && [ -s "${PKG_FILE}" ]; then \
                    echo "‚úì Cached: ${PKG_FILE}"; \
                    total_cached=$((total_cached + 1)); \
                    arch_count=$((arch_count + 1)); \
                    continue; \
                fi; \
                echo "Downloading: ${PKG_FILE}"; \
                for attempt in 1 2 3; do \
                    if wget --timeout=60 --tries=3 -nv "${BASE_URL}/${PKG_FILE}"; then \
                        echo "‚úì Downloaded: ${PKG_FILE}"; \
                        # ÁîüÊàê SHA256 Ê†°È™åÊñá‰ª∂ÔºàÁî®‰∫éÂêéÁª≠È™åËØÅÔºâ
                        shasum -a 256 "${PKG_FILE}" > "${PKG_FILE}.sha256" 2>/dev/null || true; \
                        # Â§çÂà∂Âà∞ÊûÑÂª∫ÁõÆÂΩï
                        cp "${PKG_FILE}" /saltstack-deb/ 2>/dev/null || true; \
                        total_downloaded=$((total_downloaded + 1)); \
                        arch_count=$((arch_count + 1)); \
                        break; \
                    else \
                        echo "‚ö†Ô∏è  Attempt ${attempt}/3 failed"; \
                        if [ $attempt -lt 3 ]; then sleep 2; fi; \
                    fi; \
                done || echo "‚úó Failed to download ${PKG_FILE}"; \
            done; \
            echo "‚úì ${ARCH_SUFFIX}: ${arch_count} packages available"; \
        done; \
        # Ê£ÄÊü•ÁªìÊûú
        echo ""; \
        echo "üìä Package Summary:"; \
        echo "   Cached: ${total_cached}"; \
        echo "   Downloaded: ${total_downloaded}"; \
        total_packages=$((total_cached + total_downloaded)); \
        if [ "$total_packages" -gt 0 ]; then \
            echo "‚úì Total available: ${total_packages} SaltStack deb packages"; \
            echo ""; \
            echo "AMD64 packages:"; \
            ls -lh /saltstack-deb/*_amd64.deb 2>/dev/null || echo "  (none)"; \
            echo ""; \
            echo "ARM64 packages:"; \
            ls -lh /saltstack-deb/*_arm64.deb 2>/dev/null || echo "  (none)"; \
        else \
            echo "‚ö†Ô∏è  No SaltStack packages available"; \
        fi; \
    else \
        echo "‚è≠Ô∏è  Skipping SaltStack download (BUILD_SALTSTACK=${BUILD_SALTSTACK})"; \
        mkdir -p /saltstack-deb; \
    fi

# Collect artifacts into /out (root stage)
RUN mkdir -p /out \
    && chown -R root:root /home/builder

# Move all debuild outputs to /out (skip verification if SLURM build was skipped)
RUN set -eux; \
    if [ ! -f /out/.skip_slurm ]; then \
        find /home/builder/build -maxdepth 1 -type f -name '*.deb' -exec mv {} /out/ \; || true; \
        find /home/builder/build -maxdepth 1 -type f -name '*.ddeb' -exec mv {} /out/ \; || true; \
        find /home/builder/build -maxdepth 1 -type f -name '*.build*' -exec mv {} /out/ \; || true; \
        find /home/builder/build -maxdepth 1 -type f -name '*.changes' -exec mv {} /out/ \; || true; \
        # Verify at least one .deb file was produced
        deb_count=$(find /out -name '*.deb' -type f | wc -l); \
        if [ "$deb_count" -eq 0 ]; then \
            echo "ERROR: No .deb packages were built!"; \
            echo "Build artifacts in /home/builder:"; \
            ls -la /home/builder/ || true; \
            echo "Build artifacts in /home/builder/build:"; \
            ls -la /home/builder/build/ || true; \
            exit 1; \
        fi; \
        echo "‚úì Successfully built $deb_count SLURM .deb package(s)"; \
    else \
        echo "‚ö†Ô∏è  SLURM build was skipped - no packages to collect"; \
    fi; \
    # Copy SaltStack packages
    if [ -d /saltstack-deb ] && [ "$(ls -A /saltstack-deb/*.deb 2>/dev/null)" ]; then \
        cp /saltstack-deb/*.deb /out/ || true; \
        salt_count=$(ls /saltstack-deb/*.deb 2>/dev/null | wc -l || echo 0); \
        echo "‚úì Added ${salt_count} SaltStack deb packages"; \
        ls -lh /out/salt*.deb 2>/dev/null || true; \
    fi

# =============================================================================
# Stage 2: Build SLURM rpm packages (Rocky Linux 9)
# =============================================================================
FROM rockylinux:${ROCKYLINUX_VERSION} AS rpm-builder

ENV TZ=Asia/Shanghai

# Build control flags
ARG BUILD_SLURM=true
ARG BUILD_SALTSTACK=true

# SLURM version configuration (same as deb builder)
ARG SLURM_VERSION=25.05.4
ARG SLURM_TARBALL_NAME=slurm-${SLURM_VERSION}.tar.bz2
ARG SLURM_TARBALL_PATH=${SLURM_TARBALL_NAME}

# SaltStack version configuration (same as deb builder)
ARG SALTSTACK_VERSION=v3007.8

# ÈÖçÁΩÆ Rocky Linux ÈïúÂÉèÊ∫êÔºàÂèØÈÄâÔºåÂ¶ÇÊûúÁΩëÁªú‰∏çÂ•ΩÂàôË∑≥ËøáÔºâ
# Ê≥®ÊÑèÔºö‰πüÂèØ‰ª•ÈÄöËøá docker build --build-arg HTTP_PROXY=... ‰ΩøÁî®‰ª£ÁêÜ
RUN set -eux; \
    echo "Â∞ùËØïÈÖçÁΩÆ Rocky Linux ÈòøÈáå‰∫ëÈïúÂÉèÊ∫êÔºàÂèØÈÄâÔºâ..."; \
    # Â§á‰ªΩÂéüÂßãÈÖçÁΩÆ
    cp -r /etc/yum.repos.d /etc/yum.repos.d.backup 2>/dev/null || true; \
    # Â∞ùËØïÈÖçÁΩÆÈòøÈáå‰∫ëÈïúÂÉèÊ∫ê
    ( \
        sed -e 's|^mirrorlist=|#mirrorlist=|g' \
            -e 's|^#baseurl=http://dl.rockylinux.org/\$contentdir|baseurl=http://mirrors.aliyun.com/rockylinux|g' \
            -i.bak \
            /etc/yum.repos.d/rocky*.repo 2>/dev/null && \
        dnf clean all 2>/dev/null && \
        dnf makecache 2>/dev/null && \
        echo "‚úì ÊàêÂäüÈÖçÁΩÆÈòøÈáå‰∫ëÈïúÂÉèÊ∫ê" \
    ) || { \
        echo "‚ö†Ô∏è ÈïúÂÉèÊ∫êÈÖçÁΩÆÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ"; \
        cp -r /etc/yum.repos.d.backup/* /etc/yum.repos.d/ 2>/dev/null || true; \
        dnf clean all 2>/dev/null || true; \
    }

# Install build prerequisites and enable required repositories
RUN set -eux; \
    # Enable PowerTools/CRB repository for additional development packages
    dnf config-manager --set-enabled crb 2>/dev/null || \
    dnf config-manager --set-enabled powertools 2>/dev/null || \
    echo "PowerTools/CRB repository not available"; \
    dnf install -y epel-release || echo "EPEL repository not available"; \
    # Âè™Êõ¥Êñ∞ÂÖÉÊï∞ÊçÆÁºìÂ≠òÔºå‰∏çÊõ¥Êñ∞ÊâÄÊúâÂåÖÔºàÈÅøÂÖçÁΩëÁªúÈóÆÈ¢òÔºâ
    dnf makecache --refresh || dnf makecache || true; \
    # Install basic build dependencies first
    echo "üì¶ Installing RPM build tools..."; \
    dnf install -y \
        rpm-build \
        rpmdevtools \
        redhat-rpm-config \
        gcc \
        make \
        wget \
        tar \
        bzip2 \
        pam-devel \
        readline-devel \
        perl-ExtUtils-MakeMaker \
        openssl-devel; \
    # Verify rpmdevtools installation (using command -v instead of which)
    echo "‚úì Verifying rpmdevtools installation..."; \
    if ! command -v rpmdev-setuptree >/dev/null 2>&1; then \
        echo "‚ùå rpmdev-setuptree not found, trying to reinstall..."; \
        dnf reinstall -y rpmdevtools || dnf install -y rpmdevtools; \
    fi; \
    if command -v rpmdev-setuptree >/dev/null 2>&1; then \
        echo "‚úì rpmdev-setuptree found: $(command -v rpmdev-setuptree)"; \
    else \
        echo "‚ö†Ô∏è  rpmdev-setuptree still not available, will use manual setup"; \
    fi; \
    dnf clean all; \
    # Try to install optional dependencies (may not be available)
    echo "Â∞ùËØïÂÆâË£ÖÂèØÈÄâ‰æùËµñÂåÖ..."; \
    dnf install -y munge-devel 2>/dev/null || echo "‚ö†Ô∏è  munge-devel not available"; \
    dnf install -y mariadb-devel 2>/dev/null || echo "‚ö†Ô∏è  mariadb-devel not available"; \
    dnf install -y mysql-devel 2>/dev/null || echo "‚ö†Ô∏è  mysql-devel not available"; \
    dnf install -y hwloc-devel 2>/dev/null || echo "‚ö†Ô∏è  hwloc-devel not available"; \
    dnf install -y json-c-devel 2>/dev/null || echo "‚ö†Ô∏è  json-c-devel not available"; \
    dnf install -y yaml-devel 2>/dev/null || echo "‚ö†Ô∏è  yaml-devel not available (trying libyaml-devel)"; \
    dnf install -y libyaml-devel 2>/dev/null || echo "‚ö†Ô∏è  libyaml-devel not available"; \
    echo "‰æùËµñÂåÖÂÆâË£ÖÂÆåÊàê"

# Add non-root builder user
RUN useradd -m -u 1000 builder
USER builder
WORKDIR /home/builder/build

# Setup RPM build environment
RUN set -eux; \
    echo "üìÅ Setting up RPM build tree..."; \
    # Check if rpmdev-setuptree is available
    if command -v rpmdev-setuptree >/dev/null 2>&1; then \
        rpmdev-setuptree; \
        echo "‚úì RPM build tree created successfully"; \
    else \
        # Manual setup if rpmdev-setuptree is not available
        echo "‚ö†Ô∏è  rpmdev-setuptree not found, creating directories manually..."; \
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}; \
        echo "%_topdir %(echo \$HOME)/rpmbuild" > ~/.rpmmacros; \
        echo "‚úì RPM build tree created manually"; \
    fi; \
    ls -la ~/rpmbuild/ || echo "Warning: rpmbuild directory check failed"

# Copy SLURM source tarball
ARG SLURM_TARBALL_PATH
COPY --chown=builder:builder ${SLURM_TARBALL_PATH} /home/builder/build/

# Build SLURM RPM packages
RUN set -eux; \
    if [ "${BUILD_SLURM}" = "true" ]; then \
        echo "üì¶ Building SLURM ${SLURM_VERSION} RPM packages..."; \
        cd /home/builder/build; \
        # Extract source tarball
        tarball=$(ls slurm-*.tar.bz2 | head -1); \
        echo "‚úì Found SLURM tarball: ${tarball}"; \
        tar -xaf "${tarball}"; \
        srcdir=$(basename "${tarball}" .tar.bz2); \
        cd "${srcdir}"; \
        # Setup rpmbuild directories
        echo ">>> Setting up rpmbuild environment..."; \
        mkdir -p /home/builder/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}; \
        cp ../"${tarball}" /home/builder/rpmbuild/SOURCES/; \
        # Configure SLURM
        echo ">>> Configuring SLURM for RPM build..."; \
        ./configure \
            --prefix=/usr \
            --sysconfdir=/etc/slurm \
            --disable-debug \
            --with-munge \
            --enable-pam \
            --without-rpath 2>&1 | tee /tmp/configure-rpm.log || { \
            echo "‚ùå Configure failed! Last 50 lines of output:"; \
            tail -50 /tmp/configure-rpm.log; \
            exit 1; \
        }; \
        # Build RPM packages using make rpm
        echo ">>> Building SLURM RPM packages (this may take 10-15 minutes)..."; \
        echo ">>> Current directory: $(pwd)"; \
        make contrib 2>&1 | tee /tmp/make-contrib.log || { \
            echo "‚ùå Make contrib failed! Last 100 lines of output:"; \
            tail -100 /tmp/make-contrib.log; \
            exit 1; \
        }; \
        make rpm 2>&1 | tee /tmp/make-rpm.log || { \
            echo "‚ùå Make RPM failed! Last 100 lines of output:"; \
            tail -100 /tmp/make-rpm.log; \
            exit 1; \
        }; \
        echo "‚úì SLURM RPM build completed successfully"; \
        echo ">>> Listing RPM build output locations:"; \
        find /home/builder -name "*.rpm" -type f 2>/dev/null | head -20 || echo "No RPMs found yet"; \
    else \
        echo "üö´ Skipping SLURM RPM build (BUILD_SLURM=false)"; \
        mkdir -p /home/builder/rpms; \
        touch /home/builder/rpms/.skip_slurm; \
    fi

# Download SaltStack packages from GitHub releases
USER root
ARG BUILD_SALTSTACK
ARG SALTSTACK_VERSION
ARG GITHUB_PROXY

# Use BuildKit cache mount for package caching
# This allows packages to be reused across builds without re-downloading
RUN --mount=type=cache,target=/var/cache/saltstack-rpm,sharing=locked \
    set -eux; \
    if [ "${BUILD_SALTSTACK}" = "true" ]; then \
        mkdir -p /saltstack-rpm; \
        cd /var/cache/saltstack-rpm; \
        # ========================================
        # ÂåÖÁºìÂ≠ò‰ºòÂåñÔºöÊ£ÄÊü•Âπ∂Â§çÁî®ÁºìÂ≠ò‰∏≠ÁöÑÂåÖ
        # ========================================
        cached_count=$(ls -1 *.rpm 2>/dev/null | wc -l || echo 0); \
        if [ "$cached_count" -gt 0 ]; then \
            echo "ÔøΩ ÂèëÁé∞ÁºìÂ≠òÁöÑ SaltStack rpm ÂåÖ: ${cached_count} ‰∏™"; \
            echo "‚úì È™åËØÅÁºìÂ≠òÂåÖÂÆåÊï¥ÊÄß..."; \
            # È™åËØÅÂπ∂Â§çÂà∂ÊúâÊïàÁöÑÂåÖÂà∞ÁõÆÊ†áÁõÆÂΩï
            valid_count=0; \
            for pkg in *.rpm; do \
                if [ -f "$pkg" ] && [ -s "$pkg" ]; then \
                    cp "$pkg" /saltstack-rpm/ 2>/dev/null || true; \
                    valid_count=$((valid_count + 1)); \
                fi; \
            done; \
            echo "‚úì Â§çÂà∂‰∫Ü ${valid_count} ‰∏™ÊúâÊïàÂåÖÂà∞ÊûÑÂª∫ÁõÆÂΩï"; \
        fi; \
        # ========================================
        # ÁΩëÁªú‰∏ãËΩΩÔºà‰ªÖ‰∏ãËΩΩÁº∫Â§±ÁöÑÂåÖÔºâ
        # ========================================
        echo "üì¶ Ê£ÄÊü• SaltStack ${SALTSTACK_VERSION} rpm packages..."; \
        # ÈÖçÁΩÆ‰ª£ÁêÜÔºàÂ¶ÇÊûúÊèê‰æõÔºâ
        if [ -n "${GITHUB_PROXY:-}" ]; then \
            echo "üåê Using proxy: ${GITHUB_PROXY}"; \
            export ALL_PROXY="${GITHUB_PROXY}"; \
            export HTTP_PROXY="${GITHUB_PROXY}"; \
            export HTTPS_PROXY="${GITHUB_PROXY}"; \
            export http_proxy="${GITHUB_PROXY}"; \
            export https_proxy="${GITHUB_PROXY}"; \
        fi; \
        # GitHub releases Âü∫Á°Ä URL (‰øÆÊ≠£ÁâàÊú¨Âè∑Ê†ºÂºèÔºåÁ°Æ‰øùÊúâ v ÂâçÁºÄ)
        VERSION_NUM="${SALTSTACK_VERSION#v}"; \
        # Á°Æ‰øù release tag Êúâ v ÂâçÁºÄ
        RELEASE_TAG="${SALTSTACK_VERSION}"; \
        if [[ ! "$RELEASE_TAG" =~ ^v ]]; then \
            RELEASE_TAG="v${RELEASE_TAG}"; \
        fi; \
        BASE_URL="https://github.com/saltstack/salt/releases/download/${RELEASE_TAG}"; \
        echo "Version: ${VERSION_NUM}"; \
        echo "Release Tag: ${RELEASE_TAG}"; \
        echo "Base URL: ${BASE_URL}"; \
        # ‰∏ãËΩΩ‰∏§ÁßçÊû∂ÊûÑÁöÑ rpm ÂåÖ
        total_downloaded=0; \
        total_cached=0; \
        for ARCH_SUFFIX in x86_64 aarch64; do \
            echo ""; \
            echo "üì• Processing ${ARCH_SUFFIX} packages..."; \
            arch_count=0; \
            # Ê£ÄÊü•ÊâÄÊúâ‰∏ªË¶ÅÁöÑ rpm ÂåÖ
            for pkg in salt salt-master salt-minion salt-api salt-ssh salt-syndic salt-cloud; do \
                PKG_FILE="${pkg}-${VERSION_NUM}-0.${ARCH_SUFFIX}.rpm"; \
                # Ê£ÄÊü•ÂåÖÊòØÂê¶Â∑≤Â≠òÂú®Ôºà‰ªéÁºìÂ≠òÂ§çÂà∂ÊàñÂ∑≤‰∏ãËΩΩÔºâ
                if [ -f "${PKG_FILE}" ] && [ -s "${PKG_FILE}" ]; then \
                    echo "‚úì Cached: ${PKG_FILE}"; \
                    total_cached=$((total_cached + 1)); \
                    arch_count=$((arch_count + 1)); \
                    continue; \
                fi; \
                echo "Downloading: ${PKG_FILE}"; \
                for attempt in 1 2 3; do \
                    if wget --timeout=60 --tries=3 -nv "${BASE_URL}/${PKG_FILE}"; then \
                        echo "‚úì Downloaded: ${PKG_FILE}"; \
                        # ÁîüÊàê SHA256 Ê†°È™åÊñá‰ª∂ÔºàÁî®‰∫éÂêéÁª≠È™åËØÅÔºâ
                        sha256sum "${PKG_FILE}" > "${PKG_FILE}.sha256" 2>/dev/null || \
                        shasum -a 256 "${PKG_FILE}" > "${PKG_FILE}.sha256" 2>/dev/null || true; \
                        # Â§çÂà∂Âà∞ÊûÑÂª∫ÁõÆÂΩï
                        cp "${PKG_FILE}" /saltstack-rpm/ 2>/dev/null || true; \
                        total_downloaded=$((total_downloaded + 1)); \
                        arch_count=$((arch_count + 1)); \
                        break; \
                    else \
                        echo "‚ö†Ô∏è  Attempt ${attempt}/3 failed"; \
                        if [ $attempt -lt 3 ]; then sleep 2; fi; \
                    fi; \
                done || echo "‚úó Failed to download ${PKG_FILE}"; \
            done; \
            echo "‚úì ${ARCH_SUFFIX}: ${arch_count} packages available"; \
        done; \
        # Ê£ÄÊü•ÁªìÊûú
        echo ""; \
        echo "üìä Package Summary:"; \
        echo "   Cached: ${total_cached}"; \
        echo "   Downloaded: ${total_downloaded}"; \
        total_packages=$((total_cached + total_downloaded)); \
        if [ "$total_packages" -gt 0 ]; then \
            echo "‚úì Total available: ${total_packages} SaltStack rpm packages"; \
            echo ""; \
            echo "x86_64 packages:"; \
            ls -lh /saltstack-rpm/*.x86_64.rpm 2>/dev/null || echo "  (none)"; \
            echo ""; \
            echo "aarch64 packages:"; \
            ls -lh /saltstack-rpm/*.aarch64.rpm 2>/dev/null || echo "  (none)"; \
        else \
            echo "‚ö†Ô∏è  No SaltStack packages available"; \
        fi; \
    else \
        echo "‚è≠Ô∏è  Skipping SaltStack download (BUILD_SALTSTACK=${BUILD_SALTSTACK})"; \
        mkdir -p /saltstack-rpm; \
    fi

# Collect RPM artifacts
RUN set -eux; \
    mkdir -p /out; \
    echo "üì¶ Collecting RPM packages..."; \
    if [ ! -f /home/builder/rpms/.skip_slurm ] && [ "${BUILD_SLURM}" = "true" ]; then \
        # Find and copy built SLURM RPMs from all possible locations
        echo ">>> Looking for SLURM RPM packages..."; \
        echo ">>> Searching in common RPM build locations:"; \
        # List all possible locations
        find /home/builder -name "*.rpm" -type f 2>/dev/null | head -20 || echo "No RPMs found with find command"; \
        # Check rpmbuild directory structure (standard rpmbuild location)
        if [ -d /home/builder/rpmbuild/RPMS ]; then \
            echo "  Checking: /home/builder/rpmbuild/RPMS"; \
            find /home/builder/rpmbuild/RPMS -type f -name '*.rpm' -exec cp {} /out/ \; 2>/dev/null || true; \
        fi; \
        # Check source directory (make rpm sometimes puts RPMs here)
        if [ -d /home/builder/build ]; then \
            echo "  Checking: /home/builder/build"; \
            find /home/builder/build -type f -name '*.rpm' -exec cp {} /out/ \; 2>/dev/null || true; \
        fi; \
        # Check home directory root (backup location)
        echo "  Checking: /home/builder"; \
        find /home/builder -maxdepth 3 -type f -name '*.rpm' -exec cp {} /out/ \; 2>/dev/null || true; \
        # Remove duplicates and debug symbols if needed
        cd /out && rm -f *-debuginfo-*.rpm *-debugsource-*.rpm 2>/dev/null || true; \
        # Count collected RPMs
        rpm_count=$(ls /out/*.rpm 2>/dev/null | wc -l || echo 0); \
        if [ "$rpm_count" -gt 0 ]; then \
            echo "‚úì Successfully collected ${rpm_count} SLURM RPM package(s)"; \
            echo ">>> SLURM RPM packages:"; \
            ls -lh /out/*.rpm; \
        else \
            echo "‚ö†Ô∏è  No SLURM RPM packages were found"; \
            echo ">>> Listing /home/builder structure for debugging:"; \
            ls -laR /home/builder/ | head -100 || true; \
            touch /out/.skip_slurm; \
        fi; \
    else \
        echo "‚ö†Ô∏è  SLURM RPM build was skipped"; \
        touch /out/.skip_slurm; \
    fi; \
    # Copy SaltStack packages (CRITICAL: ensure they exist before copying)
    echo "üì¶ Checking SaltStack packages..."; \
    if [ -d /saltstack-rpm ]; then \
        salt_rpm_count=$(ls /saltstack-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
        echo "Found ${salt_rpm_count} SaltStack rpm files in /saltstack-rpm"; \
        if [ "$salt_rpm_count" -gt 0 ]; then \
            ls -lh /saltstack-rpm/*.rpm; \
            cp /saltstack-rpm/*.rpm /out/ || { \
                echo "‚ùå Failed to copy SaltStack RPMs"; \
                exit 1; \
            }; \
            echo "‚úì Copied ${salt_rpm_count} SaltStack rpm packages to /out"; \
            ls -lh /out/salt*.rpm 2>/dev/null || echo "‚ö†Ô∏è  No salt*.rpm in /out"; \
        else \
            echo "‚ö†Ô∏è  No SaltStack RPM files found in /saltstack-rpm"; \
        fi; \
    else \
        echo "‚ùå /saltstack-rpm directory does not exist"; \
    fi; \
    # Final verification
    echo "üìä Final /out contents:"; \
    ls -lh /out/ || echo "‚ö†Ô∏è  /out is empty"; \
    total_rpm_count=$(ls /out/*.rpm 2>/dev/null | wc -l || echo 0); \
    echo "‚úì Total RPM packages in /out: ${total_rpm_count}"; \
    # Generate RPM repository metadata using createrepo_c (Rocky Linux has it)
    echo "üîß Installing createrepo_c for metadata generation..."; \
    dnf install -y createrepo_c 2>/dev/null || { \
        echo "‚ö†Ô∏è  createrepo_c not available, trying createrepo..."; \
        dnf install -y createrepo 2>/dev/null || echo "‚ö†Ô∏è  No createrepo tools available"; \
    }; \
    # Separate SLURM and SaltStack RPMs into subdirectories
    mkdir -p /out/slurm-rpm /out/saltstack-rpm; \
    # Check if there are any RPM files to organize
    if ls /out/*.rpm >/dev/null 2>&1; then \
        echo "üì¶ Organizing RPM packages..."; \
        mv /out/slurm-*.rpm /out/slurm-rpm/ 2>/dev/null || true; \
        mv /out/salt-*.rpm /out/saltstack-rpm/ 2>/dev/null || true; \
        # Count packages in each directory
        slurm_count=$(ls /out/slurm-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
        salt_count=$(ls /out/saltstack-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
        echo "  - SLURM RPMs: ${slurm_count}"; \
        echo "  - SaltStack RPMs: ${salt_count}"; \
        # Generate metadata for SLURM repository
        if [ "$slurm_count" -gt 0 ] && command -v createrepo_c >/dev/null 2>&1; then \
            echo "üîß Generating SLURM RPM repository metadata..."; \
            cd /out/slurm-rpm && createrepo_c . && \
            echo "‚úì Generated SLURM repodata: $(ls -d repodata 2>/dev/null || echo 'failed')"; \
        elif [ "$slurm_count" -gt 0 ] && command -v createrepo >/dev/null 2>&1; then \
            echo "üîß Generating SLURM RPM repository metadata (using createrepo)..."; \
            cd /out/slurm-rpm && createrepo . && \
            echo "‚úì Generated SLURM repodata"; \
        fi; \
        # Generate metadata for SaltStack repository
        if [ "$salt_count" -gt 0 ] && command -v createrepo_c >/dev/null 2>&1; then \
            echo "üîß Generating SaltStack RPM repository metadata..."; \
            cd /out/saltstack-rpm && createrepo_c . && \
            echo "‚úì Generated SaltStack repodata: $(ls -d repodata 2>/dev/null || echo 'failed')"; \
        elif [ "$salt_count" -gt 0 ] && command -v createrepo >/dev/null 2>&1; then \
            echo "üîß Generating SaltStack RPM repository metadata (using createrepo)..."; \
            cd /out/saltstack-rpm && createrepo . && \
            echo "‚úì Generated SaltStack repodata"; \
        fi; \
    fi

# =============================================================================
# Stage 3: Extract SLURM binaries from built packages (Support multi-arch)
# ‰ªéÂ∑≤ÊûÑÂª∫ÁöÑ DEB ÂåÖ‰∏≠ÊèêÂèñ‰∫åËøõÂà∂Êñá‰ª∂ÔºåÊîØÊåÅ x86_64 Âíå aarch64
# =============================================================================
FROM ubuntu:${UBUNTU_VERSION} AS binary-builder

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# Build control flags
ARG BUILD_SLURM=true

# SLURM version configuration
ARG SLURM_VERSION=25.05.4

# ÈÖçÁΩÆAPTÈïúÂÉèÊ∫êÂπ∂ÂÆâË£ÖÊèêÂèñÂ∑•ÂÖ∑
RUN set -eux; \
    # Â§á‰ªΩÂéüÂßãÊ∫êÈÖçÁΩÆ
    cp /etc/apt/sources.list /etc/apt/sources.list.backup; \
    # Ê£ÄÊµãÊû∂ÊûÑÂπ∂ÈÖçÁΩÆÈïúÂÉèÊ∫ê
    ARCH=$(dpkg --print-architecture); \
    echo "Detected architecture: ${ARCH}"; \
    if [ "${ARCH}" = "arm64" ] || [ "${ARCH}" = "aarch64" ]; then \
        echo "ÈÖçÁΩÆARM64Êû∂ÊûÑÈïúÂÉèÊ∫ê..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    else \
        echo "ÈÖçÁΩÆAMD64Êû∂ÊûÑÈïúÂÉèÊ∫ê..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    fi; \
    # Êõ¥Êñ∞ÂåÖÂàóË°®ÔºàÂ∏¶ÂõûÈÄÄÊú∫Âà∂Ôºâ
    if ! apt-get update; then \
        echo "ÈòøÈáå‰∫ëÈïúÂÉèÊ∫êÂ§±Ë¥•ÔºåÂõûÈÄÄÂà∞ÂÆòÊñπÊ∫ê..."; \
        mv /etc/apt/sources.list.backup /etc/apt/sources.list; \
        apt-get update; \
    fi; \
    # ÂÆâË£ÖÊèêÂèñÂ∑•ÂÖ∑
    apt-get install -y --no-install-recommends dpkg-dev binutils file && \
    rm -rf /var/lib/apt/lists/*

# ‰ªé deb-builder Â§çÂà∂ÊûÑÂª∫Â•ΩÁöÑ DEB ÂåÖÔºàÂåÖÂê´ amd64 Âíå arm64 ‰∏§ÁßçÊû∂ÊûÑÔºâ
COPY --from=deb-builder /out/*.deb /packages/deb/

# ÊèêÂèñ‰∏§ÁßçÊû∂ÊûÑÁöÑ SLURM ‰∫åËøõÂà∂Êñá‰ª∂
RUN set -eux; \
    if [ "$BUILD_SLURM" = "true" ]; then \
        mkdir -p /out/packages; \
        cd /packages/deb; \
        echo "üì¶ ÊèêÂèñ SLURM ‰∫åËøõÂà∂Êñá‰ª∂‰ªé DEB ÂåÖ..."; \
        # ÈÅçÂéÜ‰∏§ÁßçÊû∂ÊûÑ
        for ARCH in amd64 arm64; do \
            # ËΩ¨Êç¢‰∏∫ÂÆûÈôÖÁöÑÊû∂ÊûÑÂêçÁß∞
            if [ "$ARCH" = "amd64" ]; then \
                ARCH_DIR="x86_64"; \
            else \
                ARCH_DIR="aarch64"; \
            fi; \
            echo ""; \
            echo ">>> Â§ÑÁêÜ ${ARCH} (${ARCH_DIR}) Êû∂ÊûÑ..."; \
            mkdir -p /out/packages/${ARCH_DIR}/bin; \
            mkdir -p /out/packages/${ARCH_DIR}/lib; \
            mkdir -p /tmp/extract/${ARCH_DIR}; \
            # Êü•ÊâæËØ•Êû∂ÊûÑÁöÑ slurm ÂåÖ
            SLURM_PKG=$(ls slurm_*_${ARCH}.deb 2>/dev/null | head -1 || echo ""); \
            if [ -z "$SLURM_PKG" ]; then \
                echo "‚ö†Ô∏è  Êú™ÊâæÂà∞ slurm_*_${ARCH}.debÔºåÂ∞ùËØïÊü•ÊâæÂÖ∂‰ªñ slurm ÂåÖ..."; \
                SLURM_PKG=$(ls slurm-*_${ARCH}.deb 2>/dev/null | head -1 || echo ""); \
            fi; \
            if [ -n "$SLURM_PKG" ] && [ -f "$SLURM_PKG" ]; then \
                echo "  ‚úì ÊâæÂà∞ÂåÖ: $SLURM_PKG"; \
                # ÊèêÂèñ DEB ÂåÖÂÜÖÂÆπ
                dpkg-deb -x "$SLURM_PKG" /tmp/extract/${ARCH_DIR}/ || { \
                    echo "  ‚ö†Ô∏è  Êó†Ê≥ïÊèêÂèñ $SLURM_PKG"; \
                    continue; \
                }; \
                # Â§çÂà∂‰∫åËøõÂà∂Êñá‰ª∂
                for cmd in sinfo squeue scontrol scancel sbatch srun salloc sacct sacctmgr; do \
                    # Êü•ÊâæÂëΩ‰ª§ÔºàÂèØËÉΩÂú®Â§ö‰∏™‰ΩçÁΩÆÔºâ
                    FOUND=0; \
                    for bindir in /tmp/extract/${ARCH_DIR}/usr/bin \
                                  /tmp/extract/${ARCH_DIR}/usr/local/bin \
                                  /tmp/extract/${ARCH_DIR}/usr/sbin \
                                  /tmp/extract/${ARCH_DIR}/bin; do \
                        if [ -f "${bindir}/${cmd}" ]; then \
                            cp "${bindir}/${cmd}" /out/packages/${ARCH_DIR}/bin/; \
                            chmod +x /out/packages/${ARCH_DIR}/bin/${cmd}; \
                            echo "    ‚úì ${cmd}"; \
                            FOUND=1; \
                            break; \
                        fi; \
                    done; \
                    if [ "$FOUND" = "0" ]; then \
                        echo "    ‚úó Êú™ÊâæÂà∞: ${cmd}"; \
                    fi; \
                done; \
                # Â§çÂà∂Â∫ìÊñá‰ª∂
                for libdir in /tmp/extract/${ARCH_DIR}/usr/lib \
                              /tmp/extract/${ARCH_DIR}/usr/lib64 \
                              /tmp/extract/${ARCH_DIR}/usr/lib/${ARCH}-linux-gnu \
                              /tmp/extract/${ARCH_DIR}/usr/local/lib; do \
                    if [ -d "${libdir}" ]; then \
                        find "${libdir}" -name "libslurm*.so*" -type f -exec cp {} /out/packages/${ARCH_DIR}/lib/ \; 2>/dev/null || true; \
                    fi; \
                done; \
            else \
                echo "  ‚ùå Êú™ÊâæÂà∞ ${ARCH} Êû∂ÊûÑÁöÑ SLURM DEB ÂåÖ"; \
            fi; \
            # ‰øùÂ≠òÁâàÊú¨‰ø°ÊÅØ
            echo "${SLURM_VERSION}" > /out/packages/${ARCH_DIR}/VERSION; \
            # ÊòæÁ§∫ÁªìÊûú
            echo "  üìÅ ‰∫åËøõÂà∂Êñá‰ª∂:"; \
            ls -lh /out/packages/${ARCH_DIR}/bin/ 2>/dev/null || echo "    (Êó†)"; \
            echo "  üìö Â∫ìÊñá‰ª∂:"; \
            ls -lh /out/packages/${ARCH_DIR}/lib/ 2>/dev/null || echo "    (Êó†)"; \
        done; \
        # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        rm -rf /tmp/extract; \
        echo ""; \
        echo "‚úÖ SLURM ‰∫åËøõÂà∂Êñá‰ª∂ÊèêÂèñÂÆåÊàê"; \
    else \
        echo "üö´ Ë∑≥Ëøá SLURM ‰∫åËøõÂà∂Êñá‰ª∂ÊèêÂèñ (BUILD_SLURM=false)"; \
        mkdir -p /out/packages/empty; \
        echo "No SLURM binaries extracted" > /out/packages/empty/README.txt; \
    fi

# =============================================================================
# Stage 4: Build Categraf (Multi-Architecture Go Binary)
# Ê≥õÂåñÁöÑÂ∫îÁî®ÊûÑÂª∫Èò∂ÊÆµ - Âè™ÈúÄÂ§çÂà∂ scripts/categraf/ ÁõÆÂΩïÂç≥ÂèØ
# =============================================================================
FROM golang:${GOLANG_ALPINE_VERSION} AS categraf-builder

# Build control flags
ARG BUILD_CATEGRAF=true

# Categraf version configuration
ARG CATEGRAF_VERSION=v0.4.22
ARG CATEGRAF_REPO=https://github.com/flashcatcloud/categraf.git

# ÈÖçÁΩÆ Go ‰ª£ÁêÜÔºà‰∏≠ÂõΩÈïúÂÉèÂä†ÈÄüÔºâ
ARG GO_PROXY=https://goproxy.cn,https://proxy.golang.org,direct
ENV GOPROXY=${GO_PROXY}
ENV GO111MODULE=on
ENV CGO_ENABLED=0

# ÈÖçÁΩÆ Alpine ÈïúÂÉèÊ∫êÂπ∂ÂÆâË£Ö‰æùËµñÔºàÂêàÂπ∂Âà∞‰∏Ä‰∏™RUNÂáèÂ∞ëÂ±ÇÊï∞Ôºâ
RUN set -eux; \
    # Â§á‰ªΩÂπ∂ÈÖçÁΩÆÈïúÂÉèÊ∫ê
    cp /etc/apk/repositories /etc/apk/repositories.bak || true; \
    ARCH=$(uname -m); \
    echo "Detected architecture: ${ARCH}"; \
    # Ê†πÊçÆÊû∂ÊûÑÈÖçÁΩÆÈïúÂÉèÊ∫ê
    if [ "${ARCH}" = "aarch64" ]; then \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/community" >> /etc/apk/repositories; \
    else \
        echo "https://mirrors.aliyun.com/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.aliyun.com/alpine/v3.20/community" >> /etc/apk/repositories; \
    fi; \
    # Êõ¥Êñ∞ÂåÖÁ¥¢ÂºïÔºàÂ∏¶ÈáçËØïÂíåÂ§áÁî®Ê∫êÔºâ
    apk update || { \
        echo "‰∏ªÈïúÂÉèÊ∫êÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞ÂÆòÊñπÊ∫ê..."; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    } || { \
        echo "Â∞ùËØï‰ΩøÁî®HTTPÂçèËÆÆ..."; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    }; \
    # ÂÆâË£ÖÊûÑÂª∫‰æùËµñ
    apk add --no-cache git make bash tar gzip sed coreutils

# Â§çÂà∂ÈÄöÁî®ÊûÑÂª∫ËÑöÊú¨ÂíåÂ∫îÁî®ÁâπÂÆöËÑöÊú¨
COPY scripts/build-app.sh /scripts/build-app.sh
COPY scripts/categraf/ /scripts/categraf/
RUN chmod +x /scripts/build-app.sh /scripts/categraf/*.sh

# ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
RUN mkdir -p /out

# ÊâßË°åÊûÑÂª∫Ôºà‰ΩøÁî®ÈÄöÁî®ÊûÑÂª∫ËÑöÊú¨Ôºâ
ARG BUILD_CATEGRAF
ARG GITHUB_PROXY
RUN set -eux; \
    if [ "${BUILD_CATEGRAF}" = "true" ]; then \
        # ÈÖçÁΩÆ‰ª£ÁêÜÔºàÂ¶ÇÊûúÊèê‰æõÔºâ
        if [ -n "${GITHUB_PROXY:-}" ]; then \
            echo "üåê Using proxy for Categraf build: ${GITHUB_PROXY}"; \
            export ALL_PROXY="${GITHUB_PROXY}"; \
            export HTTP_PROXY="${GITHUB_PROXY}"; \
            export HTTPS_PROXY="${GITHUB_PROXY}"; \
            export http_proxy="${GITHUB_PROXY}"; \
            export https_proxy="${GITHUB_PROXY}"; \
            # ÈÖçÁΩÆ git ‰ΩøÁî®‰ª£ÁêÜÂíå SSL
            git config --global http.proxy "${GITHUB_PROXY}"; \
            git config --global https.proxy "${GITHUB_PROXY}"; \
            git config --global http.sslVerify false; \
            git config --global http.version HTTP/1.1; \
            echo "‚úì Git proxy configured"; \
        else \
            echo "‚ö†Ô∏è  No GITHUB_PROXY provided, using direct connection"; \
        fi; \
        echo "Starting Categraf build..."; \
        CATEGRAF_VERSION=${CATEGRAF_VERSION} \
        CATEGRAF_REPO=${CATEGRAF_REPO} \
        BUILD_DIR=/build \
        OUTPUT_DIR=/out \
        /scripts/build-app.sh categraf; \
    else \
        echo "‚è≠Ô∏è  Skipping Categraf build (BUILD_CATEGRAF=${BUILD_CATEGRAF})"; \
    fi

# =============================================================================
# Stage 4.5: Download Pre-built Singularity (Container Runtime for HPC)
# =============================================================================
FROM alpine:3.20 AS singularity-builder

# Build control flags - ÊöÇÊó∂Á¶ÅÁî®Ôºàdeb ÂåÖ‰∏ãËΩΩÈóÆÈ¢òÔºâ
ARG BUILD_SINGULARITY=false

# Singularity version configuration
ARG SINGULARITY_VERSION=v4.2.1
ARG GITHUB_PROXY

# ÈÖçÁΩÆ Alpine ÈïúÂÉèÊ∫êÂπ∂ÂÆâË£Ö‰æùËµñ
RUN set -eux; \
    # ÈÖçÁΩÆÈïúÂÉèÊ∫ê
    ARCH=$(uname -m); \
    if [ "${ARCH}" = "aarch64" ]; then \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/community" >> /etc/apk/repositories; \
    else \
        echo "https://mirrors.aliyun.com/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.aliyun.com/alpine/v3.20/community" >> /etc/apk/repositories; \
    fi; \
    apk update || { \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    }; \
    # ÂÆâË£ÖÂ∑•ÂÖ∑
    apk add --no-cache curl tar gzip binutils

# ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
RUN mkdir -p /out /build

# ‰∏ãËΩΩÂπ∂ÈáçÊñ∞ÊâìÂåÖÈ¢ÑÁºñËØëÁöÑ Singularity
RUN set -eux; \
    if [ "${BUILD_SINGULARITY}" = "true" ]; then \
        echo "üì¶ Downloading pre-built Singularity ${SINGULARITY_VERSION}..."; \
        ARCH=$(uname -m); \
        RELEASE_URL="https://github.com/sylabs/singularity/releases/download/${SINGULARITY_VERSION}"; \
        VERSION_NUM=$(echo ${SINGULARITY_VERSION} | sed 's/^v//'); \
        CURL_OPTS=""; \
        if [ -n "${GITHUB_PROXY:-}" ]; then \
            echo "üåê Using proxy: ${GITHUB_PROXY}"; \
            CURL_OPTS="--proxy ${GITHUB_PROXY}"; \
        fi; \
        cd /build; \
        if [ "${ARCH}" = "x86_64" ]; then \
            DEB_FILE="singularity-ce_${VERSION_NUM}-1~ubuntu22.04_amd64.deb"; \
        elif [ "${ARCH}" = "aarch64" ]; then \
            DEB_FILE="singularity-ce_${VERSION_NUM}-1~ubuntu22.04_arm64.deb"; \
        else \
            echo "‚ùå Unsupported architecture: ${ARCH}"; \
            exit 1; \
        fi; \
        echo "Downloading ${DEB_FILE}..."; \
        curl ${CURL_OPTS} -fsSL -o singularity.deb "${RELEASE_URL}/${DEB_FILE}"; \
        ar x singularity.deb; \
        tar xf data.tar.xz; \
        tar czf /out/singularity-${SINGULARITY_VERSION}-linux-${ARCH}.tar.gz usr/; \
        echo "Package: singularity" > /out/singularity-${SINGULARITY_VERSION}.info; \
        echo "Version: ${SINGULARITY_VERSION}" >> /out/singularity-${SINGULARITY_VERSION}.info; \
        echo "Architecture: ${ARCH}" >> /out/singularity-${SINGULARITY_VERSION}.info; \
        echo "Build-Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> /out/singularity-${SINGULARITY_VERSION}.info; \
        echo "Description: Singularity Container Runtime for HPC (Pre-built)" >> /out/singularity-${SINGULARITY_VERSION}.info; \
        echo "Homepage: https://github.com/sylabs/singularity" >> /out/singularity-${SINGULARITY_VERSION}.info; \
        echo "License: BSD-3-Clause" >> /out/singularity-${SINGULARITY_VERSION}.info; \
        echo "‚úÖ Singularity download and repackage completed"; \
    else \
        echo "‚è≠Ô∏è  Skipping Singularity (BUILD_SINGULARITY=${BUILD_SINGULARITY})"; \
    fi

# =============================================================================
# Stage 5: AppHub - HTTP Server with Package Management & Development Tools
# =============================================================================
ARG NGINX_ALPINE_VERSION=1.27-alpine
FROM nginx:${NGINX_ALPINE_VERSION}

# ÁâàÊú¨ÂÖÉÊï∞ÊçÆ ARGÔºàÈúÄË¶ÅÂú® FROM ÂêéÈáçÊñ∞Â£∞ÊòéÔºâ
ARG SLURM_VERSION=25.05.4
ARG SALTSTACK_VERSION=v3007.8
ARG CATEGRAF_VERSION=v0.4.22
ARG APPHUB_BASE_URL=http://localhost:8081

# Â∞ÜÁâàÊú¨‰øùÂ≠òÂà∞ÁéØÂ¢ÉÂèòÈáèÔºàÂèØÂú®ËøêË°åÊó∂ËÆøÈóÆÔºâ
ENV SLURM_VERSION=${SLURM_VERSION}
ENV SALTSTACK_VERSION=${SALTSTACK_VERSION}
ENV CATEGRAF_VERSION=${CATEGRAF_VERSION}
ENV APPHUB_BASE_URL=${APPHUB_BASE_URL}

# ÈÖçÁΩÆ Alpine ÈïúÂÉèÊ∫êÂπ∂ÂÆâË£ÖÂü∫Á°ÄÂ∑•ÂÖ∑Ôºà‰ΩøÁî®ÂõΩÂÜÖÈïúÂÉèÊ∫êÔºâ
RUN set -eux; \
    # Â§á‰ªΩÂéüÂßãÈÖçÁΩÆ
    cp /etc/apk/repositories /etc/apk/repositories.bak || true; \
    # Ê£ÄÊµãÊû∂ÊûÑ
    ARCH=$(uname -m); \
    echo "Detected architecture: ${ARCH}"; \
    # Ê†πÊçÆÊû∂ÊûÑÈÖçÁΩÆÈïúÂÉèÊ∫ê
    if [ "${ARCH}" = "aarch64" ]; then \
        echo "ÈÖçÁΩÆARM64Êû∂ÊûÑÁöÑÊ∏ÖÂçéAlpineÈïúÂÉèÊ∫ê..."; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.20/community" >> /etc/apk/repositories; \
    else \
        echo "ÈÖçÁΩÆAMD64Êû∂ÊûÑÁöÑÈòøÈáå‰∫ëAlpineÈïúÂÉèÊ∫ê..."; \
        echo "https://mirrors.aliyun.com/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://mirrors.aliyun.com/alpine/v3.20/community" >> /etc/apk/repositories; \
    fi; \
    # Êõ¥Êñ∞ÂåÖÁ¥¢ÂºïÔºàÂ∏¶ÈáçËØïÂíåÂ§áÁî®Ê∫êÔºâ
    apk update || { \
        echo "‰∏ªÈïúÂÉèÊ∫êÂ§±Ë¥•ÔºåÂàáÊç¢Âà∞ÂÆòÊñπÈïúÂÉèÊ∫ê..."; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "https://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    } || { \
        echo "Â∞ùËØï‰ΩøÁî®HTTPÂçèËÆÆ..."; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/main" > /etc/apk/repositories; \
        echo "http://dl-cdn.alpinelinux.org/alpine/v3.20/community" >> /etc/apk/repositories; \
        apk update; \
    }

# Install tools for repo management and general development
# Note: Some packages may not be available in Alpine, install what we can
RUN set -eux; \
    # Install dpkg tools first (critical for deb package indexing)
    # Also install zstd for decompressing modern deb packages (Ubuntu 22.04+ uses zstd compression)
    apk add --no-cache dpkg dpkg-dev zstd || { \
        echo "‚ö†Ô∏è  dpkg packages not available, will skip deb indexing"; \
    }; \
    # Install createrepo_c for RPM repository metadata generation
    apk add --no-cache createrepo_c || { \
        echo "‚ö†Ô∏è  createrepo_c not available, will skip RPM indexing"; \
    }; \
    # Install core development and network tools
    apk add --no-cache \
        build-base \
        git \
        vim \
        wget \
        curl \
        bash \
        ca-certificates \
        gzip \
        perl \
        || echo "‚ö†Ô∏è  Some packages failed to install"; \
    # Try to install optional network tools (may not be available)
    apk add --no-cache net-tools 2>/dev/null || echo "‚ö†Ô∏è  net-tools not available"; \
    apk add --no-cache iputils 2>/dev/null || echo "‚ö†Ô∏è  iputils not available"; \
    apk add --no-cache procps 2>/dev/null || echo "‚ö†Ô∏è  procps not available"

# Copy nginx config
COPY nginx.conf /etc/nginx/nginx.conf

# Create directories for packages
RUN mkdir -p \
    /usr/share/nginx/html/deb \
    /usr/share/nginx/html/rpm \
    /usr/share/nginx/html/pkgs/slurm-deb \
    /usr/share/nginx/html/pkgs/slurm-rpm \
    /usr/share/nginx/html/pkgs/slurm-binaries \
    /usr/share/nginx/html/pkgs/saltstack-deb \
    /usr/share/nginx/html/pkgs/saltstack-rpm \
    /usr/share/nginx/html/pkgs/categraf

# Copy all deb packages from deb-builder stage (SLURM + SaltStack)
COPY --from=deb-builder /out/ /usr/share/nginx/html/pkgs/slurm-deb/

# Copy SLURM rpm packages with metadata from rpm-builder stage
COPY --from=rpm-builder /out/slurm-rpm/ /usr/share/nginx/html/pkgs/slurm-rpm/

# Copy SaltStack rpm packages with metadata from rpm-builder stage
COPY --from=rpm-builder /out/saltstack-rpm/ /usr/share/nginx/html/pkgs/saltstack-rpm/

# Copy SLURM binaries from binary-builder stage
COPY --from=binary-builder /out/packages/ /usr/share/nginx/html/pkgs/slurm-binaries/

# Copy scripts for installation
COPY scripts/install-slurm.sh.tmpl /app/scripts/install-slurm.sh.tmpl
COPY scripts/generate-install-script.sh /app/scripts/generate-install-script.sh
RUN chmod +x /app/scripts/generate-install-script.sh

# Generate SLURM installation script from template
# ARG needs to be redeclared here if used in RUN after COPY
ARG SLURM_VERSION=25.05.4
ARG APPHUB_BASE_URL=http://localhost:8081
ENV SLURM_VERSION=${SLURM_VERSION}
ENV APPHUB_BASE_URL=${APPHUB_BASE_URL}
RUN /app/scripts/generate-install-script.sh \
    /app/scripts/install-slurm.sh.tmpl \
    /usr/share/nginx/html/packages/install-slurm.sh

# Copy Categraf packages from categraf-builder stage
COPY --from=categraf-builder /out/ /usr/share/nginx/html/pkgs/categraf/

# Copy Singularity packages from singularity-builder stage
COPY --from=singularity-builder /out/ /usr/share/nginx/html/pkgs/singularity/

# Organize packages and generate DEB indexes (RPM metadata already generated in rpm-builder stage)
RUN set -eux; \
    echo "üì¶ Organizing packages..."; \
    # Separate SLURM and SaltStack deb packages
    mkdir -p /usr/share/nginx/html/pkgs/saltstack-deb; \
    if [ -d /usr/share/nginx/html/pkgs/slurm-deb ]; then \
        cd /usr/share/nginx/html/pkgs/slurm-deb; \
        # Move SaltStack packages to separate directory
        find . -name "salt-*.deb" -exec mv {} /usr/share/nginx/html/pkgs/saltstack-deb/ \; 2>/dev/null || true; \
    fi; \
    # Count packages
    slurm_deb_count=$(ls -1 /usr/share/nginx/html/pkgs/slurm-deb/*.deb 2>/dev/null | wc -l || echo 0); \
    slurm_rpm_count=$(ls -1 /usr/share/nginx/html/pkgs/slurm-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
    slurm_bin_count=$(find /usr/share/nginx/html/pkgs/slurm-binaries -type f -name "s*" 2>/dev/null | wc -l || echo 0); \
    salt_deb_count=$(ls -1 /usr/share/nginx/html/pkgs/saltstack-deb/*.deb 2>/dev/null | wc -l || echo 0); \
    salt_rpm_count=$(ls -1 /usr/share/nginx/html/pkgs/saltstack-rpm/*.rpm 2>/dev/null | wc -l || echo 0); \
    categraf_count=$(ls -1 /usr/share/nginx/html/pkgs/categraf/*.tar.gz 2>/dev/null | wc -l || echo 0); \
    singularity_count=$(ls -1 /usr/share/nginx/html/pkgs/singularity/*.tar.gz 2>/dev/null | wc -l || echo 0); \
    # Check if RPM metadata was copied from rpm-builder
    slurm_rpm_metadata=$([ -d /usr/share/nginx/html/pkgs/slurm-rpm/repodata ] && echo "yes" || echo "no"); \
    salt_rpm_metadata=$([ -d /usr/share/nginx/html/pkgs/saltstack-rpm/repodata ] && echo "yes" || echo "no"); \
    echo "üìä Package Summary:"; \
    echo "  - SLURM deb packages: ${slurm_deb_count}"; \
    echo "  - SLURM rpm packages: ${slurm_rpm_count} (metadata: ${slurm_rpm_metadata})"; \
    echo "  - SLURM binaries: ${slurm_bin_count}"; \
    echo "  - SaltStack deb packages: ${salt_deb_count}"; \
    echo "  - SaltStack rpm packages: ${salt_rpm_count} (metadata: ${salt_rpm_metadata})"; \
    echo "  - Categraf packages: ${categraf_count}"; \
    echo "  - Singularity packages: ${singularity_count}"; \
    # Generate Debian repository metadata (both Packages and Packages.gz)
    if [ "$slurm_deb_count" -gt 0 ] && command -v dpkg-scanpackages >/dev/null 2>&1; then \
        echo "üîß Generating SLURM DEB repository metadata..."; \
        cd /usr/share/nginx/html/pkgs/slurm-deb && \
        dpkg-scanpackages -m . > Packages && \
        gzip -k -f Packages; \
        echo "‚úì Generated SLURM DEB repository metadata (Packages, Packages.gz)"; \
    elif [ "$slurm_deb_count" -gt 0 ]; then \
        echo "‚ö†Ô∏è  dpkg-scanpackages not available, SLURM DEB packages available for direct download only"; \
    fi; \
    if [ "$salt_deb_count" -gt 0 ] && command -v dpkg-scanpackages >/dev/null 2>&1; then \
        echo "üîß Generating SaltStack DEB repository metadata..."; \
        cd /usr/share/nginx/html/pkgs/saltstack-deb && \
        dpkg-scanpackages -m . > Packages && \
        gzip -k -f Packages; \
        echo "‚úì Generated SaltStack DEB repository metadata (Packages, Packages.gz)"; \
    elif [ "$salt_deb_count" -gt 0 ]; then \
        echo "‚ö†Ô∏è  dpkg-scanpackages not available, SaltStack DEB packages available for direct download only"; \
    fi; \
    # General deb index (if any)
    if [ -d /usr/share/nginx/html/deb ] && [ "$(ls -A /usr/share/nginx/html/deb 2>/dev/null)" ]; then \
        if command -v dpkg-scanpackages >/dev/null 2>&1; then \
            cd /usr/share/nginx/html/deb && \
            dpkg-scanpackages -m . > Packages && \
            gzip -k -f Packages; \
            echo "‚úì Generated general deb package index"; \
        fi; \
    fi; \
    # RPM metadata was already generated in rpm-builder stage (Rocky Linux has createrepo)
    # Verify it was copied correctly
    if [ "$slurm_rpm_count" -gt 0 ]; then \
        if [ -d /usr/share/nginx/html/pkgs/slurm-rpm/repodata ]; then \
            echo "‚úì SLURM RPM repository metadata available (repodata/)"; \
        else \
            echo "‚ö†Ô∏è  SLURM RPM metadata missing - packages available for direct download only"; \
        fi; \
    fi; \
    if [ "$salt_rpm_count" -gt 0 ]; then \
        if [ -d /usr/share/nginx/html/pkgs/saltstack-rpm/repodata ]; then \
            echo "‚úì SaltStack RPM repository metadata available (repodata/)"; \
            ls -la /usr/share/nginx/html/pkgs/saltstack-rpm/repodata/ || true; \
        else \
            echo "‚ö†Ô∏è  SaltStack RPM metadata missing - packages available for direct download only"; \
        fi; \
    fi; \
    # SLURM binaries (list architecture directories)
    if [ "$slurm_bin_count" -gt 0 ]; then \
        echo "‚úì SLURM binaries available at /pkgs/slurm-binaries/"; \
        for arch_dir in /usr/share/nginx/html/pkgs/slurm-binaries/*; do \
            if [ -d "$arch_dir" ]; then \
                arch=$(basename "$arch_dir"); \
                bin_count=$(ls "$arch_dir/bin/"* 2>/dev/null | wc -l || echo 0); \
                echo "  ‚úì ${arch}: ${bin_count} binaries"; \
            fi; \
        done; \
    fi; \
    # Categraf packages (create latest symlinks)
    if [ "$categraf_count" -gt 0 ]; then \
        cd /usr/share/nginx/html/pkgs/categraf; \
        echo "‚úì Categraf packages available at /pkgs/categraf/"; \
        # Create latest symlink for amd64
        latest_amd64=$(ls -t categraf-*-linux-amd64.tar.gz 2>/dev/null | head -1); \
        if [ -n "$latest_amd64" ]; then \
            ln -sf "$latest_amd64" categraf-latest-linux-amd64.tar.gz; \
            echo "  ‚úì Created symlink: categraf-latest-linux-amd64.tar.gz -> $latest_amd64"; \
        fi; \
        # Create latest symlink for arm64
        latest_arm64=$(ls -t categraf-*-linux-arm64.tar.gz 2>/dev/null | head -1); \
        if [ -n "$latest_arm64" ]; then \
            ln -sf "$latest_arm64" categraf-latest-linux-arm64.tar.gz; \
            echo "  ‚úì Created symlink: categraf-latest-linux-arm64.tar.gz -> $latest_arm64"; \
        fi; \
    fi; \
    # Create symlinks in top-level directories for easier access
    echo "üîó Creating top-level package directory symlinks..."; \
    # Link SLURM deb packages to /usr/share/nginx/html/deb/
    if [ "$slurm_deb_count" -gt 0 ]; then \
        ln -sf ../pkgs/slurm-deb/* /usr/share/nginx/html/deb/ 2>/dev/null || true; \
        echo "  ‚úì Linked SLURM deb packages to /deb/"; \
    fi; \
    # Link SLURM rpm packages to /usr/share/nginx/html/rpm/
    if [ "$slurm_rpm_count" -gt 0 ]; then \
        ln -sf ../pkgs/slurm-rpm/* /usr/share/nginx/html/rpm/ 2>/dev/null || true; \
        echo "  ‚úì Linked SLURM rpm packages to /rpm/"; \
    fi; \
    # Note about RPM metadata
    if [ "$slurm_rpm_count" -gt 0 ] || [ "$salt_rpm_count" -gt 0 ]; then \
        echo "‚ö†Ô∏è  Note: YUM/DNF metadata not generated (createrepo not available in Alpine)"; \
        echo "‚ö†Ô∏è  Packages can be downloaded directly via HTTP"; \
    fi

# Expose port
EXPOSE 80

# Entrypoint to regenerate indexes if needed
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]