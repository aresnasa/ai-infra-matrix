# HAProxy配置文件
# 用于代理Docker网络中的数据库和缓存服务到宿主机网络

global
    # 日志配置
    log stdout format raw local0 info
    
    # 最大连接数
    maxconn 4096
    
    # 运行用户
    user haproxy
    group haproxy
    
    # 守护进程模式
    daemon

defaults
    # 使用全局日志配置
    log global
    
    # 模式: TCP（用于数据库连接）
    mode tcp
    
    # 选项
    option tcplog
    option dontlognull
    
    # 超时配置
    timeout connect 10s
    timeout client 1m
    timeout server 1m
    
    # 重试次数
    retries 3

# HAProxy统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats show-legends
    stats show-node
    stats auth admin:admin

# PostgreSQL 代理 (5432)
frontend postgres_frontend
    bind *:5432
    mode tcp
    option tcplog
    default_backend postgres_backend

backend postgres_backend
    mode tcp
    option tcp-check
    tcp-check connect
    server postgres postgres:5432 check inter 10s fall 3 rise 2

# MySQL 代理 (3306)
frontend mysql_frontend
    bind *:3306
    mode tcp
    option tcplog
    default_backend mysql_backend

backend mysql_backend
    mode tcp
    option tcp-check
    tcp-check connect
    server mysql mysql:3306 check inter 10s fall 3 rise 2

# Redis 代理 (6379)
frontend redis_frontend
    bind *:6379
    mode tcp
    option tcplog
    default_backend redis_backend

backend redis_backend
    mode tcp
    option tcp-check
    tcp-check connect
    server redis redis:6379 check inter 10s fall 3 rise 2

# OceanBase 代理 (2881)
frontend oceanbase_frontend
    bind *:2881
    mode tcp
    option tcplog
    default_backend oceanbase_backend

backend oceanbase_backend
    mode tcp
    option tcp-check
    tcp-check connect
    server oceanbase oceanbase:2881 check inter 10s fall 3 rise 2
