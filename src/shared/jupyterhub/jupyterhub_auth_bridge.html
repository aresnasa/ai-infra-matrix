<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JupyterHub认证中转</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .auth-container {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 400px;
            max-width: 500px;
        }

        .logo {
            width: 64px;
            height: 64px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
        }

        .status.loading {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }

        .status.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        .status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #1890ff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-buttons {
            margin-top: 20px;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #1890ff;
            color: white;
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">AI</div>
        <h1>JupyterHub访问</h1>
        <p class="subtitle">正在验证您的登录状态...</p>
        
        <div id="status" class="status loading">
            <span class="loading-spinner"></span>
            检查认证状态...
        </div>
        
        <div id="actions" class="action-buttons" style="display: none;">
            <a href="/sso/?redirect_uri=/jupyterhub-authenticated&from=manual" class="btn btn-primary" onclick="recordRedirect();">前往登录</a>
            <a href="/" class="btn btn-secondary">返回首页</a>
        </div>
    </div>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
        }

        // 更新状态显示
        function updateStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            const icons = {
                loading: '<span class="loading-spinner"></span>',
                success: '✅',
                error: '❌'
            };
            
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = icons[type] + message;
        }

        // 显示操作按钮
        function showActions() {
            document.getElementById('actions').style.display = 'block';
        }

        // 重定向循环检测
        function checkRedirectLoop() {
            const urlParams = new URLSearchParams(window.location.search);
            const redirectCount = parseInt(sessionStorage.getItem('redirect_count') || '0');
            const lastRedirectTime = parseInt(sessionStorage.getItem('last_redirect_time') || '0');
            const currentTime = Date.now();
            
            // 如果在10秒内重定向超过3次，认为是循环
            if (redirectCount >= 3 && (currentTime - lastRedirectTime) < 10000) {
                log('检测到重定向循环，停止自动重定向', 'error');
                updateStatus('检测到重定向循环，请手动登录', 'error');
                showActions();
                sessionStorage.removeItem('redirect_count');
                sessionStorage.removeItem('last_redirect_time');
                return true;
            }
            
            // 检查是否刚从SSO重定向过来但没有token
            const fromSSO = document.referrer.includes('/sso/') || urlParams.get('from') === 'sso';
            if (fromSSO) {
                // 检查是否有任何形式的token（URL参数或localStorage）
                const hasToken = urlParams.get('token') || urlParams.get('auth_token') || localStorage.getItem('token');
                if (!hasToken) {
                    log('从SSO重定向过来但未获得token，可能认证失败', 'error');
                    updateStatus('SSO认证可能失败，请重新尝试登录', 'error');
                    showActions();
                    return true;
                } else {
                    log('从SSO重定向过来，已检测到token，继续认证流程', 'info');
                }
            }
            
            return false;
        }
        
        // 记录重定向
        function recordRedirect() {
            const redirectCount = parseInt(sessionStorage.getItem('redirect_count') || '0') + 1;
            sessionStorage.setItem('redirect_count', redirectCount.toString());
            sessionStorage.setItem('last_redirect_time', Date.now().toString());
        }

        // 检查并传递认证
        async function checkAndPassAuth() {
            try {
                log('开始检查认证状态...');
                
                // 首先检查重定向循环
                if (checkRedirectLoop()) {
                    return;
                }
                
                // 1. 优先从URL参数获取token
                const urlParams = new URLSearchParams(window.location.search);
                let token = urlParams.get('token') || urlParams.get('auth_token');
                
                // 2. 如果在iframe中，尝试从父窗口获取token
                if (!token && window.parent !== window) {
                    try {
                        token = window.parent.localStorage.getItem('token');
                        log('从父窗口获取到token');
                    } catch (e) {
                        log('无法访问父窗口localStorage，可能是跨域限制');
                    }
                }
                
                // 3. 检查localStorage中的token
                if (!token) {
                    token = localStorage.getItem('token');
                }
                // 4. 尝试从cookie中获取token（与JupyterHub后端兼容的多个名称）
                if (!token) {
                    const cookies = Object.fromEntries(document.cookie.split('; ').map(v => v.split('=')));
                    token = cookies['ai_infra_token'] || cookies['jwt_token'] || cookies['auth_token'] || cookies['token'];
                }
                
                const tokenExpires = localStorage.getItem('token_expires') || urlParams.get('token_expires');
                
                if (!token) {
                    log('未找到认证token，自动跳转到登录页面');
                    updateStatus('未找到认证信息，正在跳转到登录页面...', 'error');
                    recordRedirect();
                    
                    // 获取target_url参数，构建正确的重定向URL
                    const targetUrl = urlParams.get('target_url') || '/jupyter/hub/';
                    const redirectUri = encodeURIComponent(`/jupyterhub-auth-bridge?target_url=${encodeURIComponent(targetUrl)}`);
                    
                    setTimeout(() => {
                        window.location.href = `/sso/?redirect_uri=${redirectUri}&from=no_token`;
                    }, 1500);
                    return;
                }
                
                log(`找到token: ${token.substring(0, 20)}...`);
                
                // 2. 检查token是否过期
                if (tokenExpires) {
                    const expiryTime = new Date(tokenExpires).getTime();
                    const currentTime = new Date().getTime();
                    
                    if (currentTime >= expiryTime) {
                        log('Token已过期，自动跳转到登录页面');
                        updateStatus('认证信息已过期，正在跳转到登录页面...', 'error');
                        recordRedirect();
                        setTimeout(() => {
                            window.location.href = '/sso/?redirect_uri=/jupyterhub-authenticated&from=expired';
                        }, 2000);
                        return;
                    }
                }
                
                // 3. 验证token有效性
                updateStatus('正在验证认证信息...', 'loading');
                console.log('开始API调用验证token');
                
                // 调用API验证真实token
                const verifyResponse = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log(`API响应状态: ${verifyResponse.status} ${verifyResponse.statusText}`);
                if (!verifyResponse.ok) {
                    throw new Error(`Token验证失败: ${verifyResponse.status} ${verifyResponse.statusText}`);
                }
                const userData = await verifyResponse.json();
                console.log('API响应数据:', userData);
                
                log(`Token验证成功: ${userData.username || userData.user?.username || '未知用户'}`);
                
                // 4. 认证成功，确定跳转目标
                updateStatus(`认证成功！正在进入JupyterHub...`, 'success');
                
                // 5. 重新获取URL参数确保数据正确
                const currentUrlParams = new URLSearchParams(window.location.search);
                const targetUrl = currentUrlParams.get('target_url') || '/jupyter/hub/';
                const username = userData.username || userData.user?.username || 'testuser';
                
                // 调试输出
                console.log('=== 重定向参数调试 ===');
                console.log(`当前URL: ${window.location.href}`);
                console.log(`URL参数: ${window.location.search}`);
                console.log(`解析的target_url: ${targetUrl}`);
                console.log(`用户名: ${username}`);
                console.log(`Token: ${token ? token.substring(0, 20) + '...' : 'null'}`);
                
                // 构建带认证信息的跳转URL，使用不会循环的路径
                // 统一通过JupyterHub的自动登录端点建立会话
                const baseTarget = targetUrl || '/jupyter/hub/home';
                const nextParam = encodeURIComponent(baseTarget);
                // 传递 token（参数名为 token 以匹配 AutoLoginHandler），让其完成验证与登录
                const redirectUrl = `/jupyter/auto-login?token=${encodeURIComponent(token)}&next=${nextParam}`;
                
                console.log(`最终重定向URL: ${redirectUrl}`);
                log(`跳转到目标页面: ${targetUrl}`);
                
                // 延迟跳转以便用户看到成功消息
                setTimeout(() => {
                    console.log(`执行跳转到: ${redirectUrl}`);
                    updateStatus(`正在跳转到JupyterHub: ${targetUrl}`, 'success');
                    window.location.href = redirectUrl;
                }, 1000);
                
            } catch (error) {
                log(`认证检查失败: ${error.message}`, 'error');
                updateStatus(`认证检查失败，跳转到登录页面...`, 'error');
                // 出错时也记录重定向，避免循环
                recordRedirect();
                setTimeout(() => {
                    window.location.href = '/sso/?redirect_uri=/jupyterhub-authenticated&from=error';
                }, 2000);
            }
        }

        // 立即检查token，但避免循环
        (function() {
            console.log('=== JupyterHub认证桥接页面初始化 ===');
            
            // 首先检查是否存在重定向循环
            if (checkRedirectLoop()) {
                console.log('检测到重定向循环，停止自动跳转');
                return;
            }
            
            // 1. 优先从URL参数获取token
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('token') || urlParams.get('auth_token');
            console.log(`URL参数token: ${token ? token.substring(0, 20) + '...' : 'null'}`);
            
            // 2. 如果在iframe中，尝试从父窗口获取token
            if (!token && window.parent !== window) {
                try {
                    token = window.parent.localStorage.getItem('token');
                    console.log(`父窗口token: ${token ? token.substring(0, 20) + '...' : 'null'}`);
                } catch (e) {
                    console.log('无法访问父窗口localStorage:', e.message);
                }
            }
            
            // 3. 检查localStorage中的token
            if (!token) {
                token = localStorage.getItem('token');
                console.log(`本地token: ${token ? token.substring(0, 20) + '...' : 'null'}`);
            }
            
            // 如果没有token，触发认证检查流程（会自动重定向到SSO）
            if (!token) {
                console.log('未找到token，将触发认证检查流程');
                // 清除重定向计数，避免影响正常流程
                sessionStorage.removeItem('redirect_count');
                sessionStorage.removeItem('last_redirect_time');
                // 不要return，让DOMContentLoaded处理
                return;
            }
            
            // 有token，继续正常的认证流程
            console.log('找到token，将继续认证流程');
        })();

        // 页面加载完成后立即开始检查
        document.addEventListener('DOMContentLoaded', () => {
            log('JupyterHub认证中转页面加载完成');
            console.log('=== DOMContentLoaded 认证检查 ===');
            
            // 再次检查重定向循环
            if (checkRedirectLoop()) {
                console.log('DOMContentLoaded: 检测到重定向循环，停止处理');
                return;
            }
            
            // 再次检查token（双重保险）
            const urlParams = new URLSearchParams(window.location.search);
            let token = urlParams.get('token') || urlParams.get('auth_token');
            
            if (!token && window.parent !== window) {
                try {
                    token = window.parent.localStorage.getItem('token');
                    console.log('从父窗口获取token');
                } catch (e) {
                    console.log('无法访问父窗口localStorage');
                }
            }
            
            if (!token) {
                token = localStorage.getItem('token');
            }
            
            console.log(`最终token状态: ${token ? '存在' : '不存在'}`);
            
            if (!token) {
                log('DOMContentLoaded检查：未找到token，自动跳转到登录页面');
                updateStatus('未找到认证信息，正在跳转到登录页面...', 'error');
                recordRedirect();
                
                // 获取target_url参数，构建正确的重定向URL
                const targetUrl = urlParams.get('target_url') || '/jupyter/hub/';
                const redirectUri = encodeURIComponent(`/jupyterhub-auth-bridge?target_url=${encodeURIComponent(targetUrl)}`);
                
                setTimeout(() => {
                    window.location.href = `/sso/?redirect_uri=${redirectUri}&from=auth_bridge`;
                }, 1500);
                return;
            }
            
            // 有token，执行完整认证检查
            console.log('开始执行完整认证检查');
            checkAndPassAuth();
        });
    </script>
</body>
</html>
