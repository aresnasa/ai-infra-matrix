<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŸºç¡€è®¾æ–½çŸ©é˜µ - JupyterHub è®¿é—®å…¥å£</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .wrapper-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            text-align: center;
            min-width: 400px;
            max-width: 600px;
            position: relative;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.5;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 14px;
            font-weight: 500;
        }

        .status.loading {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }

        .status.success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }

        .status.error {
            background: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #1890ff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .iframe-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
        }

        .iframe-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 500;
        }

        .iframe-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .iframe-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #jupyterhub-frame {
            width: 100%;
            height: calc(100% - 50px);
            border: none;
        }

        .action-buttons {
            margin-top: 30px;
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #666;
            max-height: 200px;
            overflow-y: auto;
        }

        .feature-list {
            text-align: left;
            margin: 20px 0;
            color: #666;
        }

        .feature-list li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }

        .feature-list li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #52c41a;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="wrapper-container" id="mainContainer">
        <div class="logo">ğŸš€</div>
        
        <h1>JupyterHub è®¿é—®å…¥å£</h1>
        <p class="subtitle">AIåŸºç¡€è®¾æ–½çŸ©é˜µ - ç»Ÿä¸€Notebookå¼€å‘ç¯å¢ƒ</p>
        
        <div id="status" class="status loading">
            <span class="loading-spinner"></span>
            æ­£åœ¨æ£€æŸ¥è®¤è¯çŠ¶æ€å’ŒæœåŠ¡è¿æ¥...
        </div>
        
        <div class="feature-list">
            <ul>
                <li>ç»Ÿä¸€SSOå•ç‚¹ç™»å½•</li>
                <li>å¤šç”¨æˆ·éš”ç¦»ç¯å¢ƒ</li>
                <li>GPU/CPUèµ„æºè°ƒåº¦</li>
                <li>å®æ—¶åä½œç¼–ç¨‹</li>
                <li>ç‰ˆæœ¬æ§åˆ¶é›†æˆ</li>
            </ul>
        </div>

        <div class="action-buttons" id="actionButtons">
            <button class="btn btn-primary" onclick="openJupyterHub()">
                ğŸ”— åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ JupyterHub
            </button>
            <button class="btn btn-primary" onclick="openInFrame()">
                ğŸ“± åœ¨å½“å‰é¡µé¢æ‰“å¼€
            </button>
            <button class="btn btn-secondary" onclick="checkSSO()">
                ğŸ” æ£€æŸ¥SSOçŠ¶æ€
            </button>
            <button class="btn btn-secondary" onclick="goBack()">
                â† è¿”å›ä¸»é¡µ
            </button>
        </div>

        <div class="debug-info" id="debugInfo">
            <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
            <span id="debugLog">åˆå§‹åŒ–ä¸­...</span>
        </div>
    </div>

    <!-- å†…åµŒiframeå®¹å™¨ -->
    <div class="iframe-container" id="iframeContainer">
        <div class="iframe-header">
            <span>ğŸš€ AIåŸºç¡€è®¾æ–½çŸ©é˜µ - JupyterHub</span>
            <button class="iframe-close" onclick="closeFrame()">å…³é—­</button>
        </div>
        <iframe id="jupyterhub-frame" src=""></iframe>
    </div>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push(logEntry);
            
            console.log(`%c${logEntry}`, type === 'error' ? 'color: red' : 'color: blue');
            
            document.getElementById('debugLog').innerHTML = debugLog.slice(-10).join('<br>');
        }

        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            let icon = '';
            
            switch(type) {
                case 'loading':
                    icon = '<span class="loading-spinner"></span>';
                    break;
                case 'success':
                    icon = 'âœ… ';
                    break;
                case 'error':
                    icon = 'âŒ ';
                    break;
                default:
                    icon = 'â„¹ï¸ ';
            }
            
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = icon + message;
        }

        function showActions() {
            document.getElementById('actionButtons').style.display = 'block';
        }

        async function checkAuth() {
            try {
                log('å¼€å§‹æ£€æŸ¥è®¤è¯çŠ¶æ€...');
                
                // æ£€æŸ¥localStorageä¸­çš„token
                const token = localStorage.getItem('token');
                const tokenExpires = localStorage.getItem('token_expires');
                
                if (!token) {
                    log('æœªæ‰¾åˆ°è®¤è¯token', 'warn');
                    updateStatus('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯ï¼Œå»ºè®®å…ˆç™»å½•', 'error');
                    showActions();
                    return false;
                }
                
                log(`æ‰¾åˆ°token: ${token.substring(0, 20)}...`);
                
                // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸ
                if (tokenExpires) {
                    const expiryTime = new Date(tokenExpires).getTime();
                    const currentTime = new Date().getTime();
                    
                    if (currentTime >= expiryTime) {
                        log('Tokenå·²è¿‡æœŸ', 'warn');
                        updateStatus('è®¤è¯ä¿¡æ¯å·²è¿‡æœŸï¼Œå»ºè®®é‡æ–°ç™»å½•', 'error');
                        showActions();
                        return false;
                    }
                }
                
                // éªŒè¯tokenæœ‰æ•ˆæ€§
                updateStatus('æ­£åœ¨éªŒè¯è®¤è¯ä¿¡æ¯...', 'loading');
                
                const verifyResponse = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!verifyResponse.ok) {
                    throw new Error(`éªŒè¯å¤±è´¥: ${verifyResponse.status}`);
                }
                
                const userData = await verifyResponse.json();
                log(`ç”¨æˆ·éªŒè¯æˆåŠŸ: ${userData.username || userData.user?.username || 'æœªçŸ¥ç”¨æˆ·'}`);
                
                updateStatus(`è®¤è¯æˆåŠŸï¼æ¬¢è¿ ${userData.username || 'ç”¨æˆ·'} ğŸ‘‹`, 'success');
                showActions();
                
                return true;
                
            } catch (error) {
                log(`è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus(`è®¤è¯æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
                showActions();
                return false;
            }
        }

        async function checkJupyterHubStatus() {
            try {
                log('æ£€æŸ¥JupyterHubæœåŠ¡çŠ¶æ€...');
                
                const response = await fetch('/jupyter/hub/api', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                log(`JupyterHub APIå“åº”: ${response.status}`);
                return response.status === 200 || response.status === 405; // 405ä¹Ÿæ˜¯æ­£å¸¸çš„
                
            } catch (error) {
                log(`JupyterHubè¿æ¥å¤±è´¥: ${error.message}`, 'error');
                return false;
            }
        }

        function openJupyterHub() {
            log('åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€JupyterHub...');
            window.open('/jupyter/hub/', '_blank');
        }

        function openInFrame() {
            log('åœ¨å½“å‰é¡µé¢åŠ è½½JupyterHub...');
            document.getElementById('jupyterhub-frame').src = '/jupyter/hub/';
            document.getElementById('iframeContainer').style.display = 'block';
            document.getElementById('mainContainer').style.display = 'none';
        }

        function closeFrame() {
            log('å…³é—­iframe...');
            document.getElementById('iframeContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
            document.getElementById('jupyterhub-frame').src = '';
        }

        async function checkSSO() {
            log('è§¦å‘SSOæ£€æŸ¥...');
            updateStatus('æ­£åœ¨æ£€æŸ¥SSOçŠ¶æ€...', 'loading');
            
            const authOK = await checkAuth();
            const hubOK = await checkJupyterHubStatus();
            
            if (authOK && hubOK) {
                updateStatus('SSOçŠ¶æ€æ­£å¸¸ï¼Œå¯ä»¥è®¿é—®JupyterHub', 'success');
            } else if (!authOK) {
                updateStatus('éœ€è¦å…ˆå®Œæˆèº«ä»½è®¤è¯', 'error');
            } else {
                updateStatus('JupyterHubæœåŠ¡è¿æ¥å¼‚å¸¸', 'error');
            }
        }

        function goBack() {
            log('è¿”å›ä¸»é¡µ...');
            window.location.href = '/';
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', async () => {
            log('JupyterHub Wrapperé¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œè®©é¡µé¢æœ‰æ—¶é—´æ¸²æŸ“
            setTimeout(async () => {
                await checkAuth();
                await checkJupyterHubStatus();
            }, 500);
        });

        // å¤„ç†iframeæ¶ˆæ¯
        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            
            if (event.data.type === 'jupyterhub-ready') {
                log('JupyterHub iframeåŠ è½½å®Œæˆ');
            }
        });

        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                log('é¡µé¢é‡æ–°å¯è§ï¼Œåˆ·æ–°çŠ¶æ€');
            }
        });
    </script>
</body>
</html>
