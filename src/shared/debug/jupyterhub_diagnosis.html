<!DOCTYPE html>
<html>
<head>
    <title>JupyterHubè®¤è¯æµç¨‹è¯Šæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 10px 15px; }
    </style>
</head>
<body>
    <h1>ğŸ” JupyterHubè®¤è¯æµç¨‹è¯Šæ–­</h1>
    
    <button onclick="startDiagnosis()">å¼€å§‹è¯Šæ–­</button>
    <button onclick="setTestToken()">è®¾ç½®æµ‹è¯•Token</button>
    <button onclick="clearAll()">æ¸…é™¤æ‰€æœ‰</button>
    
    <div id="results"></div>

    <script>
        function log(step, message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${type}`;
            stepDiv.innerHTML = `<strong>æ­¥éª¤ ${step}:</strong> ${message}`;
            resultsDiv.appendChild(stepDiv);
            console.log(`[æ­¥éª¤${step}] ${message}`);
        }

        function clearAll() {
            localStorage.clear();
            document.getElementById('results').innerHTML = '';
            log(0, 'å·²æ¸…é™¤æ‰€æœ‰æ•°æ®å’Œæ—¥å¿—', 'info');
        }

        function setTestToken() {
            const testToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoxLCJ1c2VybmFtZSI6InRlc3R1c2VyIiwiZXhwIjoxNzIzMzEwNDAwfQ.test_signature';
            const expires = new Date(Date.now() + 3600000).toISOString();
            
            localStorage.setItem('token', testToken);
            localStorage.setItem('token_expires', expires);
            
            log(1, `æµ‹è¯•Tokenå·²è®¾ç½®: ${testToken.substring(0, 30)}...`, 'success');
        }

        async function startDiagnosis() {
            document.getElementById('results').innerHTML = '';
            
            // æ­¥éª¤1: æ£€æŸ¥Token
            const token = localStorage.getItem('token');
            if (token) {
                log(1, `æ‰¾åˆ°Token: ${token.substring(0, 30)}...`, 'success');
            } else {
                log(1, 'æœªæ‰¾åˆ°Tokenï¼Œè¯·å…ˆè®¾ç½®æµ‹è¯•Token', 'error');
                return;
            }

            // æ­¥éª¤2: æ£€æŸ¥è®¤è¯æ¡¥æ¥é¡µé¢
            try {
                log(2, 'æ£€æŸ¥è®¤è¯æ¡¥æ¥é¡µé¢å¯è®¿é—®æ€§...', 'info');
                const response = await fetch('/jupyterhub-auth-bridge?target_url=/jupyter/hub/');
                if (response.ok) {
                    log(2, `è®¤è¯æ¡¥æ¥é¡µé¢æ­£å¸¸ (HTTP ${response.status})`, 'success');
                } else {
                    log(2, `è®¤è¯æ¡¥æ¥é¡µé¢å¼‚å¸¸ (HTTP ${response.status})`, 'error');
                }
            } catch (error) {
                log(2, `è®¤è¯æ¡¥æ¥é¡µé¢è®¿é—®å¤±è´¥: ${error.message}`, 'error');
            }

            // æ­¥éª¤3: æ£€æŸ¥JupyterHubå¯è®¿é—®æ€§
            try {
                log(3, 'æ£€æŸ¥JupyterHubåç«¯å¯è®¿é—®æ€§...', 'info');
                const response = await fetch('/jupyter/hub/', { redirect: 'manual' });
                log(3, `JupyterHubå“åº” (HTTP ${response.status})`, response.status === 302 ? 'success' : 'info');
            } catch (error) {
                log(3, `JupyterHubè®¿é—®å¤±è´¥: ${error.message}`, 'error');
            }

            // æ­¥éª¤4: æ¨¡æ‹Ÿè®¤è¯æ¡¥æ¥é€»è¾‘
            log(4, 'æ¨¡æ‹Ÿè®¤è¯æ¡¥æ¥æµç¨‹...', 'info');
            
            const urlParams = new URLSearchParams('?target_url=/jupyter/hub/');
            const targetUrl = urlParams.get('target_url') || '/jupyter/hub/';
            const username = 'testuser';
            
            let redirectUrl;
            if (targetUrl.includes('?')) {
                redirectUrl = `${targetUrl}&auth_token=${encodeURIComponent(token)}&username=${encodeURIComponent(username)}`;
            } else {
                redirectUrl = `${targetUrl}?auth_token=${encodeURIComponent(token)}&username=${encodeURIComponent(username)}`;
            }
            
            log(4, `æ„å»ºçš„é‡å®šå‘URL: ${redirectUrl}`, 'success');

            // æ­¥éª¤5: æµ‹è¯•æœ€ç»ˆé‡å®šå‘
            log(5, 'å‡†å¤‡è·³è½¬åˆ°JupyterHub...', 'info');
            setTimeout(() => {
                log(5, `å³å°†è·³è½¬åˆ°: ${redirectUrl}`, 'info');
                window.location.href = redirectUrl;
            }, 3000);
        }
    </script>
</body>
</html>
