<!DOCTYPE html>
<html>
<head>
    <title>è®¤è¯çŠ¶æ€è¯Šæ–­</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        .warning { background: #fff3cd; border-color: #ffeeba; }
        button { margin: 5px; padding: 10px 15px; }
        .code { background: #f8f9fa; padding: 5px; font-family: monospace; border-radius: 3px; }
        .token-display { word-break: break-all; max-width: 100%; }
    </style>
</head>
<body>
    <h1>ğŸ” è®¤è¯çŠ¶æ€è¯Šæ–­å·¥å…·</h1>
    
    <button onclick="checkAuthStatus()">ğŸ”„ æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
    <button onclick="testAPICall()">ğŸ§ª æµ‹è¯•APIè°ƒç”¨</button>
    <button onclick="clearAuth()">ğŸ—‘ï¸ æ¸…é™¤è®¤è¯ä¿¡æ¯</button>
    
    <div id="results"></div>

    <script>
        let stepCounter = 0;

        function log(message, type = 'info') {
            stepCounter++;
            const resultsDiv = document.getElementById('results');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${type}`;
            stepDiv.innerHTML = `<strong>æ­¥éª¤ ${stepCounter}:</strong> ${message}`;
            resultsDiv.appendChild(stepDiv);
            console.log(`[æ­¥éª¤${stepCounter}] ${message}`);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
            stepDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            stepCounter = 0;
        }

        function clearAuth() {
            localStorage.clear();
            sessionStorage.clear();
            clearResults();
            log('å·²æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨çš„è®¤è¯ä¿¡æ¯', 'info');
        }

        function checkAuthStatus() {
            clearResults();
            log('å¼€å§‹æ£€æŸ¥è®¤è¯çŠ¶æ€...', 'info');
            
            // æ£€æŸ¥localStorageä¸­çš„è®¤è¯ä¿¡æ¯
            const token = localStorage.getItem('token');
            const expires = localStorage.getItem('token_expires');
            const user = localStorage.getItem('user');
            
            if (token) {
                log(`âœ… å‘ç°Token: <div class="code token-display">${token}</div>`, 'success');
                
                // æ£€æŸ¥tokenæ ¼å¼
                if (token.startsWith('eyJ')) {
                    log('âœ… Tokenæ ¼å¼æ­£ç¡®ï¼ˆJWTæ ¼å¼ï¼‰', 'success');
                } else {
                    log('âš ï¸ Tokenæ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼ˆéJWTæ ¼å¼ï¼‰', 'warning');
                }
                
                if (expires) {
                    const expiryDate = new Date(expires);
                    const now = new Date();
                    const isExpired = now >= expiryDate;
                    log(`Tokenè¿‡æœŸæ—¶é—´: <span class="code">${expiryDate.toLocaleString()}</span> ${isExpired ? 'âŒ (å·²è¿‡æœŸ)' : 'âœ… (æœ‰æ•ˆ)'}`, isExpired ? 'error' : 'success');
                }
                
                if (user) {
                    try {
                        const userData = JSON.parse(user);
                        log(`âœ… ç”¨æˆ·ä¿¡æ¯: <span class="code">${userData.username || userData.email || 'æœªçŸ¥ç”¨æˆ·'}</span>`, 'success');
                    } catch (e) {
                        log('âš ï¸ ç”¨æˆ·ä¿¡æ¯æ ¼å¼é”™è¯¯', 'warning');
                    }
                }
            } else {
                log('âŒ æœªå‘ç°Tokenï¼Œç”¨æˆ·æœªç™»å½•', 'error');
                return;
            }
            
            // æ£€æŸ¥cookieä¸­çš„è®¤è¯ä¿¡æ¯
            const cookies = document.cookie.split(';');
            const authCookies = cookies.filter(cookie => 
                cookie.trim().toLowerCase().includes('token') || 
                cookie.trim().toLowerCase().includes('auth')
            );
            
            if (authCookies.length > 0) {
                log(`âœ… å‘ç°è®¤è¯ç›¸å…³çš„Cookie: <span class="code">${authCookies.join(', ')}</span>`, 'success');
            } else {
                log('âš ï¸ æœªå‘ç°è®¤è¯ç›¸å…³çš„Cookie', 'warning');
            }
        }

        async function testAPICall() {
            if (stepCounter === 0) {
                checkAuthStatus();
            }
            
            const token = localStorage.getItem('token');
            if (!token) {
                log('âŒ æ— Tokenï¼Œæ— æ³•æµ‹è¯•APIè°ƒç”¨', 'error');
                return;
            }
            
            log('ğŸ§ª å¼€å§‹æµ‹è¯•APIè°ƒç”¨...', 'info');
            
            try {
                // æµ‹è¯•/api/auth/verifyç«¯ç‚¹
                log('æµ‹è¯• /api/auth/verify ç«¯ç‚¹...', 'info');
                
                const response = await fetch('/api/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`APIå“åº”çŠ¶æ€: <span class="code">${response.status} ${response.statusText}</span>`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… APIè°ƒç”¨æˆåŠŸï¼Œè¿”å›æ•°æ®: <div class="code">${JSON.stringify(data, null, 2)}</div>`, 'success');
                } else {
                    const errorText = await response.text();
                    log(`âŒ APIè°ƒç”¨å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯: <div class="code">${errorText}</div>`, 'error');
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯å¤´çš„é—®é¢˜
                    if (response.status === 401) {
                        log('ğŸ” 401é”™è¯¯é€šå¸¸è¡¨ç¤ºè®¤è¯å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› :', 'warning');
                        log('1. Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ', 'warning');
                        log('2. Tokenæ ¼å¼ä¸æ­£ç¡®', 'warning');
                        log('3. åç«¯è®¤è¯é€»è¾‘æœ‰é—®é¢˜', 'warning');
                        log('4. nginxä»£ç†æ²¡æœ‰æ­£ç¡®è½¬å‘è®¤è¯å¤´', 'warning');
                    }
                }
                
            } catch (error) {
                log(`âŒ APIè°ƒç”¨å‡ºç°å¼‚å¸¸: <span class="code">${error.message}</span>`, 'error');
            }
            
            // æµ‹è¯•å…¶ä»–APIç«¯ç‚¹
            try {
                log('æµ‹è¯• /api/auth/me ç«¯ç‚¹...', 'info');
                
                const response = await fetch('/api/auth/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`/api/auth/me å“åº”çŠ¶æ€: <span class="code">${response.status} ${response.statusText}</span>`, response.ok ? 'success' : 'warning');
                
            } catch (error) {
                log(`/api/auth/me è°ƒç”¨å¼‚å¸¸: <span class="code">${error.message}</span>`, 'warning');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.addEventListener('load', () => {
            checkAuthStatus();
        });
    </script>
</body>
</html>
