# AI Infrastructure Matrix - SLURM Master Service
# åŸºäºUbuntuæ„å»ºSLURMæ§åˆ¶èŠ‚ç‚¹
FROM ubuntu:22.04

ARG VERSION=v0.3.6-dev
LABEL maintainer="AI Infrastructure Team"
LABEL version="${VERSION}"
LABEL description="AI Infrastructure Matrix SLURM Master Service"

# é¿å…äº¤äº’å¼å®‰è£…æç¤º
ENV DEBIAN_FRONTEND=noninteractive
ENV container=docker
ENV TZ=Asia/Shanghai

# ä½¿ç”¨å®˜æ–¹æºå…ˆå®‰è£…åŸºç¡€å·¥å…·ï¼Œç„¶åé…ç½®é•œåƒæº
RUN set -eux; \
    # å¤‡ä»½åŸå§‹sources.list
    cp /etc/apt/sources.list /etc/apt/sources.list.backup; \
    # é‡è¯•æœºåˆ¶å®‰è£…åŸºç¡€åŒ…
    for i in 1 2 3; do \
        apt-get update && apt-get install -y --no-install-recommends ca-certificates curl && break; \
        echo "å°è¯•ç¬¬ $i æ¬¡å®‰è£…å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."; \
        sleep 5; \
    done

# é…ç½®é˜¿é‡Œäº‘é•œåƒæºï¼ˆç›´æ¥ä½¿ç”¨ï¼Œä¸åšéªŒè¯ï¼‰
RUN set -eux; \
    ARCH=$(dpkg --print-architecture); \
    echo "Detected architecture: ${ARCH}"; \
    # æ ¹æ®æ¶æ„ç›´æ¥é…ç½®é˜¿é‡Œäº‘é•œåƒæº
    if [ "${ARCH}" = "arm64" ] || [ "${ARCH}" = "aarch64" ]; then \
        echo "é…ç½®ARM64é˜¿é‡Œäº‘é•œåƒæº..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu-ports/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "# å®˜æ–¹å¤‡ç”¨æº" >> /etc/apt/sources.list && \
        echo "deb http://ports.ubuntu.com/ubuntu-ports jammy main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://ports.ubuntu.com/ubuntu-ports jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://ports.ubuntu.com/ubuntu-ports jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://ports.ubuntu.com/ubuntu-ports jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    else \
        echo "é…ç½®AMD64é˜¿é‡Œäº‘é•œåƒæº..."; \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse" > /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "# å®˜æ–¹å¤‡ç”¨æº" >> /etc/apt/sources.list && \
        echo "deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse" >> /etc/apt/sources.list && \
        echo "deb http://archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse" >> /etc/apt/sources.list; \
    fi; \
    # APT é‡è¯•ä¸è¶…æ—¶é…ç½®
    echo 'Acquire::Retries "5"; Acquire::http::Timeout "30"; Acquire::https::Timeout "30";' > /etc/apt/apt.conf.d/99retries; \
    # æ›´æ–°åŒ…åˆ—è¡¨ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
    apt-get update || (sleep 5 && apt-get update) || (sleep 10 && apt-get update)

# å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆca-certificateså’Œcurlå·²åœ¨ä¸Šé¢å®‰è£…ï¼‰
RUN set -eux; \
    # Refresh index right before install to avoid stale caches across layers
    for i in 1 2 3; do \
        apt-get -o Acquire::Retries=3 update && break || (echo "apt-get update failed (attempt $i), retrying..." && sleep 5); \
    done; \
    # Install with --fix-missing and retries to improve robustness on flaky mirrors
    apt-get -o Acquire::Retries=3 install -y --no-install-recommends --fix-missing \
        systemd \
        systemd-sysv \
        # networking and diagnostics \
        curl \
        wget \
        telnet \
        openssh-client \
        mtr-tiny \
        netcat-openbsd \
        # utilities \
        vim \
        tree \
        procps \
        gettext-base \
        # slurm prerequisites \
        munge \
        libmunge2 \
        postgresql-client \
        default-mysql-client && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
            
# å®‰è£…SLURMåŒ…å‰å…ˆåˆ›å»ºç”¨æˆ·ï¼Œè¿™æ ·å®‰è£…è¿‡ç¨‹ä¼šè‡ªåŠ¨é…ç½®æƒé™
RUN groupadd -r slurm && useradd -r -g slurm -d /var/lib/slurm -s /bin/bash slurm

# åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p /etc/slurm \
    /var/spool/slurm/slurmctld \
    /var/spool/slurm/slurmdbd \
    /var/log/slurm \
    /var/lib/slurm \
    /var/run/slurm \
    /etc/munge \
    /var/lib/munge \
    /var/log/munge \
    /var/run/munge \
    /srv/shared

# å°è¯•ä»AppHubå®‰è£…SLURM 25.05.3ç‰ˆæœ¬åŒ…ï¼ˆä¼˜å…ˆçº§ï¼šAppHub > ç³»ç»Ÿä»“åº“ï¼‰
ARG APPHUB_URL=http://apphub:80
RUN set -eux; \
    echo "ğŸ” å°è¯•ä»AppHubå®‰è£…SLURMåŒ…..."; \
    # æ·»åŠ AppHubæº
    echo "deb [trusted=yes] ${APPHUB_URL}/pkgs/slurm-deb ./" > /etc/apt/sources.list.d/ai-infra-slurm.list; \
    echo "ğŸ“‹ AppHubæºé…ç½®:"; \
    cat /etc/apt/sources.list.d/ai-infra-slurm.list; \
    \
    # æµ‹è¯•AppHubè¿æ¥
    echo "ğŸŒ æµ‹è¯•AppHubè¿æ¥..."; \
    if timeout 10 wget -q --spider ${APPHUB_URL}/pkgs/slurm-deb/Packages; then \
        echo "âœ… AppHubè¿æ¥æ­£å¸¸"; \
        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…
        if timeout 60 apt-get update && \
           apt-get install -y --no-install-recommends \
               slurm-smd \
               slurm-smd-client \
               slurm-smd-slurmctld \
               slurm-smd-slurmdbd; then \
            echo "âœ… æˆåŠŸä»AppHubå®‰è£…SLURM 25.05.3åŒ…"; \
            SLURM_INSTALLED=true; \
            SLURM_SOURCE="AppHub"; \
        else \
            echo "âŒ AppHubåŒ…å®‰è£…å¤±è´¥ï¼Œå°è¯•ç³»ç»Ÿä»“åº“..."; \
            rm -f /etc/apt/sources.list.d/ai-infra-slurm.list; \
            apt-get update; \
            if apt-get install -y slurm-wlm slurm-wlm-basic-plugins slurmctld slurmdbd slurm-client; then \
                echo "âœ… æˆåŠŸä»ç³»ç»Ÿä»“åº“å®‰è£…SLURM"; \
                SLURM_INSTALLED=true; \
                SLURM_SOURCE="SystemRepo"; \
            else \
                echo "âŒ ç³»ç»Ÿä»“åº“å®‰è£…ä¹Ÿå¤±è´¥"; \
                SLURM_INSTALLED=false; \
                SLURM_SOURCE="None"; \
            fi; \
        fi; \
    else \
        echo "âŒ AppHubè¿æ¥å¤±è´¥ï¼Œç›´æ¥ä½¿ç”¨ç³»ç»Ÿä»“åº“"; \
        rm -f /etc/apt/sources.list.d/ai-infra-slurm.list; \
        apt-get update; \
        if apt-get install -y slurm-wlm slurm-wlm-basic-plugins slurmctld slurmdbd slurm-client; then \
            echo "âœ… æˆåŠŸä»ç³»ç»Ÿä»“åº“å®‰è£…SLURM"; \
            SLURM_INSTALLED=true; \
            SLURM_SOURCE="SystemRepo"; \
        else \
            echo "âŒ SLURMå®‰è£…å®Œå…¨å¤±è´¥"; \
            SLURM_INSTALLED=false; \
            SLURM_SOURCE="None"; \
        fi; \
    fi; \
    \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*; \
    \
    # åˆ›å»ºæ ‡è®°æ–‡ä»¶å’Œè·¯å¾„æ£€æŸ¥
    if [ "$SLURM_INSTALLED" = "true" ]; then \
        touch /opt/slurm-installed; \
        echo "$SLURM_SOURCE" > /opt/slurm-source; \
        # åŠ¨æ€æ£€æŸ¥å®é™…çš„äºŒè¿›åˆ¶æ–‡ä»¶ä½ç½®
        echo "ğŸ” æ£€æŸ¥SLURMäºŒè¿›åˆ¶æ–‡ä»¶ä½ç½®..."; \
        SLURMCTLD_PATH=$(which slurmctld 2>/dev/null || find /usr -name "slurmctld" -type f -executable 2>/dev/null | head -1 || echo ""); \
        SLURMDBD_PATH=$(which slurmdbd 2>/dev/null || find /usr -name "slurmdbd" -type f -executable 2>/dev/null | head -1 || echo ""); \
        \
        if [ -n "$SLURMCTLD_PATH" ] && [ -x "$SLURMCTLD_PATH" ]; then \
            echo "$SLURMCTLD_PATH" > /opt/slurmctld-path; \
            echo "âœ… slurmctld: $SLURMCTLD_PATH"; \
        else \
            echo "/usr/sbin/slurmctld" > /opt/slurmctld-path; \
            echo "âš ï¸  slurmctldè·¯å¾„æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„"; \
        fi; \
        \
        if [ -n "$SLURMDBD_PATH" ] && [ -x "$SLURMDBD_PATH" ]; then \
            echo "$SLURMDBD_PATH" > /opt/slurmdbd-path; \
            echo "âœ… slurmdbd: $SLURMDBD_PATH"; \
        else \
            echo "/usr/sbin/slurmdbd" > /opt/slurmdbd-path; \
            echo "âš ï¸  slurmdbdè·¯å¾„æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„"; \
        fi; \
        \
        echo "ğŸ“¦ SLURMå®‰è£…æ‘˜è¦:"; \
        echo "  æ¥æº: $SLURM_SOURCE"; \
        echo "  slurmctld: $(cat /opt/slurmctld-path)"; \
        echo "  slurmdbd: $(cat /opt/slurmdbd-path)"; \
    else \
        echo "SLURMæœªå®‰è£…ï¼Œå°†è¿è¡Œæ¼”ç¤ºæ¨¡å¼" > /opt/slurm-demo-mode; \
        echo "âŒ å®¹å™¨å°†ä»¥æ¼”ç¤ºæ¨¡å¼è¿è¡Œ"; \
    fi

# é…ç½®ç”¨æˆ·ç»„å’Œæƒé™ï¼ˆåœ¨SLURMå®‰è£…åï¼‰
RUN usermod -a -G munge slurm && \
    chown -R slurm:slurm /var/spool/slurm /var/log/slurm /var/lib/slurm /var/run/slurm /etc/slurm && \
    chown -R munge:munge /etc/munge /var/lib/munge /var/log/munge /var/run/munge && \
    chmod 755 /var/spool/slurm /var/log/slurm /var/lib/slurm /var/run/slurm && \
    chmod 700 /etc/munge /var/lib/munge && \
    chmod 755 /var/log/munge /var/run/munge && \
    chmod 640 /etc/munge/munge.key || true

# å¤åˆ¶é…ç½®ä¸systemdè„šæœ¬
COPY config/ /etc/slurm-templates/
COPY entrypoint.sh /usr/local/bin/slurm-bootstrap.sh
COPY systemd-entrypoint.sh /usr/local/bin/systemd-entrypoint.sh
COPY healthcheck.sh /usr/local/bin/healthcheck.sh
COPY systemd/ /etc/systemd/system/
RUN chmod +x /usr/local/bin/slurm-bootstrap.sh /usr/local/bin/systemd-entrypoint.sh /usr/local/bin/healthcheck.sh && \
    ln -sf /etc/systemd/system/slurm-bootstrap.service /etc/systemd/system/multi-user.target.wants/slurm-bootstrap.service && \
    ln -sf /etc/systemd/system/slurmctld.service /etc/systemd/system/multi-user.target.wants/slurmctld.service && \
    ln -sf /etc/systemd/system/slurmdbd.service /etc/systemd/system/multi-user.target.wants/slurmdbd.service && \
    ln -sf /lib/systemd/system/munge.service /etc/systemd/system/multi-user.target.wants/munge.service

# æš´éœ²ç«¯å£
EXPOSE 6817 6818

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /etc/slurm

# å¯åŠ¨è„šæœ¬
STOPSIGNAL SIGRTMIN+3

VOLUME ["/sys/fs/cgroup"]

ENTRYPOINT ["/usr/local/bin/systemd-entrypoint.sh"]
CMD ["/sbin/init"]