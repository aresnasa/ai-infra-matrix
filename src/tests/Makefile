# Ansible Playbook Generator Test Suite
# Usage: make test-all
# Author: DevOps Team

# é¡¹ç›®è·¯å¾„
PROJECT_ROOT := $(shell cd .. && pwd)
BACKEND_DIR := $(PROJECT_ROOT)/backend
FRONTEND_DIR := $(PROJECT_ROOT)/frontend

.PHONY: help test-all test-unit test-integration test-e2e start-test-env stop-test-env clean \
        health-check build-all start-prod stop-prod logs status restart auto-test quick-test \
        build-and-test

# Default target
help:
	@echo "ğŸ¯ Ansible Playbook Generator Test Suite"
	@echo "========================================"
	@echo "Available commands:"
	@echo ""
	@echo "ğŸš€ AUTOMATED TESTING:"
	@echo "  auto-test       - Run FULLY AUTOMATED test suite with reports"
	@echo "  quick-test      - Run essential tests only (faster)"
	@echo ""
	@echo "ğŸ§ª MANUAL TESTING:"
	@echo "  test-all        - Run all tests in sequence"
	@echo "  test-unit       - Run unit tests in Docker containers"
	@echo "  test-integration - Run integration tests"
	@echo "  test-e2e        - Run end-to-end tests"
	@echo ""
	@echo "ğŸ› ï¸  ENVIRONMENT MANAGEMENT:"
	@echo "  start-test-env  - Start test environment"
	@echo "  stop-test-env   - Stop test environment"
	@echo "  health-check    - Check all services health status"
	@echo "  build-all       - Build all Docker images"
	@echo ""
	@echo "ğŸŒ PRODUCTION:"
	@echo "  start-prod      - Start production environment"
	@echo "  stop-prod       - Stop production environment"
	@echo ""
	@echo "ğŸ”§ UTILITIES:"
	@echo "  logs            - Show logs from all services"
	@echo "  status          - Show status of all services"
	@echo "  restart         - Restart all services"
	@echo "  clean           - Clean test artifacts and containers"

# ğŸš€ FULLY AUTOMATED TEST SUITE
auto-test:
	@echo "ğŸ¤– Starting FULLY AUTOMATED test suite..."
	@echo "=========================================="
	@chmod +x ./run-all-tests.sh && \
	./run-all-tests.sh

# âš¡ QUICK AUTOMATED TESTS
quick-test:
	@echo "âš¡ Starting QUICK automated test suite..."
	@echo "========================================"
	@chmod +x ./run-all-tests.sh && \
	QUICK_MODE=true ./run-all-tests.sh

# Run all tests in fully automated mode
test-all: clean build-all start-test-env health-check test-unit test-integration test-e2e stop-test-env
	@echo "ğŸ‰ All tests completed successfully!"
	@echo "âœ… Ansible Playbook Generator is ready for production!"

# Build all Docker images
build-all:
	@echo "ğŸ”¨ Building all Docker images..."
	@cd $(PROJECT_ROOT) && docker-compose build
	@echo "âœ… All images built successfully!"

# Start production services
start-prod:
	@echo "ğŸš€ Starting production environment..."
	@cd $(PROJECT_ROOT) && docker-compose up -d
	@echo "âœ… Production environment started!"
	@echo "ğŸŒ Frontend: http://localhost:3001"
	@echo "ğŸ”§ Backend API: http://localhost:8082/api"

# Stop production services  
stop-prod:
	@echo "â¹ï¸  Stopping production environment..."
	@cd $(PROJECT_ROOT) && docker-compose down
	@echo "âœ… Production environment stopped!"

# Unit tests in containers
test-unit:
	@echo "ğŸ§ª Running unit tests in Docker containers..."
	@echo "Testing backend services..."
	@docker-compose -f docker-compose.test.yml exec -T backend-test go test -v ./internal/... -short -coverprofile=coverage.out
	@echo "Testing frontend services..."
	@if docker-compose -f docker-compose.test.yml ps frontend-test | grep -q "Up"; then \
		docker-compose -f docker-compose.test.yml exec -T frontend-test npm test -- --watchAll=false --passWithNoTests --coverage; \
	else \
		echo "âš ï¸  Frontend test container not running, skipping frontend tests"; \
	fi
	@echo "âœ… Unit tests completed!"

# Integration tests
test-integration:
	@echo "ğŸ”— Running integration tests..."
	@docker-compose -f docker-compose.test.yml exec -T backend-test go test -v ./integration/... -tags=integration
	@echo "âœ… Integration tests completed!"

# End-to-end tests
test-e2e:
	@echo "ğŸŒ Running end-to-end tests..."
	@chmod +x ./scripts/e2e-test.sh
	@./scripts/e2e-test.sh
	@echo "âœ… End-to-end tests completed!"

# Start test environment with health checks
start-test-env:
	@echo "ğŸš€ Starting test environment..."
	@docker-compose -f docker-compose.test.yml down --remove-orphans && \
	docker-compose -f docker-compose.test.yml up --build -d
	@echo "â³ Waiting for services to be ready..."
	@chmod +x ./scripts/wait-for-services.sh
	@./scripts/wait-for-services.sh
	@echo "âœ… Test environment is ready!"

# Stop test environment
stop-test-env:
	@echo "ğŸ›‘ Stopping test environment..."
	@docker-compose -f docker-compose.test.yml down --remove-orphans
	@echo "âœ… Test environment stopped!"

# Health check for all services
health-check:
	@echo "ğŸ¥ Running enhanced health check..."
	@chmod +x ./scripts/health-check-enhanced.sh
	@./scripts/health-check-enhanced.sh

# Stop production environment
stop-prod:
	@echo "ğŸ›‘ Stopping production environment..."
	@cd .. && docker-compose down --remove-orphans

# Show logs from all services
logs:
	@echo "ğŸ“‹ Showing logs from all services..."
	@docker-compose -f docker-compose.test.yml logs --tail=50 -f

# Show status of all services
status:
	@echo "ğŸ“Š Service Status:"
	@echo "=================="
	@echo "Test Environment:"
	@docker-compose -f docker-compose.test.yml ps
	@echo ""
	@echo "Production Environment:"
	@cd .. && docker-compose ps

# Restart all services
restart: stop-test-env start-test-env
	@echo "ğŸ”„ All services restarted!"

# Clean test artifacts and containers
clean:
	@echo "ğŸ§¹ Cleaning test artifacts and containers..."
	@rm -rf reports/ coverage/ logs/
	@mkdir -p reports coverage logs
	@docker-compose -f docker-compose.test.yml down --remove-orphans --volumes
	@cd .. && docker-compose down --remove-orphans --volumes
	@docker system prune -f
	@echo "âœ… Cleanup completed!"

# å¿«é€Ÿæ„å»ºå’Œæµ‹è¯•ï¼ˆæ¨èç”¨äºå¼€å‘ï¼‰
build-and-test:
	@echo "ğŸš€ Quick Build and Test Pipeline"
	@echo "================================="
	@cd $(PROJECT_ROOT) && \
	echo "ğŸ›‘ Stopping existing containers..." && \
	docker-compose down --volumes && \
	echo "ğŸ”¨ Building..." && \
	docker-compose build && \
	echo "ğŸš€ Starting services..." && \
	docker-compose up -d && \
	echo "â³ Waiting for services to be ready..." && \
	sleep 30 && \
	echo "ğŸ” Health check..." && \
	curl -f http://localhost:8082/api/health && \
	echo "" && \
	echo "âœ… Build and test completed successfully!" && \
	echo "ğŸŒ Frontend: http://localhost:3001" && \
	echo "ğŸ”§ Backend API: http://localhost:8082/api"
