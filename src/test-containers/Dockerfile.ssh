# SSH测试容器 - 用于SaltStack客户端安装测试
FROM ubuntu:22.04

# 避免交互式安装
ENV DEBIAN_FRONTEND=noninteractive

# 使用阿里云源加速下载
RUN sed -i 's|archive.ubuntu.com|mirrors.aliyun.com|g; s|security.ubuntu.com|mirrors.aliyun.com|g; s|ports.ubuntu.com|mirrors.aliyun.com|g' /etc/apt/sources.list

# 安装SSH服务器和基本工具
RUN apt-get update && apt-get install -y \
    openssh-server \
    sudo \
    curl \
    wget \
    python3 \
    python3-pip \
    systemd \
    init \
    dnsutils \
    iputils-ping \
    net-tools \
    && rm -rf /var/lib/apt/lists/*

# 创建SSH运行目录
RUN mkdir -p /var/run/sshd /run/sshd

# 配置SSH
RUN echo 'root:rootpass123' | chpasswd
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

# 生成SSH主机密钥
RUN ssh-keygen -A

# 创建测试用户
RUN useradd -m -s /bin/bash testuser
RUN echo 'testuser:testpass123' | chpasswd
RUN usermod -aG sudo testuser

# 允许sudo免密码
RUN echo 'testuser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# 配置pip使用阿里云源
RUN pip3 config set global.index-url https://mirrors.aliyun.com/pypi/simple/ && \
    pip3 config set global.trusted-host mirrors.aliyun.com

# 创建工作目录
RUN mkdir -p /opt/saltstack
WORKDIR /opt/saltstack

# 暴露SSH端口
EXPOSE 22

# 启动SSH服务
CMD ["/usr/sbin/sshd", "-D"]
