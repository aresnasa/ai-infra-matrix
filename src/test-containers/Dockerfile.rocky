# Rocky Linux 9 SSH测试容器 - 用于SaltStack和SLURM客户端安装测试
FROM rockylinux:9

ARG VERSION="dev"
ARG YUM_MIRROR
ARG PIP_INDEX_URL
ENV APP_VERSION=${VERSION}
ENV container=docker
ENV TZ=Asia/Shanghai

# 配置阿里云镜像源加速
RUN set -eux; \
    if [ -n "${YUM_MIRROR}" ]; then \
        sed -e 's|^mirrorlist=|#mirrorlist=|g' \
            -e "s|^#baseurl=http://dl.rockylinux.org/\$contentdir|baseurl=http://${YUM_MIRROR}/rockylinux|g" \
            -i.bak \
            /etc/yum.repos.d/rocky*.repo; \
    else \
        sed -e 's|^mirrorlist=|#mirrorlist=|g' \
            -e 's|^#baseurl=http://dl.rockylinux.org/\$contentdir|baseurl=http://mirrors.aliyun.com/rockylinux|g' \
            -i.bak \
            /etc/yum.repos.d/rocky*.repo; \
    fi && \
    dnf clean all && \
    dnf makecache

# 安装SSH服务器和基本工具
RUN dnf install -y --allowerasing \
    systemd \
    openssh-server \
    sudo \
    curl \
    wget \
    python3 \
    python3-pip \
    bind-utils \
    iputils \
    net-tools \
    procps-ng \
    iproute \
    which \
    vim-minimal \
    ca-certificates \
    tzdata \
    && dnf clean all

# 配置时区
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# 创建SSH运行目录
RUN mkdir -p /var/run/sshd /run/sshd

# 配置SSH
RUN sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config || \
    sed -i 's/#PermitRootLogin yes/PermitRootLogin yes/' /etc/ssh/sshd_config
RUN sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config || \
    sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config

# 生成SSH主机密钥
RUN ssh-keygen -A

# 预先创建 SLURM 相关用户（使用固定 UID/GID 确保一致性）
# 这样在后续安装 SLURM 时不会自动分配不同的 UID/GID
# munge: UID=998, GID=998 (SLURM 认证服务)
# slurm: UID=999, GID=999 (SLURM 主用户)
# Rocky Linux 9 默认可能有 systemd-coredump (UID/GID=999), 需要先删除用户再删除组
RUN (getent passwd 998 >/dev/null && userdel -f $(getent passwd 998 | cut -d: -f1) || true) && \
    (getent passwd 999 >/dev/null && userdel -f $(getent passwd 999 | cut -d: -f1) || true) && \
    (getent group 998 >/dev/null && groupdel $(getent group 998 | cut -d: -f1) || true) && \
    (getent group 999 >/dev/null && groupdel $(getent group 999 | cut -d: -f1) || true) && \
    groupadd -g 998 munge && useradd -u 998 -g munge -d /var/lib/munge -s /sbin/nologin munge && \
    groupadd -g 999 slurm && useradd -u 999 -g slurm -d /var/spool/slurm -s /sbin/nologin slurm

# 创建测试用户
RUN useradd -m -s /bin/bash testuser
RUN usermod -aG wheel testuser

# 允许wheel组sudo免密码
RUN echo '%wheel ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# 配置pip使用阿里云源
RUN if [ -n "${PIP_INDEX_URL}" ]; then \
        pip3 config set global.index-url ${PIP_INDEX_URL} && \
        pip3 config set global.trusted-host $(echo ${PIP_INDEX_URL} | awk -F/ '{print $3}'); \
    else \
        pip3 config set global.index-url https://mirrors.aliyun.com/pypi/simple/ && \
        pip3 config set global.trusted-host mirrors.aliyun.com; \
    fi || true

# 创建工作目录
RUN mkdir -p /opt/saltstack /opt/slurm
WORKDIR /root

# 复制SSH密钥（用于连接slurm-master）
RUN mkdir -p /root/.ssh && chmod 700 /root/.ssh
COPY ssh-key/id_rsa /root/.ssh/id_rsa
RUN chmod 600 /root/.ssh/id_rsa && \
    ssh-keyscan slurm-master > /root/.ssh/known_hosts 2>/dev/null || true

# 复制启动脚本
COPY src/test-containers/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# 暴露SSH端口
EXPOSE 22

# 启用SSH服务
RUN systemctl enable sshd

# 添加标签
LABEL maintainer="AI Infrastructure Team"
LABEL version="${VERSION}"
LABEL description="AI Infrastructure Matrix Test Container - Rocky Linux 9"
LABEL os="rocky"
LABEL os.version="9"

STOPSIGNAL SIGRTMIN+3

VOLUME [ "/sys/fs/cgroup" ]

# 使用entrypoint脚本启动（会设置密码并启动systemd）
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
