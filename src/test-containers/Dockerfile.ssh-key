# Ubuntu 22.04 with OpenSSH server (key auth preset)
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive

# Use Aliyun mirrors and install OpenSSH server
RUN sed -i 's|archive.ubuntu.com|mirrors.aliyun.com|g; s|security.ubuntu.com|mirrors.aliyun.com|g; s|ports.ubuntu.com|mirrors.aliyun.com|g' /etc/apt/sources.list \
    && sed -Ei 's/ jammy ([^\n]*)/ jammy \1 universe multiverse restricted/g; s/ jammy-updates ([^\n]*)/ jammy-updates \1 universe multiverse restricted/g; s/ jammy-security ([^\n]*)/ jammy-security \1 universe multiverse restricted/g' /etc/apt/sources.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends openssh-server ca-certificates tzdata \
    && rm -rf /var/lib/apt/lists/*

# Create user and seed authorized_keys with demo public key
RUN useradd -m -s /bin/bash tester \
    && mkdir -p /home/tester/.ssh \
    && touch /home/tester/.ssh/authorized_keys \
    && chown -R tester:tester /home/tester/.ssh \
    && chmod 700 /home/tester/.ssh \
    && chmod 600 /home/tester/.ssh/authorized_keys

COPY --chown=tester:tester demo_keys/id_rsa.pub /home/tester/.ssh/authorized_keys

# sshd config: disable root login, allow pubkey auth (password optional off)
RUN sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config \
    && sed -i 's/^#\?PubkeyAuthentication .*/PubkeyAuthentication yes/' /etc/ssh/sshd_config \
    && sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication no/' /etc/ssh/sshd_config \
    && printf "\nUseDNS no\nClientAliveInterval 60\nClientAliveCountMax 3\n" >> /etc/ssh/sshd_config

EXPOSE 22
CMD ["/usr/sbin/sshd","-D","-e"]
